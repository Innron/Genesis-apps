<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>üöõ Genesis Trucker GPS</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- OpenCV.js for document scanning -->
    <script async src="https://docs.opencv.org/4.7.0/opencv.js" onload="onOpenCvReady()"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #f5f5f5; height: 100vh; color: #333; overflow: hidden; 
        }
        
        .screen { display: none; height: 100vh; width: 100%; }
        .screen.active { display: flex; flex-direction: column; }
        
        /* LOGIN/SETUP */
        .code-screen { justify-content: center; align-items: center; padding: 40px 20px; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: #fff; }
        .logo { font-size: 80px; margin-bottom: 20px; }
        .title { font-size: 28px; font-weight: 700; margin-bottom: 10px; }
        .subtitle { color: #888; margin-bottom: 30px; }
        .code-input { width: 100%; max-width: 300px; padding: 18px; font-size: 20px; text-align: center; border: 3px solid #333; border-radius: 15px; background: #111; color: #00ff88; letter-spacing: 3px; }
        .code-input:focus { outline: none; border-color: #00ff88; }
        .btn { padding: 18px 40px; margin-top: 15px; border: none; border-radius: 15px; font-size: 18px; font-weight: 700; cursor: pointer; width: 100%; max-width: 300px; }
        .btn-primary { background: linear-gradient(135deg, #00b894 0%, #00cec9 100%); color: #000; }
        .btn-danger { background: #e74c3c; color: #fff; }
        .error-msg { color: #ff6b6b; margin-top: 15px; display: none; }
        .error-msg.show { display: block; }
        
        .setup-screen { padding: 30px 20px; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); overflow-y: auto; color: #fff; }
        .setup-header { text-align: center; margin-bottom: 30px; }
        .form-card { background: rgba(255,255,255,0.1); border-radius: 15px; padding: 20px; margin-bottom: 15px; max-width: 500px; margin: 0 auto 15px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; }
        .form-input, .form-select { width: 100%; padding: 15px; border: 2px solid rgba(255,255,255,0.2); border-radius: 12px; background: rgba(0,0,0,0.3); color: #fff; font-size: 16px; }
        .form-input:focus, .form-select:focus { outline: none; border-color: #00ff88; }
        
        /* MAIN MAP SCREEN */
        .main-screen { position: relative; }
        #map { position: absolute; top: 0; bottom: 0; left: 0; right: 0; z-index: 1; }
        
        /* TOP SEARCH BAR */
        .top-bar {
            position: absolute; top: 0; left: 0; right: 0; z-index: 1000;
            padding: 10px; padding-top: max(10px, env(safe-area-inset-top));
        }
        
        .search-box {
            background: #fff; border-radius: 12px; box-shadow: 0 2px 15px rgba(0,0,0,0.15);
            display: flex; align-items: center; padding: 5px;
        }
        .menu-btn { background: none; border: none; font-size: 22px; padding: 10px 12px; cursor: pointer; }
        .search-input { flex: 1; border: none; padding: 12px 5px; font-size: 16px; background: transparent; }
        .search-input:focus { outline: none; }
        .search-input::placeholder { color: #999; }
        .clear-btn { background: none; border: none; font-size: 18px; padding: 10px 12px; cursor: pointer; color: #999; display: none; }
        .clear-btn.show { display: block; }
        .go-btn { background: #00b894; border: none; font-size: 16px; padding: 10px 15px; cursor: pointer; color: #fff; border-radius: 8px; margin-right: 5px; display: none; font-weight: 600; }
        .go-btn.show { display: block; }
        
        /* Autocomplete Dropdown */
        .autocomplete-dropdown {
            position: absolute; top: 100%; left: 0; right: 0; 
            background: #fff; border-radius: 0 0 12px 12px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); 
            max-height: 250px; overflow-y: auto; display: none; z-index: 1001;
        }
        .autocomplete-dropdown.show { display: block; }
        .autocomplete-item { display: flex; align-items: center; padding: 12px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
        .autocomplete-item:last-child { border-bottom: none; }
        .autocomplete-item:active { background: #f0f0f0; }
        .autocomplete-icon { font-size: 18px; margin-right: 12px; color: #888; }
        .autocomplete-text { flex: 1; }
        .autocomplete-main { font-size: 14px; font-weight: 500; }
        .autocomplete-sub { font-size: 12px; color: #888; }
        
        /* RECENT DROPDOWN - Shows below search */
        .recent-dropdown {
            background: #fff; border-radius: 12px; margin-top: 8px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); max-height: 300px; 
            overflow-y: auto; display: none;
        }
        .recent-dropdown.show { display: block; }
        .recent-section-title { padding: 12px 15px 8px; font-size: 11px; color: #00b894; font-weight: 700; text-transform: uppercase; border-bottom: 1px solid #eee; }
        .recent-item { display: flex; align-items: center; padding: 12px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
        .recent-item:last-child { border-bottom: none; }
        .recent-item:active { background: #f0f0f0; }
        .recent-icon { font-size: 18px; margin-right: 12px; }
        .recent-text { flex: 1; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .recent-arrow { color: #ccc; font-size: 14px; }
        .no-recent { padding: 20px; text-align: center; color: #999; font-size: 14px; }
        
        /* QUICK PLACES (Home/Work) */
        .quick-places { display: flex; gap: 10px; padding: 10px 15px; border-bottom: 1px solid #eee; }
        .quick-place { flex: 1; display: flex; align-items: center; padding: 10px; background: #f8f8f8; border-radius: 10px; cursor: pointer; }
        .quick-place.not-set { border: 2px dashed #ddd; background: transparent; }
        .quick-place.set { border: 2px solid #00b894; background: #e8f8f5; }
        .quick-place-icon { font-size: 20px; margin-right: 8px; }
        .quick-place-text { font-size: 12px; }
        .quick-place-name { font-weight: 600; }
        .quick-place-addr { color: #888; font-size: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px; }
        
        /* NAVIGATION DISPLAY - Shows during active navigation */
        .nav-display {
            position: absolute; top: 0; left: 0; right: 0; z-index: 1000;
            background: linear-gradient(135deg, #1a1a2e 0%, #2d3436 100%);
            padding: 15px; padding-top: max(15px, env(safe-area-inset-top));
            display: none; color: #fff;
        }
        .nav-display.show { display: block; }
        .nav-instruction { display: flex; align-items: center; gap: 15px; margin-bottom: 10px; }
        .nav-turn-icon { font-size: 45px; }
        .nav-turn-text { flex: 1; }
        .nav-turn-main { font-size: 18px; font-weight: 700; }
        .nav-turn-punjabi { font-size: 13px; color: #aaa; margin-top: 3px; }
        .nav-turn-dist { font-size: 26px; font-weight: 800; color: #00ff88; }
        .nav-stats { display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid #444; margin-top: 10px; }
        .nav-stat { text-align: center; }
        .nav-stat-val { font-size: 18px; font-weight: 700; color: #00ff88; }
        .nav-stat-label { font-size: 10px; color: #888; }
        
        /* BOTTOM CONTROLS */
        .bottom-bar {
            position: absolute; bottom: 0; left: 0; right: 0; z-index: 1000;
            padding: 15px; padding-bottom: max(15px, env(safe-area-inset-bottom));
        }
        
        /* Route Preview Card */
        .route-card {
            background: #fff; border-radius: 15px; padding: 15px;
            box-shadow: 0 -2px 20px rgba(0,0,0,0.1); display: none;
        }
        .route-card.show { display: block; }
        .route-dest { font-size: 16px; font-weight: 600; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .route-info { display: flex; gap: 20px; margin: 10px 0; }
        .route-stat { }
        .route-stat-val { font-size: 24px; font-weight: 700; color: #00b894; }
        .route-stat-label { font-size: 11px; color: #888; }
        .route-actions { display: flex; gap: 10px; margin-top: 10px; }
        .route-btn { flex: 1; padding: 15px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .route-btn-start { background: #00b894; color: #fff; }
        .route-btn-cancel { background: #f0f0f0; color: #333; }
        
        /* Route Options - Multiple routes */
        .route-options { margin: 10px 0; }
        .route-option { display: flex; align-items: center; padding: 12px; margin-bottom: 8px; border-radius: 10px; cursor: pointer; border: 2px solid #eee; }
        .route-option.selected { border-color: #00b894; background: #e8f8f5; }
        .route-option-icon { font-size: 20px; margin-right: 10px; }
        .route-option-info { flex: 1; }
        .route-option-label { font-size: 13px; font-weight: 600; }
        .route-option-detail { font-size: 11px; color: #888; }
        .route-option-time { text-align: right; }
        .route-option-time-val { font-size: 16px; font-weight: 700; color: #00b894; }
        .route-option-dist { font-size: 11px; color: #888; }
        
        /* Directions Toggle (in route card) */
        .directions-toggle {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px; background: #f8f9fa; border-radius: 10px; 
            margin: 10px 0; cursor: pointer;
        }
        .directions-toggle:active { background: #eee; }
        .directions-step-indicator { font-size: 12px; color: #00b894; font-weight: 600; }
        .directions-arrow { color: #888; transition: transform 0.3s; }
        .directions-arrow.expanded { transform: rotate(180deg); }
        
        /* Directions List Container (in route card) */
        .directions-list-container {
            max-height: 0; overflow: hidden; transition: max-height 0.3s ease;
        }
        .directions-list-container.expanded { max-height: 250px; }
        .directions-list { max-height: 250px; overflow-y: auto; padding: 0 5px; }
        .direction-item { display: flex; padding: 10px 5px; border-bottom: 1px solid #f0f0f0; align-items: flex-start; }
        .direction-item.current { background: #e8f8f5; margin: 0 -5px; padding: 10px; border-radius: 8px; }
        .direction-item.completed { opacity: 0.5; }
        .direction-icon { font-size: 16px; margin-right: 10px; width: 24px; text-align: center; flex-shrink: 0; }
        .direction-text { flex: 1; font-size: 13px; line-height: 1.3; }
        .direction-dist { font-size: 11px; color: #888; text-align: right; flex-shrink: 0; margin-left: 8px; }
        
        /* Mini Directions Bar (during navigation) */
        .mini-directions-bar {
            position: absolute; bottom: 0; left: 0; right: 0; z-index: 1050;
            background: #fff; padding: 12px 15px;
            box-shadow: 0 -2px 15px rgba(0,0,0,0.1);
            display: none;
        }
        .mini-directions-bar.show { display: block; }
        .mini-directions-content { display: flex; align-items: center; cursor: pointer; }
        .mini-directions-step { font-size: 11px; color: #00b894; font-weight: 600; margin-right: 10px; white-space: nowrap; }
        .mini-directions-text { flex: 1; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .mini-directions-expand { color: #888; margin-left: 10px; }
        
        /* Full Directions Panel (during navigation) */
        .full-directions-panel {
            position: absolute; bottom: 0; left: 0; right: 0; z-index: 1100;
            background: #fff; border-radius: 20px 20px 0 0;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
            max-height: 70vh; display: none;
        }
        .full-directions-panel.show { display: block; }
        .full-directions-header { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; }
        .full-directions-header span { font-weight: 600; font-size: 16px; }
        .full-directions-close { background: none; border: none; font-size: 20px; color: #888; cursor: pointer; }
        .full-directions-tabs { display: flex; padding: 10px; gap: 10px; }
        .full-dir-tab { flex: 1; padding: 10px; border: 2px solid #eee; border-radius: 10px; background: #fff; font-size: 14px; cursor: pointer; }
        .full-dir-tab.active { border-color: #00b894; background: #e8f8f5; }
        .full-directions-list { max-height: calc(70vh - 120px); overflow-y: auto; padding: 10px 15px; }
        
        /* End Navigation Button - Tap screen to show */
        .nav-end-bar {
            background: #fff; border-radius: 15px; padding: 10px;
            box-shadow: 0 -2px 20px rgba(0,0,0,0.1); display: none;
        }
        .nav-end-bar.show { display: block; }
        .nav-end-btn { width: 100%; padding: 15px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; background: #e74c3c; color: #fff; }
        .nav-voice-btn { width: 100%; padding: 12px; border: none; border-radius: 10px; font-size: 14px; cursor: pointer; background: #f0f0f0; color: #333; margin-bottom: 10px; }
        
        /* POI interrupt prompt */
        .poi-prompt {
            position: absolute; bottom: 100px; left: 15px; right: 15px; z-index: 1100;
            background: #fff; border-radius: 15px; padding: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2); display: none;
        }
        .poi-prompt.show { display: block; }
        .poi-prompt-title { font-weight: 600; margin-bottom: 10px; }
        .poi-prompt-btns { display: flex; gap: 10px; }
        .poi-prompt-btn { flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; }
        
        /* MENU PANEL */
        .menu-panel {
            position: absolute; top: 0; bottom: 0; left: 0; width: 85%; max-width: 320px;
            background: #fff; z-index: 2000; transform: translateX(-100%);
            transition: transform 0.3s ease; overflow-y: auto;
            padding-top: max(20px, env(safe-area-inset-top));
        }
        .menu-panel.show { transform: translateX(0); }
        .menu-overlay { position: absolute; top: 0; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.5); z-index: 1999; display: none; }
        .menu-overlay.show { display: block; }
        
        .menu-header { padding: 20px; border-bottom: 1px solid #eee; }
        .menu-name { font-size: 18px; font-weight: 700; }
        .menu-truck { font-size: 13px; color: #888; }
        
        .menu-section { padding: 10px 0; border-bottom: 1px solid #eee; }
        .menu-section-title { padding: 10px 20px; font-size: 11px; color: #00b894; font-weight: 700; text-transform: uppercase; }
        .menu-item { display: flex; align-items: center; padding: 15px 20px; cursor: pointer; }
        .menu-item:active { background: #f0f0f0; }
        .menu-item-icon { font-size: 20px; margin-right: 15px; width: 25px; text-align: center; }
        .menu-item-text { flex: 1; font-size: 15px; }
        .menu-item-arrow { color: #ccc; }
        
        .menu-map-styles { padding: 10px 20px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .map-style-btn { padding: 10px 5px; border: 2px solid #eee; border-radius: 8px; text-align: center; cursor: pointer; font-size: 11px; }
        .map-style-btn.active { border-color: #00b894; background: #e8f8f5; }
        .map-style-icon { font-size: 20px; display: block; margin-bottom: 3px; }
        
        /* SET PLACE MODAL */
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 3000; display: none; justify-content: center; align-items: center; padding: 20px; }
        .modal.show { display: flex; }
        .modal-content { background: #fff; border-radius: 20px; padding: 25px; width: 100%; max-width: 350px; }
        .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 20px; text-align: center; }
        .modal-input { width: 100%; padding: 15px; border: 2px solid #eee; border-radius: 12px; font-size: 16px; margin-bottom: 10px; }
        .modal-input:focus { outline: none; border-color: #00b894; }
        .modal-or { text-align: center; color: #999; margin: 10px 0; font-size: 13px; }
        .modal-btns { display: flex; gap: 10px; margin-top: 15px; }
        .modal-btn { flex: 1; padding: 15px; border: none; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .modal-btn-primary { background: #00b894; color: #fff; }
        .modal-btn-secondary { background: #f0f0f0; color: #333; }
        
        /* POI Results */
        .poi-results {
            position: absolute; bottom: 0; left: 0; right: 0; z-index: 1000;
            background: #fff; border-radius: 20px 20px 0 0; max-height: 50vh;
            overflow-y: auto; display: none; padding-bottom: max(10px, env(safe-area-inset-bottom));
        }
        .poi-results.show { display: block; }
        .poi-header { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; position: sticky; top: 0; background: #fff; }
        .poi-title { font-weight: 600; }
        .poi-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #999; }
        .poi-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
        .poi-item:active { background: #f8f8f8; }
        .poi-item-info { flex: 1; }
        .poi-item-name { font-weight: 600; font-size: 15px; }
        .poi-item-detail { font-size: 12px; color: #888; margin-top: 2px; }
        .poi-item-dist { font-size: 14px; font-weight: 600; color: #00b894; }
        
        /* Trip Banner */
        .trip-banner {
            position: absolute; top: 70px; left: 10px; right: 10px; z-index: 999;
            background: #e74c3c; color: #fff; border-radius: 10px; padding: 10px 15px;
            display: none; align-items: center; justify-content: space-between;
        }
        .trip-banner.show { display: flex; }
        .trip-info { display: flex; align-items: center; gap: 10px; }
        .trip-dot { width: 10px; height: 10px; background: #fff; border-radius: 50%; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
        .trip-text { font-size: 13px; font-weight: 600; }
        .trip-stop-btn { background: rgba(0,0,0,0.2); border: none; padding: 8px 12px; border-radius: 8px; color: #fff; font-size: 12px; cursor: pointer; }
        
        /* Loading */
        .loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; padding: 30px; border-radius: 15px; text-align: center; z-index: 2000; display: none; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        .loading.show { display: block; }
        .spinner { width: 40px; height: 40px; border: 4px solid #eee; border-top-color: #00b894; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Markers */
        .truck-marker { font-size: 32px; filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.5)); }
        .dest-marker { font-size: 30px; filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.5)); }
        .poi-marker { font-size: 24px; filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.5)); }
    </style>
</head>
<body>
    <!-- CODE SCREEN -->
    <div id="codeScreen" class="screen active code-screen">
        <div class="logo">üöõ</div>
        <div class="title">Genesis Trucker GPS</div>
        <div class="subtitle">Full Navigation + IFTA Tracking</div>
        <input type="text" class="code-input" id="inviteCode" placeholder="Enter code">
        <button class="btn btn-primary" onclick="validateCode()">üîì Enter</button>
        <div class="error-msg" id="codeError">Invalid code</div>
    </div>
    
    <!-- SETUP SCREEN -->
    <div id="setupScreen" class="screen setup-screen">
        <div class="setup-header">
            <div style="font-size:60px;margin-bottom:15px;">üöõ</div>
            <h2>Driver Setup</h2>
        </div>
        
        <!-- Trucking Warning -->
        <div class="form-card" style="background:rgba(231,76,60,0.2);border:2px solid #e74c3c;">
            <div style="text-align:center;padding:10px;">
                <div style="font-size:30px;margin-bottom:10px;">‚ö†Ô∏è</div>
                <div style="font-weight:700;color:#e74c3c;margin-bottom:5px;">TRUCKING ROUTES ONLY</div>
                <div style="font-size:12px;color:#ccc;">This GPS is optimized for commercial trucks.<br>Routes avoid low bridges and weight-restricted roads.</div>
            </div>
        </div>
        
        <div class="form-card">
            <label class="form-label">Name</label>
            <input type="text" class="form-input" id="driverName" placeholder="Your name">
        </div>
        <div class="form-card">
            <label class="form-label">Truck #</label>
            <input type="text" class="form-input" id="truckNumber" placeholder="e.g. TX-1234">
        </div>
        <div class="form-card">
            <label class="form-label">Company</label>
            <input type="text" class="form-input" id="companyName" placeholder="Company name">
        </div>
        <div class="form-card">
            <label class="form-label">Route Mode</label>
            <select class="form-select" id="routeMode">
                <option value="truck">üöõ Truck (Commercial Routes)</option>
                <option value="car">üöó Car (Standard Routes)</option>
            </select>
        </div>
        <div class="form-card">
            <label class="form-label">Voice Language</label>
            <select class="form-select" id="voiceLang">
                <option value="en">üá∫üá∏ English</option>
                <option value="es">üá™üá∏ Spanish / Espa√±ol</option>
            </select>
        </div>
        <div style="max-width:500px;margin:0 auto;padding:0 20px;">
            <button class="btn btn-primary" onclick="completeSetup()" style="width:100%;">‚úÖ Start</button>
        </div>
    </div>
    
    <!-- MAIN MAP SCREEN -->
    <div id="mainScreen" class="screen main-screen">
        <div id="map"></div>
        
        <!-- Loading -->
        <div class="loading" id="loading"><div class="spinner"></div>Loading...</div>
        
        <!-- Trip Recording Banner -->
        <div class="trip-banner" id="tripBanner">
            <div class="trip-info">
                <div class="trip-dot"></div>
                <span class="trip-text">Recording: <span id="tripMiles">0.0</span> mi</span>
            </div>
            <button class="trip-stop-btn" onclick="stopTrip()">‚èπ Stop</button>
        </div>
        
        <!-- TOP BAR - Search -->
        <div class="top-bar" id="topBar">
            <div class="search-box" style="position:relative;">
                <button class="menu-btn" onclick="openMenu()">‚ò∞</button>
                <input type="text" class="search-input" id="searchInput" placeholder="Where to?" onclick="showRecent()" oninput="onSearchInput()" onkeypress="handleSearchKey(event)">
                <button class="clear-btn" id="clearBtn" onclick="clearSearch()">‚úï</button>
                <button class="go-btn" id="goBtn" onclick="searchAddress()">Go</button>
                
                <!-- Autocomplete Dropdown -->
                <div class="autocomplete-dropdown" id="autocompleteDropdown"></div>
            </div>
            
            <!-- Recent Dropdown -->
            <div class="recent-dropdown" id="recentDropdown">
                <!-- Quick Places -->
                <div class="quick-places">
                    <div class="quick-place not-set" id="homePlace" onclick="handlePlaceClick('home')">
                        <span class="quick-place-icon">üè†</span>
                        <div class="quick-place-text">
                            <div class="quick-place-name">Home</div>
                            <div class="quick-place-addr" id="homeAddr">Set location</div>
                        </div>
                    </div>
                    <div class="quick-place not-set" id="workPlace" onclick="handlePlaceClick('work')">
                        <span class="quick-place-icon">üöõ</span>
                        <div class="quick-place-text">
                            <div class="quick-place-name">Truck Yard</div>
                            <div class="quick-place-addr" id="workAddr">Set location</div>
                        </div>
                    </div>
                </div>
                
                <!-- Favorites -->
                <div id="favoritesSection"></div>
                
                <!-- Recent Searches -->
                <div class="recent-section-title">Recent</div>
                <div id="recentList"></div>
            </div>
        </div>
        
        <!-- NAVIGATION DISPLAY - During active nav -->
        <div class="nav-display" id="navDisplay">
            <div class="nav-instruction">
                <span class="nav-turn-icon" id="navIcon">‚Üë</span>
                <div class="nav-turn-text">
                    <div class="nav-turn-main" id="navText">Head north</div>
                    <div class="nav-turn-spanish" id="navSpanish" style="font-size:13px;color:#aaa;margin-top:3px;"></div>
                </div>
                <span class="nav-turn-dist" id="navDist">0.5 mi</span>
            </div>
            <div class="nav-stats">
                <div class="nav-stat"><div class="nav-stat-val" id="navETA">--</div><div class="nav-stat-label">ETA</div></div>
                <div class="nav-stat"><div class="nav-stat-val" id="navRemain">--</div><div class="nav-stat-label">Left</div></div>
                <div class="nav-stat"><div class="nav-stat-val" id="navSpeed">--</div><div class="nav-stat-label">MPH</div></div>
            </div>
        </div>
        
        <!-- BOTTOM BAR -->
        <div class="bottom-bar" id="bottomBar">
            <!-- Route Preview Card -->
            <div class="route-card" id="routeCard">
                <div class="route-dest" id="routeDest">Destination</div>
                
                <!-- Route Options -->
                <div class="route-options" id="routeOptions">
                    <!-- Truck Route -->
                    <div class="route-option selected" id="truckRouteOption" onclick="selectRouteOption('truck')">
                        <span class="route-option-icon">üöõ</span>
                        <div class="route-option-info">
                            <div class="route-option-label">Truck Route</div>
                            <div class="route-option-detail">Commercial vehicle safe</div>
                        </div>
                        <div class="route-option-time">
                            <div class="route-option-time-val" id="truckRouteTime">--</div>
                            <div class="route-option-dist" id="truckRouteDist">-- mi</div>
                        </div>
                    </div>
                    <!-- Car Route -->
                    <div class="route-option" id="carRouteOption" onclick="selectRouteOption('car')">
                        <span class="route-option-icon">üöó</span>
                        <div class="route-option-info">
                            <div class="route-option-label">Car Route</div>
                            <div class="route-option-detail">Fastest route</div>
                        </div>
                        <div class="route-option-time">
                            <div class="route-option-time-val" id="carRouteTime">--</div>
                            <div class="route-option-dist" id="carRouteDist">-- mi</div>
                        </div>
                    </div>
                </div>
                
                <!-- Directions Toggle -->
                <div class="directions-toggle" onclick="toggleDirectionsInCard()">
                    <span id="directionsToggleText">üìã Tap to see directions</span>
                    <span class="directions-step-indicator" id="directionsStepIndicator">Step 1 of --</span>
                    <span class="directions-arrow" id="directionsArrow">‚ñº</span>
                </div>
                
                <!-- Directions List (embedded in card) -->
                <div class="directions-list-container" id="directionsListContainer">
                    <div class="directions-list" id="directionsList"></div>
                </div>
                
                <div class="route-actions">
                    <button class="route-btn route-btn-cancel" onclick="cancelRoute()">Cancel</button>
                    <button class="route-btn route-btn-start" onclick="startNavigation()">‚ñ∂ Start</button>
                </div>
            </div>
            
            <!-- Nav End Bar - tap screen to show during navigation -->
            <div class="nav-end-bar" id="navEndBar">
                <button class="nav-voice-btn" id="voiceToggle" onclick="toggleVoice()">üîä Voice: ON</button>
                <button class="nav-end-btn" onclick="endNavigation()">End Navigation</button>
            </div>
        </div>
        
        <!-- Mini Directions Bar (during navigation) -->
        <div class="mini-directions-bar" id="miniDirectionsBar">
            <div class="mini-directions-content" onclick="expandMiniDirections()">
                <span class="mini-directions-step" id="miniStepIndicator">Step 1/10</span>
                <span class="mini-directions-text" id="miniStepText">Continue straight</span>
                <span class="mini-directions-expand">‚ñ≤</span>
            </div>
        </div>
        
        <!-- Full Directions Panel (during navigation, expandable) -->
        <div class="full-directions-panel" id="fullDirectionsPanel">
            <div class="full-directions-header">
                <span id="fullDirectionsTitle">Directions</span>
                <button class="full-directions-close" onclick="closefullDirections()">‚úï</button>
            </div>
            <div class="full-directions-tabs">
                <button class="full-dir-tab active" id="fullDirTabTruck" onclick="switchFullDirTab('truck')">üöõ Truck</button>
                <button class="full-dir-tab" id="fullDirTabCar" onclick="switchFullDirTab('car')">üöó Car</button>
            </div>
            <div class="full-directions-list" id="fullDirectionsList"></div>
        </div>
        
        <!-- POI Prompt - when selecting POI during navigation -->
        <div class="poi-prompt" id="poiPrompt">
            <div class="poi-prompt-title">Add stop or replace route?</div>
            <div class="poi-prompt-btns">
                <button class="poi-prompt-btn" style="background:#f0f0f0;" onclick="cancelPOIPrompt()">Cancel</button>
                <button class="poi-prompt-btn" style="background:#0984e3;color:#fff;" onclick="addStopThenResume()">Add Stop</button>
                <button class="poi-prompt-btn" style="background:#00b894;color:#fff;" onclick="replaceRoute()">Replace</button>
            </div>
        </div>
        
        <!-- POI Results -->
        <div class="poi-results" id="poiResults">
            <div class="poi-header">
                <span class="poi-title" id="poiTitle">Results</span>
                <button class="poi-close" onclick="closePOI()">√ó</button>
            </div>
            <div id="poiList"></div>
        </div>
        
        <!-- Menu Overlay -->
        <div class="menu-overlay" id="menuOverlay" onclick="closeMenu()"></div>
        
        <!-- Menu Panel -->
        <div class="menu-panel" id="menuPanel">
            <div class="menu-header">
                <div class="menu-name" id="menuName">Driver</div>
                <div class="menu-truck" id="menuTruck">Truck #</div>
            </div>
            
            <div class="menu-section">
                <div class="menu-section-title">üó∫ Map Style</div>
                <div class="menu-map-styles" id="mapStyles"></div>
            </div>
            
            <div class="menu-section">
                <div class="menu-section-title">üìç Saved Places</div>
                <div class="menu-item" onclick="openSetPlace('home')">
                    <span class="menu-item-icon">üè†</span>
                    <span class="menu-item-text">Set Home</span>
                    <span class="menu-item-arrow">‚Ä∫</span>
                </div>
                <div class="menu-item" onclick="openSetPlace('work')">
                    <span class="menu-item-icon">üöõ</span>
                    <span class="menu-item-text">Set Truck Yard</span>
                    <span class="menu-item-arrow">‚Ä∫</span>
                </div>
            </div>
            
            <div class="menu-section">
                <div class="menu-section-title">üçΩ Find Nearby</div>
                <div class="menu-item" onclick="searchPOI('mexican')">
                    <span class="menu-item-icon">üåÆ</span>
                    <span class="menu-item-text">Mexican Food</span>
                    <span class="menu-item-arrow">‚Ä∫</span>
                </div>
                <div class="menu-item" onclick="searchPOI('indian')">
                    <span class="menu-item-icon">üçõ</span>
                    <span class="menu-item-text">Indian Food</span>
                    <span class="menu-item-arrow">‚Ä∫</span>
                </div>
                <div class="menu-item" onclick="searchPOI('pizza')">
                    <span class="menu-item-icon">üçï</span>
                    <span class="menu-item-text">Pizza</span>
                    <span class="menu-item-arrow">‚Ä∫</span>
                </div>
                <div class="menu-item" onclick="searchPOI('sandwich')">
                    <span class="menu-item-icon">ü•™</span>
                    <span class="menu-item-text">Sandwiches / Subs</span>
                    <span class="menu-item-arrow">‚Ä∫</span>
                </div>
                <div class="menu-item" onclick="searchPOI('restaurant')">
                    <span class="menu-item-icon">üçî</span>
                    <span class="menu-item-text">All Restaurants</span>
                    <span class="menu-item-arrow">‚Ä∫</span>
                </div>
                <div class="menu-item" onclick="searchPOI('fuel')">
                    <span class="menu-item-icon">‚õΩ</span>
                    <span class="menu-item-text">Fuel / Truck Stop</span>
                    <span class="menu-item-arrow">‚Ä∫</span>
                </div>
                <div class="menu-item" onclick="searchPOI('parking')">
                    <span class="menu-item-icon">üÖøÔ∏è</span>
                    <span class="menu-item-text">Parking</span>
                    <span class="menu-item-arrow">‚Ä∫</span>
                </div>
                <div class="menu-item" onclick="searchPOI('repair')">
                    <span class="menu-item-icon">üîß</span>
                    <span class="menu-item-text">Repair Shop</span>
                    <span class="menu-item-arrow">‚Ä∫</span>
                </div>
            </div>
            
            <div class="menu-section">
                <div class="menu-section-title">üìä Tracking</div>
                <div class="menu-item" onclick="toggleTrip()">
                    <span class="menu-item-icon" id="tripIcon">‚ñ∂Ô∏è</span>
                    <span class="menu-item-text" id="tripText">Start Trip Recording</span>
                    <span class="menu-item-arrow">‚Ä∫</span>
                </div>
                <div class="menu-item" onclick="openTrips()">
                    <span class="menu-item-icon">üìã</span>
                    <span class="menu-item-text">Trip History</span>
                    <span class="menu-item-arrow">‚Ä∫</span>
                </div>
                <div class="menu-item" onclick="openIFTA()">
                    <span class="menu-item-icon">üìä</span>
                    <span class="menu-item-text">IFTA Report</span>
                    <span class="menu-item-arrow">‚Ä∫</span>
                </div>
            </div>
            
            <div class="menu-section">
                <div class="menu-section-title">üìÑ Documents</div>
                <div class="menu-item" onclick="scanLoadPaper()">
                    <span class="menu-item-icon">üì∏</span>
                    <span class="menu-item-text">Scan Load Paper</span>
                    <span class="menu-item-arrow">‚Ä∫</span>
                </div>
                <div class="menu-item" onclick="viewScannedDocs()">
                    <span class="menu-item-icon">üìÅ</span>
                    <span class="menu-item-text">My Documents</span>
                    <span class="menu-item-arrow">‚Ä∫</span>
                </div>
            </div>
            
            <div class="menu-section">
                <div class="menu-section-title">üìû Dispatch Contacts</div>
                <div class="menu-item" onclick="openDispatchContacts()">
                    <span class="menu-item-icon">üë•</span>
                    <span class="menu-item-text">Manage Contacts</span>
                    <span class="menu-item-arrow">‚Ä∫</span>
                </div>
            </div>
            
            <div class="menu-section">
                <div class="menu-item" onclick="logout()">
                    <span class="menu-item-icon">üö™</span>
                    <span class="menu-item-text" style="color:#e74c3c;">Logout</span>
                </div>
            </div>
        </div>
        
        <!-- Dispatch Contacts Modal -->
        <div class="modal" id="dispatchContactsModal">
            <div class="modal-content" style="max-height:85vh;">
                <div class="modal-title">üìû Dispatch Contacts</div>
                <div style="max-height:400px;overflow-y:auto;">
                    <div style="margin-bottom:15px;">
                        <div style="font-size:12px;color:#888;margin-bottom:8px;">PHONE CONTACTS (up to 4)</div>
                        <div id="dispatchPhoneList"></div>
                        <button onclick="addDispatchPhone()" style="width:100%;padding:12px;background:rgba(0,184,148,0.2);border:2px dashed #00b894;border-radius:10px;color:#00b894;font-size:14px;cursor:pointer;margin-top:8px;">+ Add Phone Contact</button>
                    </div>
                    <div style="margin-bottom:15px;">
                        <div style="font-size:12px;color:#888;margin-bottom:8px;">EMAIL ADDRESSES (up to 4)</div>
                        <div id="dispatchEmailList"></div>
                        <button onclick="addDispatchEmail()" style="width:100%;padding:12px;background:rgba(233,69,96,0.2);border:2px dashed #e94560;border-radius:10px;color:#e94560;font-size:14px;cursor:pointer;margin-top:8px;">+ Add Email</button>
                    </div>
                </div>
                <div class="modal-btns">
                    <button class="modal-btn modal-btn-secondary" onclick="closeModal('dispatchContactsModal')">Done</button>
                </div>
            </div>
        </div>
        
        <!-- Add Phone Contact Modal -->
        <div class="modal" id="addPhoneModal">
            <div class="modal-content">
                <div class="modal-title">üì± Add Phone Contact</div>
                <input type="text" class="modal-input" id="newPhoneName" placeholder="Name (e.g., Dispatch - John)">
                <input type="tel" class="modal-input" id="newPhoneNumber" placeholder="Phone number">
                <div class="modal-btns">
                    <button class="modal-btn modal-btn-secondary" onclick="closeModal('addPhoneModal')">Cancel</button>
                    <button class="modal-btn modal-btn-primary" onclick="saveDispatchPhone()">Save</button>
                </div>
            </div>
        </div>
        
        <!-- Add Email Modal -->
        <div class="modal" id="addEmailModal">
            <div class="modal-content">
                <div class="modal-title">üìß Add Email</div>
                <input type="text" class="modal-input" id="newEmailName" placeholder="Name (e.g., Dispatch Office)">
                <input type="email" class="modal-input" id="newEmailAddress" placeholder="Email address">
                <div class="modal-btns">
                    <button class="modal-btn modal-btn-secondary" onclick="closeModal('addEmailModal')">Cancel</button>
                    <button class="modal-btn modal-btn-primary" onclick="saveDispatchEmail()">Save</button>
                </div>
            </div>
        </div>
        
        <!-- Select Contact Modal (for sending) -->
        <div class="modal" id="selectContactModal">
            <div class="modal-content">
                <div class="modal-title" id="selectContactTitle">Select Recipient</div>
                <div id="selectContactList" style="max-height:300px;overflow-y:auto;"></div>
                <div class="modal-btns">
                    <button class="modal-btn modal-btn-secondary" onclick="closeModal('selectContactModal')">Cancel</button>
                </div>
            </div>
        </div>
        <div class="modal" id="docScanModal">
            <div class="modal-content" style="max-height:90vh;">
                <div class="modal-title">üì∏ Load Paper Scanner</div>
                <div id="docPreviewArea" style="margin-bottom:10px;border-radius:10px;overflow:hidden;background:#111;min-height:150px;display:flex;align-items:center;justify-content:center;">
                    <span style="color:#666;">No image</span>
                </div>
                <div style="display:flex;gap:10px;margin-bottom:15px;">
                    <button onclick="rotateDocument()" style="flex:1;padding:12px;border:none;border-radius:10px;background:#f0f0f0;font-size:14px;cursor:pointer;">üîÑ Rotate</button>
                    <button onclick="document.getElementById('docScanInput').click()" style="flex:1;padding:12px;border:none;border-radius:10px;background:#f0f0f0;font-size:14px;cursor:pointer;">üì∑ Retake</button>
                </div>
                <input type="text" class="modal-input" id="docTitle" placeholder="Document title (e.g., Load #12345)">
                <div class="modal-btns" style="flex-wrap:wrap;gap:8px;">
                    <button class="modal-btn modal-btn-secondary" onclick="closeDocScan()" style="flex:1 1 45%;">Cancel</button>
                    <button class="modal-btn" style="flex:1 1 45%;background:#0984e3;color:#fff;" onclick="saveDocAsPDF()">üíæ Save</button>
                    <button class="modal-btn" style="flex:1 1 45%;background:#00b894;color:#fff;" onclick="shareDocText()">üì± Text</button>
                    <button class="modal-btn" style="flex:1 1 45%;background:#e94560;color:#fff;" onclick="shareDocEmail()">üìß Email</button>
                </div>
            </div>
        </div>
        
        <!-- Documents List Modal -->
        <div class="modal" id="docsListModal">
            <div class="modal-content" style="max-height:80vh;">
                <div class="modal-title">üìÅ My Documents</div>
                <div id="docsList" style="max-height:400px;overflow-y:auto;"></div>
                <div class="modal-btns">
                    <button class="modal-btn modal-btn-secondary" onclick="closeModal('docsListModal')">Close</button>
                </div>
            </div>
        </div>
        
        <!-- Hidden file input for document scanner -->
        <input type="file" id="docScanInput" accept="image/*" capture="environment" style="display:none;" onchange="handleDocScan(event)">
        
        <!-- Set Place Modal -->
        <div class="modal" id="setPlaceModal">
            <div class="modal-content">
                <div class="modal-title" id="setPlaceTitle">Set Home</div>
                <input type="text" class="modal-input" id="setPlaceInput" placeholder="Enter address...">
                <div class="modal-or">‚Äî or ‚Äî</div>
                <button class="btn btn-primary" style="width:100%;padding:15px;" onclick="setPlaceCurrentLocation()">üìç Use Current Location</button>
                <div class="modal-btns">
                    <button class="modal-btn modal-btn-secondary" onclick="closeSetPlace()">Cancel</button>
                    <button class="modal-btn modal-btn-primary" onclick="savePlaceFromInput()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
    // === CONFIG ===
    const API_KEY = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImRlMDNiNzNlNDg4ZjQ2N2NiYmEyOThhZWNiMzdmOWI1IiwiaCI6Im11cm11cjY0In0=';
    const STORE = { profile: 'gps_profile', recent: 'gps_recent', favorites: 'gps_favorites', places: 'gps_places', trips: 'gps_trips', mapStyle: 'gps_mapStyle' };
    
    const MAP_STYLES = {
        standard: { name: 'Standard', icon: 'üó∫', url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png' },
        streets: { name: 'Streets+', icon: 'üõ£', url: 'https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png' },
        light: { name: 'Light', icon: '‚òÄÔ∏è', url: 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png' },
        topo: { name: 'Terrain', icon: '‚õ∞', url: 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png' },
        satellite: { name: 'Satellite', icon: 'üõ∞', url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}' },
        hybrid: { name: 'Hybrid', icon: 'üåç', url: 'https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}' },
        dark: { name: 'Dark', icon: 'üåô', url: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png' }
    };
    
    // Spanish translations for navigation
    const SPANISH = { 
        'Turn left':'Gira a la izquierda', 
        'Turn right':'Gira a la derecha', 
        'Continue':'Contin√∫a', 
        'Head':'Dir√≠gete hacia', 
        'Arrive':'Has llegado', 
        'straight':'recto',
        'north':'norte',
        'south':'sur',
        'east':'este',
        'west':'oeste',
        'onto':'hacia',
        'on':'en',
        'in':'en',
        'miles':'millas',
        'feet':'pies',
        'destination':'destino',
        'left':'izquierda',
        'right':'derecha'
    };
    
    // === STATE ===
    let profile = null, map = null, tileLayer = null;
    let userMarker = null, destMarker = null, routeLine = null, poiMarkers = [];
    let userLat = null, userLon = null, userSpeed = 0, watchId = null;
    let isNavigating = false, navHidden = true, routeSteps = [], stepIndex = 0;
    let destCoords = null, destName = '', savedRoute = null, pendingPOI = null;
    let voiceOn = true, voiceLang = 'en', mapStyle = 'light', routeMode = 'truck';
    let isTripActive = false, currentTrip = null, tripLine = null;
    let setPlaceType = null;
    
    // === INIT ===
    document.addEventListener('DOMContentLoaded', () => {
        const p = localStorage.getItem(STORE.profile);
        const c = localStorage.getItem('gps_code');
        if (c && p) { profile = JSON.parse(p); showMain(); }
        else if (c) showScreen('setupScreen');
        
        // Load voices
        if ('speechSynthesis' in window) { speechSynthesis.getVoices(); speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices(); }
    });
    
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }
    
    function validateCode() {
        let code = document.getElementById('inviteCode').value.trim().toUpperCase();
        if (!code.startsWith('TRUCK-')) code = 'TRUCK-' + code;
        if (code.length >= 8) { localStorage.setItem('gps_code', code); showScreen('setupScreen'); }
        else document.getElementById('codeError').classList.add('show');
    }
    
    function completeSetup() {
        const name = document.getElementById('driverName').value.trim();
        if (!name) { alert('Enter your name'); return; }
        profile = {
            name, 
            truck: document.getElementById('truckNumber').value.trim() || '-',
            company: document.getElementById('companyName').value.trim() || '-',
            voiceLang: document.getElementById('voiceLang').value,
            routeMode: document.getElementById('routeMode').value
        };
        localStorage.setItem(STORE.profile, JSON.stringify(profile));
        showMain();
    }
    
    function showMain() {
        showScreen('mainScreen');
        voiceLang = profile.voiceLang || 'en';
        mapStyle = localStorage.getItem(STORE.mapStyle) || 'light';
        
        document.getElementById('menuName').textContent = profile.name;
        document.getElementById('menuTruck').textContent = profile.truck;
        
        initMap();
        startGPS();
        renderMapStyles();
        updatePlaceButtons();
        
        document.getElementById('searchInput').addEventListener('keypress', e => { if (e.key === 'Enter') doSearch(); });
        
        // Tap map to toggle nav controls
        document.getElementById('map').addEventListener('click', () => {
            if (isNavigating) {
                navHidden = !navHidden;
                document.getElementById('navEndBar').classList.toggle('show', !navHidden);
            }
        });
    }
    
    function initMap() {
        map = L.map('map', { 
            zoomControl: true,
            minZoom: 3,
            maxZoom: 19
        }).setView([32.78, -96.80], 13);
        
        // Add zoom control to bottom right
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        
        setMapStyle(mapStyle);
        userMarker = L.marker([32.78, -96.80], { icon: L.divIcon({ html: '<div class="truck-marker">üöõ</div>', className: '', iconSize: [32,32], iconAnchor: [16,16] }) }).addTo(map);
    }
    
    function setMapStyle(style) {
        mapStyle = style;
        localStorage.setItem(STORE.mapStyle, style);
        if (tileLayer) map.removeLayer(tileLayer);
        tileLayer = L.tileLayer(MAP_STYLES[style]?.url || MAP_STYLES.standard.url, { 
            maxZoom: 19,
            attribution: ''
        }).addTo(map);
        renderMapStyles();
    }
    
    function renderMapStyles() {
        document.getElementById('mapStyles').innerHTML = Object.entries(MAP_STYLES).map(([k,v]) => 
            `<div class="map-style-btn ${mapStyle===k?'active':''}" onclick="setMapStyle('${k}')"><span class="map-style-icon">${v.icon}</span>${v.name}</div>`
        ).join('');
    }
    
    // Track if user is manually panning/zooming
    let userInteracting = false;
    let interactionTimeout = null;
    
    function startGPS() {
        if (!navigator.geolocation) return;
        
        // Detect user interaction with map
        map.on('dragstart zoomstart', () => {
            userInteracting = true;
            clearTimeout(interactionTimeout);
        });
        map.on('dragend zoomend', () => {
            // Allow manual control for 10 seconds after interaction
            clearTimeout(interactionTimeout);
            interactionTimeout = setTimeout(() => { userInteracting = false; }, 10000);
        });
        
        watchId = navigator.geolocation.watchPosition(pos => {
            const prev = { lat: userLat, lon: userLon };
            userLat = pos.coords.latitude;
            userLon = pos.coords.longitude;
            userSpeed = pos.coords.speed || 0;
            
            if (userMarker) userMarker.setLatLng([userLat, userLon]);
            
            // Only auto-center if not interacting AND navigating AND no route card showing
            if (isNavigating && !userInteracting) {
                document.getElementById('navSpeed').textContent = Math.round(userSpeed * 2.237);
                map.setView([userLat, userLon], map.getZoom()); // Keep current zoom level
            } else if (!routeLine && !truckRouteLine && !carRouteLine && !userInteracting) {
                // Only center when no route displayed and not interacting
                map.setView([userLat, userLon], 14);
            }
            
            // Trip recording
            if (isTripActive && currentTrip && prev.lat) {
                const d = getDist(prev.lat, prev.lon, userLat, userLon);
                currentTrip.miles += d;
                document.getElementById('tripMiles').textContent = currentTrip.miles.toFixed(1);
                if (tripLine) tripLine.addLatLng([userLat, userLon]);
            }
        }, () => {}, { enableHighAccuracy: true, maximumAge: 2000 });
    }
    
    // === SEARCH ===
    let autocompleteTimeout = null;
    
    function onSearchInput() {
        const v = document.getElementById('searchInput').value;
        document.getElementById('clearBtn').classList.toggle('show', v.length > 0 && v.length < 3);
        document.getElementById('goBtn').classList.toggle('show', v.length >= 3);
        
        if (v.length === 0) {
            hideRecent();
            hideAutocomplete();
        } else if (v.length >= 3) {
            // Debounce autocomplete
            clearTimeout(autocompleteTimeout);
            autocompleteTimeout = setTimeout(() => fetchAutocomplete(v), 300);
        }
    }
    
    function handleSearchKey(event) {
        if (event.key === 'Enter') {
            searchAddress();
        }
    }
    
    async function fetchAutocomplete(query) {
        try {
            const res = await fetch(`https://api.openrouteservice.org/geocode/autocomplete?api_key=${API_KEY}&text=${encodeURIComponent(query)}&size=5`);
            const data = await res.json();
            
            if (!data.features?.length) {
                hideAutocomplete();
                return;
            }
            
            const dropdown = document.getElementById('autocompleteDropdown');
            dropdown.innerHTML = data.features.map(f => {
                const name = f.properties.name || f.properties.label;
                const region = f.properties.region || f.properties.country || '';
                return `
                    <div class="autocomplete-item" onclick="selectAutocomplete(${f.geometry.coordinates[1]}, ${f.geometry.coordinates[0]}, '${(f.properties.label || '').replace(/'/g, "\\'")}')">
                        <span class="autocomplete-icon">üìç</span>
                        <div class="autocomplete-text">
                            <div class="autocomplete-main">${name}</div>
                            <div class="autocomplete-sub">${f.properties.label || region}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            dropdown.classList.add('show');
            hideRecent();
        } catch(e) {
            console.error('Autocomplete error:', e);
        }
    }
    
    function selectAutocomplete(lat, lon, label) {
        document.getElementById('searchInput').value = label;
        hideAutocomplete();
        hideRecent();
        
        destCoords = { lat, lon };
        destName = label;
        
        saveRecent(destName, lat, lon);
        calcRoute();
    }
    
    function hideAutocomplete() {
        document.getElementById('autocompleteDropdown').classList.remove('show');
    }
    
    function showRecent() {
        renderRecent();
        updatePlaceButtons();
        hideAutocomplete();
        document.getElementById('recentDropdown').classList.add('show');
    }
    
    function hideRecent() {
        document.getElementById('recentDropdown').classList.remove('show');
    }
    
    function clearSearch() {
        document.getElementById('searchInput').value = '';
        document.getElementById('clearBtn').classList.remove('show');
        document.getElementById('goBtn').classList.remove('show');
        hideRecent();
        hideAutocomplete();
    }
    
    function clearAll() {
        clearSearch();
        cancelRoute();
    }
    
    async function searchAddress() {
        const q = document.getElementById('searchInput').value.trim();
        if (!q) return;
        hideRecent();
        hideAutocomplete();
        showLoading(true);
        
        try {
            const res = await fetch(`https://api.openrouteservice.org/geocode/search?api_key=${API_KEY}&text=${encodeURIComponent(q)}&size=1`);
            const data = await res.json();
            if (!data.features?.length) { alert('Address not found. Try adding city and state.'); showLoading(false); return; }
            
            const c = data.features[0].geometry.coordinates;
            destCoords = { lat: c[1], lon: c[0] };
            destName = data.features[0].properties.label || q;
            
            document.getElementById('searchInput').value = destName;
            
            saveRecent(destName, c[1], c[0]);
            await calcRoute();
        } catch(e) { console.error(e); alert('Search failed'); }
        showLoading(false);
    }
    
    async function doSearch() {
        await searchAddress();
    }
    
    // === ROUTING ===
    // Store both route data
    let truckRouteData = null;
    let carRouteData = null;
    let selectedRouteType = 'truck';
    let truckRouteLine = null;
    let carRouteLine = null;
    
    async function calcRoute() {
        if (!userLat || !destCoords) return;
        showLoading(true);
        
        try {
            // Fetch both truck and car routes in parallel
            const [truckRes, carRes] = await Promise.all([
                fetch(`https://api.openrouteservice.org/v2/directions/driving-hgv?api_key=${API_KEY}&start=${userLon},${userLat}&end=${destCoords.lon},${destCoords.lat}`),
                fetch(`https://api.openrouteservice.org/v2/directions/driving-car?api_key=${API_KEY}&start=${userLon},${userLat}&end=${destCoords.lon},${destCoords.lat}`)
            ]);
            
            const truckData = await truckRes.json();
            const carData = await carRes.json();
            
            if (!truckData.features?.length && !carData.features?.length) { 
                alert('No route found'); 
                showLoading(false); 
                return; 
            }
            
            clearRouteDisplay();
            
            // Store route data
            truckRouteData = truckData.features?.[0] || null;
            carRouteData = carData.features?.[0] || null;
            
            // Draw both routes (car first so truck is on top)
            if (carRouteData) {
                const carCoords = carRouteData.geometry.coordinates.map(c => [c[1], c[0]]);
                carRouteLine = L.polyline(carCoords, { color: '#888', weight: 5, opacity: 0.5, dashArray: '10, 10' }).addTo(map);
                
                const carDist = carRouteData.properties.summary.distance;
                const carTime = carRouteData.properties.summary.duration;
                document.getElementById('carRouteTime').textContent = formatDuration(carTime);
                document.getElementById('carRouteDist').textContent = (carDist/1609.34).toFixed(1) + ' mi';
                
                // Store car route steps
                carRouteSteps = carRouteData.properties.segments[0].steps;
            }
            
            if (truckRouteData) {
                const truckCoords = truckRouteData.geometry.coordinates.map(c => [c[1], c[0]]);
                truckRouteLine = L.polyline(truckCoords, { color: '#0984e3', weight: 6 }).addTo(map);
                
                const truckDist = truckRouteData.properties.summary.distance;
                const truckTime = truckRouteData.properties.summary.duration;
                document.getElementById('truckRouteTime').textContent = formatDuration(truckTime);
                document.getElementById('truckRouteDist').textContent = (truckDist/1609.34).toFixed(1) + ' mi';
                
                // Store truck route steps
                truckRouteSteps = truckRouteData.properties.segments[0].steps;
                routeSteps = truckRouteSteps; // Default to truck
            }
            
            // Add destination marker
            destMarker = L.marker([destCoords.lat, destCoords.lon], { 
                icon: L.divIcon({ html: '<div class="dest-marker">üìç</div>', className: '', iconSize: [30,30], iconAnchor: [15,30] }) 
            }).addTo(map);
            
            // Fit to show the selected route
            const activeLine = selectedRouteType === 'truck' ? truckRouteLine : carRouteLine;
            if (activeLine) map.fitBounds(activeLine.getBounds(), { padding: [50, 100] });
            
            document.getElementById('routeDest').textContent = destName;
            selectRouteOption(selectedRouteType);
            
            document.getElementById('routeCard').classList.add('show');
            document.getElementById('topBar').style.display = 'block';
            
            // Build directions list
            buildDirectionsList();
            
        } catch(e) { console.error(e); alert('Route failed: ' + e.message); }
        showLoading(false);
    }
    
    function formatDuration(seconds) {
        const hours = Math.floor(seconds / 3600);
        const mins = Math.round((seconds % 3600) / 60);
        if (hours > 0) {
            return `${hours}h ${mins}m`;
        }
        return `${mins} min`;
    }
    
    function selectRouteOption(type) {
        selectedRouteType = type;
        
        // Update UI
        document.getElementById('truckRouteOption').classList.toggle('selected', type === 'truck');
        document.getElementById('carRouteOption').classList.toggle('selected', type === 'car');
        
        // Update line styles
        if (truckRouteLine) {
            truckRouteLine.setStyle({ 
                color: type === 'truck' ? '#0984e3' : '#888', 
                weight: type === 'truck' ? 6 : 5,
                opacity: type === 'truck' ? 1 : 0.5,
                dashArray: type === 'truck' ? null : '10, 10'
            });
        }
        if (carRouteLine) {
            carRouteLine.setStyle({ 
                color: type === 'car' ? '#e94560' : '#888', 
                weight: type === 'car' ? 6 : 5,
                opacity: type === 'car' ? 1 : 0.5,
                dashArray: type === 'car' ? null : '10, 10'
            });
        }
        
        // Update route steps for selected route
        routeSteps = type === 'truck' ? truckRouteSteps : carRouteSteps;
        buildDirectionsList();
        
        // Bring selected line to front
        if (type === 'truck' && truckRouteLine) truckRouteLine.bringToFront();
        if (type === 'car' && carRouteLine) carRouteLine.bringToFront();
    }
    
    // Store directions for both routes
    let truckRouteSteps = [];
    let carRouteSteps = [];
    
    function buildDirectionsList() {
        const list = document.getElementById('directionsList');
        if (!routeSteps.length) {
            list.innerHTML = '<div style="padding:15px;text-align:center;color:#888;font-size:13px;">No directions available</div>';
            document.getElementById('directionsStepIndicator').textContent = '';
            return;
        }
        
        list.innerHTML = routeSteps.map((step, i) => `
            <div class="direction-item" id="dirStep${i}">
                <span class="direction-icon">${getIcon(step.instruction)}</span>
                <span class="direction-text">${step.instruction}</span>
                <span class="direction-dist">${fmtDist(step.distance)}</span>
            </div>
        `).join('');
        
        document.getElementById('directionsStepIndicator').textContent = `Step 1 of ${routeSteps.length}`;
    }
    
    function toggleDirectionsInCard() {
        const container = document.getElementById('directionsListContainer');
        const arrow = document.getElementById('directionsArrow');
        const isExpanded = container.classList.toggle('expanded');
        arrow.classList.toggle('expanded', isExpanded);
        document.getElementById('directionsToggleText').textContent = isExpanded ? 'üìã Directions' : 'üìã Tap to see directions';
    }
    
    function expandMiniDirections() {
        document.getElementById('fullDirectionsPanel').classList.add('show');
        document.getElementById('miniDirectionsBar').classList.remove('show');
        buildFullDirectionsList();
    }
    
    function closefullDirections() {
        document.getElementById('fullDirectionsPanel').classList.remove('show');
        document.getElementById('miniDirectionsBar').classList.add('show');
    }
    
    function switchFullDirTab(type) {
        document.getElementById('fullDirTabTruck').classList.toggle('active', type === 'truck');
        document.getElementById('fullDirTabCar').classList.toggle('active', type === 'car');
        
        const steps = type === 'truck' ? truckRouteSteps : carRouteSteps;
        const list = document.getElementById('fullDirectionsList');
        
        if (!steps.length) {
            list.innerHTML = '<div style="padding:20px;text-align:center;color:#888;">No directions for this route</div>';
            return;
        }
        
        list.innerHTML = steps.map((step, i) => `
            <div class="direction-item ${i === stepIndex ? 'current' : ''} ${i < stepIndex ? 'completed' : ''}">
                <span class="direction-icon">${getIcon(step.instruction)}</span>
                <span class="direction-text">${step.instruction}</span>
                <span class="direction-dist">${fmtDist(step.distance)}</span>
            </div>
        `).join('');
    }
    
    function buildFullDirectionsList() {
        switchFullDirTab(selectedRouteType);
    }
    
    function updateMiniDirections() {
        if (!routeSteps.length || stepIndex >= routeSteps.length) return;
        
        const step = routeSteps[stepIndex];
        document.getElementById('miniStepIndicator').textContent = `${stepIndex + 1}/${routeSteps.length}`;
        document.getElementById('miniStepText').textContent = step.instruction;
    }
    
    function cancelRoute() {
        clearRouteDisplay();
        document.getElementById('routeCard').classList.remove('show');
        document.getElementById('directionsListContainer').classList.remove('expanded');
        document.getElementById('directionsArrow').classList.remove('expanded');
        document.getElementById('miniDirectionsBar').classList.remove('show');
        document.getElementById('fullDirectionsPanel').classList.remove('show');
        destCoords = null;
        destName = '';
        truckRouteData = null;
        carRouteData = null;
        truckRouteSteps = [];
        carRouteSteps = [];
        if (userLat && !userInteracting) map.setView([userLat, userLon], 14);
    }
    
    function clearRouteDisplay() {
        if (routeLine) { map.removeLayer(routeLine); routeLine = null; }
        if (truckRouteLine) { map.removeLayer(truckRouteLine); truckRouteLine = null; }
        if (carRouteLine) { map.removeLayer(carRouteLine); carRouteLine = null; }
        if (destMarker) { map.removeLayer(destMarker); destMarker = null; }
        clearPOIMarkers();
    }
    
    function startNavigation() {
        if (!routeSteps.length) return;
        isNavigating = true;
        stepIndex = 0;
        navHidden = true;
        
        document.getElementById('routeCard').classList.remove('show');
        document.getElementById('directionsListContainer').classList.remove('expanded');
        document.getElementById('topBar').style.display = 'none';
        document.getElementById('navDisplay').classList.add('show');
        document.getElementById('navEndBar').classList.remove('show');
        document.getElementById('miniDirectionsBar').classList.add('show');
        
        updateNavDisplay();
        updateMiniDirections();
        if (voiceOn && voiceLang !== 'off') setTimeout(() => speakStep(routeSteps[0]), 500);
        map.setView([userLat, userLon], 16);
    }
    
    function updateNavDisplay() {
        if (stepIndex >= routeSteps.length) {
            document.getElementById('navIcon').textContent = 'üèÅ';
            document.getElementById('navText').textContent = 'You have arrived!';
            document.getElementById('navSpanish').textContent = voiceLang === 'es' ? '¬°Has llegado!' : '';
            document.getElementById('navDist').textContent = '';
            document.getElementById('miniStepIndicator').textContent = 'Done!';
            document.getElementById('miniStepText').textContent = 'You have arrived!';
            if (voiceOn) speak('You have arrived.');
            return;
        }
        
        const s = routeSteps[stepIndex];
        document.getElementById('navIcon').textContent = getIcon(s.instruction);
        document.getElementById('navText').textContent = s.instruction;
        document.getElementById('navSpanish').textContent = voiceLang === 'es' ? toSpanish(s.instruction) : '';
        document.getElementById('navDist').textContent = fmtDist(s.distance);
        
        let rem = 0, time = 0;
        for (let i = stepIndex; i < routeSteps.length; i++) { rem += routeSteps[i].distance; time += routeSteps[i].duration; }
        document.getElementById('navRemain').textContent = fmtDist(rem);
        document.getElementById('navETA').textContent = new Date(Date.now() + time*1000).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
        
        // Update directions panel step indicator
        document.getElementById('directionsStepIndicator').textContent = `Step ${stepIndex + 1} of ${routeSteps.length}`;
        document.getElementById('directionsStepText').textContent = s.instruction.substring(0, 30) + (s.instruction.length > 30 ? '...' : '');
        
        // Highlight current step in directions list
        document.querySelectorAll('.direction-item').forEach((el, i) => {
            el.classList.remove('current', 'completed');
            if (i === stepIndex) el.classList.add('current');
            if (i < stepIndex) el.classList.add('completed');
        });
    }
    
    function endNavigation() {
        isNavigating = false;
        document.getElementById('navDisplay').classList.remove('show');
        document.getElementById('navEndBar').classList.remove('show');
        document.getElementById('topBar').style.display = 'block';
        document.getElementById('miniDirectionsBar').classList.remove('show');
        document.getElementById('fullDirectionsPanel').classList.remove('show');
        
        clearRouteDisplay();
        document.getElementById('searchInput').value = '';
        document.getElementById('clearBtn').classList.remove('show');
        document.getElementById('goBtn').classList.remove('show');
        
        // If we have a saved route to resume
        if (savedRoute) {
            destCoords = savedRoute.coords;
            destName = savedRoute.name;
            savedRoute = null;
            calcRoute();
        } else if (userLat && !userInteracting) {
            map.setView([userLat, userLon], 14);
        }
    }
    
    function toggleVoice() {
        voiceOn = !voiceOn;
        document.getElementById('voiceToggle').textContent = voiceOn ? 'üîä Voice: ON' : 'üîá Voice: OFF';
    }
    
    // === VOICE ===
    function speakStep(step) {
        const d = step.distance >= 1609 ? (step.distance/1609.34).toFixed(1) + ' miles' : Math.round(step.distance*3.28) + ' feet';
        speak(`In ${d}, ${step.instruction}`);
        if (voiceLang === 'es' || voiceLang === 'both') {
            setTimeout(() => speak(toSpanish(step.instruction), 'es'), 2500);
        }
    }
    
    function speak(text, lang = 'en') {
        if (!('speechSynthesis' in window) || !voiceOn) return;
        speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        const voices = speechSynthesis.getVoices();
        if (lang === 'es') {
            const v = voices.find(v => v.lang.startsWith('hi')) || voices.find(v => v.lang.startsWith('es'));
            if (v) { u.voice = v; u.lang = v.lang; } else u.lang = 'hi-IN';
        } else {
            u.lang = 'en-US';
        }
        u.rate = 0.9;
        speechSynthesis.speak(u);
    }
    
    // === POI SEARCH ===
    async function searchPOI(type) {
        if (!userLat) { alert('Getting GPS...'); return; }
        closeMenu();
        showLoading(true);
        clearPOIMarkers();
        
        const cfg = {
            mexican: { q: 'cuisine~"mexican|tex-mex|taco"', nameQ: 'name~"taco|burrito|mexican|taqueria"', icon: 'üåÆ', title: 'Mexican Food' },
            indian: { q: 'cuisine~"indian|pakistani"', nameQ: 'name~"india|curry|tandoor"', icon: 'üçõ', title: 'Indian Food' },
            pizza: { q: 'cuisine~"pizza|italian"', nameQ: 'name~"pizza|domino|papa"', icon: 'üçï', title: 'Pizza' },
            sandwich: { q: 'cuisine~"sandwich|sub|deli"', nameQ: 'name~"subway|jersey|firehouse|jimmy"', icon: 'ü•™', title: 'Sandwiches' },
            restaurant: { q: 'amenity=restaurant', icon: 'üçî', title: 'Restaurants' },
            fuel: { q: 'amenity=fuel', icon: '‚õΩ', title: 'Fuel Stations' },
            parking: { q: 'amenity=parking', icon: 'üÖøÔ∏è', title: 'Parking' },
            repair: { q: 'shop=car_repair', icon: 'üîß', title: 'Repair Shops' }
        }[type] || { q: 'amenity=restaurant', icon: 'üçî', title: 'Food' };
        
        const bbox = `${userLat-0.2},${userLon-0.2},${userLat+0.2},${userLon+0.2}`;
        let query;
        if (type === 'indian' || type === 'mexican' || type === 'pizza' || type === 'sandwich') {
            const cuisineMatch = cfg.q.split('~')[1].replace(/"/g, '');
            const nameMatch = cfg.nameQ ? cfg.nameQ.split('~')[1].replace(/"/g, '') : '';
            query = `[out:json][timeout:25];(node["amenity"="restaurant"]["cuisine"~"${cuisineMatch}",i](${bbox});node["amenity"="fast_food"]["cuisine"~"${cuisineMatch}",i](${bbox});${nameMatch ? `node["amenity"~"restaurant|fast_food"]["name"~"${nameMatch}",i](${bbox});` : ''});out 30;`;
        } else {
            const [k, v] = cfg.q.split('=');
            query = `[out:json][timeout:25];node["${k}"="${v}"](${bbox});out 40;`;
        }
        
        try {
            const res = await fetch('https://overpass-api.de/api/interpreter', { method: 'POST', body: query });
            const data = await res.json();
            
            if (!data.elements?.length) { alert('None found nearby'); showLoading(false); return; }
            
            const pois = data.elements
                .filter(e => e.lat && e.lon && e.tags?.name)
                .map(e => ({
                    name: e.tags.name,
                    lat: e.lat, lon: e.lon,
                    cuisine: e.tags.cuisine || '',
                    brand: e.tags.brand || '',
                    dist: getDist(userLat, userLon, e.lat, e.lon)
                }))
                .sort((a,b) => a.dist - b.dist)
                .slice(0, 20);
            
            pois.forEach(p => {
                const m = L.marker([p.lat, p.lon], { icon: L.divIcon({ html: `<div class="poi-marker">${cfg.icon}</div>`, className: '', iconSize: [24,24], iconAnchor: [12,12] }) }).addTo(map);
                m.on('click', () => selectPOI(p));
                poiMarkers.push(m);
            });
            
            if (poiMarkers.length) map.fitBounds(L.featureGroup(poiMarkers).getBounds().pad(0.2));
            
            document.getElementById('poiTitle').textContent = `${cfg.icon} ${cfg.title} (${pois.length})`;
            document.getElementById('poiList').innerHTML = pois.map((p,i) => `
                <div class="poi-item" onclick="selectPOIByIndex(${i})">
                    <div class="poi-item-info">
                        <div class="poi-item-name">${p.name}</div>
                        <div class="poi-item-detail">${p.cuisine || p.brand || ''}</div>
                    </div>
                    <div class="poi-item-dist">${p.dist.toFixed(1)} mi</div>
                </div>
            `).join('');
            
            window._pois = pois;
            document.getElementById('poiResults').classList.add('show');
        } catch(e) { console.error(e); alert('Search failed'); }
        showLoading(false);
    }
    
    function selectPOIByIndex(i) { selectPOI(window._pois[i]); }
    
    function selectPOI(poi) {
        closePOI();
        
        // If currently navigating, ask what to do
        if (isNavigating) {
            pendingPOI = poi;
            document.getElementById('poiPrompt').classList.add('show');
        } else {
            destCoords = { lat: poi.lat, lon: poi.lon };
            destName = poi.name;
            document.getElementById('searchInput').value = poi.name;
            document.getElementById('clearBtn').classList.add('show');
            calcRoute();
        }
    }
    
    function cancelPOIPrompt() {
        pendingPOI = null;
        document.getElementById('poiPrompt').classList.remove('show');
    }
    
    function addStopThenResume() {
        // Save current destination to resume later
        savedRoute = { coords: destCoords, name: destName };
        
        // Navigate to POI first
        destCoords = { lat: pendingPOI.lat, lon: pendingPOI.lon };
        destName = pendingPOI.name;
        pendingPOI = null;
        document.getElementById('poiPrompt').classList.remove('show');
        
        // Stop current nav and start new one
        isNavigating = false;
        document.getElementById('navDisplay').classList.remove('show');
        document.getElementById('navEndBar').classList.remove('show');
        document.getElementById('topBar').style.display = 'block';
        clearRouteDisplay();
        calcRoute();
    }
    
    function replaceRoute() {
        savedRoute = null; // Don't resume
        destCoords = { lat: pendingPOI.lat, lon: pendingPOI.lon };
        destName = pendingPOI.name;
        pendingPOI = null;
        document.getElementById('poiPrompt').classList.remove('show');
        
        isNavigating = false;
        document.getElementById('navDisplay').classList.remove('show');
        document.getElementById('navEndBar').classList.remove('show');
        document.getElementById('topBar').style.display = 'block';
        clearRouteDisplay();
        calcRoute();
    }
    
    function closePOI() {
        document.getElementById('poiResults').classList.remove('show');
        clearPOIMarkers();
    }
    
    function clearPOIMarkers() {
        poiMarkers.forEach(m => map.removeLayer(m));
        poiMarkers = [];
    }
    
    // === RECENT & FAVORITES ===
    function getRecent() { return JSON.parse(localStorage.getItem(STORE.recent) || '[]'); }
    function saveRecentList(r) { localStorage.setItem(STORE.recent, JSON.stringify(r)); }
    
    function saveRecent(name, lat, lon) {
        let r = getRecent();
        // Remove duplicate
        r = r.filter(x => x.name !== name);
        // Add to front
        r.unshift({ name, lat, lon });
        // Keep 20
        saveRecentList(r.slice(0, 20));
    }
    
    function renderRecent() {
        const r = getRecent();
        const fav = getFavorites();
        
        // Favorites section
        if (fav.length) {
            document.getElementById('favoritesSection').innerHTML = `
                <div class="recent-section-title">‚≠ê Favorites</div>
                ${fav.map((f,i) => `<div class="recent-item" onclick="navToFav(${i})"><span class="recent-icon">‚≠ê</span><span class="recent-text">${f.name}</span><span class="recent-arrow">‚Ä∫</span></div>`).join('')}
            `;
        } else {
            document.getElementById('favoritesSection').innerHTML = '';
        }
        
        // Recent
        if (r.length) {
            document.getElementById('recentList').innerHTML = r.map((x,i) => `
                <div class="recent-item" onclick="navToRecent(${i})">
                    <span class="recent-icon">üïê</span>
                    <span class="recent-text">${x.name}</span>
                    <span class="recent-arrow">‚Ä∫</span>
                </div>
            `).join('');
        } else {
            document.getElementById('recentList').innerHTML = '<div class="no-recent">No recent searches</div>';
        }
    }
    
    function navToRecent(i) {
        const r = getRecent()[i];
        if (!r) return;
        destCoords = { lat: r.lat, lon: r.lon };
        destName = r.name;
        document.getElementById('searchInput').value = r.name;
        document.getElementById('clearBtn').classList.add('show');
        hideRecent();
        calcRoute();
    }
    
    function getFavorites() { return JSON.parse(localStorage.getItem(STORE.favorites) || '[]'); }
    function saveFavList(f) { localStorage.setItem(STORE.favorites, JSON.stringify(f)); }
    
    function navToFav(i) {
        const f = getFavorites()[i];
        if (!f) return;
        destCoords = { lat: f.lat, lon: f.lon };
        destName = f.name;
        document.getElementById('searchInput').value = f.name;
        document.getElementById('clearBtn').classList.add('show');
        hideRecent();
        calcRoute();
    }
    
    // === PLACES (Home/Work) ===
    function getPlaces() { return JSON.parse(localStorage.getItem(STORE.places) || '{}'); }
    function savePlaces(p) { localStorage.setItem(STORE.places, JSON.stringify(p)); updatePlaceButtons(); }
    
    function updatePlaceButtons() {
        const p = getPlaces();
        ['home', 'work'].forEach(k => {
            const el = document.getElementById(k + 'Place');
            const addr = document.getElementById(k + 'Addr');
            if (p[k]) {
                el.classList.remove('not-set'); el.classList.add('set');
                addr.textContent = p[k].name.substring(0, 20);
            } else {
                el.classList.add('not-set'); el.classList.remove('set');
                addr.textContent = 'Set location';
            }
        });
    }
    
    function handlePlaceClick(type) {
        const p = getPlaces();
        if (p[type]) {
            destCoords = { lat: p[type].lat, lon: p[type].lon };
            destName = p[type].name;
            document.getElementById('searchInput').value = destName;
            document.getElementById('clearBtn').classList.add('show');
            hideRecent();
            calcRoute();
        } else {
            openSetPlace(type);
        }
    }
    
    function openSetPlace(type) {
        setPlaceType = type;
        document.getElementById('setPlaceTitle').textContent = type === 'home' ? 'üè† Set Home' : 'üöõ Set Truck Yard';
        document.getElementById('setPlaceInput').value = '';
        document.getElementById('setPlaceModal').classList.add('show');
        closeMenu();
        hideRecent();
    }
    
    function closeSetPlace() {
        document.getElementById('setPlaceModal').classList.remove('show');
        setPlaceType = null;
    }
    
    async function savePlaceFromInput() {
        const addr = document.getElementById('setPlaceInput').value.trim();
        if (!addr) { alert('Enter an address'); return; }
        showLoading(true);
        
        try {
            const res = await fetch(`https://api.openrouteservice.org/geocode/search?api_key=${API_KEY}&text=${encodeURIComponent(addr)}&size=1`);
            const data = await res.json();
            if (!data.features?.length) { alert('Address not found'); showLoading(false); return; }
            
            const c = data.features[0].geometry.coordinates;
            const p = getPlaces();
            p[setPlaceType] = { name: data.features[0].properties.label || addr, lat: c[1], lon: c[0] };
            savePlaces(p);
            closeSetPlace();
            alert('Saved!');
        } catch(e) { alert('Failed to save'); }
        showLoading(false);
    }
    
    function setPlaceCurrentLocation() {
        if (!userLat) { alert('Getting GPS...'); return; }
        const p = getPlaces();
        p[setPlaceType] = { name: setPlaceType === 'home' ? 'Home' : 'Truck Yard', lat: userLat, lon: userLon };
        savePlaces(p);
        closeSetPlace();
        alert('Saved to current location!');
    }
    
    // === TRIP RECORDING ===
    function toggleTrip() {
        if (isTripActive) stopTrip();
        else startTrip();
        closeMenu();
    }
    
    function startTrip() {
        isTripActive = true;
        currentTrip = { start: Date.now(), miles: 0 };
        tripLine = L.polyline([[userLat, userLon]], { color: '#e74c3c', weight: 4 }).addTo(map);
        document.getElementById('tripBanner').classList.add('show');
        document.getElementById('tripIcon').textContent = '‚èπ';
        document.getElementById('tripText').textContent = 'Stop Recording';
    }
    
    function stopTrip() {
        isTripActive = false;
        currentTrip.end = Date.now();
        
        // Save trip
        const trips = JSON.parse(localStorage.getItem(STORE.trips) || '[]');
        trips.unshift(currentTrip);
        localStorage.setItem(STORE.trips, JSON.stringify(trips.slice(0, 100)));
        
        document.getElementById('tripBanner').classList.remove('show');
        document.getElementById('tripIcon').textContent = '‚ñ∂Ô∏è';
        document.getElementById('tripText').textContent = 'Start Trip Recording';
        
        if (tripLine) { map.removeLayer(tripLine); tripLine = null; }
        alert(`Trip saved: ${currentTrip.miles.toFixed(1)} miles`);
        currentTrip = null;
    }
    
    function openTrips() {
        const trips = JSON.parse(localStorage.getItem(STORE.trips) || '[]');
        const list = trips.slice(0, 20).map(t => 
            `${new Date(t.start).toLocaleDateString()} - ${t.miles.toFixed(1)} mi`
        ).join('\n');
        alert('Recent Trips:\n\n' + (list || 'No trips yet'));
        closeMenu();
    }
    
    function openIFTA() {
        const trips = JSON.parse(localStorage.getItem(STORE.trips) || '[]');
        const total = trips.reduce((a,t) => a + t.miles, 0);
        alert(`IFTA Total: ${total.toFixed(1)} miles\n\nFor detailed state-by-state breakdown, use the full desktop version.`);
        closeMenu();
    }
    
    // === MENU ===
    function openMenu() {
        hideRecent();
        document.getElementById('menuOverlay').classList.add('show');
        document.getElementById('menuPanel').classList.add('show');
    }
    
    function closeMenu() {
        document.getElementById('menuOverlay').classList.remove('show');
        document.getElementById('menuPanel').classList.remove('show');
    }
    
    // === DISPATCH CONTACTS ===
    const DISPATCH_KEY = 'gps_dispatch_contacts';
    let dispatchContacts = JSON.parse(localStorage.getItem(DISPATCH_KEY) || '{"phones":[],"emails":[]}');
    
    function openDispatchContacts() {
        closeMenu();
        renderDispatchContacts();
        document.getElementById('dispatchContactsModal').classList.add('show');
    }
    
    function renderDispatchContacts() {
        // Render phone contacts
        const phoneList = document.getElementById('dispatchPhoneList');
        if (dispatchContacts.phones.length === 0) {
            phoneList.innerHTML = '<div style="padding:15px;text-align:center;color:#888;font-size:13px;">No phone contacts added</div>';
        } else {
            phoneList.innerHTML = dispatchContacts.phones.map((p, i) => `
                <div style="display:flex;align-items:center;padding:12px;background:rgba(255,255,255,0.05);border-radius:10px;margin-bottom:8px;">
                    <span style="font-size:20px;margin-right:12px;">üì±</span>
                    <div style="flex:1;">
                        <div style="font-weight:600;">${p.name}</div>
                        <div style="font-size:13px;color:#888;">${p.phone}</div>
                    </div>
                    <button onclick="deleteDispatchPhone(${i})" style="background:none;border:none;color:#e74c3c;font-size:18px;cursor:pointer;">üóëÔ∏è</button>
                </div>
            `).join('');
        }
        
        // Render email contacts
        const emailList = document.getElementById('dispatchEmailList');
        if (dispatchContacts.emails.length === 0) {
            emailList.innerHTML = '<div style="padding:15px;text-align:center;color:#888;font-size:13px;">No email addresses added</div>';
        } else {
            emailList.innerHTML = dispatchContacts.emails.map((e, i) => `
                <div style="display:flex;align-items:center;padding:12px;background:rgba(255,255,255,0.05);border-radius:10px;margin-bottom:8px;">
                    <span style="font-size:20px;margin-right:12px;">üìß</span>
                    <div style="flex:1;">
                        <div style="font-weight:600;">${e.name}</div>
                        <div style="font-size:13px;color:#888;">${e.email}</div>
                    </div>
                    <button onclick="deleteDispatchEmail(${i})" style="background:none;border:none;color:#e74c3c;font-size:18px;cursor:pointer;">üóëÔ∏è</button>
                </div>
            `).join('');
        }
    }
    
    function addDispatchPhone() {
        if (dispatchContacts.phones.length >= 4) {
            alert('Maximum 4 phone contacts allowed');
            return;
        }
        document.getElementById('newPhoneName').value = '';
        document.getElementById('newPhoneNumber').value = '';
        document.getElementById('addPhoneModal').classList.add('show');
    }
    
    function saveDispatchPhone() {
        const name = document.getElementById('newPhoneName').value.trim();
        const phone = document.getElementById('newPhoneNumber').value.trim();
        
        if (!name || !phone) {
            alert('Please enter name and phone number');
            return;
        }
        
        dispatchContacts.phones.push({ name, phone });
        localStorage.setItem(DISPATCH_KEY, JSON.stringify(dispatchContacts));
        
        closeModal('addPhoneModal');
        renderDispatchContacts();
    }
    
    function deleteDispatchPhone(index) {
        if (!confirm('Delete this contact?')) return;
        dispatchContacts.phones.splice(index, 1);
        localStorage.setItem(DISPATCH_KEY, JSON.stringify(dispatchContacts));
        renderDispatchContacts();
    }
    
    function addDispatchEmail() {
        if (dispatchContacts.emails.length >= 4) {
            alert('Maximum 4 email addresses allowed');
            return;
        }
        document.getElementById('newEmailName').value = '';
        document.getElementById('newEmailAddress').value = '';
        document.getElementById('addEmailModal').classList.add('show');
    }
    
    function saveDispatchEmail() {
        const name = document.getElementById('newEmailName').value.trim();
        const email = document.getElementById('newEmailAddress').value.trim();
        
        if (!name || !email) {
            alert('Please enter name and email address');
            return;
        }
        
        dispatchContacts.emails.push({ name, email });
        localStorage.setItem(DISPATCH_KEY, JSON.stringify(dispatchContacts));
        
        closeModal('addEmailModal');
        renderDispatchContacts();
    }
    
    function deleteDispatchEmail(index) {
        if (!confirm('Delete this email?')) return;
        dispatchContacts.emails.splice(index, 1);
        localStorage.setItem(DISPATCH_KEY, JSON.stringify(dispatchContacts));
        renderDispatchContacts();
    }
    
    // === DOCUMENT SCANNER ===
    const DOCS_KEY = 'gps_scanned_docs';
    let scannedDocs = JSON.parse(localStorage.getItem(DOCS_KEY) || '[]');
    let currentDocImage = null;
    
    function scanLoadPaper() {
        closeMenu();
        document.getElementById('docScanInput').click();
    }
    
    async function handleDocScan(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        showLoading(true);
        
        const reader = new FileReader();
        reader.onload = async (e) => {
            rawDocImage = e.target.result;
            docRotation = 0;
            
            // Process and clean up the image
            currentDocImage = await processDocumentImage(rawDocImage, 0);
            
            // Show preview
            document.getElementById('docPreviewArea').innerHTML = `
                <img src="${currentDocImage}" style="width:100%;max-height:200px;object-fit:contain;">
            `;
            
            document.getElementById('docTitle').value = `Load_${new Date().toISOString().slice(0,10)}`;
            document.getElementById('docScanModal').classList.add('show');
            showLoading(false);
        };
        reader.readAsDataURL(file);
        event.target.value = '';
    }
    
    // OpenCV state
    let cvReady = false;
    let docRotation = 0;
    let rawDocImage = null;
    let detectedCorners = null;
    
    function onOpenCvReady() {
        cvReady = true;
        console.log('OpenCV.js loaded successfully');
    }
    
    async function processDocumentImage(imageData, rotation = 0, autoDetect = true) {
        return new Promise((resolve) => {
            const img = new Image();
            img.onload = () => {
                // Create canvas
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Handle rotation first
                const isRotated = rotation === 90 || rotation === 270;
                const maxDim = 1200;
                const scale = Math.min(1, maxDim / Math.max(img.width, img.height));
                
                if (isRotated) {
                    canvas.width = img.height * scale;
                    canvas.height = img.width * scale;
                } else {
                    canvas.width = img.width * scale;
                    canvas.height = img.height * scale;
                }
                
                ctx.save();
                ctx.translate(canvas.width / 2, canvas.height / 2);
                ctx.rotate((rotation * Math.PI) / 180);
                if (isRotated) {
                    ctx.drawImage(img, -canvas.height / 2, -canvas.width / 2, canvas.height, canvas.width);
                } else {
                    ctx.drawImage(img, -canvas.width / 2, -canvas.height / 2, canvas.width, canvas.height);
                }
                ctx.restore();
                
                // If OpenCV is ready and autoDetect enabled, use it
                if (cvReady && autoDetect && typeof cv !== 'undefined') {
                    try {
                        const result = processWithOpenCV(canvas);
                        resolve(result);
                        return;
                    } catch (e) {
                        console.error('OpenCV processing failed, using fallback:', e);
                    }
                }
                
                // Fallback: Basic enhancement without edge detection
                const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imgData.data;
                
                let totalBrightness = 0;
                for (let i = 0; i < data.length; i += 4) {
                    totalBrightness += (data[i] + data[i + 1] + data[i + 2]) / 3;
                }
                const avgBrightness = totalBrightness / (data.length / 4);
                
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i], g = data[i + 1], b = data[i + 2];
                    const gray = r * 0.299 + g * 0.587 + b * 0.114;
                    const threshold = avgBrightness > 180 ? 200 : avgBrightness > 120 ? 160 : 120;
                    
                    let val;
                    if (gray > threshold) {
                        val = 255;
                    } else if (gray > threshold * 0.5) {
                        val = Math.min(255, gray * 1.3);
                    } else {
                        val = Math.max(0, gray * 0.6);
                    }
                    
                    data[i] = val;
                    data[i + 1] = val;
                    data[i + 2] = val;
                }
                
                ctx.putImageData(imgData, 0, 0);
                resolve(canvas.toDataURL('image/jpeg', 0.9));
            };
            img.src = imageData;
        });
    }
    
    function processWithOpenCV(canvas) {
        // Read image from canvas
        let src = cv.imread(canvas);
        let dst = new cv.Mat();
        let gray = new cv.Mat();
        let blur = new cv.Mat();
        let edges = new cv.Mat();
        
        try {
            // Convert to grayscale
            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
            
            // Apply Gaussian blur to reduce noise
            cv.GaussianBlur(gray, blur, new cv.Size(5, 5), 0);
            
            // Detect edges using Canny
            cv.Canny(blur, edges, 50, 150);
            
            // Find contours
            let contours = new cv.MatVector();
            let hierarchy = new cv.Mat();
            cv.findContours(edges, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);
            
            // Find the largest rectangular contour (likely the document)
            let maxArea = 0;
            let bestContour = null;
            let docCorners = null;
            
            for (let i = 0; i < contours.size(); i++) {
                let contour = contours.get(i);
                let area = cv.contourArea(contour);
                
                if (area > maxArea && area > (src.rows * src.cols * 0.1)) { // At least 10% of image
                    let peri = cv.arcLength(contour, true);
                    let approx = new cv.Mat();
                    cv.approxPolyDP(contour, approx, 0.02 * peri, true);
                    
                    if (approx.rows === 4) { // Found a quadrilateral
                        maxArea = area;
                        bestContour = approx;
                        
                        // Extract corners
                        docCorners = [];
                        for (let j = 0; j < 4; j++) {
                            docCorners.push({
                                x: approx.data32S[j * 2],
                                y: approx.data32S[j * 2 + 1]
                            });
                        }
                    }
                    approx.delete();
                }
            }
            
            // If we found document corners, apply perspective transform
            if (docCorners && docCorners.length === 4) {
                // Sort corners: top-left, top-right, bottom-right, bottom-left
                docCorners = orderCorners(docCorners);
                detectedCorners = docCorners;
                
                // Calculate output dimensions
                const width = Math.max(
                    distance(docCorners[0], docCorners[1]),
                    distance(docCorners[3], docCorners[2])
                );
                const height = Math.max(
                    distance(docCorners[0], docCorners[3]),
                    distance(docCorners[1], docCorners[2])
                );
                
                // Create perspective transform
                let srcTri = cv.matFromArray(4, 1, cv.CV_32FC2, [
                    docCorners[0].x, docCorners[0].y,
                    docCorners[1].x, docCorners[1].y,
                    docCorners[2].x, docCorners[2].y,
                    docCorners[3].x, docCorners[3].y
                ]);
                
                let dstTri = cv.matFromArray(4, 1, cv.CV_32FC2, [
                    0, 0,
                    width, 0,
                    width, height,
                    0, height
                ]);
                
                let M = cv.getPerspectiveTransform(srcTri, dstTri);
                dst = new cv.Mat();
                let dsize = new cv.Size(width, height);
                cv.warpPerspective(src, dst, M, dsize, cv.INTER_LINEAR, cv.BORDER_CONSTANT, new cv.Scalar());
                
                srcTri.delete();
                dstTri.delete();
                M.delete();
            } else {
                // No document detected, just enhance the original
                dst = src.clone();
                detectedCorners = null;
            }
            
            // Apply adaptive thresholding for document look
            let enhanced = new cv.Mat();
            cv.cvtColor(dst, gray, cv.COLOR_RGBA2GRAY);
            cv.adaptiveThreshold(gray, enhanced, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY, 21, 10);
            
            // Convert back to color (grayscale as RGB)
            cv.cvtColor(enhanced, dst, cv.COLOR_GRAY2RGBA);
            
            // Output to canvas
            let outputCanvas = document.createElement('canvas');
            cv.imshow(outputCanvas, dst);
            
            // Cleanup
            contours.delete();
            hierarchy.delete();
            enhanced.delete();
            
            return outputCanvas.toDataURL('image/jpeg', 0.9);
            
        } finally {
            src.delete();
            dst.delete();
            gray.delete();
            blur.delete();
            edges.delete();
        }
    }
    
    function orderCorners(corners) {
        // Sort by y coordinate first (top vs bottom)
        corners.sort((a, b) => a.y - b.y);
        
        // Top two and bottom two
        let top = corners.slice(0, 2);
        let bottom = corners.slice(2, 4);
        
        // Sort by x coordinate
        top.sort((a, b) => a.x - b.x);
        bottom.sort((a, b) => a.x - b.x);
        
        // Return: top-left, top-right, bottom-right, bottom-left
        return [top[0], top[1], bottom[1], bottom[0]];
    }
    
    function distance(p1, p2) {
        return Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2));
    }
    
    function rotateDocument() {
        if (!rawDocImage) return;
        docRotation = (docRotation + 90) % 360;
        reprocessDocument();
    }
    
    async function reprocessDocument() {
        showLoading(true);
        currentDocImage = await processDocumentImage(rawDocImage, docRotation);
        document.getElementById('docPreviewArea').innerHTML = `
            <img src="${currentDocImage}" style="width:100%;max-height:200px;object-fit:contain;">
            ${detectedCorners ? '<div style="color:#00b894;font-size:11px;text-align:center;margin-top:5px;">‚úì Document edges detected</div>' : '<div style="color:#888;font-size:11px;text-align:center;margin-top:5px;">Manual mode (no edges detected)</div>'}
        `;
        showLoading(false);
    }
    
    function closeDocScan() {
        document.getElementById('docScanModal').classList.remove('show');
        currentDocImage = null;
        rawDocImage = null;
        docRotation = 0;
        detectedCorners = null;
    }
    
    function saveDocAsPDF() {
        if (!currentDocImage) return;
        
        const title = document.getElementById('docTitle').value.trim() || 'Document';
        
        // Save to local storage
        const doc = {
            id: Date.now(),
            title: title,
            image: currentDocImage,
            date: new Date().toISOString(),
            company: profile?.company || ''
        };
        
        scannedDocs.push(doc);
        localStorage.setItem(DOCS_KEY, JSON.stringify(scannedDocs));
        
        // Create downloadable PDF-like file (image download for now)
        const link = document.createElement('a');
        link.download = `${title.replace(/\s+/g, '_')}.jpg`;
        link.href = currentDocImage;
        link.click();
        
        closeDocScan();
        alert('‚úÖ Document saved!');
    }
    
    function shareDocText() {
        if (!currentDocImage) return;
        
        // If we have saved phone contacts, show selection
        if (dispatchContacts.phones.length > 0) {
            showContactSelector('phone');
            return;
        }
        
        // No saved contacts, use default sharing
        sendDocViaText(null);
    }
    
    function sendDocViaText(phoneNumber) {
        const title = document.getElementById('docTitle').value.trim() || 'Load Paper';
        const truck = profile?.truck || '';
        
        const message = `üìÑ ${title}\n\nüöõ Truck: ${truck}\nüìÖ Date: ${new Date().toLocaleDateString()}\n‚è∞ Time: ${new Date().toLocaleTimeString()}\n\n‚Äî Sent via Genesis Trucker GPS`;
        
        if (navigator.share && navigator.canShare) {
            fetch(currentDocImage)
                .then(res => res.blob())
                .then(blob => {
                    const file = new File([blob], `${title}.jpg`, { type: 'image/jpeg' });
                    if (navigator.canShare({ files: [file] })) {
                        navigator.share({
                            title: title,
                            text: message,
                            files: [file]
                        });
                    } else {
                        const smsUrl = phoneNumber ? `sms:${phoneNumber}?body=` : 'sms:?body=';
                        window.open(smsUrl + encodeURIComponent(message));
                    }
                });
        } else {
            const smsUrl = phoneNumber ? `sms:${phoneNumber}?body=` : 'sms:?body=';
            window.open(smsUrl + encodeURIComponent(message));
        }
        
        closeModal('selectContactModal');
        closeDocScan();
    }
    
    function shareDocEmail() {
        if (!currentDocImage) return;
        
        // If we have saved email contacts, show selection
        if (dispatchContacts.emails.length > 0) {
            showContactSelector('email');
            return;
        }
        
        // No saved contacts, use default
        sendDocViaEmail(null);
    }
    
    function sendDocViaEmail(emailAddress) {
        const title = document.getElementById('docTitle').value.trim() || 'Load Paper';
        const truck = profile?.truck || '';
        
        const subject = encodeURIComponent(`${title} - ${truck}`);
        const body = encodeURIComponent(`Hi Dispatch,\n\nPlease find the attached load paper.\n\nüìÑ Document: ${title}\nüöõ Truck: ${truck}\nüìÖ Date: ${new Date().toLocaleDateString()}\n‚è∞ Time: ${new Date().toLocaleTimeString()}\n\nBest regards,\n${profile?.name || 'Driver'}\n\n‚Äî Sent via Genesis Trucker GPS`);
        
        const mailto = emailAddress ? `mailto:${emailAddress}?subject=${subject}&body=${body}` : `mailto:?subject=${subject}&body=${body}`;
        window.open(mailto);
        
        // Download image so they can attach
        const link = document.createElement('a');
        link.download = `${title.replace(/\s+/g, '_')}.jpg`;
        link.href = currentDocImage;
        link.click();
        
        closeModal('selectContactModal');
        closeDocScan();
        
        alert('üìß Email opened! The document was downloaded - attach it to your email.');
    }
    
    function showContactSelector(type) {
        const list = document.getElementById('selectContactList');
        
        if (type === 'phone') {
            document.getElementById('selectContactTitle').textContent = 'üì± Select Contact to Text';
            list.innerHTML = dispatchContacts.phones.map(p => `
                <div onclick="sendDocViaText('${p.phone}')" style="display:flex;align-items:center;padding:15px;border-bottom:1px solid rgba(255,255,255,0.1);cursor:pointer;">
                    <span style="font-size:24px;margin-right:15px;">üì±</span>
                    <div style="flex:1;">
                        <div style="font-weight:600;font-size:16px;">${p.name}</div>
                        <div style="font-size:13px;color:#888;">${p.phone}</div>
                    </div>
                    <span style="color:#00b894;font-size:20px;">‚Ä∫</span>
                </div>
            `).join('') + `
                <div onclick="sendDocViaText(null)" style="display:flex;align-items:center;padding:15px;cursor:pointer;color:#888;">
                    <span style="font-size:24px;margin-right:15px;">üìù</span>
                    <div style="flex:1;">Enter number manually</div>
                    <span style="font-size:20px;">‚Ä∫</span>
                </div>
            `;
        } else {
            document.getElementById('selectContactTitle').textContent = 'üìß Select Email Recipient';
            list.innerHTML = dispatchContacts.emails.map(e => `
                <div onclick="sendDocViaEmail('${e.email}')" style="display:flex;align-items:center;padding:15px;border-bottom:1px solid rgba(255,255,255,0.1);cursor:pointer;">
                    <span style="font-size:24px;margin-right:15px;">üìß</span>
                    <div style="flex:1;">
                        <div style="font-weight:600;font-size:16px;">${e.name}</div>
                        <div style="font-size:13px;color:#888;">${e.email}</div>
                    </div>
                    <span style="color:#e94560;font-size:20px;">‚Ä∫</span>
                </div>
            `).join('') + `
                <div onclick="sendDocViaEmail(null)" style="display:flex;align-items:center;padding:15px;cursor:pointer;color:#888;">
                    <span style="font-size:24px;margin-right:15px;">üìù</span>
                    <div style="flex:1;">Enter email manually</div>
                    <span style="font-size:20px;">‚Ä∫</span>
                </div>
            `;
        }
        
        document.getElementById('selectContactModal').classList.add('show');
    }
    
    function viewScannedDocs() {
        closeMenu();
        
        if (scannedDocs.length === 0) {
            document.getElementById('docsList').innerHTML = '<div style="text-align:center;color:#888;padding:30px;">No documents yet.<br><br>Tap "Scan Load Paper" to add documents.</div>';
        } else {
            document.getElementById('docsList').innerHTML = scannedDocs.slice().reverse().map(d => `
                <div style="display:flex;align-items:center;gap:12px;padding:12px;border-bottom:1px solid rgba(255,255,255,0.1);">
                    <img src="${d.image}" style="width:50px;height:50px;object-fit:cover;border-radius:8px;">
                    <div style="flex:1;min-width:0;">
                        <div style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${d.title}</div>
                        <div style="font-size:11px;color:#888;">${new Date(d.date).toLocaleDateString()}</div>
                    </div>
                    <button onclick="downloadDoc(${d.id})" style="background:#0984e3;border:none;color:#fff;padding:8px 12px;border-radius:8px;font-size:12px;">üíæ</button>
                    <button onclick="deleteDoc(${d.id})" style="background:#e74c3c;border:none;color:#fff;padding:8px 12px;border-radius:8px;font-size:12px;">üóëÔ∏è</button>
                </div>
            `).join('');
        }
        
        document.getElementById('docsListModal').classList.add('show');
    }
    
    function downloadDoc(id) {
        const doc = scannedDocs.find(d => d.id === id);
        if (!doc) return;
        
        const link = document.createElement('a');
        link.download = `${doc.title.replace(/\s+/g, '_')}.jpg`;
        link.href = doc.image;
        link.click();
    }
    
    function deleteDoc(id) {
        if (!confirm('Delete this document?')) return;
        scannedDocs = scannedDocs.filter(d => d.id !== id);
        localStorage.setItem(DOCS_KEY, JSON.stringify(scannedDocs));
        viewScannedDocs();
    }
    
    function logout() {
        if (isTripActive && !confirm('Stop trip and logout?')) return;
        if (isTripActive) stopTrip();
        localStorage.removeItem(STORE.profile);
        localStorage.removeItem('gps_code');
        location.reload();
    }
    
    // === UTILS ===
    function getDist(lat1, lon1, lat2, lon2) {
        const R = 3959;
        const dLat = (lat2-lat1) * Math.PI/180;
        const dLon = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }
    
    function fmtDist(m) { return m >= 1609 ? (m/1609.34).toFixed(1) + ' mi' : Math.round(m*3.28) + ' ft'; }
    function getIcon(t) { const l = t.toLowerCase(); if (l.includes('left')) return '‚Ü∞'; if (l.includes('right')) return '‚Ü±'; if (l.includes('arrive')) return 'üèÅ'; return '‚Üë'; }
    function toSpanish(t) { let r = t; Object.entries(SPANISH).forEach(([e,p]) => r = r.replace(new RegExp(e,'gi'), p)); return r; }
    function showLoading(s) { document.getElementById('loading').classList.toggle('show', s); }
    </script>
</body>
</html>
