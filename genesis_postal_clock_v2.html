<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>üìÆ Genesis Postal Clock</title>
    <!-- OpenCV.js for document scanning -->
    <script async src="https://docs.opencv.org/4.7.0/opencv.js" onload="onOpenCvReady()"></script>
    <!-- Tesseract.js for OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <!-- Leaflet for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); 
            min-height: 100vh; color: #fff; 
        }
        
        .container { max-width: 500px; margin: 0 auto; padding: 15px; padding-top: max(15px, env(safe-area-inset-top)); padding-bottom: 80px; }
        
        /* Header */
        .header { text-align: center; padding: 20px 0; }
        .header-icon { font-size: 50px; margin-bottom: 10px; }
        .header-title { font-size: 22px; font-weight: 700; }
        .header-subtitle { font-size: 12px; color: #888; margin-top: 5px; }
        .header-date { font-size: 14px; color: #00b894; margin-top: 10px; }
        
        /* Main Timer */
        .timer-card { background: rgba(255,255,255,0.1); border-radius: 20px; padding: 25px; margin-bottom: 15px; text-align: center; }
        .timer-label { font-size: 12px; color: #888; margin-bottom: 5px; text-transform: uppercase; }
        .timer-display { font-size: 52px; font-weight: 700; font-family: 'SF Mono', monospace; color: #00ff88; }
        .timer-status { display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: 600; margin-top: 10px; }
        .timer-status.clocked-in { background: #00b894; color: #fff; }
        .timer-status.clocked-out { background: #636e72; color: #fff; }
        
        /* Position & Office */
        .info-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .info-card { flex: 1; background: rgba(255,255,255,0.1); border-radius: 12px; padding: 12px; text-align: center; }
        .info-card-label { font-size: 10px; color: #888; margin-bottom: 3px; }
        .info-card-value { font-size: 14px; font-weight: 600; }
        
        /* Task Selection */
        .task-section { background: rgba(255,255,255,0.1); border-radius: 15px; padding: 15px; margin-bottom: 15px; }
        .task-section-title { font-size: 12px; color: #00b894; margin-bottom: 10px; text-transform: uppercase; font-weight: 600; }
        .task-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .task-btn { padding: 12px 8px; border: 2px solid rgba(255,255,255,0.2); border-radius: 10px; background: transparent; color: #fff; font-size: 12px; cursor: pointer; transition: all 0.2s; }
        .task-btn:active { transform: scale(0.95); }
        .task-btn.active { border-color: #00b894; background: rgba(0,184,148,0.2); }
        .task-btn-icon { font-size: 18px; display: block; margin-bottom: 3px; }
        
        /* Task Breakdown */
        .breakdown-section { background: rgba(255,255,255,0.1); border-radius: 15px; padding: 15px; margin-bottom: 15px; }
        .breakdown-title { font-size: 12px; color: #00b894; margin-bottom: 10px; text-transform: uppercase; font-weight: 600; display: flex; justify-content: space-between; }
        .breakdown-list { max-height: 150px; overflow-y: auto; }
        .breakdown-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 13px; }
        .breakdown-item:last-child { border-bottom: none; }
        .breakdown-time { color: #00ff88; font-weight: 600; font-family: monospace; }
        
        /* Today's Entries */
        .entries-section { background: rgba(255,255,255,0.1); border-radius: 15px; padding: 15px; margin-bottom: 15px; }
        .entries-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .entries-title { font-size: 12px; color: #00b894; text-transform: uppercase; font-weight: 600; }
        .entries-toggle { font-size: 18px; transition: transform 0.3s; }
        .entries-toggle.open { transform: rotate(180deg); }
        .entries-list { max-height: 0; overflow: hidden; transition: max-height 0.3s; }
        .entries-list.open { max-height: 400px; overflow-y: auto; margin-top: 10px; }
        .entry-item { padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 12px; display: flex; align-items: center; gap: 10px; }
        .entry-item:last-child { border-bottom: none; }
        .entry-icon { font-size: 14px; }
        .entry-text { flex: 1; }
        .entry-time { color: #00b894; font-family: monospace; }
        .entry-edited { font-size: 10px; color: #e17055; }
        
        /* Clock Buttons */
        .clock-buttons { display: flex; gap: 10px; margin-bottom: 15px; }
        .clock-btn { flex: 1; padding: 18px; border: none; border-radius: 15px; font-size: 16px; font-weight: 700; cursor: pointer; }
        .clock-btn-in { background: linear-gradient(135deg, #00b894 0%, #00cec9 100%); color: #fff; }
        .clock-btn-out { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: #fff; }
        .clock-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Green Card Section */
        .greencard-section { background: rgba(255,255,255,0.1); border-radius: 15px; padding: 15px; margin-bottom: 15px; }
        .greencard-btn { width: 100%; padding: 15px; border: 2px dashed rgba(255,255,255,0.3); border-radius: 12px; background: transparent; color: #fff; font-size: 14px; cursor: pointer; }
        .greencard-preview { display: flex; gap: 10px; margin-top: 10px; }
        .greencard-preview img { width: 50%; border-radius: 10px; }
        
        /* Bottom Nav */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(26,26,46,0.98); border-top: 1px solid rgba(255,255,255,0.1); display: flex; padding-bottom: max(10px, env(safe-area-inset-bottom)); }
        .nav-btn { flex: 1; padding: 12px 5px; border: none; background: transparent; color: #888; font-size: 10px; cursor: pointer; text-align: center; }
        .nav-btn.active { color: #00b894; }
        .nav-btn-icon { font-size: 20px; display: block; margin-bottom: 2px; }
        
        /* Package Route Builder Steps */
        .pkg-step { display: flex; flex-direction: column; align-items: center; opacity: 0.5; }
        .pkg-step.active { opacity: 1; }
        .pkg-step.completed { opacity: 1; }
        .pkg-step-num { width: 28px; height: 28px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; margin-bottom: 5px; }
        .pkg-step.active .pkg-step-num { background: #00b894; }
        .pkg-step.completed .pkg-step-num { background: #00b894; }
        .pkg-step-text { font-size: 11px; color: #888; }
        .pkg-step.active .pkg-step-text { color: #00b894; }
        
        .pkg-content-step { min-height: 60vh; }
        
        .pkg-scanned-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 10px; margin-bottom: 10px; }
        .pkg-scanned-thumb { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; }
        .pkg-scanned-info { flex: 1; }
        .pkg-scanned-address { font-size: 14px; font-weight: 500; }
        .pkg-scanned-status { font-size: 11px; color: #888; margin-top: 3px; }
        .pkg-scanned-delete { background: none; border: none; color: #e74c3c; font-size: 18px; cursor: pointer; padding: 5px; }
        
        .pkg-address-edit { background: rgba(255,255,255,0.1); border-radius: 10px; padding: 12px; margin-bottom: 10px; }
        .pkg-address-input { width: 100%; padding: 12px; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.1); color: #fff; font-size: 14px; }
        .pkg-address-input:focus { outline: none; border-color: #00b894; }
        
        .pkg-manifest-item { display: flex; align-items: center; gap: 15px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 12px; margin-bottom: 10px; }
        .pkg-manifest-num { width: 40px; height: 40px; background: #00b894; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 700; color: #fff; flex-shrink: 0; }
        .pkg-manifest-address { flex: 1; font-size: 14px; line-height: 1.4; }
        
        .pkg-upcoming-item { display: flex; align-items: center; gap: 12px; padding: 10px 12px; background: #f8f9fa; border-radius: 10px; margin-bottom: 8px; }
        .pkg-upcoming-item.current { background: #e8f8f5; border-left: 4px solid #00b894; }
        .pkg-upcoming-num { width: 28px; height: 28px; background: #ddd; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 600; color: #333; }
        .pkg-upcoming-item.current .pkg-upcoming-num { background: #00b894; color: #fff; }
        .pkg-upcoming-address { flex: 1; font-size: 13px; color: #333; }
        .pkg-upcoming-dist { font-size: 12px; color: #00b894; font-weight: 600; }
        
        /* Panels */
        .panel { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); z-index: 100; transform: translateX(100%); transition: transform 0.3s; overflow-y: auto; }
        .panel.show { transform: translateX(0); }
        .panel-header { display: flex; align-items: center; padding: 15px; padding-top: max(15px, env(safe-area-inset-top)); border-bottom: 1px solid rgba(255,255,255,0.1); position: sticky; top: 0; background: rgba(26,26,46,0.98); z-index: 10; }
        .panel-back { background: none; border: none; color: #fff; font-size: 24px; cursor: pointer; margin-right: 15px; }
        .panel-title { font-size: 18px; font-weight: 700; }
        .panel-content { padding: 15px; padding-bottom: 100px; }
        
        /* Route Search */
        .route-search-box { background: #fff; border-radius: 12px; padding: 5px; margin-bottom: 15px; display: flex; }
        .route-search-input { flex: 1; border: none; padding: 12px; font-size: 16px; background: transparent; color: #333; }
        .route-search-input::placeholder { color: #999; }
        .route-search-input:focus { outline: none; }
        .route-search-clear { background: none; border: none; font-size: 18px; padding: 10px; cursor: pointer; color: #999; }
        
        .route-results { background: rgba(255,255,255,0.1); border-radius: 15px; overflow: hidden; }
        .route-result-item { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; }
        .route-result-item:last-child { border-bottom: none; }
        .route-result-item:active { background: rgba(255,255,255,0.1); }
        .route-result-addr { font-size: 15px; font-weight: 600; }
        .route-result-range { font-size: 12px; color: #888; margin-top: 3px; }
        .route-result-code { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 14px; font-weight: 700; margin-top: 8px; }
        .route-result-code.city { background: #0984e3; }
        .route-result-code.rural { background: #00b894; }
        
        .route-detail-card { background: rgba(255,255,255,0.1); border-radius: 20px; padding: 25px; text-align: center; margin-bottom: 20px; }
        .route-detail-addr { font-size: 20px; font-weight: 700; margin-bottom: 15px; }
        .route-detail-code { font-size: 36px; font-weight: 800; padding: 15px 30px; border-radius: 15px; display: inline-block; }
        .route-detail-code.city { background: #0984e3; }
        .route-detail-code.rural { background: #00b894; }
        .route-detail-type { font-size: 14px; color: #888; margin-top: 10px; }
        
        /* Settings */
        .setting-group { background: rgba(255,255,255,0.1); border-radius: 15px; margin-bottom: 15px; overflow: hidden; }
        .setting-group-title { padding: 12px 15px; font-size: 12px; color: #00b894; text-transform: uppercase; font-weight: 600; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .setting-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .setting-item:last-child { border-bottom: none; }
        .setting-label { font-size: 14px; }
        .setting-value { font-size: 14px; color: #00b894; }
        .setting-select { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 8px 12px; color: #fff; font-size: 14px; }
        
        /* Help */
        .help-section { background: rgba(255,255,255,0.1); border-radius: 15px; margin-bottom: 15px; overflow: hidden; }
        .help-item { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; }
        .help-item:last-child { border-bottom: none; }
        .help-item:active { background: rgba(255,255,255,0.05); }
        .help-item-title { font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .help-item-icon { font-size: 18px; }
        
        /* Modals */
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 200; display: none; justify-content: center; align-items: center; padding: 20px; }
        .modal.show { display: flex; }
        .modal-content { background: #1a1a2e; border-radius: 20px; padding: 25px; width: 100%; max-width: 350px; max-height: 80vh; overflow-y: auto; }
        .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 20px; text-align: center; }
        .modal-input { width: 100%; padding: 15px; border: 2px solid rgba(255,255,255,0.2); border-radius: 12px; background: rgba(0,0,0,0.3); color: #fff; font-size: 16px; margin-bottom: 10px; }
        .modal-input:focus { outline: none; border-color: #00b894; }
        .modal-btns { display: flex; gap: 10px; margin-top: 15px; }
        .modal-btn { flex: 1; padding: 15px; border: none; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .modal-btn-cancel { background: rgba(255,255,255,0.1); color: #fff; }
        .modal-btn-confirm { background: #00b894; color: #fff; }
        
        /* Geofence Alert */
        .geo-alert { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1a1a2e; border: 2px solid #00b894; border-radius: 20px; padding: 25px; width: 90%; max-width: 320px; z-index: 300; display: none; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        .geo-alert.show { display: block; animation: popIn 0.3s ease; }
        @keyframes popIn { from { transform: translate(-50%, -50%) scale(0.8); opacity: 0; } to { transform: translate(-50%, -50%) scale(1); opacity: 1; } }
        .geo-alert-icon { font-size: 50px; margin-bottom: 15px; }
        .geo-alert-title { font-size: 18px; font-weight: 700; margin-bottom: 10px; }
        .geo-alert-subtitle { font-size: 14px; color: #888; margin-bottom: 20px; }
        .geo-alert-btns { display: flex; gap: 10px; }
        .geo-alert-btn { flex: 1; padding: 15px; border: none; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; }
        
        /* Toast */
        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 12px 25px; border-radius: 25px; font-size: 14px; z-index: 400; display: none; }
        .toast.show { display: block; animation: fadeInUp 0.3s ease; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateX(-50%) translateY(20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
    </style>
</head>
<body>
    <!-- Main Screen -->
    <div class="container" id="mainScreen">
        <div class="header">
            <div class="header-icon">üìÆ</div>
            <div class="header-title">Genesis Postal Clock</div>
            <div class="header-subtitle">Employee Time Tracker</div>
            <div class="header-date" id="currentDate">Loading...</div>
        </div>
        
        <!-- Main Timer -->
        <div class="timer-card">
            <div class="timer-label">Total Shift Time</div>
            <div class="timer-display" id="mainTimer">00:00:00</div>
            <div class="timer-status clocked-out" id="timerStatus">Clocked Out</div>
        </div>
        
        <!-- Position & Office -->
        <div class="info-row">
            <div class="info-card" onclick="openPositionModal()">
                <div class="info-card-label">Position</div>
                <div class="info-card-value" id="currentPosition">Carrier</div>
            </div>
            <div class="info-card" onclick="openOfficeModal()">
                <div class="info-card-label">Office</div>
                <div class="info-card-value" id="currentOffice">Mansfield</div>
            </div>
        </div>
        
        <!-- Clock Buttons -->
        <div class="clock-buttons">
            <button class="clock-btn clock-btn-in" id="clockInBtn" onclick="clockIn()">‚è±Ô∏è Clock In</button>
            <button class="clock-btn clock-btn-out" id="clockOutBtn" onclick="clockOut()" disabled>‚èπÔ∏è Clock Out</button>
        </div>
        
        <!-- Clerk Lunch & Break Buttons (only visible for clerks) -->
        <div id="clerkBreakSection" style="display:none;margin-top:15px;">
            <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
                <button class="break-btn" id="lunchBtn" onclick="startLunch()" disabled style="background:#f39c12;color:#fff;border:none;padding:12px 20px;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;opacity:0.5;">
                    üçΩÔ∏è Lunch
                </button>
                <button class="break-btn" id="break1Btn" onclick="startBreak(1)" disabled style="background:#9b59b6;color:#fff;border:none;padding:12px 20px;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;opacity:0.5;">
                    ‚òï Break 1
                </button>
                <button class="break-btn" id="break2Btn" onclick="startBreak(2)" disabled style="background:#9b59b6;color:#fff;border:none;padding:12px 20px;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;opacity:0.5;">
                    ‚òï Break 2
                </button>
            </div>
            <!-- Timer display for active lunch/break -->
            <div id="breakTimerDisplay" style="display:none;text-align:center;margin-top:15px;padding:15px;background:rgba(243,156,18,0.2);border-radius:12px;">
                <div style="font-size:12px;color:#f39c12;margin-bottom:5px;" id="breakTimerLabel">LUNCH TIME</div>
                <div style="font-size:32px;font-weight:700;font-family:monospace;" id="breakTimerCountdown">30:00</div>
                <button onclick="endBreakEarly()" style="margin-top:10px;background:#e74c3c;color:#fff;border:none;padding:8px 20px;border-radius:8px;font-size:12px;cursor:pointer;">End Early</button>
            </div>
        </div>
        
        <!-- Task Selection -->
        <div class="task-section" id="taskSection" style="display:none;">
            <div class="task-section-title">Current Task</div>
            <div class="task-grid" id="taskGrid"></div>
        </div>
        
        <!-- Task Breakdown -->
        <div class="breakdown-section" id="breakdownSection" style="display:none;">
            <div class="breakdown-title">
                <span>‚è±Ô∏è Time Breakdown</span>
                <span id="breakdownTotal">0:00</span>
            </div>
            <div class="breakdown-list" id="breakdownList"></div>
        </div>
        
        <!-- Today's Entries -->
        <div class="entries-section">
            <div class="entries-header" onclick="toggleEntries()">
                <span class="entries-title">üìã Today's Entries</span>
                <span class="entries-toggle" id="entriesToggle">‚ñº</span>
            </div>
            <div class="entries-list" id="entriesList"></div>
        </div>
        
        <!-- Green Card / Documents -->
        <div class="greencard-section">
            <div class="task-section-title">üì∏ Documents (Green Card & Forms)</div>
            <div id="greencardImages" style="margin-bottom:10px;"></div>
            <button class="greencard-btn" id="greencardBtn" onclick="captureGreenCard()">
                üì∑ Add Photo
            </button>
            <div style="font-size:11px;color:#666;text-align:center;margin-top:8px;">
                Tap photo to view full size ‚Ä¢ Long press to delete
            </div>
        </div>
    </div>
    
    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <button class="nav-btn active" onclick="showPanel('main')">
            <span class="nav-btn-icon">‚è±Ô∏è</span>Clock
        </button>
        <button class="nav-btn" onclick="showPanel('packages')">
            <span class="nav-btn-icon">üì¶</span>Packages
        </button>
        <button class="nav-btn" onclick="showPanel('history')">
            <span class="nav-btn-icon">üìä</span>History
        </button>
        <button class="nav-btn" onclick="showPanel('pay')">
            <span class="nav-btn-icon">üí∞</span>Pay
        </button>
        <button class="nav-btn" onclick="showPanel('settings')">
            <span class="nav-btn-icon">‚öôÔ∏è</span>Settings
        </button>
        <button class="nav-btn" onclick="showPanel('help')">
            <span class="nav-btn-icon">‚ùì</span>Help
        </button>
    </div>
    
    <!-- Package Route Builder Panel -->
    <div class="panel" id="packagesPanel">
        <div class="panel-header">
            <button class="panel-back" onclick="closePanel()">‚Üê</button>
            <span class="panel-title">üì¶ Package Route Builder</span>
        </div>
        <div class="panel-content" style="padding:0;">
            <!-- Step indicator -->
            <div style="display:flex;justify-content:space-around;padding:15px;background:rgba(0,184,148,0.1);border-bottom:1px solid rgba(255,255,255,0.1);">
                <div id="pkgStep1" class="pkg-step active">
                    <span class="pkg-step-num">1</span>
                    <span class="pkg-step-text">Scan</span>
                </div>
                <div id="pkgStep2" class="pkg-step">
                    <span class="pkg-step-num">2</span>
                    <span class="pkg-step-text">Review</span>
                </div>
                <div id="pkgStep3" class="pkg-step">
                    <span class="pkg-step-num">3</span>
                    <span class="pkg-step-text">Label</span>
                </div>
                <div id="pkgStep4" class="pkg-step">
                    <span class="pkg-step-num">4</span>
                    <span class="pkg-step-text">Navigate</span>
                </div>
            </div>
            
            <!-- Step 1: Scan Packages -->
            <div id="pkgScanStep" class="pkg-content-step">
                <div style="text-align:center;padding:30px 20px;">
                    <div style="font-size:60px;margin-bottom:15px;">üì¶</div>
                    <div style="font-size:18px;font-weight:600;margin-bottom:10px;">Scan Package Labels</div>
                    <div style="color:#888;font-size:14px;margin-bottom:25px;">Take photos of package labels to extract addresses</div>
                    
                    <input type="file" id="pkgScanInput" accept="image/*" capture="environment" style="display:none;" onchange="handlePackageScan(event)">
                    <button onclick="document.getElementById('pkgScanInput').click()" style="width:100%;padding:18px;background:#00b894;color:#fff;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;margin-bottom:15px;">
                        üì∑ Scan Package Label
                    </button>
                </div>
                
                <!-- Scanned packages list -->
                <div id="scannedPackagesList" style="padding:0 15px 15px;"></div>
                
                <!-- Action buttons -->
                <div id="pkgScanActions" style="display:none;padding:15px;border-top:1px solid rgba(255,255,255,0.1);">
                    <button onclick="clearAllPackages()" style="width:48%;padding:14px;background:#e74c3c;color:#fff;border:none;border-radius:10px;font-size:14px;cursor:pointer;">üóëÔ∏è Clear All</button>
                    <button onclick="goToPkgStep(2)" style="width:48%;padding:14px;background:#0984e3;color:#fff;border:none;border-radius:10px;font-size:14px;cursor:pointer;float:right;">Next: Review ‚Üí</button>
                </div>
            </div>
            
            <!-- Step 2: Review & Edit Addresses -->
            <div id="pkgReviewStep" class="pkg-content-step" style="display:none;">
                <div style="padding:15px;">
                    <div style="font-size:14px;color:#888;margin-bottom:15px;">Review and edit extracted addresses:</div>
                    <div id="pkgAddressReviewList"></div>
                </div>
                <div style="padding:15px;border-top:1px solid rgba(255,255,255,0.1);display:flex;gap:10px;">
                    <button onclick="goToPkgStep(1)" style="flex:1;padding:14px;background:#636e72;color:#fff;border:none;border-radius:10px;font-size:14px;cursor:pointer;">‚Üê Back</button>
                    <button onclick="buildPackageRoute()" style="flex:2;padding:14px;background:#00b894;color:#fff;border:none;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;">üó∫Ô∏è Build Route</button>
                </div>
            </div>
            
            <!-- Step 3: Manifest / Label Packages -->
            <div id="pkgManifestStep" class="pkg-content-step" style="display:none;">
                <div style="padding:15px;background:rgba(0,184,148,0.1);border-bottom:1px solid rgba(255,255,255,0.1);">
                    <div style="font-size:16px;font-weight:600;margin-bottom:5px;">üìã Delivery Manifest</div>
                    <div style="font-size:13px;color:#888;">Label your packages with these stop numbers</div>
                </div>
                <div id="pkgManifestList" style="padding:15px;max-height:50vh;overflow-y:auto;"></div>
                <div style="padding:15px;border-top:1px solid rgba(255,255,255,0.1);display:flex;gap:10px;">
                    <button onclick="goToPkgStep(2)" style="flex:1;padding:14px;background:#636e72;color:#fff;border:none;border-radius:10px;font-size:14px;cursor:pointer;">‚Üê Back</button>
                    <button onclick="startPackageNavigation()" style="flex:2;padding:14px;background:#00b894;color:#fff;border:none;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;">‚ñ∂ Start Navigation</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Package Navigation Full Screen -->
    <div id="pkgNavigationScreen" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:2000;background:#1a1a2e;overflow:hidden;">
        <!-- Map - leave room for panels -->
        <div id="pkgMap" style="position:absolute;top:80px;left:0;right:0;bottom:220px;"></div>
        
        <!-- Top info bar -->
        <div style="position:absolute;top:0;left:0;right:0;height:80px;background:linear-gradient(135deg,#1a1a2e,#16213e);padding:15px;padding-top:max(15px, env(safe-area-inset-top));z-index:20;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div style="flex:1;">
                    <div style="font-size:11px;color:#888;">DELIVERING TO</div>
                    <div id="pkgCurrentAddress" style="font-size:14px;font-weight:600;color:#fff;line-height:1.3;max-height:40px;overflow:hidden;">Loading...</div>
                </div>
                <div style="text-align:right;margin-left:15px;">
                    <div id="pkgStopNum" style="font-size:24px;font-weight:700;color:#00b894;">1</div>
                    <div id="pkgStopTotal" style="font-size:11px;color:#888;">of 0 stops</div>
                </div>
            </div>
        </div>
        
        <!-- Bottom panel with controls and upcoming stops - ALWAYS VISIBLE -->
        <div id="pkgNavBottomPanel" style="position:absolute;bottom:0;left:0;right:0;height:220px;background:#fff;border-radius:20px 20px 0 0;padding:15px;padding-bottom:max(15px, env(safe-area-inset-bottom));z-index:20;box-shadow:0 -5px 20px rgba(0,0,0,0.2);">
            <div style="width:40px;height:4px;background:#ddd;border-radius:2px;margin:0 auto 12px;"></div>
            
            <!-- Controls - ALWAYS VISIBLE -->
            <div id="pkgNavControls" style="display:flex;gap:10px;margin-bottom:12px;">
                <button onclick="markDelivered()" style="flex:2;padding:16px;background:#00b894;color:#fff;border:none;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer;box-shadow:0 3px 10px rgba(0,184,148,0.3);">‚úì Delivered</button>
                <button onclick="skipStop()" style="flex:1;padding:16px;background:#f0f0f0;color:#333;border:none;border-radius:12px;font-size:14px;font-weight:600;cursor:pointer;">Skip</button>
                <button onclick="endPackageNavigation()" style="flex:1;padding:16px;background:#e74c3c;color:#fff;border:none;border-radius:12px;font-size:14px;font-weight:600;cursor:pointer;">End</button>
            </div>
            
            <!-- Upcoming stops -->
            <div style="font-size:11px;color:#888;margin-bottom:8px;font-weight:600;">UPCOMING STOPS</div>
            <div id="pkgUpcomingStops" style="max-height:100px;overflow-y:auto;"></div>
        </div>
    </div>
    
    <!-- Address Selection Modal (for OCR multiple addresses) -->
    <div class="modal" id="addressSelectModal">
        <div class="modal-content" style="max-height:80vh;overflow-y:auto;">
            <div class="modal-title">üìç Select Delivery Address</div>
            <div style="font-size:13px;color:#888;margin-bottom:15px;">Multiple addresses found. Tap the DELIVERY address:</div>
            <div id="addressSelectList"></div>
            <div class="modal-btns" style="margin-top:15px;">
                <button class="modal-btn modal-btn-cancel" onclick="closeModal('addressSelectModal');manualAddressEntry();">Enter Manually</button>
            </div>
        </div>
    </div>
    
    <!-- History Panel -->
    <div class="panel" id="historyPanel">
        <div class="panel-header">
            <button class="panel-back" onclick="closePanel()">‚Üê</button>
            <span class="panel-title">üìä History</span>
        </div>
        <div class="panel-content">
            <div id="historyList"></div>
        </div>
    </div>
    
    <!-- Pay Panel -->
    <div class="panel" id="payPanel">
        <div class="panel-header">
            <button class="panel-back" onclick="closePanel()">‚Üê</button>
            <span class="panel-title">üí∞ Pay Calculator</span>
        </div>
        <div class="panel-content">
            <div class="setting-group">
                <div class="setting-group-title">üíµ Hourly Rate</div>
                <div class="setting-item">
                    <span class="setting-label">Your Hourly Rate</span>
                    <input type="number" class="setting-select" id="payHourlyRate" value="20" style="width:80px;" onchange="savePaySettings()">
                </div>
            </div>
            <div class="setting-group">
                <div class="setting-group-title">‚è±Ô∏è Current Pay Period</div>
                <div class="setting-item">
                    <span class="setting-label">Hours This Period</span>
                    <span class="setting-value" id="payPeriodHours">0.0</span>
                </div>
                <div class="setting-item">
                    <span class="setting-label">Estimated Gross</span>
                    <span class="setting-value" id="payEstimate">$0.00</span>
                </div>
            </div>
            <div class="setting-group">
                <div class="setting-group-title">üìù Enter Previous Hours</div>
                <div style="padding:15px;">
                    <input type="number" class="modal-input" id="prevHours" placeholder="Previous Period Hours">
                    <input type="date" class="modal-input" id="prevDate" style="color:#fff;">
                    <button class="clock-btn" style="width:100%;margin-top:10px;background:#636e72;" onclick="addPreviousHours()">Add to History</button>
                </div>
            </div>
            <div class="setting-group">
                <div class="setting-group-title">üßæ Enter Paycheck</div>
                <div style="padding:15px;">
                    <input type="number" class="modal-input" id="grossPay" placeholder="Gross Pay ($)">
                    <input type="number" class="modal-input" id="netPay" placeholder="Net Pay ($)">
                    <input type="number" class="modal-input" id="dependents" placeholder="Dependents (0-10)">
                    <button class="clock-btn clock-btn-in" style="width:100%;margin-top:10px;" onclick="calculatePay()">Calculate</button>
                </div>
            </div>
            <div class="setting-group">
                <div class="setting-group-title">‚ûï Custom Deductions</div>
                <div style="padding:15px;">
                    <div id="customDeductionsList"></div>
                    <div style="display:flex;gap:10px;margin-top:10px;">
                        <input type="text" class="modal-input" id="deductionName" placeholder="Name (e.g. TSP, Insurance)" style="flex:1;margin:0;">
                        <input type="number" class="modal-input" id="deductionAmount" placeholder="$" style="width:80px;margin:0;">
                    </div>
                    <button class="clock-btn" style="width:100%;margin-top:10px;background:#636e72;" onclick="addDeduction()">Add Deduction</button>
                </div>
            </div>
            <div class="setting-group" id="payBreakdown" style="display:none;">
                <div class="setting-group-title">üìä Breakdown</div>
                <div id="payBreakdownList"></div>
            </div>
        </div>
    </div>
    
    <!-- Settings Panel -->
    <div class="panel" id="settingsPanel">
        <div class="panel-header">
            <button class="panel-back" onclick="closePanel()">‚Üê</button>
            <span class="panel-title">‚öôÔ∏è Settings</span>
        </div>
        <div class="panel-content">
            <div class="setting-group">
                <div class="setting-group-title">Position</div>
                <div class="setting-item">
                    <span class="setting-label">Current Position</span>
                    <select class="setting-select" id="positionSelect" onchange="changePosition()">
                        <option value="carrier">Carrier</option>
                        <option value="clerk">Clerk</option>
                        <option value="204b">204B</option>
                        <option value="supervisor">Supervisor</option>
                    </select>
                </div>
            </div>
            <div class="setting-group">
                <div class="setting-group-title">Office</div>
                <div class="setting-item">
                    <span class="setting-label">Current Office</span>
                    <span class="setting-value" id="settingsOffice">Mansfield</span>
                </div>
                <div class="setting-item" onclick="openOfficeModal()">
                    <span class="setting-label">Change Office</span>
                    <span class="setting-value">‚Üí</span>
                </div>
            </div>
            <div class="setting-group">
                <div class="setting-group-title">Geofence</div>
                <div class="setting-item">
                    <span class="setting-label">Auto Clock Prompt</span>
                    <select class="setting-select" id="geofenceEnabled" onchange="saveSettings()">
                        <option value="on">On</option>
                        <option value="off">Off</option>
                    </select>
                </div>
                <div class="setting-item">
                    <span class="setting-label">Radius</span>
                    <select class="setting-select" id="geofenceRadius" onchange="saveSettings()">
                        <option value="100">100 ft</option>
                        <option value="200">200 ft</option>
                        <option value="500">500 ft</option>
                    </select>
                </div>
            </div>
            <div class="setting-group">
                <div class="setting-group-title">Pay Rate</div>
                <div class="setting-item">
                    <span class="setting-label">Hourly Rate</span>
                    <input type="number" class="setting-select" id="hourlyRate" value="20" style="width:80px;" onchange="saveSettings()">
                </div>
            </div>
            <div class="setting-group" id="clerkLunchSettings" style="display:none;">
                <div class="setting-group-title">Lunch Duration (Clerks)</div>
                <div class="setting-item">
                    <span class="setting-label">Lunch Break Length</span>
                    <select class="setting-select" id="lunchDuration" onchange="saveSettings()">
                        <option value="30">30 Minutes</option>
                        <option value="60">1 Hour</option>
                    </select>
                </div>
            </div>
            <div class="setting-group">
                <div class="setting-group-title">Data</div>
                <div class="setting-item" onclick="exportData()">
                    <span class="setting-label">Export All Data</span>
                    <span class="setting-value">üì§</span>
                </div>
                <div class="setting-item" onclick="clearAllData()">
                    <span class="setting-label" style="color:#e74c3c;">Clear All Data</span>
                    <span class="setting-value">üóëÔ∏è</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Help Panel -->
    <div class="panel" id="helpPanel">
        <div class="panel-header">
            <button class="panel-back" onclick="closePanel()">‚Üê</button>
            <span class="panel-title">‚ùì Help</span>
        </div>
        <div class="panel-content">
            <div class="help-section">
                <div class="help-item" onclick="showHelpTopic('clock')">
                    <div class="help-item-title"><span class="help-item-icon">‚è±Ô∏è</span> Clock In/Out</div>
                </div>
                <div class="help-item" onclick="showHelpTopic('tasks')">
                    <div class="help-item-title"><span class="help-item-icon">üìã</span> Task Tracking</div>
                </div>
                <div class="help-item" onclick="showHelpTopic('greencard')">
                    <div class="help-item-title"><span class="help-item-icon">üì∏</span> Green Card Photo</div>
                </div>
                <div class="help-item" onclick="showHelpTopic('geofence')">
                    <div class="help-item-title"><span class="help-item-icon">üìç</span> Auto Clock-In (GPS)</div>
                </div>
                <div class="help-item" onclick="showHelpTopic('pay')">
                    <div class="help-item-title"><span class="help-item-icon">üí∞</span> Pay Calculator</div>
                </div>
                <div class="help-item" onclick="showHelpTopic('204b')">
                    <div class="help-item-title"><span class="help-item-icon">üëî</span> 204B Tracking</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Position Modal -->
    <div class="modal" id="positionModal">
        <div class="modal-content">
            <div class="modal-title">Select Position</div>
            <div class="task-grid">
                <button class="task-btn" onclick="setPosition('carrier')"><span class="task-btn-icon">üö∂</span>Carrier</button>
                <button class="task-btn" onclick="setPosition('clerk')"><span class="task-btn-icon">üè™</span>Clerk</button>
                <button class="task-btn" onclick="setPosition('204b')"><span class="task-btn-icon">üëî</span>204B</button>
                <button class="task-btn" onclick="setPosition('supervisor')"><span class="task-btn-icon">üë®‚Äçüíº</span>Supervisor</button>
            </div>
            <div class="modal-btns">
                <button class="modal-btn modal-btn-cancel" onclick="closeModal('positionModal')">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Office Modal -->
    <div class="modal" id="officeModal">
        <div class="modal-content">
            <div class="modal-title">Select Office</div>
            <div id="officeList"></div>
            <input type="text" class="modal-input" id="newOffice" placeholder="Or enter new office name...">
            <div class="modal-btns">
                <button class="modal-btn modal-btn-cancel" onclick="closeModal('officeModal')">Cancel</button>
                <button class="modal-btn modal-btn-confirm" onclick="saveNewOffice()">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Time Modal -->
    <div class="modal" id="editTimeModal">
        <div class="modal-content">
            <div class="modal-title">Edit Time</div>
            <p style="font-size:12px;color:#888;margin-bottom:15px;text-align:center;">GPS arrived at: <span id="gpsArrivalTime">--:--</span></p>
            <input type="time" class="modal-input" id="editTimeInput">
            <p style="font-size:11px;color:#e17055;text-align:center;">Edits are logged for accountability</p>
            <div class="modal-btns">
                <button class="modal-btn modal-btn-cancel" onclick="closeModal('editTimeModal')">Cancel</button>
                <button class="modal-btn modal-btn-confirm" onclick="saveEditedTime()">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Geofence Alert -->
    <div class="geo-alert" id="geoAlert">
        <div class="geo-alert-icon">üìç</div>
        <div class="geo-alert-title" id="geoAlertTitle">Arrived at Office</div>
        <div class="geo-alert-subtitle" id="geoAlertSubtitle">Mansfield Post Office</div>
        <div class="geo-alert-btns">
            <button class="geo-alert-btn modal-btn-cancel" onclick="dismissGeoAlert()">Dismiss</button>
            <button class="geo-alert-btn modal-btn-confirm" id="geoAlertAction" onclick="geoAlertAction()">‚è±Ô∏è Clock In</button>
        </div>
    </div>
    
    <!-- Toast -->
    <div class="toast" id="toast"></div>
    
    <!-- Hidden file input for green card -->
    <input type="file" id="greenCardInput" accept="image/*" capture="environment" style="display:none;" onchange="handleGreenCard(event)">

    <script>
    // ==================== ROUTE DATA (1558 entries) ====================
    const ROUTE_DATA = [];
    
    // ==================== TASK DEFINITIONS ====================
    const TASKS = {
        carrier: [
            { id: 'casing', name: 'Casing Mail', icon: 'üì¨', needsRoute: true },
            { id: 'organizing_parcels', name: 'Organizing Parcels', icon: 'üì¶', needsRoute: true },
            { id: 'loading', name: 'Loading Truck', icon: 'üöö', needsRoute: true },
            { id: 'delivering', name: 'Delivering Mail', icon: 'üö∂', needsRoute: true }
        ],
        clerk: [
            { id: 'throwing_parcels', name: 'Throwing Parcels', icon: 'üì¶' },
            { id: 'box_mail_parcels', name: 'Box Mail/Parcels', icon: 'üì¨' },
            { id: 'window', name: 'Window Services', icon: 'ü™ü' },
            { id: 'sorting_letters', name: 'Sorting Letters', icon: '‚úâÔ∏è' },
            { id: 'accountable', name: 'Accountable', icon: 'üìù' },
            { id: 'rfs', name: 'RFS', icon: 'üîÑ' },
            { id: 'pars_dispatch', name: 'PARS Dispatch', icon: 'üöõ' },
            { id: 'training', name: 'Training', icon: 'üìö' },
            { id: 'misc', name: 'Miscellaneous', icon: 'üìã' }
        ],
        '204b': [
            { id: 'custom', name: 'Add Task Entry', icon: '‚úèÔ∏è', isCustom: true }
        ],
        supervisor: [
            { id: 'custom', name: 'Add Task Entry', icon: '‚úèÔ∏è', isCustom: true }
        ]
    };
    
    // ==================== STATE ====================
    const STORE_KEY = 'genesis_timekeeper_basic_v2';
    let state = {
        isClockedIn: false,
        clockInTime: null,
        position: 'carrier',
        office: 'Mansfield',
        offices: ['Mansfield'],
        currentTask: null,
        currentRoute: null,
        taskTimes: {},
        taskStartTime: null,
        entries: [],
        history: [],
        greenCard: null, // Legacy
        greenCardImages: [], // New: array of images
        gpsArrival: null,
        customEntries: [],
        customDeductions: [],
        // Clerk lunch/break tracking
        lunchTaken: false,
        lunchStartTime: null,
        lunchTotalMs: 0,
        break1Taken: false,
        break2Taken: false,
        activeBreakType: null,
        settings: {
            geofenceEnabled: 'on',
            geofenceRadius: '200',
            hourlyRate: 20,
            lunchDuration: 60
        }
    };
    
    let timerInterval = null;
    let geoWatchId = null;
    let officeCoords = null;
    let cvReady = false;
    let breakTimerInterval = null;
    
    function onOpenCvReady() {
        cvReady = true;
        console.log('OpenCV.js loaded');
    }
    
    // ==================== INIT ====================
    document.addEventListener('DOMContentLoaded', () => {
        loadState();
        updateDate();
        renderTasks();
        updateUI();
        startGeofence();
        
        // Update date every minute
        setInterval(updateDate, 60000);
        
        // Persist state every 5 seconds
        setInterval(saveState, 5000);
    });
    
    function loadState() {
        const saved = localStorage.getItem(STORE_KEY);
        if (saved) {
            const parsed = JSON.parse(saved);
            state = { ...state, ...parsed };
            
            // Check if it's a new day
            if (state.clockInTime) {
                const clockInDate = new Date(state.clockInTime).toDateString();
                const today = new Date().toDateString();
                if (clockInDate !== today) {
                    // Auto clock out from yesterday
                    autoClockOutYesterday();
                }
            }
        }
    }
    
    function saveState() {
        localStorage.setItem(STORE_KEY, JSON.stringify(state));
    }
    
    function autoClockOutYesterday() {
        // Save yesterday's data
        const yesterday = {
            date: new Date(state.clockInTime).toDateString(),
            clockIn: state.clockInTime,
            clockOut: new Date(state.clockInTime).setHours(23, 59, 59),
            entries: state.entries,
            taskTimes: state.taskTimes,
            greenCard: state.greenCard
        };
        state.history.push(yesterday);
        
        // Reset for today
        state.isClockedIn = false;
        state.clockInTime = null;
        state.currentTask = null;
        state.taskTimes = {};
        state.taskStartTime = null;
        state.entries = [];
        state.greenCard = null;
        state.gpsArrival = null;
        saveState();
    }
    
    // ==================== UI UPDATES ====================
    function updateDate() {
        const now = new Date();
        const options = { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' };
        document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', options);
    }
    
    function updateUI() {
        // Timer status
        const statusEl = document.getElementById('timerStatus');
        const clockInBtn = document.getElementById('clockInBtn');
        const clockOutBtn = document.getElementById('clockOutBtn');
        const taskSection = document.getElementById('taskSection');
        const breakdownSection = document.getElementById('breakdownSection');
        const clerkBreakSection = document.getElementById('clerkBreakSection');
        const clerkLunchSettings = document.getElementById('clerkLunchSettings');
        
        // Show/hide clerk-specific elements
        const isClerk = state.position === 'clerk';
        clerkBreakSection.style.display = isClerk ? 'block' : 'none';
        clerkLunchSettings.style.display = isClerk ? 'block' : 'none';
        
        if (state.isClockedIn) {
            statusEl.textContent = 'Clocked In';
            statusEl.className = 'timer-status clocked-in';
            clockInBtn.disabled = true;
            clockOutBtn.disabled = false;
            taskSection.style.display = 'block';
            breakdownSection.style.display = 'block';
            startTimer();
            
            // Enable clerk break buttons if clocked in
            if (isClerk) {
                updateClerkBreakButtons();
            }
        } else {
            statusEl.textContent = 'Clocked Out';
            statusEl.className = 'timer-status clocked-out';
            clockInBtn.disabled = false;
            clockOutBtn.disabled = true;
            taskSection.style.display = 'none';
            breakdownSection.style.display = 'none';
            document.getElementById('mainTimer').textContent = '00:00:00';
            stopTimer();
            
            // Disable clerk break buttons
            if (isClerk) {
                document.getElementById('lunchBtn').disabled = true;
                document.getElementById('lunchBtn').style.opacity = '0.5';
                document.getElementById('break1Btn').disabled = true;
                document.getElementById('break1Btn').style.opacity = '0.5';
                document.getElementById('break2Btn').disabled = true;
                document.getElementById('break2Btn').style.opacity = '0.5';
            }
        }
        
        // Position & Office
        document.getElementById('currentPosition').textContent = state.position.charAt(0).toUpperCase() + state.position.slice(1);
        document.getElementById('currentOffice').textContent = state.office;
        document.getElementById('settingsOffice').textContent = state.office;
        document.getElementById('positionSelect').value = state.position;
        
        // Settings
        if (state.settings) {
            document.getElementById('geofenceEnabled').value = state.settings.geofenceEnabled || 'on';
            document.getElementById('geofenceRadius').value = state.settings.geofenceRadius || '200';
            document.getElementById('hourlyRate').value = state.settings.hourlyRate || 20;
            document.getElementById('lunchDuration').value = state.settings.lunchDuration || 60;
        }
        
        renderTaskBreakdown();
        renderEntries();
        renderGreenCardImages();
        renderCustomDeductions();
        updatePayEstimate();
    }
    
    function updateClerkBreakButtons() {
        const lunchBtn = document.getElementById('lunchBtn');
        const break1Btn = document.getElementById('break1Btn');
        const break2Btn = document.getElementById('break2Btn');
        
        // Lunch button
        if (state.lunchTaken || state.activeBreakType) {
            lunchBtn.disabled = true;
            lunchBtn.style.opacity = '0.5';
            if (state.lunchTaken) lunchBtn.textContent = '‚úì Lunch Done';
        } else {
            lunchBtn.disabled = false;
            lunchBtn.style.opacity = '1';
            lunchBtn.textContent = 'üçΩÔ∏è Lunch';
        }
        
        // Break 1 button
        if (state.break1Taken || state.activeBreakType) {
            break1Btn.disabled = true;
            break1Btn.style.opacity = '0.5';
            if (state.break1Taken) break1Btn.textContent = '‚úì Break 1 Done';
        } else {
            break1Btn.disabled = false;
            break1Btn.style.opacity = '1';
            break1Btn.textContent = '‚òï Break 1';
        }
        
        // Break 2 button
        if (state.break2Taken || state.activeBreakType) {
            break2Btn.disabled = true;
            break2Btn.style.opacity = '0.5';
            if (state.break2Taken) break2Btn.textContent = '‚úì Break 2 Done';
        } else {
            break2Btn.disabled = false;
            break2Btn.style.opacity = '1';
            break2Btn.textContent = '‚òï Break 2';
        }
    }
    
    function renderTasks() {
        const tasks = TASKS[state.position] || TASKS.carrier;
        const grid = document.getElementById('taskGrid');
        
        // For 204B/Supervisor show custom entry form
        if (state.position === '204b' || state.position === 'supervisor') {
            grid.innerHTML = `
                <div style="grid-column: 1 / -1; padding: 10px;">
                    <input type="text" id="customTaskInput" placeholder="Enter task description..." 
                           style="width:100%;padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.3);background:rgba(255,255,255,0.1);color:#fff;font-size:14px;margin-bottom:10px;">
                    <button onclick="addCustomTask()" style="width:100%;padding:14px;border:none;border-radius:12px;background:#00b894;color:#fff;font-size:15px;font-weight:600;cursor:pointer;">
                        ‚úèÔ∏è Add Entry
                    </button>
                </div>
            `;
            return;
        }
        
        // For Carriers, show Switch Route button if on a route
        let routeHtml = '';
        if (state.position === 'carrier' && state.currentRoute) {
            routeHtml = `
                <div style="grid-column: 1 / -1; background:rgba(0,184,148,0.2);padding:10px;border-radius:10px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-size:14px;">üìç Route: <strong>${state.currentRoute}</strong></span>
                    <button onclick="switchRoute()" style="padding:8px 15px;border:none;border-radius:8px;background:#0984e3;color:#fff;font-size:13px;cursor:pointer;">üîÑ Switch Route</button>
                </div>
            `;
        }
        
        grid.innerHTML = routeHtml + tasks.map(t => `
            <button class="task-btn ${state.currentTask === t.id ? 'active' : ''}" onclick="selectTask('${t.id}', ${t.needsRoute || false})">
                <span class="task-btn-icon">${t.icon}</span>${t.name}
            </button>
        `).join('');
    }
    
    function renderTaskBreakdown() {
        const list = document.getElementById('breakdownList');
        const tasks = TASKS[state.position] || TASKS.carrier;
        let totalMs = 0;
        
        let html = '';
        
        // For 204B/Supervisor, show custom entries
        if (state.position === '204b' || state.position === 'supervisor') {
            if (state.customEntries && state.customEntries.length > 0) {
                state.customEntries.forEach((entry, i) => {
                    html += `
                        <div class="breakdown-item" style="cursor:pointer;" onclick="removeCustomEntry(${i})">
                            <span>üìù ${entry.text}</span>
                            <span class="breakdown-time" style="color:#888;">${entry.time}</span>
                        </div>
                    `;
                });
            }
            list.innerHTML = html || '<div style="text-align:center;color:#888;padding:10px;">No entries yet. Use the field above to add tasks.</div>';
            document.getElementById('breakdownTotal').textContent = '--';
            return;
        }
        
        tasks.forEach(t => {
            let ms = state.taskTimes[t.id] || 0;
            
            // Add current running time if this is active task
            if (state.currentTask === t.id && state.taskStartTime) {
                ms += Date.now() - state.taskStartTime;
            }
            
            totalMs += ms;
            if (ms > 0) {
                const routeInfo = state.currentRoute && t.needsRoute ? ` (${state.currentRoute})` : '';
                html += `<div class="breakdown-item"><span>${t.icon} ${t.name}${routeInfo}</span><span class="breakdown-time">${formatTime(ms)}</span></div>`;
            }
        });
        
        list.innerHTML = html || '<div style="text-align:center;color:#888;padding:10px;">No tasks recorded yet</div>';
        document.getElementById('breakdownTotal').textContent = formatTime(totalMs);
    }
    
    function addCustomTask() {
        const input = document.getElementById('customTaskInput');
        const text = input.value.trim();
        if (!text) return;
        
        if (!state.customEntries) state.customEntries = [];
        state.customEntries.push({
            text: text,
            time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
            timestamp: Date.now()
        });
        
        state.entries.push({
            icon: 'üìù',
            text: text,
            time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
            timestamp: Date.now(),
            type: 'custom'
        });
        
        input.value = '';
        saveState();
        renderTaskBreakdown();
        renderEntries();
        showToast('Entry added');
    }
    
    function removeCustomEntry(index) {
        if (!confirm('Remove this entry?')) return;
        state.customEntries.splice(index, 1);
        saveState();
        renderTaskBreakdown();
        showToast('Entry removed');
    }
    
    function switchRoute() {
        const newRoute = prompt('Enter new route number:', state.currentRoute || '');
        if (newRoute && newRoute.trim()) {
            const oldRoute = state.currentRoute;
            state.currentRoute = newRoute.trim();
            
            state.entries.push({
                icon: 'üîÑ',
                text: `Switched from Route ${oldRoute} to Route ${state.currentRoute}`,
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                timestamp: Date.now(),
                type: 'route_change'
            });
            
            saveState();
            renderTasks();
            renderEntries();
            showToast(`Switched to Route ${state.currentRoute}`);
        }
    }
    
    function renderEntries() {
        const list = document.getElementById('entriesList');
        if (state.entries.length === 0) {
            list.innerHTML = '<div class="entry-item"><span class="entry-icon">üìù</span><span class="entry-text" style="color:#888;">No entries yet</span></div>';
            return;
        }
        
        list.innerHTML = state.entries.map((e, i) => `
            <div class="entry-item" onclick="editEntry(${i})">
                <span class="entry-icon">${e.icon}</span>
                <span class="entry-text">
                    ${e.text}
                    ${e.edited ? `<span class="entry-edited">(edited from ${e.original})</span>` : ''}
                </span>
                <span class="entry-time">${e.time}</span>
            </div>
        `).join('');
    }
    
    // ==================== TIMER ====================
    function startTimer() {
        if (timerInterval) return;
        updateTimerDisplay();
        timerInterval = setInterval(updateTimerDisplay, 1000);
    }
    
    function stopTimer() {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
    }
    
    function updateTimerDisplay() {
        if (!state.clockInTime) return;
        const elapsed = Date.now() - state.clockInTime;
        document.getElementById('mainTimer').textContent = formatTime(elapsed);
        
        // Update breakdown every 10 seconds
        if (Date.now() % 10000 < 1000) {
            renderTaskBreakdown();
        }
    }
    
    function formatTime(ms) {
        const totalSeconds = Math.floor(ms / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    function formatTimeShort(ms) {
        const totalMinutes = Math.floor(ms / 60000);
        const hours = Math.floor(totalMinutes / 60);
        const minutes = totalMinutes % 60;
        if (hours > 0) {
            return `${hours}h ${minutes}m`;
        }
        return `${minutes}m`;
    }
    
    // ==================== CLOCK IN/OUT ====================
    function clockIn() {
        const now = new Date();
        state.isClockedIn = true;
        state.clockInTime = now.getTime();
        state.taskTimes = {};
        state.entries = [];
        
        // Add GPS arrival if available
        if (state.gpsArrival) {
            state.entries.push({
                icon: 'üìç',
                text: `Arrived at ${state.office}`,
                time: state.gpsArrival,
                type: 'arrival'
            });
        }
        
        // Add clock in entry
        state.entries.push({
            icon: '‚è±Ô∏è',
            text: 'Clocked In',
            time: now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
            timestamp: now.getTime(),
            type: 'clockin'
        });
        
        saveState();
        updateUI();
        renderTasks();
        showToast('Clocked in at ' + now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
    }
    
    function clockOut() {
        if (!state.isClockedIn) return;
        
        // Stop any active break timer
        if (breakTimerInterval) {
            clearInterval(breakTimerInterval);
            breakTimerInterval = null;
        }
        
        // Save current task time
        if (state.currentTask && state.taskStartTime) {
            state.taskTimes[state.currentTask] = (state.taskTimes[state.currentTask] || 0) + (Date.now() - state.taskStartTime);
        }
        
        const now = new Date();
        const totalTime = now.getTime() - state.clockInTime;
        
        // Get the clock in entry to check if it was edited
        const clockInEntry = state.entries.find(e => e.type === 'clockin');
        
        // Add clock out entry
        state.entries.push({
            icon: '‚èπÔ∏è',
            text: `Clocked Out (Total: ${formatTimeShort(totalTime)})`,
            time: now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
            timestamp: now.getTime(),
            type: 'clockout'
        });
        
        // Save to history - use the CURRENT clockInTime (which reflects edits)
        state.history.push({
            date: new Date(state.clockInTime).toDateString(),
            clockIn: state.clockInTime,
            clockInEdited: clockInEntry ? clockInEntry.edited : false,
            clockOut: now.getTime(),
            totalTime: totalTime,
            lunchTime: state.lunchTotalMs || 0, // Track lunch time for pay calculation
            entries: [...state.entries],
            taskTimes: { ...state.taskTimes },
            greenCard: state.greenCard,
            office: state.office,
            position: state.position
        });
        
        // Reset
        state.isClockedIn = false;
        state.clockInTime = null;
        state.currentTask = null;
        state.taskStartTime = null;
        state.gpsArrival = null;
        // Reset lunch/break for next shift
        state.lunchTaken = false;
        state.lunchStartTime = null;
        state.lunchTotalMs = 0;
        state.break1Taken = false;
        state.break2Taken = false;
        state.activeBreakType = null;
        
        saveState();
        updateUI();
        showToast('Clocked out - Total: ' + formatTimeShort(totalTime));
    }
    
    // ==================== CLERK LUNCH & BREAKS ====================
    function startLunch() {
        if (state.lunchTaken || state.activeBreakType) return;
        
        const duration = parseInt(state.settings.lunchDuration) || 60;
        state.activeBreakType = 'lunch';
        state.lunchStartTime = Date.now();
        
        // Add entry
        state.entries.push({
            icon: 'üçΩÔ∏è',
            text: `Lunch Started (${duration} min)`,
            time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
            timestamp: Date.now(),
            type: 'lunch_start'
        });
        
        showBreakTimer('LUNCH TIME', duration * 60);
        saveState();
        updateClerkBreakButtons();
        showToast(`Lunch started - ${duration} minutes`);
    }
    
    function startBreak(breakNum) {
        if ((breakNum === 1 && state.break1Taken) || (breakNum === 2 && state.break2Taken) || state.activeBreakType) return;
        
        state.activeBreakType = `break${breakNum}`;
        
        // Add entry
        state.entries.push({
            icon: '‚òï',
            text: `Break ${breakNum} Started (15 min)`,
            time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
            timestamp: Date.now(),
            type: `break${breakNum}_start`
        });
        
        showBreakTimer(`BREAK ${breakNum}`, 15 * 60);
        saveState();
        updateClerkBreakButtons();
        showToast(`Break ${breakNum} started - 15 minutes`);
    }
    
    function showBreakTimer(label, totalSeconds) {
        const display = document.getElementById('breakTimerDisplay');
        const labelEl = document.getElementById('breakTimerLabel');
        const countdownEl = document.getElementById('breakTimerCountdown');
        
        display.style.display = 'block';
        labelEl.textContent = label;
        
        // Set color based on type
        if (label.includes('LUNCH')) {
            display.style.background = 'rgba(243,156,18,0.2)';
            labelEl.style.color = '#f39c12';
        } else {
            display.style.background = 'rgba(155,89,182,0.2)';
            labelEl.style.color = '#9b59b6';
        }
        
        let remaining = totalSeconds;
        
        function updateCountdown() {
            const mins = Math.floor(remaining / 60);
            const secs = remaining % 60;
            countdownEl.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            
            if (remaining <= 0) {
                endBreakTimer();
            } else {
                remaining--;
            }
        }
        
        updateCountdown();
        breakTimerInterval = setInterval(updateCountdown, 1000);
    }
    
    function endBreakTimer() {
        if (breakTimerInterval) {
            clearInterval(breakTimerInterval);
            breakTimerInterval = null;
        }
        
        const breakType = state.activeBreakType;
        const now = new Date();
        
        if (breakType === 'lunch') {
            state.lunchTaken = true;
            state.lunchTotalMs = Date.now() - state.lunchStartTime;
            
            state.entries.push({
                icon: 'üçΩÔ∏è',
                text: `Lunch Ended`,
                time: now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                timestamp: Date.now(),
                type: 'lunch_end'
            });
            
            showToast('Lunch break ended!');
            if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
            
        } else if (breakType === 'break1') {
            state.break1Taken = true;
            
            state.entries.push({
                icon: '‚òï',
                text: `Break 1 Ended`,
                time: now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                timestamp: Date.now(),
                type: 'break1_end'
            });
            
            showToast('Break 1 ended!');
            if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
            
        } else if (breakType === 'break2') {
            state.break2Taken = true;
            
            state.entries.push({
                icon: '‚òï',
                text: `Break 2 Ended`,
                time: now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                timestamp: Date.now(),
                type: 'break2_end'
            });
            
            showToast('Break 2 ended!');
            if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
        }
        
        state.activeBreakType = null;
        document.getElementById('breakTimerDisplay').style.display = 'none';
        
        saveState();
        updateClerkBreakButtons();
        renderEntries();
    }
    
    function endBreakEarly() {
        if (!state.activeBreakType) return;
        
        if (confirm('End break early?')) {
            endBreakTimer();
        }
    }
    
    // ==================== TASKS ====================
    function selectTask(taskId, needsRoute = false) {
        // For carriers, check if route is needed and not set
        if (needsRoute && state.position === 'carrier' && !state.currentRoute) {
            const route = prompt('Enter route number:');
            if (!route || !route.trim()) {
                showToast('Route number required');
                return;
            }
            state.currentRoute = route.trim();
            
            state.entries.push({
                icon: 'üìç',
                text: `Set to Route ${state.currentRoute}`,
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                timestamp: Date.now(),
                type: 'route_set'
            });
        }
        
        // Save time for previous task
        if (state.currentTask && state.taskStartTime) {
            state.taskTimes[state.currentTask] = (state.taskTimes[state.currentTask] || 0) + (Date.now() - state.taskStartTime);
        }
        
        // Set new task
        state.currentTask = taskId;
        state.taskStartTime = Date.now();
        
        // Get task name
        const tasks = TASKS[state.position] || TASKS.carrier;
        const task = tasks.find(t => t.id === taskId);
        
        // Add entry
        const routeInfo = state.currentRoute && task.needsRoute ? ` (Route ${state.currentRoute})` : '';
        state.entries.push({
            icon: '‚Üí',
            text: `Switched to ${task.name}${routeInfo}`,
            time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
            timestamp: Date.now(),
            type: 'task',
            taskId: taskId,
            route: state.currentRoute
        });
        
        saveState();
        renderTasks();
        renderTaskBreakdown();
        renderEntries();
    }
    
    // ==================== ENTRIES ====================
    function toggleEntries() {
        const list = document.getElementById('entriesList');
        const toggle = document.getElementById('entriesToggle');
        list.classList.toggle('open');
        toggle.classList.toggle('open');
    }
    
    function editEntry(index) {
        const entry = state.entries[index];
        if (entry.type !== 'clockin') return;
        
        document.getElementById('gpsArrivalTime').textContent = state.gpsArrival || '--:--';
        document.getElementById('editTimeInput').value = entry.time.replace(' AM', '').replace(' PM', '');
        document.getElementById('editTimeModal').dataset.index = index;
        document.getElementById('editTimeModal').classList.add('show');
    }
    
    function saveEditedTime() {
        const index = parseInt(document.getElementById('editTimeModal').dataset.index);
        const newTime = document.getElementById('editTimeInput').value;
        const entry = state.entries[index];
        
        if (!entry.edited) {
            entry.original = entry.time;
            entry.originalTimestamp = entry.timestamp;
        }
        entry.edited = true;
        entry.time = newTime;
        
        // CRITICAL FIX: Parse the new time and update the actual clockInTime
        if (entry.type === 'clockin') {
            const [hours, minutes] = newTime.split(':').map(n => parseInt(n));
            const newDate = new Date(state.clockInTime);
            
            let adjustedHours = hours;
            if (newTime.toLowerCase().includes('pm') && hours < 12) {
                adjustedHours = hours + 12;
            } else if (newTime.toLowerCase().includes('am') && hours === 12) {
                adjustedHours = 0;
            }
            
            newDate.setHours(adjustedHours, minutes, 0, 0);
            state.clockInTime = newDate.getTime();
            entry.timestamp = newDate.getTime();
        }
        
        saveState();
        renderEntries();
        updateTimerDisplay();
        closeModal('editTimeModal');
        showToast('Time updated - Timer recalculated');
    }
    
    // ==================== POSITION & OFFICE ====================
    function openPositionModal() {
        document.getElementById('positionModal').classList.add('show');
    }
    
    function setPosition(pos) {
        state.position = pos;
        saveState();
        renderTasks();
        updateUI();
        closeModal('positionModal');
        showToast('Position changed to ' + pos);
    }
    
    function changePosition() {
        state.position = document.getElementById('positionSelect').value;
        saveState();
        renderTasks();
        updateUI();
    }
    
    function openOfficeModal() {
        const list = document.getElementById('officeList');
        list.innerHTML = state.offices.map(o => `
            <button class="task-btn ${state.office === o ? 'active' : ''}" onclick="setOffice('${o}')" style="width:100%;margin-bottom:8px;">
                ${o}
            </button>
        `).join('');
        document.getElementById('officeModal').classList.add('show');
    }
    
    function setOffice(office) {
        state.office = office;
        saveState();
        updateUI();
        closeModal('officeModal');
        showToast('Office set to ' + office);
    }
    
    function saveNewOffice() {
        const name = document.getElementById('newOffice').value.trim();
        if (!name) return;
        
        if (!state.offices.includes(name)) {
            state.offices.push(name);
        }
        state.office = name;
        document.getElementById('newOffice').value = '';
        
        saveState();
        updateUI();
        closeModal('officeModal');
        showToast('Office added: ' + name);
    }
    
    // ==================== ROUTE SEARCH ====================
    function searchRoute() {
        const query = document.getElementById('routeSearchInput').value.trim().toUpperCase();
        const results = document.getElementById('routeResults');
        
        if (query.length < 2) {
            results.innerHTML = '<div style="padding:20px;text-align:center;color:#888;">Type at least 2 characters to search</div>';
            return;
        }
        
        // Parse query - could be "1024" or "1024 Broad" or "Broad"
        const parts = query.split(' ');
        let numQuery = null;
        let strQuery = '';
        
        if (!isNaN(parts[0])) {
            numQuery = parseInt(parts[0]);
            strQuery = parts.slice(1).join(' ');
        } else {
            strQuery = query;
        }
        
        // Search routes
        let matches = ROUTE_DATA.filter(r => {
            let numMatch = true;
            let strMatch = true;
            
            if (numQuery !== null) {
                numMatch = numQuery >= r.s && numQuery <= r.e;
            }
            
            if (strQuery) {
                strMatch = r.n.includes(strQuery);
            }
            
            return numMatch && strMatch;
        });
        
        // Sort by relevance
        matches.sort((a, b) => {
            if (numQuery) {
                // Exact range match first
                const aExact = numQuery >= a.s && numQuery <= a.e;
                const bExact = numQuery >= b.s && numQuery <= b.e;
                if (aExact && !bExact) return -1;
                if (!aExact && bExact) return 1;
            }
            return a.n.localeCompare(b.n);
        });
        
        // Limit results
        matches = matches.slice(0, 20);
        
        if (matches.length === 0) {
            results.innerHTML = '<div style="padding:20px;text-align:center;color:#888;">No routes found</div>';
            return;
        }
        
        results.innerHTML = matches.map(r => {
            const isCity = r.r.startsWith('C');
            const fullAddr = `${r.s}-${r.e} ${r.d ? r.d + ' ' : ''}${r.n} ${r.y}`.trim();
            const routeType = isCity ? 'City Route ' + r.r.substring(1) : 'Rural Route ' + r.r.substring(1);
            
            return `
                <div class="route-result-item" onclick="showRouteDetail('${encodeURIComponent(JSON.stringify(r))}')">
                    <div class="route-result-addr">${r.d ? r.d + ' ' : ''}${r.n} ${r.y}</div>
                    <div class="route-result-range">#${r.s} - ${r.e} ${r.t}</div>
                    <span class="route-result-code ${isCity ? 'city' : 'rural'}">${r.r}</span>
                </div>
            `;
        }).join('');
    }
    
    function showRouteDetail(encoded) {
        const r = JSON.parse(decodeURIComponent(encoded));
        const isCity = r.r.startsWith('C');
        const routeType = isCity ? 'City Route ' + r.r.substring(1) : 'Rural Route ' + r.r.substring(1);
        const addr = `${r.d ? r.d + ' ' : ''}${r.n} ${r.y}`;
        
        document.getElementById('routeResults').innerHTML = `
            <div class="route-detail-card">
                <div class="route-detail-addr">${addr}</div>
                <div style="color:#888;font-size:13px;margin-bottom:15px;">#${r.s} - ${r.e} ${r.t === '(B)' ? '(Both sides)' : r.t === '(E)' ? '(Even only)' : '(Odd only)'}</div>
                <div class="route-detail-code ${isCity ? 'city' : 'rural'}">${r.r}</div>
                <div class="route-detail-type">${routeType}</div>
            </div>
            <button class="clock-btn clock-btn-in" style="width:100%;" onclick="clearRouteSearch()">‚Üê Search Again</button>
        `;
    }
    
    function clearRouteSearch() {
        document.getElementById('routeSearchInput').value = '';
        document.getElementById('routeResults').innerHTML = '<div style="padding:20px;text-align:center;color:#888;">Type an address to search<br><br>Examples:<br>1024<br>1024 Broad<br>Broad St</div>';
    }
    
    // ==================== GREEN CARD / DOCUMENTS ====================
    function captureGreenCard() {
        if (state.greenCardImages.length >= 5) {
            showToast('Maximum 5 images per day');
            return;
        }
        document.getElementById('greenCardInput').click();
    }
    
    async function handleGreenCard(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        showLoading(true);
        
        const reader = new FileReader();
        reader.onload = async (e) => {
            const rawImage = e.target.result;
            
            let processedImage;
            try {
                processedImage = await processDocumentImage(rawImage);
            } catch (err) {
                console.error('Image processing failed:', err);
                processedImage = rawImage;
            }
            
            // Migrate legacy
            if (state.greenCard && !state.greenCardImages.length) {
                state.greenCardImages.push({
                    id: Date.now() - 1000,
                    image: state.greenCard,
                    timestamp: new Date().toISOString()
                });
                state.greenCard = null;
            }
            
            state.greenCardImages.push({
                id: Date.now(),
                image: processedImage,
                timestamp: new Date().toISOString()
            });
            
            saveState();
            renderGreenCardImages();
            showLoading(false);
            showToast('Photo added');
        };
        reader.readAsDataURL(file);
        event.target.value = '';
    }
    
    function renderGreenCardImages() {
        const container = document.getElementById('greencardImages');
        
        if (state.greenCard && !state.greenCardImages.length) {
            state.greenCardImages.push({
                id: Date.now(),
                image: state.greenCard,
                timestamp: new Date().toISOString()
            });
            state.greenCard = null;
            saveState();
        }
        
        if (!state.greenCardImages.length) {
            container.innerHTML = '';
            document.getElementById('greencardBtn').innerHTML = 'üì∑ Add Photo';
            return;
        }
        
        container.innerHTML = `
            <div style="display:flex;gap:8px;flex-wrap:wrap;">
                ${state.greenCardImages.map((img, idx) => `
                    <div style="position:relative;width:calc(50% - 4px);">
                        <img src="${img.image}" 
                             style="width:100%;border-radius:10px;cursor:pointer;" 
                             onclick="viewGreenCard(${idx})"
                             oncontextmenu="event.preventDefault();confirmDeleteImage(${img.id});"
                             ontouchstart="startLongPress(${img.id})"
                             ontouchend="cancelLongPress()">
                        <div style="position:absolute;top:5px;right:5px;background:rgba(0,0,0,0.6);color:#fff;font-size:10px;padding:2px 6px;border-radius:10px;">
                            ${idx === 0 ? 'Green Card' : 'Form ' + idx}
                        </div>
                        <button onclick="confirmDeleteImage(${img.id})" 
                                style="position:absolute;bottom:5px;right:5px;background:#e74c3c;color:#fff;border:none;border-radius:50%;width:24px;height:24px;font-size:12px;cursor:pointer;">
                            üóëÔ∏è
                        </button>
                    </div>
                `).join('')}
            </div>
        `;
        
        document.getElementById('greencardBtn').innerHTML = state.greenCardImages.length >= 5 ? '‚úì Max Photos' : 'üì∑ Add Another Photo';
    }
    
    let longPressTimer = null;
    
    function startLongPress(imageId) {
        longPressTimer = setTimeout(() => confirmDeleteImage(imageId), 600);
    }
    
    function cancelLongPress() {
        clearTimeout(longPressTimer);
    }
    
    function confirmDeleteImage(imageId) {
        cancelLongPress();
        if (confirm('Delete this photo?')) {
            state.greenCardImages = state.greenCardImages.filter(img => img.id !== imageId);
            saveState();
            renderGreenCardImages();
            showToast('Photo deleted');
        }
    }
    
    function viewGreenCard(index) {
        const img = state.greenCardImages[index];
        if (!img) return;
        
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:#000;z-index:500;display:flex;flex-direction:column;';
        modal.innerHTML = `
            <div style="flex:1;display:flex;align-items:center;justify-content:center;overflow:auto;">
                <img src="${img.image}" style="max-width:100%;max-height:100%;">
            </div>
            <div style="display:flex;gap:10px;padding:15px;background:#111;">
                <button onclick="this.closest('div').parentElement.remove()" style="flex:1;padding:12px;background:#333;color:#fff;border:none;border-radius:10px;font-size:14px;">Close</button>
                <button onclick="downloadGreenCard(${index})" style="flex:1;padding:12px;background:#00b894;color:#fff;border:none;border-radius:10px;font-size:14px;">üíæ Save</button>
                <button onclick="confirmDeleteImage(${img.id});this.closest('div').parentElement.remove();" style="flex:1;padding:12px;background:#e74c3c;color:#fff;border:none;border-radius:10px;font-size:14px;">üóëÔ∏è Delete</button>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    function downloadGreenCard(index) {
        const img = state.greenCardImages[index];
        if (!img) return;
        
        const link = document.createElement('a');
        link.download = `greencard_${new Date().toISOString().slice(0,10)}_${index + 1}.jpg`;
        link.href = img.image;
        link.click();
        showToast('Photo saved to downloads');
    }
    
    // OpenCV Document Processing
    async function processDocumentImage(imageData) {
        return new Promise((resolve) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                const maxDim = 1200;
                const scale = Math.min(1, maxDim / Math.max(img.width, img.height));
                canvas.width = img.width * scale;
                canvas.height = img.height * scale;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                if (cvReady && typeof cv !== 'undefined') {
                    try {
                        const result = processWithOpenCV(canvas);
                        resolve(result);
                        return;
                    } catch (e) {
                        console.error('OpenCV failed:', e);
                    }
                }
                
                // Fallback
                const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imgData.data;
                
                let totalBrightness = 0;
                for (let i = 0; i < data.length; i += 4) {
                    totalBrightness += (data[i] + data[i + 1] + data[i + 2]) / 3;
                }
                const avgBrightness = totalBrightness / (data.length / 4);
                
                for (let i = 0; i < data.length; i += 4) {
                    const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                    const threshold = avgBrightness > 180 ? 200 : avgBrightness > 120 ? 160 : 120;
                    let val = gray > threshold ? 255 : (gray > threshold * 0.5 ? Math.min(255, gray * 1.3) : Math.max(0, gray * 0.6));
                    data[i] = data[i + 1] = data[i + 2] = val;
                }
                
                ctx.putImageData(imgData, 0, 0);
                resolve(canvas.toDataURL('image/jpeg', 0.9));
            };
            img.src = imageData;
        });
    }
    
    function processWithOpenCV(canvas) {
        let src = cv.imread(canvas);
        let dst = new cv.Mat();
        let gray = new cv.Mat();
        let blur = new cv.Mat();
        let edges = new cv.Mat();
        
        try {
            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
            cv.GaussianBlur(gray, blur, new cv.Size(5, 5), 0);
            cv.Canny(blur, edges, 50, 150);
            
            let contours = new cv.MatVector();
            let hierarchy = new cv.Mat();
            cv.findContours(edges, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);
            
            let maxArea = 0;
            let docCorners = null;
            
            for (let i = 0; i < contours.size(); i++) {
                let contour = contours.get(i);
                let area = cv.contourArea(contour);
                
                if (area > maxArea && area > (src.rows * src.cols * 0.1)) {
                    let peri = cv.arcLength(contour, true);
                    let approx = new cv.Mat();
                    cv.approxPolyDP(contour, approx, 0.02 * peri, true);
                    
                    if (approx.rows === 4) {
                        maxArea = area;
                        docCorners = [];
                        for (let j = 0; j < 4; j++) {
                            docCorners.push({ x: approx.data32S[j * 2], y: approx.data32S[j * 2 + 1] });
                        }
                    }
                    approx.delete();
                }
            }
            
            if (docCorners) {
                docCorners = orderCorners(docCorners);
                const width = Math.max(distance(docCorners[0], docCorners[1]), distance(docCorners[3], docCorners[2]));
                const height = Math.max(distance(docCorners[0], docCorners[3]), distance(docCorners[1], docCorners[2]));
                
                let srcTri = cv.matFromArray(4, 1, cv.CV_32FC2, [
                    docCorners[0].x, docCorners[0].y, docCorners[1].x, docCorners[1].y,
                    docCorners[2].x, docCorners[2].y, docCorners[3].x, docCorners[3].y
                ]);
                let dstTri = cv.matFromArray(4, 1, cv.CV_32FC2, [0, 0, width, 0, width, height, 0, height]);
                
                let M = cv.getPerspectiveTransform(srcTri, dstTri);
                cv.warpPerspective(src, dst, M, new cv.Size(width, height));
                srcTri.delete(); dstTri.delete(); M.delete();
            } else {
                dst = src.clone();
            }
            
            let enhanced = new cv.Mat();
            cv.cvtColor(dst, gray, cv.COLOR_RGBA2GRAY);
            cv.adaptiveThreshold(gray, enhanced, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY, 21, 10);
            cv.cvtColor(enhanced, dst, cv.COLOR_GRAY2RGBA);
            
            let outputCanvas = document.createElement('canvas');
            cv.imshow(outputCanvas, dst);
            
            contours.delete(); hierarchy.delete(); enhanced.delete();
            return outputCanvas.toDataURL('image/jpeg', 0.9);
        } finally {
            src.delete(); dst.delete(); gray.delete(); blur.delete(); edges.delete();
        }
    }
    
    function orderCorners(corners) {
        corners.sort((a, b) => a.y - b.y);
        let top = corners.slice(0, 2).sort((a, b) => a.x - b.x);
        let bottom = corners.slice(2, 4).sort((a, b) => a.x - b.x);
        return [top[0], top[1], bottom[1], bottom[0]];
    }
    
    function distance(p1, p2) {
        return Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2));
    }
    
    function showLoading(show) {
        let loader = document.getElementById('loadingOverlay');
        if (!loader && show) {
            loader = document.createElement('div');
            loader.id = 'loadingOverlay';
            loader.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:9999;display:flex;align-items:center;justify-content:center;';
            loader.innerHTML = '<div style="color:#fff;font-size:18px;">Processing...</div>';
            document.body.appendChild(loader);
        } else if (loader && !show) {
            loader.remove();
        }
    }
    
    // ==================== GEOFENCE ====================
    function startGeofence() {
        if (!navigator.geolocation) return;
        if (state.settings.geofenceEnabled !== 'on') return;
        
        // For demo, set Mansfield office coords (you'd set this when adding office)
        officeCoords = { lat: 32.5632, lng: -97.1417 }; // Mansfield, TX
        
        geoWatchId = navigator.geolocation.watchPosition(
            checkGeofence,
            (err) => console.log('Geo error:', err),
            { enableHighAccuracy: true, maximumAge: 30000 }
        );
    }
    
    function checkGeofence(position) {
        if (!officeCoords) return;
        
        const dist = getDistance(
            position.coords.latitude,
            position.coords.longitude,
            officeCoords.lat,
            officeCoords.lng
        );
        
        const radiusFeet = parseInt(state.settings.geofenceRadius) || 200;
        const radiusMeters = radiusFeet * 0.3048;
        
        if (dist <= radiusMeters) {
            // Arrived at office
            if (!state.isClockedIn && !state.gpsArrival) {
                state.gpsArrival = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                showGeoAlert('arrive');
            }
        } else {
            // Left office
            if (state.isClockedIn && state.currentTask !== 'delivering') {
                // Only prompt if not on delivery
                // showGeoAlert('leave');
            }
        }
    }
    
    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371000; // meters
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }
    
    function showGeoAlert(type) {
        const alert = document.getElementById('geoAlert');
        const title = document.getElementById('geoAlertTitle');
        const subtitle = document.getElementById('geoAlertSubtitle');
        const action = document.getElementById('geoAlertAction');
        
        if (type === 'arrive') {
            title.textContent = 'üìç Arrived at Office';
            subtitle.textContent = state.office;
            action.textContent = '‚è±Ô∏è Clock In';
            action.onclick = () => { clockIn(); dismissGeoAlert(); };
        } else {
            title.textContent = 'üìç Leaving Office';
            subtitle.textContent = 'Would you like to clock out?';
            action.textContent = '‚èπÔ∏è Clock Out';
            action.onclick = () => { clockOut(); dismissGeoAlert(); };
        }
        
        alert.classList.add('show');
    }
    
    function dismissGeoAlert() {
        document.getElementById('geoAlert').classList.remove('show');
    }
    
    function geoAlertAction() {
        // Handled by dynamic onclick
    }
    
    // ==================== HISTORY ====================
    function renderHistory() {
        const list = document.getElementById('historyList');
        if (state.history.length === 0) {
            list.innerHTML = '<div style="text-align:center;color:#888;padding:40px;">No history yet</div>';
            return;
        }
        
        list.innerHTML = state.history.slice().reverse().map((h, i) => `
            <div class="setting-group" style="margin-bottom:15px;">
                <div class="setting-group-title">${h.date}</div>
                <div class="setting-item">
                    <span>Clock In ${h.clockInEdited ? '<span style="color:#e17055;font-size:10px;">(edited)</span>' : ''}</span>
                    <span class="setting-value">${new Date(h.clockIn).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</span>
                </div>
                <div class="setting-item">
                    <span>Clock Out</span>
                    <span class="setting-value">${new Date(h.clockOut).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</span>
                </div>
                <div class="setting-item">
                    <span>Total</span>
                    <span class="setting-value">${formatTimeShort(h.totalTime)}</span>
                </div>
                <div class="setting-item">
                    <span>Office</span>
                    <span class="setting-value">${h.office || 'N/A'}</span>
                </div>
            </div>
        `).join('');
    }
    
    // ==================== PAY ====================
    function savePaySettings() {
        state.settings.hourlyRate = parseFloat(document.getElementById('payHourlyRate').value) || 20;
        saveState();
        updatePayEstimate();
        showToast('Hourly rate saved');
    }
    
    function updatePayEstimate() {
        // Calculate hours from history in current pay period (last 2 weeks)
        const twoWeeksAgo = Date.now() - (14 * 24 * 60 * 60 * 1000);
        let totalMs = 0;
        let totalLunchMs = 0;
        
        state.history.forEach(h => {
            if (h.clockIn > twoWeeksAgo) {
                totalMs += h.totalTime || 0;
                // Subtract lunch time for clerks (lunch is unpaid)
                if (h.position === 'clerk' && h.lunchTime) {
                    totalLunchMs += h.lunchTime;
                }
            }
        });
        
        // Paid time = total time minus lunch time
        const paidMs = totalMs - totalLunchMs;
        const hours = paidMs / (1000 * 60 * 60);
        const rate = state.settings.hourlyRate || 20;
        const estimate = hours * rate;
        
        document.getElementById('payPeriodHours').textContent = hours.toFixed(1);
        document.getElementById('payEstimate').textContent = '$' + estimate.toFixed(2);
        document.getElementById('payHourlyRate').value = rate;
        
        // Show lunch time deducted if any
        if (totalLunchMs > 0) {
            const lunchHours = (totalLunchMs / (1000 * 60 * 60)).toFixed(1);
            document.getElementById('payPeriodHours').textContent = hours.toFixed(1) + ` (${lunchHours}h lunch deducted)`;
        }
    }
    
    function addPreviousHours() {
        const hours = parseFloat(document.getElementById('prevHours').value);
        const date = document.getElementById('prevDate').value;
        
        if (!hours || !date) {
            showToast('Enter hours and date');
            return;
        }
        
        const dateObj = new Date(date);
        const totalMs = hours * 60 * 60 * 1000;
        
        // Add to history
        state.history.push({
            date: dateObj.toDateString(),
            clockIn: dateObj.getTime(),
            clockOut: dateObj.getTime() + totalMs,
            totalTime: totalMs,
            entries: [],
            taskTimes: {},
            office: state.office,
            position: state.position,
            manualEntry: true
        });
        
        saveState();
        document.getElementById('prevHours').value = '';
        document.getElementById('prevDate').value = '';
        updatePayEstimate();
        showToast('Added ' + hours + ' hours for ' + dateObj.toLocaleDateString());
    }
    
    function addDeduction() {
        const name = document.getElementById('deductionName').value.trim();
        const amount = parseFloat(document.getElementById('deductionAmount').value) || 0;
        
        if (!name || amount <= 0) {
            showToast('Enter name and amount');
            return;
        }
        
        if (!state.customDeductions) {
            state.customDeductions = [];
        }
        
        state.customDeductions.push({ name, amount });
        saveState();
        
        document.getElementById('deductionName').value = '';
        document.getElementById('deductionAmount').value = '';
        
        renderCustomDeductions();
        showToast('Deduction added: ' + name);
    }
    
    function renderCustomDeductions() {
        const list = document.getElementById('customDeductionsList');
        if (!state.customDeductions || state.customDeductions.length === 0) {
            list.innerHTML = '<div style="color:#888;font-size:12px;text-align:center;">No custom deductions</div>';
            return;
        }
        
        list.innerHTML = state.customDeductions.map((d, i) => `
            <div class="setting-item" style="padding:8px 0;">
                <span>${d.name}</span>
                <span style="display:flex;align-items:center;gap:10px;">
                    <span style="color:#e74c3c;">-$${d.amount.toFixed(2)}</span>
                    <button onclick="removeDeduction(${i})" style="background:none;border:none;color:#888;font-size:14px;">‚úï</button>
                </span>
            </div>
        `).join('');
    }
    
    function removeDeduction(index) {
        state.customDeductions.splice(index, 1);
        saveState();
        renderCustomDeductions();
    }
    
    function calculatePay() {
        const gross = parseFloat(document.getElementById('grossPay').value) || 0;
        const net = parseFloat(document.getElementById('netPay').value) || 0;
        const dependents = parseInt(document.getElementById('dependents').value) || 0;
        
        if (gross === 0) {
            showToast('Enter gross pay');
            return;
        }
        
        // Calculate taxes (simplified estimates)
        const fedTax = gross * (0.12 - (dependents * 0.01)); // ~12% base, -1% per dependent
        const stateTax = gross * 0; // Texas has no state tax
        const socialSecurity = gross * 0.062;
        const medicare = gross * 0.0145;
        
        // Calculate custom deductions
        let customTotal = 0;
        let customHtml = '';
        if (state.customDeductions && state.customDeductions.length > 0) {
            state.customDeductions.forEach(d => {
                customTotal += d.amount;
                customHtml += `<div class="setting-item"><span>${d.name}</span><span style="color:#e74c3c;">-$${d.amount.toFixed(2)}</span></div>`;
            });
        }
        
        const totalTax = fedTax + stateTax + socialSecurity + medicare;
        const calculated = gross - totalTax - customTotal;
        
        document.getElementById('payBreakdown').style.display = 'block';
        document.getElementById('payBreakdownList').innerHTML = `
            <div class="setting-item"><span>Gross Pay</span><span class="setting-value">$${gross.toFixed(2)}</span></div>
            <div class="setting-item"><span>Federal Tax (~${(fedTax/gross*100).toFixed(1)}%)</span><span style="color:#e74c3c;">-$${fedTax.toFixed(2)}</span></div>
            <div class="setting-item"><span>Social Security (6.2%)</span><span style="color:#e74c3c;">-$${socialSecurity.toFixed(2)}</span></div>
            <div class="setting-item"><span>Medicare (1.45%)</span><span style="color:#e74c3c;">-$${medicare.toFixed(2)}</span></div>
            <div class="setting-item"><span>State Tax</span><span style="color:#888;">$0 (TX)</span></div>
            ${customHtml}
            <div class="setting-item" style="border-top:2px solid #00b894;margin-top:10px;padding-top:15px;">
                <span><strong>Calculated Net</strong></span>
                <span class="setting-value"><strong>$${calculated.toFixed(2)}</strong></span>
            </div>
            ${net > 0 ? `
            <div class="setting-item">
                <span>Actual Net (entered)</span>
                <span class="setting-value">$${net.toFixed(2)}</span>
            </div>
            <div class="setting-item">
                <span>Difference</span>
                <span style="color:${(calculated - net) > 0 ? '#e74c3c' : '#00b894'};">$${Math.abs(calculated - net).toFixed(2)}</span>
            </div>
            ` : ''}
        `;
    }
    
    // ==================== SETTINGS ====================
    function saveSettings() {
        state.settings.geofenceEnabled = document.getElementById('geofenceEnabled').value;
        state.settings.geofenceRadius = document.getElementById('geofenceRadius').value;
        state.settings.hourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 20;
        state.settings.lunchDuration = parseInt(document.getElementById('lunchDuration').value) || 60;
        saveState();
        
        // Restart geofence if enabled
        if (geoWatchId) {
            navigator.geolocation.clearWatch(geoWatchId);
        }
        if (state.settings.geofenceEnabled === 'on') {
            startGeofence();
        }
    }
    
    function exportData() {
        const data = JSON.stringify(state, null, 2);
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'postal_clock_backup.json';
        a.click();
        showToast('Data exported');
    }
    
    function clearAllData() {
        if (!confirm('Are you sure? This will delete all data!')) return;
        localStorage.removeItem(STORE_KEY);
        location.reload();
    }
    
    // ==================== HELP ====================
    function showHelpTopic(topic) {
        const topics = {
            clock: { title: 'Clock In/Out', content: `
                <p><strong>To Clock In:</strong></p>
                <p>1. Tap the green "Clock In" button</p>
                <p>2. Your timer will start automatically</p>
                <p><strong>To Clock Out:</strong></p>
                <p>1. Tap the red "Clock Out" button</p>
                <p>2. Your day will be saved to history</p>
                <p><strong>Auto Clock-In:</strong></p>
                <p>If GPS is enabled, you'll get a prompt when you arrive at your office.</p>
            `},
            tasks: { title: 'Task Tracking', content: `
                <p><strong>Switching Tasks:</strong></p>
                <p>1. After clocking in, select your current task</p>
                <p>2. Tap a different task when you switch</p>
                <p>3. Time is tracked automatically for each task</p>
                <p><strong>Task Breakdown:</strong></p>
                <p>View how much time you spent on each task in the breakdown section.</p>
            `},
            routes: { title: 'Route Lookup', content: `
                <p><strong>To Find a Route:</strong></p>
                <p>1. Tap the "Routes" tab at the bottom</p>
                <p>2. Type an address number, street name, or both</p>
                <p>3. Tap a result to see the route code</p>
                <p><strong>Examples:</strong></p>
                <p>‚Ä¢ "1024" - shows all streets with that number</p>
                <p>‚Ä¢ "Broad" - shows all Broad streets</p>
                <p>‚Ä¢ "1024 Broad" - finds exact match</p>
            `},
            greencard: { title: 'Green Card Photo', content: `
                <p><strong>Taking a Photo:</strong></p>
                <p>1. Scroll to the Green Card section</p>
                <p>2. Tap "Take Photo of Green Card"</p>
                <p>3. Capture your green card clearly</p>
                <p><strong>Comparing:</strong></p>
                <p>The app shows your tracked data next to your green card photo so you can verify they match.</p>
            `},
            geofence: { title: 'Auto Clock-In (GPS)', content: `
                <p><strong>How it Works:</strong></p>
                <p>When you arrive at your saved office location, the app will prompt you to clock in.</p>
                <p><strong>Settings:</strong></p>
                <p>‚Ä¢ Turn on/off in Settings</p>
                <p>‚Ä¢ Adjust the detection radius (100-500 ft)</p>
                <p><strong>Note:</strong></p>
                <p>The app won't prompt clock out if you're on delivery tasks.</p>
            `},
            pay: { title: 'Pay Calculator', content: `
                <p><strong>To Calculate:</strong></p>
                <p>1. Go to the Pay tab</p>
                <p>2. Enter your gross pay</p>
                <p>3. Optionally enter net pay and dependents</p>
                <p>4. Tap Calculate</p>
                <p><strong>Shows:</strong></p>
                <p>‚Ä¢ Federal tax estimate</p>
                <p>‚Ä¢ Social Security (6.2%)</p>
                <p>‚Ä¢ Medicare (1.45%)</p>
                <p>‚Ä¢ Other deductions (if net entered)</p>
            `},
            '204b': { title: '204B Tracking', content: `
                <p><strong>For 204B/Supervisor:</strong></p>
                <p>1. Change your position in Settings</p>
                <p>2. Add offices you work at</p>
                <p>3. Track time at each office separately</p>
                <p><strong>History:</strong></p>
                <p>View which days you worked as 204B in your history for pay verification.</p>
            `}
        };
        
        const t = topics[topic];
        if (!t) return;
        
        const modal = document.createElement('div');
        modal.className = 'modal show';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-title">${t.title}</div>
                <div style="font-size:14px;line-height:1.6;color:#ccc;">${t.content}</div>
                <div class="modal-btns">
                    <button class="modal-btn modal-btn-confirm" onclick="this.closest('.modal').remove()">Got it</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    // ==================== PANELS & MODALS ====================
    function showPanel(panel) {
        // Update nav
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        event.target.closest('.nav-btn').classList.add('active');
        
        if (panel === 'main') {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('show'));
            return;
        }
        
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('show'));
        document.getElementById(panel + 'Panel').classList.add('show');
        
        if (panel === 'history') renderHistory();
        if (panel === 'routes') clearRouteSearch();
        if (panel === 'packages') {
            // Reload packages from storage in case it was updated
            scannedPackages = JSON.parse(localStorage.getItem(PKG_STORE_KEY) || '[]');
            renderScannedPackages();
        }
    }
    
    function closePanel() {
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('show'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.querySelector('.nav-btn').classList.add('active');
    }
    
    function closeModal(id) {
        document.getElementById(id).classList.remove('show');
    }
    
    function showToast(msg) {
        const toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
    }
    
    // ==================== PACKAGE ROUTE BUILDER ====================
    const PKG_STORE_KEY = 'genesis_delivery_manifest_basic';
    let scannedPackages = JSON.parse(localStorage.getItem(PKG_STORE_KEY) || '[]');
    let packageRoute = [];
    let currentPkgStop = 0;
    let pkgMap = null;
    let pkgRouteLines = [];
    let pkgMarkers = [];
    let userPkgLat = null;
    let userPkgLon = null;
    
    // Step navigation
    function goToPkgStep(step) {
        document.querySelectorAll('.pkg-content-step').forEach(s => s.style.display = 'none');
        document.querySelectorAll('.pkg-step').forEach((s, i) => {
            s.classList.remove('active');
            if (i < step - 1) s.classList.add('completed');
        });
        document.getElementById(`pkgStep${step}`).classList.add('active');
        
        if (step === 1) {
            document.getElementById('pkgScanStep').style.display = 'block';
            renderScannedPackages();
        } else if (step === 2) {
            document.getElementById('pkgReviewStep').style.display = 'block';
            renderAddressReview();
        } else if (step === 3) {
            document.getElementById('pkgManifestStep').style.display = 'block';
            renderManifest();
        }
    }
    
    // Handle package label scan
    let pendingImageData = null;
    let pendingPackageId = null;
    
    async function handlePackageScan(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        showToast('Scanning label... please wait');
        
        const reader = new FileReader();
        reader.onload = async (e) => {
            const imageData = e.target.result;
            pendingImageData = imageData;
            pendingPackageId = Date.now();
            
            try {
                // Try to extract addresses using OCR
                const addresses = await extractAddressesFromImage(imageData);
                
                console.log('Addresses found:', addresses);
                
                if (addresses.length === 0) {
                    // No addresses found - prompt manual entry
                    showToast('No address found. Enter manually.');
                    setTimeout(() => manualAddressEntry(), 500);
                } else if (addresses.length === 1) {
                    // One address found - use it
                    addPackageWithAddress(addresses[0]);
                } else {
                    // Multiple addresses found - let user pick
                    showAddressSelection(addresses);
                }
            } catch (err) {
                console.error('Scan error:', err);
                showToast('Scan error. Enter manually.');
                setTimeout(() => manualAddressEntry(), 500);
            }
        };
        reader.readAsDataURL(file);
        event.target.value = '';
    }
    
    // Real OCR using Tesseract.js
    async function extractAddressesFromImage(imageData) {
        try {
            showToast('Reading text from label...');
            
            // Use Tesseract to extract text
            const result = await Tesseract.recognize(imageData, 'eng', {
                logger: m => {
                    if (m.status === 'recognizing text') {
                        const pct = Math.round(m.progress * 100);
                        if (pct % 20 === 0) showToast(`Scanning... ${pct}%`);
                    }
                }
            });
            
            const text = result.data.text;
            console.log('OCR Result:', text);
            
            showToast('Processing text...');
            
            // Extract addresses from the text
            const addresses = parseAddressesFromText(text);
            
            return addresses;
        } catch (e) {
            console.error('OCR Error:', e);
            showToast('OCR failed. Please enter manually.');
            return [];
        }
    }
    
    // Parse addresses from OCR text
    function parseAddressesFromText(text) {
        const addresses = [];
        const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
        
        // Common US address patterns
        // Look for lines with street numbers + street names
        const streetPattern = /^\d+\s+[\w\s]+(?:st|street|ave|avenue|rd|road|dr|drive|ln|lane|blvd|boulevard|ct|court|way|pl|place|cir|circle)\b/i;
        const cityStateZipPattern = /^[\w\s]+,?\s*[A-Z]{2}\s*\d{5}(-\d{4})?$/i;
        
        let currentAddress = [];
        
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            
            // Check if line looks like a street address
            if (streetPattern.test(line)) {
                // Start a new address
                if (currentAddress.length > 0) {
                    const addr = currentAddress.join(', ');
                    if (addr.length > 10) addresses.push(addr);
                }
                currentAddress = [line];
            }
            // Check if line looks like city, state zip
            else if (cityStateZipPattern.test(line) && currentAddress.length > 0) {
                currentAddress.push(line);
                const addr = currentAddress.join(', ');
                if (addr.length > 10) addresses.push(addr);
                currentAddress = [];
            }
            // Check for apartment/unit numbers to add to current address
            else if (currentAddress.length > 0 && /^(apt|unit|suite|#|ste)\s*\d+/i.test(line)) {
                currentAddress[0] += ' ' + line;
            }
        }
        
        // Add any remaining address
        if (currentAddress.length > 0) {
            const addr = currentAddress.join(', ');
            if (addr.length > 10) addresses.push(addr);
        }
        
        // Also try to find full address patterns in a single line
        const fullAddressPattern = /\d+\s+[\w\s]+(?:st|street|ave|avenue|rd|road|dr|drive|ln|lane|blvd|ct|way|pl|cir)[,.\s]+[\w\s]+,?\s*[A-Z]{2}\s*\d{5}/gi;
        const fullMatches = text.match(fullAddressPattern);
        if (fullMatches) {
            fullMatches.forEach(m => {
                const cleaned = m.replace(/\s+/g, ' ').trim();
                if (!addresses.some(a => a.toLowerCase().includes(cleaned.substring(0, 20).toLowerCase()))) {
                    addresses.push(cleaned);
                }
            });
        }
        
        // Remove duplicates and clean up
        const unique = [...new Set(addresses.map(a => a.replace(/\s+/g, ' ').trim()))];
        
        return unique.filter(a => a.length >= 15); // Minimum address length
    }
    
    // Store found addresses for selection
    let foundAddresses = [];
    
    // Show address selection modal
    function showAddressSelection(addresses) {
        foundAddresses = addresses; // Store for later use
        const list = document.getElementById('addressSelectList');
        list.innerHTML = addresses.map((addr, i) => `
            <div onclick="selectFoundAddressIndex(${i})" style="padding:15px;background:rgba(255,255,255,0.1);border-radius:10px;margin-bottom:10px;cursor:pointer;border:2px solid transparent;transition:all 0.2s;" ontouchstart="this.style.background='rgba(0,184,148,0.3)';this.style.borderColor='#00b894'" ontouchend="this.style.background='rgba(255,255,255,0.1)';this.style.borderColor='transparent'">
                <div style="font-size:14px;font-weight:500;">${addr}</div>
            </div>
        `).join('');
        
        document.getElementById('addressSelectModal').classList.add('show');
    }
    
    function selectFoundAddressIndex(index) {
        const address = foundAddresses[index];
        if (address) {
            closeModal('addressSelectModal');
            addPackageWithAddress(address);
        }
    }
    
    function manualAddressEntry() {
        const address = prompt('Enter the delivery address from the label:');
        if (address && address.trim()) {
            addPackageWithAddress(address.trim());
        } else {
            // Add with empty address for later editing
            addPackageWithAddress('');
        }
    }
    
    function addPackageWithAddress(address) {
        scannedPackages.push({
            id: pendingPackageId || Date.now(),
            image: pendingImageData,
            address: address,
            status: address ? 'extracted' : 'manual',
            timestamp: Date.now()
        });
        
        savePackages();
        renderScannedPackages();
        
        pendingImageData = null;
        pendingPackageId = null;
        
        if (address) {
            showToast('Address added!');
        } else {
            showToast('Package added. Edit address in Review step.');
        }
    }
    
    function savePackages() {
        localStorage.setItem(PKG_STORE_KEY, JSON.stringify(scannedPackages));
    }
    
    function renderScannedPackages() {
        const list = document.getElementById('scannedPackagesList');
        const actions = document.getElementById('pkgScanActions');
        
        if (scannedPackages.length === 0) {
            list.innerHTML = '';
            actions.style.display = 'none';
            return;
        }
        
        actions.style.display = 'flex';
        
        list.innerHTML = scannedPackages.map((pkg, i) => `
            <div class="pkg-scanned-item">
                <img src="${pkg.image}" class="pkg-scanned-thumb" onclick="viewPackageImage(${pkg.id})">
                <div class="pkg-scanned-info">
                    <div class="pkg-scanned-address">${pkg.address || '(No address - tap to edit)'}</div>
                    <div class="pkg-scanned-status">${pkg.status === 'extracted' ? '‚úì Auto-extracted' : '‚úèÔ∏è Needs review'}</div>
                </div>
                <button class="pkg-scanned-delete" onclick="deletePackage(${pkg.id})">‚úï</button>
            </div>
        `).join('');
    }
    
    function deletePackage(id) {
        scannedPackages = scannedPackages.filter(p => p.id !== id);
        savePackages();
        renderScannedPackages();
    }
    
    function clearAllPackages() {
        if (!confirm('Clear all scanned packages?')) return;
        scannedPackages = [];
        savePackages();
        renderScannedPackages();
        showToast('All packages cleared');
    }
    
    function viewPackageImage(id) {
        const pkg = scannedPackages.find(p => p.id === id);
        if (!pkg) return;
        
        const viewer = document.createElement('div');
        viewer.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:#000;z-index:3000;display:flex;flex-direction:column;';
        viewer.innerHTML = `
            <div style="padding:15px;display:flex;justify-content:space-between;align-items:center;">
                <span style="color:#fff;font-weight:600;">Package Label</span>
                <button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:#fff;font-size:28px;">‚úï</button>
            </div>
            <div style="flex:1;display:flex;align-items:center;justify-content:center;padding:10px;">
                <img src="${pkg.image}" style="max-width:100%;max-height:100%;object-fit:contain;">
            </div>
        `;
        document.body.appendChild(viewer);
    }
    
    // Step 2: Review addresses
    function renderAddressReview() {
        const list = document.getElementById('pkgAddressReviewList');
        
        list.innerHTML = scannedPackages.map((pkg, i) => `
            <div class="pkg-address-edit">
                <div style="display:flex;gap:10px;margin-bottom:10px;">
                    <img src="${pkg.image}" style="width:40px;height:40px;border-radius:6px;object-fit:cover;">
                    <div style="flex:1;">
                        <div style="font-size:12px;color:#888;margin-bottom:5px;">Package ${i + 1}</div>
                        <input type="text" class="pkg-address-input" id="pkgAddr${pkg.id}" value="${pkg.address}" placeholder="Enter full address...">
                    </div>
                </div>
            </div>
        `).join('');
    }
    
    // Build optimized route
    async function buildPackageRoute() {
        // Save edited addresses
        scannedPackages.forEach(pkg => {
            const input = document.getElementById(`pkgAddr${pkg.id}`);
            if (input) pkg.address = input.value.trim();
        });
        savePackages();
        
        // Filter out packages without addresses
        const validPackages = scannedPackages.filter(p => p.address);
        
        if (validPackages.length === 0) {
            alert('Please enter at least one address.');
            return;
        }
        
        showToast('Building route...');
        
        // Get user's current location for route optimization
        try {
            const pos = await new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 5000 });
            });
            userPkgLat = pos.coords.latitude;
            userPkgLon = pos.coords.longitude;
        } catch (e) {
            // Default to a central location if GPS fails
            userPkgLat = 32.7157; // Arlington TX area
            userPkgLon = -97.1072;
        }
        
        // Geocode all addresses
        packageRoute = [];
        for (const pkg of validPackages) {
            const coords = await geocodeAddress(pkg.address);
            if (coords) {
                packageRoute.push({
                    ...pkg,
                    lat: coords.lat,
                    lon: coords.lon
                });
            } else {
                showToast(`Could not find: ${pkg.address.substring(0, 30)}...`);
            }
        }
        
        if (packageRoute.length === 0) {
            alert('Could not geocode any addresses. Please check and try again.');
            return;
        }
        
        // Sort by nearest neighbor (simple TSP approximation)
        packageRoute = optimizeRoute(packageRoute);
        
        showToast(`Route built: ${packageRoute.length} stops`);
        goToPkgStep(3);
    }
    
    async function geocodeAddress(address) {
        try {
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`;
            const res = await fetch(url, { headers: { 'User-Agent': 'PostalClock/1.0' } });
            const data = await res.json();
            
            if (data?.length) {
                return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
            }
        } catch (e) {
            console.error('Geocode error:', e);
        }
        return null;
    }
    
    function optimizeRoute(stops) {
        // Simple nearest neighbor algorithm
        const result = [];
        let remaining = [...stops];
        let currentLat = userPkgLat;
        let currentLon = userPkgLon;
        
        while (remaining.length > 0) {
            let nearestIdx = 0;
            let nearestDist = Infinity;
            
            remaining.forEach((stop, i) => {
                const dist = getPkgDistance(currentLat, currentLon, stop.lat, stop.lon);
                if (dist < nearestDist) {
                    nearestDist = dist;
                    nearestIdx = i;
                }
            });
            
            const nearest = remaining.splice(nearestIdx, 1)[0];
            result.push(nearest);
            currentLat = nearest.lat;
            currentLon = nearest.lon;
        }
        
        return result;
    }
    
    function getPkgDistance(lat1, lon1, lat2, lon2) {
        const R = 3959; // Earth radius in miles
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }
    
    // Step 3: Manifest
    function renderManifest() {
        const list = document.getElementById('pkgManifestList');
        
        list.innerHTML = packageRoute.map((stop, i) => `
            <div class="pkg-manifest-item">
                <div class="pkg-manifest-num">${i + 1}</div>
                <div class="pkg-manifest-address">${stop.address}</div>
            </div>
        `).join('');
    }
    
    // Navigation
    function startPackageNavigation() {
        if (packageRoute.length === 0) return;
        
        currentPkgStop = 0;
        document.getElementById('pkgNavigationScreen').style.display = 'block';
        
        // Initialize map
        setTimeout(() => {
            initPackageMap();
            updatePkgNavDisplay();
        }, 100);
    }
    
    function initPackageMap() {
        if (pkgMap) {
            pkgMap.remove();
        }
        
        pkgMap = L.map('pkgMap', {
            zoomControl: false
        }).setView([packageRoute[0].lat, packageRoute[0].lon], 14);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(pkgMap);
        
        // Add markers for all stops
        packageRoute.forEach((stop, i) => {
            const marker = L.marker([stop.lat, stop.lon], {
                icon: L.divIcon({
                    html: `<div style="background:${i === currentPkgStop ? '#00b894' : '#0984e3'};color:#fff;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;border:3px solid #fff;box-shadow:0 2px 5px rgba(0,0,0,0.3);">${i + 1}</div>`,
                    className: '',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                })
            }).addTo(pkgMap);
            pkgMarkers.push(marker);
        });
        
        // Draw route line
        drawPkgRouteLine();
        
        // Fit bounds to show all stops
        const bounds = L.latLngBounds(packageRoute.map(s => [s.lat, s.lon]));
        pkgMap.fitBounds(bounds, { padding: [50, 50] });
    }
    
    async function drawPkgRouteLine() {
        // Clear existing lines
        pkgRouteLines.forEach(l => pkgMap.removeLayer(l));
        pkgRouteLines = [];
        
        // Get route from current position through remaining stops
        const remainingStops = packageRoute.slice(currentPkgStop);
        if (remainingStops.length < 1) return;
        
        // Build waypoints string for OpenRouteService (car route only)
        let coords = [];
        if (userPkgLat && userPkgLon) {
            coords.push([userPkgLon, userPkgLat]);
        }
        remainingStops.forEach(s => coords.push([s.lon, s.lat]));
        
        if (coords.length < 2) return;
        
        try {
            // Use simple polyline connecting points for now
            // In production, use OpenRouteService directions API for actual road route
            const latLngs = coords.map(c => [c[1], c[0]]);
            const line = L.polyline(latLngs, { color: '#0984e3', weight: 4, opacity: 0.8 }).addTo(pkgMap);
            pkgRouteLines.push(line);
        } catch (e) {
            console.error('Route draw error:', e);
        }
    }
    
    function updatePkgNavDisplay() {
        if (currentPkgStop >= packageRoute.length) {
            showToast('All packages delivered! üéâ');
            endPackageNavigation();
            return;
        }
        
        const current = packageRoute[currentPkgStop];
        
        document.getElementById('pkgCurrentAddress').textContent = current.address;
        document.getElementById('pkgStopNum').textContent = currentPkgStop + 1;
        document.getElementById('pkgStopTotal').textContent = `of ${packageRoute.length} stops`;
        
        // Update markers
        pkgMarkers.forEach((marker, i) => {
            const isActive = i === currentPkgStop;
            const isDelivered = i < currentPkgStop;
            marker.setIcon(L.divIcon({
                html: `<div style="background:${isDelivered ? '#888' : (isActive ? '#00b894' : '#0984e3')};color:#fff;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;border:3px solid #fff;box-shadow:0 2px 5px rgba(0,0,0,0.3);">${isDelivered ? '‚úì' : i + 1}</div>`,
                className: '',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            }));
        });
        
        // Center map on current stop
        pkgMap.setView([current.lat, current.lon], 16);
        
        // Render upcoming stops
        renderUpcomingStops();
    }
    
    function renderUpcomingStops() {
        const container = document.getElementById('pkgUpcomingStops');
        const upcoming = packageRoute.slice(currentPkgStop, currentPkgStop + 3);
        
        container.innerHTML = upcoming.map((stop, i) => {
            const stopNum = currentPkgStop + i + 1;
            const isCurrent = i === 0;
            return `
                <div class="pkg-upcoming-item ${isCurrent ? 'current' : ''}">
                    <div class="pkg-upcoming-num">${stopNum}</div>
                    <div class="pkg-upcoming-address">${stop.address}</div>
                </div>
            `;
        }).join('');
        
        if (upcoming.length === 0) {
            container.innerHTML = '<div style="text-align:center;color:#888;padding:20px;">All stops completed!</div>';
        }
    }
    
    function markDelivered() {
        showToast(`Stop ${currentPkgStop + 1} delivered! ‚úì`);
        currentPkgStop++;
        updatePkgNavDisplay();
        drawPkgRouteLine();
    }
    
    function skipStop() {
        if (!confirm('Skip this stop?')) return;
        // Move to end of route
        const skipped = packageRoute.splice(currentPkgStop, 1)[0];
        packageRoute.push(skipped);
        showToast('Stop moved to end of route');
        updatePkgNavDisplay();
        drawPkgRouteLine();
    }
    
    function endPackageNavigation() {
        document.getElementById('pkgNavigationScreen').style.display = 'none';
        if (pkgMap) {
            pkgMap.remove();
            pkgMap = null;
        }
        pkgMarkers = [];
        pkgRouteLines = [];
        
        // Clear packages after navigation ends
        if (currentPkgStop >= packageRoute.length) {
            scannedPackages = [];
            packageRoute = [];
            savePackages();
            goToPkgStep(1);
        }
    }
    </script>
</body>
</html>
