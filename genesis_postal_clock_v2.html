<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>üìÆ Genesis Postal Clock</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); 
            min-height: 100vh; color: #fff; 
        }
        
        .container { max-width: 500px; margin: 0 auto; padding: 15px; padding-top: max(15px, env(safe-area-inset-top)); padding-bottom: 80px; }
        
        /* Header */
        .header { text-align: center; padding: 20px 0; }
        .header-icon { font-size: 50px; margin-bottom: 10px; }
        .header-title { font-size: 22px; font-weight: 700; }
        .header-subtitle { font-size: 12px; color: #888; margin-top: 5px; }
        .header-date { font-size: 14px; color: #00b894; margin-top: 10px; }
        
        /* Main Timer */
        .timer-card { background: rgba(255,255,255,0.1); border-radius: 20px; padding: 25px; margin-bottom: 15px; text-align: center; }
        .timer-label { font-size: 12px; color: #888; margin-bottom: 5px; text-transform: uppercase; }
        .timer-display { font-size: 52px; font-weight: 700; font-family: 'SF Mono', monospace; color: #00ff88; }
        .timer-status { display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: 600; margin-top: 10px; }
        .timer-status.clocked-in { background: #00b894; color: #fff; }
        .timer-status.clocked-out { background: #636e72; color: #fff; }
        
        /* Position & Office */
        .info-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .info-card { flex: 1; background: rgba(255,255,255,0.1); border-radius: 12px; padding: 12px; text-align: center; }
        .info-card-label { font-size: 10px; color: #888; margin-bottom: 3px; }
        .info-card-value { font-size: 14px; font-weight: 600; }
        
        /* Task Selection */
        .task-section { background: rgba(255,255,255,0.1); border-radius: 15px; padding: 15px; margin-bottom: 15px; }
        .task-section-title { font-size: 12px; color: #00b894; margin-bottom: 10px; text-transform: uppercase; font-weight: 600; }
        .task-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .task-btn { padding: 12px 8px; border: 2px solid rgba(255,255,255,0.2); border-radius: 10px; background: transparent; color: #fff; font-size: 12px; cursor: pointer; transition: all 0.2s; }
        .task-btn:active { transform: scale(0.95); }
        .task-btn.active { border-color: #00b894; background: rgba(0,184,148,0.2); }
        .task-btn-icon { font-size: 18px; display: block; margin-bottom: 3px; }
        
        /* Task Breakdown */
        .breakdown-section { background: rgba(255,255,255,0.1); border-radius: 15px; padding: 15px; margin-bottom: 15px; }
        .breakdown-title { font-size: 12px; color: #00b894; margin-bottom: 10px; text-transform: uppercase; font-weight: 600; display: flex; justify-content: space-between; }
        .breakdown-list { max-height: 150px; overflow-y: auto; }
        .breakdown-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 13px; }
        .breakdown-item:last-child { border-bottom: none; }
        .breakdown-time { color: #00ff88; font-weight: 600; font-family: monospace; }
        
        /* Today's Entries */
        .entries-section { background: rgba(255,255,255,0.1); border-radius: 15px; padding: 15px; margin-bottom: 15px; }
        .entries-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .entries-title { font-size: 12px; color: #00b894; text-transform: uppercase; font-weight: 600; }
        .entries-toggle { font-size: 18px; transition: transform 0.3s; }
        .entries-toggle.open { transform: rotate(180deg); }
        .entries-list { max-height: 0; overflow: hidden; transition: max-height 0.3s; }
        .entries-list.open { max-height: 400px; overflow-y: auto; margin-top: 10px; }
        .entry-item { padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 12px; display: flex; align-items: center; gap: 10px; }
        .entry-item:last-child { border-bottom: none; }
        .entry-icon { font-size: 14px; }
        .entry-text { flex: 1; }
        .entry-time { color: #00b894; font-family: monospace; }
        .entry-edited { font-size: 10px; color: #e17055; }
        
        /* Clock Buttons */
        .clock-buttons { display: flex; gap: 10px; margin-bottom: 15px; }
        .clock-btn { flex: 1; padding: 18px; border: none; border-radius: 15px; font-size: 16px; font-weight: 700; cursor: pointer; }
        .clock-btn-in { background: linear-gradient(135deg, #00b894 0%, #00cec9 100%); color: #fff; }
        .clock-btn-out { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: #fff; }
        .clock-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Green Card Section */
        .greencard-section { background: rgba(255,255,255,0.1); border-radius: 15px; padding: 15px; margin-bottom: 15px; }
        .greencard-btn { width: 100%; padding: 15px; border: 2px dashed rgba(255,255,255,0.3); border-radius: 12px; background: transparent; color: #fff; font-size: 14px; cursor: pointer; }
        .greencard-preview { display: flex; gap: 10px; margin-top: 10px; }
        .greencard-preview img { width: 50%; border-radius: 10px; }
        
        /* Bottom Nav */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(26,26,46,0.98); border-top: 1px solid rgba(255,255,255,0.1); display: flex; padding-bottom: max(10px, env(safe-area-inset-bottom)); }
        .nav-btn { flex: 1; padding: 12px 5px; border: none; background: transparent; color: #888; font-size: 10px; cursor: pointer; text-align: center; }
        .nav-btn.active { color: #00b894; }
        .nav-btn-icon { font-size: 20px; display: block; margin-bottom: 2px; }
        
        /* Panels */
        .panel { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); z-index: 100; transform: translateX(100%); transition: transform 0.3s; overflow-y: auto; }
        .panel.show { transform: translateX(0); }
        .panel-header { display: flex; align-items: center; padding: 15px; padding-top: max(15px, env(safe-area-inset-top)); border-bottom: 1px solid rgba(255,255,255,0.1); position: sticky; top: 0; background: rgba(26,26,46,0.98); z-index: 10; }
        .panel-back { background: none; border: none; color: #fff; font-size: 24px; cursor: pointer; margin-right: 15px; }
        .panel-title { font-size: 18px; font-weight: 700; }
        .panel-content { padding: 15px; padding-bottom: 100px; }
        
        /* Route Search */
        .route-search-box { background: #fff; border-radius: 12px; padding: 5px; margin-bottom: 15px; display: flex; }
        .route-search-input { flex: 1; border: none; padding: 12px; font-size: 16px; background: transparent; color: #333; }
        .route-search-input::placeholder { color: #999; }
        .route-search-input:focus { outline: none; }
        .route-search-clear { background: none; border: none; font-size: 18px; padding: 10px; cursor: pointer; color: #999; }
        
        .route-results { background: rgba(255,255,255,0.1); border-radius: 15px; overflow: hidden; }
        .route-result-item { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; }
        .route-result-item:last-child { border-bottom: none; }
        .route-result-item:active { background: rgba(255,255,255,0.1); }
        .route-result-addr { font-size: 15px; font-weight: 600; }
        .route-result-range { font-size: 12px; color: #888; margin-top: 3px; }
        .route-result-code { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 14px; font-weight: 700; margin-top: 8px; }
        .route-result-code.city { background: #0984e3; }
        .route-result-code.rural { background: #00b894; }
        
        .route-detail-card { background: rgba(255,255,255,0.1); border-radius: 20px; padding: 25px; text-align: center; margin-bottom: 20px; }
        .route-detail-addr { font-size: 20px; font-weight: 700; margin-bottom: 15px; }
        .route-detail-code { font-size: 36px; font-weight: 800; padding: 15px 30px; border-radius: 15px; display: inline-block; }
        .route-detail-code.city { background: #0984e3; }
        .route-detail-code.rural { background: #00b894; }
        .route-detail-type { font-size: 14px; color: #888; margin-top: 10px; }
        
        /* Settings */
        .setting-group { background: rgba(255,255,255,0.1); border-radius: 15px; margin-bottom: 15px; overflow: hidden; }
        .setting-group-title { padding: 12px 15px; font-size: 12px; color: #00b894; text-transform: uppercase; font-weight: 600; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .setting-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .setting-item:last-child { border-bottom: none; }
        .setting-label { font-size: 14px; }
        .setting-value { font-size: 14px; color: #00b894; }
        .setting-select { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 8px 12px; color: #fff; font-size: 14px; }
        
        /* Help */
        .help-section { background: rgba(255,255,255,0.1); border-radius: 15px; margin-bottom: 15px; overflow: hidden; }
        .help-item { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; }
        .help-item:last-child { border-bottom: none; }
        .help-item:active { background: rgba(255,255,255,0.05); }
        .help-item-title { font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .help-item-icon { font-size: 18px; }
        
        /* Modals */
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 200; display: none; justify-content: center; align-items: center; padding: 20px; }
        .modal.show { display: flex; }
        .modal-content { background: #1a1a2e; border-radius: 20px; padding: 25px; width: 100%; max-width: 350px; max-height: 80vh; overflow-y: auto; }
        .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 20px; text-align: center; }
        .modal-input { width: 100%; padding: 15px; border: 2px solid rgba(255,255,255,0.2); border-radius: 12px; background: rgba(0,0,0,0.3); color: #fff; font-size: 16px; margin-bottom: 10px; }
        .modal-input:focus { outline: none; border-color: #00b894; }
        .modal-btns { display: flex; gap: 10px; margin-top: 15px; }
        .modal-btn { flex: 1; padding: 15px; border: none; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .modal-btn-cancel { background: rgba(255,255,255,0.1); color: #fff; }
        .modal-btn-confirm { background: #00b894; color: #fff; }
        
        /* Geofence Alert */
        .geo-alert { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1a1a2e; border: 2px solid #00b894; border-radius: 20px; padding: 25px; width: 90%; max-width: 320px; z-index: 300; display: none; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        .geo-alert.show { display: block; animation: popIn 0.3s ease; }
        @keyframes popIn { from { transform: translate(-50%, -50%) scale(0.8); opacity: 0; } to { transform: translate(-50%, -50%) scale(1); opacity: 1; } }
        .geo-alert-icon { font-size: 50px; margin-bottom: 15px; }
        .geo-alert-title { font-size: 18px; font-weight: 700; margin-bottom: 10px; }
        .geo-alert-subtitle { font-size: 14px; color: #888; margin-bottom: 20px; }
        .geo-alert-btns { display: flex; gap: 10px; }
        .geo-alert-btn { flex: 1; padding: 15px; border: none; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; }
        
        /* Toast */
        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 12px 25px; border-radius: 25px; font-size: 14px; z-index: 400; display: none; }
        .toast.show { display: block; animation: fadeInUp 0.3s ease; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateX(-50%) translateY(20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
    </style>
</head>
<body>
    <!-- Main Screen -->
    <div class="container" id="mainScreen">
        <div class="header">
            <div class="header-icon">üìÆ</div>
            <div class="header-title">Genesis Postal Clock</div>
            <div class="header-subtitle">Employee Time Tracker</div>
            <div class="header-date" id="currentDate">Loading...</div>
        </div>
        
        <!-- Main Timer -->
        <div class="timer-card">
            <div class="timer-label">Total Shift Time</div>
            <div class="timer-display" id="mainTimer">00:00:00</div>
            <div class="timer-status clocked-out" id="timerStatus">Clocked Out</div>
        </div>
        
        <!-- Position & Office -->
        <div class="info-row">
            <div class="info-card" onclick="openPositionModal()">
                <div class="info-card-label">Position</div>
                <div class="info-card-value" id="currentPosition">Carrier</div>
            </div>
            <div class="info-card" onclick="openOfficeModal()">
                <div class="info-card-label">Office</div>
                <div class="info-card-value" id="currentOffice">Mansfield</div>
            </div>
        </div>
        
        <!-- Clock Buttons -->
        <div class="clock-buttons">
            <button class="clock-btn clock-btn-in" id="clockInBtn" onclick="clockIn()">‚è±Ô∏è Clock In</button>
            <button class="clock-btn clock-btn-out" id="clockOutBtn" onclick="clockOut()" disabled>‚èπÔ∏è Clock Out</button>
        </div>
        
        <!-- Task Selection -->
        <div class="task-section" id="taskSection" style="display:none;">
            <div class="task-section-title">Current Task</div>
            <div class="task-grid" id="taskGrid"></div>
        </div>
        
        <!-- Task Breakdown -->
        <div class="breakdown-section" id="breakdownSection" style="display:none;">
            <div class="breakdown-title">
                <span>‚è±Ô∏è Time Breakdown</span>
                <span id="breakdownTotal">0:00</span>
            </div>
            <div class="breakdown-list" id="breakdownList"></div>
        </div>
        
        <!-- Today's Entries -->
        <div class="entries-section">
            <div class="entries-header" onclick="toggleEntries()">
                <span class="entries-title">üìã Today's Entries</span>
                <span class="entries-toggle" id="entriesToggle">‚ñº</span>
            </div>
            <div class="entries-list" id="entriesList"></div>
        </div>
        
        <!-- Green Card -->
        <div class="greencard-section">
            <div class="task-section-title">üì∏ Green Card</div>
            <button class="greencard-btn" id="greencardBtn" onclick="captureGreenCard()">
                üì∑ Take Photo of Green Card
            </button>
            <div class="greencard-preview" id="greencardPreview" style="display:none;"></div>
        </div>
    </div>
    
    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <button class="nav-btn active" onclick="showPanel('main')">
            <span class="nav-btn-icon">‚è±Ô∏è</span>Clock
        </button>
        
        <button class="nav-btn" onclick="showPanel('history')">
            <span class="nav-btn-icon">üìä</span>History
        </button>
        <button class="nav-btn" onclick="showPanel('pay')">
            <span class="nav-btn-icon">üí∞</span>Pay
        </button>
        <button class="nav-btn" onclick="showPanel('settings')">
            <span class="nav-btn-icon">‚öôÔ∏è</span>Settings
        </button>
        <button class="nav-btn" onclick="showPanel('help')">
            <span class="nav-btn-icon">‚ùì</span>Help
        </button>
    </div>
    
    <!-- Route Search Panel (Disabled in Public Version) -->
    <div class="panel" id="routesPanel"></div>
    
    <!-- History Panel -->
    <div class="panel" id="historyPanel">
        <div class="panel-header">
            <button class="panel-back" onclick="closePanel()">‚Üê</button>
            <span class="panel-title">üìä History</span>
        </div>
        <div class="panel-content">
            <div id="historyList"></div>
        </div>
    </div>
    
    <!-- Pay Panel -->
    <div class="panel" id="payPanel">
        <div class="panel-header">
            <button class="panel-back" onclick="closePanel()">‚Üê</button>
            <span class="panel-title">üí∞ Pay Calculator</span>
        </div>
        <div class="panel-content">
            <div class="setting-group">
                <div class="setting-group-title">Current Pay Period</div>
                <div class="setting-item">
                    <span class="setting-label">Hours This Period</span>
                    <span class="setting-value" id="payPeriodHours">0.0</span>
                </div>
                <div class="setting-item">
                    <span class="setting-label">Estimated Gross</span>
                    <span class="setting-value" id="payEstimate">$0.00</span>
                </div>
            </div>
            <div class="setting-group">
                <div class="setting-group-title">Enter Paycheck</div>
                <div style="padding:15px;">
                    <input type="number" class="modal-input" id="grossPay" placeholder="Gross Pay ($)">
                    <input type="number" class="modal-input" id="netPay" placeholder="Net Pay ($)">
                    <input type="number" class="modal-input" id="dependents" placeholder="Dependents (0-10)">
                    <button class="clock-btn clock-btn-in" style="width:100%;margin-top:10px;" onclick="calculatePay()">Calculate</button>
                </div>
            </div>
            <div class="setting-group" id="payBreakdown" style="display:none;">
                <div class="setting-group-title">Breakdown</div>
                <div id="payBreakdownList"></div>
            </div>
        </div>
    </div>
    
    <!-- Settings Panel -->
    <div class="panel" id="settingsPanel">
        <div class="panel-header">
            <button class="panel-back" onclick="closePanel()">‚Üê</button>
            <span class="panel-title">‚öôÔ∏è Settings</span>
        </div>
        <div class="panel-content">
            <div class="setting-group">
                <div class="setting-group-title">Position</div>
                <div class="setting-item">
                    <span class="setting-label">Current Position</span>
                    <select class="setting-select" id="positionSelect" onchange="changePosition()">
                        <option value="carrier">Carrier</option>
                        <option value="clerk">Clerk</option>
                        <option value="204b">204B</option>
                        <option value="supervisor">Supervisor</option>
                    </select>
                </div>
            </div>
            <div class="setting-group">
                <div class="setting-group-title">Office</div>
                <div class="setting-item">
                    <span class="setting-label">Current Office</span>
                    <span class="setting-value" id="settingsOffice">Mansfield</span>
                </div>
                <div class="setting-item" onclick="openOfficeModal()">
                    <span class="setting-label">Change Office</span>
                    <span class="setting-value">‚Üí</span>
                </div>
            </div>
            <div class="setting-group">
                <div class="setting-group-title">Geofence</div>
                <div class="setting-item">
                    <span class="setting-label">Auto Clock Prompt</span>
                    <select class="setting-select" id="geofenceEnabled" onchange="saveSettings()">
                        <option value="on">On</option>
                        <option value="off">Off</option>
                    </select>
                </div>
                <div class="setting-item">
                    <span class="setting-label">Radius</span>
                    <select class="setting-select" id="geofenceRadius" onchange="saveSettings()">
                        <option value="100">100 ft</option>
                        <option value="200">200 ft</option>
                        <option value="500">500 ft</option>
                    </select>
                </div>
            </div>
            <div class="setting-group">
                <div class="setting-group-title">Pay Rate</div>
                <div class="setting-item">
                    <span class="setting-label">Hourly Rate</span>
                    <input type="number" class="setting-select" id="hourlyRate" value="20" style="width:80px;" onchange="saveSettings()">
                </div>
            </div>
            <div class="setting-group">
                <div class="setting-group-title">Data</div>
                <div class="setting-item" onclick="exportData()">
                    <span class="setting-label">Export All Data</span>
                    <span class="setting-value">üì§</span>
                </div>
                <div class="setting-item" onclick="clearAllData()">
                    <span class="setting-label" style="color:#e74c3c;">Clear All Data</span>
                    <span class="setting-value">üóëÔ∏è</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Help Panel -->
    <div class="panel" id="helpPanel">
        <div class="panel-header">
            <button class="panel-back" onclick="closePanel()">‚Üê</button>
            <span class="panel-title">‚ùì Help</span>
        </div>
        <div class="panel-content">
            <div class="help-section">
                <div class="help-item" onclick="showHelpTopic('clock')">
                    <div class="help-item-title"><span class="help-item-icon">‚è±Ô∏è</span> Clock In/Out</div>
                </div>
                <div class="help-item" onclick="showHelpTopic('tasks')">
                    <div class="help-item-title"><span class="help-item-icon">üìã</span> Task Tracking</div>
                </div>
                <div class="help-item" onclick="showHelpTopic('routes')">
                    <div class="help-item-title"><span class="help-item-icon">üîç</span> Route Lookup</div>
                </div>
                <div class="help-item" onclick="showHelpTopic('greencard')">
                    <div class="help-item-title"><span class="help-item-icon">üì∏</span> Green Card Photo</div>
                </div>
                <div class="help-item" onclick="showHelpTopic('geofence')">
                    <div class="help-item-title"><span class="help-item-icon">üìç</span> Auto Clock-In (GPS)</div>
                </div>
                <div class="help-item" onclick="showHelpTopic('pay')">
                    <div class="help-item-title"><span class="help-item-icon">üí∞</span> Pay Calculator</div>
                </div>
                <div class="help-item" onclick="showHelpTopic('204b')">
                    <div class="help-item-title"><span class="help-item-icon">üëî</span> 204B Tracking</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Position Modal -->
    <div class="modal" id="positionModal">
        <div class="modal-content">
            <div class="modal-title">Select Position</div>
            <div class="task-grid">
                <button class="task-btn" onclick="setPosition('carrier')"><span class="task-btn-icon">üö∂</span>Carrier</button>
                <button class="task-btn" onclick="setPosition('clerk')"><span class="task-btn-icon">üè™</span>Clerk</button>
                <button class="task-btn" onclick="setPosition('204b')"><span class="task-btn-icon">üëî</span>204B</button>
                <button class="task-btn" onclick="setPosition('supervisor')"><span class="task-btn-icon">üë®‚Äçüíº</span>Supervisor</button>
            </div>
            <div class="modal-btns">
                <button class="modal-btn modal-btn-cancel" onclick="closeModal('positionModal')">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Office Modal -->
    <div class="modal" id="officeModal">
        <div class="modal-content">
            <div class="modal-title">Select Office</div>
            <div id="officeList"></div>
            <input type="text" class="modal-input" id="newOffice" placeholder="Or enter new office name...">
            <div class="modal-btns">
                <button class="modal-btn modal-btn-cancel" onclick="closeModal('officeModal')">Cancel</button>
                <button class="modal-btn modal-btn-confirm" onclick="saveNewOffice()">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Time Modal -->
    <div class="modal" id="editTimeModal">
        <div class="modal-content">
            <div class="modal-title">Edit Time</div>
            <p style="font-size:12px;color:#888;margin-bottom:15px;text-align:center;">GPS arrived at: <span id="gpsArrivalTime">--:--</span></p>
            <input type="time" class="modal-input" id="editTimeInput">
            <p style="font-size:11px;color:#e17055;text-align:center;">Edits are logged for accountability</p>
            <div class="modal-btns">
                <button class="modal-btn modal-btn-cancel" onclick="closeModal('editTimeModal')">Cancel</button>
                <button class="modal-btn modal-btn-confirm" onclick="saveEditedTime()">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Geofence Alert -->
    <div class="geo-alert" id="geoAlert">
        <div class="geo-alert-icon">üìç</div>
        <div class="geo-alert-title" id="geoAlertTitle">Arrived at Office</div>
        <div class="geo-alert-subtitle" id="geoAlertSubtitle">Mansfield Post Office</div>
        <div class="geo-alert-btns">
            <button class="geo-alert-btn modal-btn-cancel" onclick="dismissGeoAlert()">Dismiss</button>
            <button class="geo-alert-btn modal-btn-confirm" id="geoAlertAction" onclick="geoAlertAction()">‚è±Ô∏è Clock In</button>
        </div>
    </div>
    
    <!-- Toast -->
    <div class="toast" id="toast"></div>
    
    <!-- Hidden file input for green card -->
    <input type="file" id="greenCardInput" accept="image/*" capture="environment" style="display:none;" onchange="handleGreenCard(event)">

    <script>
    // ==================== ROUTE DATA (1558 entries) ====================
    const ROUTE_DATA = [];
    
    // ==================== TASK DEFINITIONS ====================
    const TASKS = {
        carrier: [
            { id: 'box_parcels', name: 'Box Parcels', icon: 'üì¶' },
            { id: 'box_letters', name: 'Box Letters', icon: '‚úâÔ∏è' },
            { id: 'throwing', name: 'Throwing', icon: 'üéØ' },
            { id: 'loading', name: 'Loading', icon: 'üöö' },
            { id: 'delivering', name: 'Delivering', icon: 'üö∂' },
            { id: 'misc', name: 'Miscellaneous', icon: 'üìã' }
        ],
        clerk: [
            { id: 'window', name: 'Window Services', icon: 'ü™ü' },
            { id: 'sorting_letters', name: 'Sorting Letters', icon: '‚úâÔ∏è' },
            { id: 'throwing_parcels', name: 'Throwing Parcels', icon: 'üì¶' },
            { id: 'box_section', name: 'Box Section', icon: 'üì¨' },
            { id: 'dispatch', name: 'Dispatch', icon: 'üöõ' },
            { id: 'training', name: 'Training', icon: 'üìö' },
            { id: 'misc', name: 'Miscellaneous', icon: 'üìã' }
        ],
        '204b': [
            { id: 'supervision', name: 'Supervision', icon: 'üëî' },
            { id: 'scheduling', name: 'Scheduling', icon: 'üìÖ' },
            { id: 'training', name: 'Training', icon: 'üìö' },
            { id: 'misc', name: 'Miscellaneous', icon: 'üìã' }
        ],
        supervisor: [
            { id: 'supervision', name: 'Supervision', icon: 'üëî' },
            { id: 'scheduling', name: 'Scheduling', icon: 'üìÖ' },
            { id: 'admin', name: 'Admin', icon: 'üíº' },
            { id: 'misc', name: 'Miscellaneous', icon: 'üìã' }
        ]
    };
    
    // ==================== STATE ====================
    const STORE_KEY = 'postal_clock_pro';
    let state = {
        isClockedIn: false,
        clockInTime: null,
        position: 'carrier',
        office: 'Mansfield',
        offices: ['Mansfield'],
        currentTask: null,
        taskTimes: {},
        taskStartTime: null,
        entries: [],
        history: [],
        greenCard: null,
        gpsArrival: null,
        settings: {
            geofenceEnabled: 'on',
            geofenceRadius: '200',
            hourlyRate: 20
        }
    };
    
    let timerInterval = null;
    let geoWatchId = null;
    let officeCoords = null;
    
    // ==================== INIT ====================
    document.addEventListener('DOMContentLoaded', () => {
        loadState();
        updateDate();
        renderTasks();
        updateUI();
        startGeofence();
        
        // Update date every minute
        setInterval(updateDate, 60000);
        
        // Persist state every 5 seconds
        setInterval(saveState, 5000);
    });
    
    function loadState() {
        const saved = localStorage.getItem(STORE_KEY);
        if (saved) {
            const parsed = JSON.parse(saved);
            state = { ...state, ...parsed };
            
            // Check if it's a new day
            if (state.clockInTime) {
                const clockInDate = new Date(state.clockInTime).toDateString();
                const today = new Date().toDateString();
                if (clockInDate !== today) {
                    // Auto clock out from yesterday
                    autoClockOutYesterday();
                }
            }
        }
    }
    
    function saveState() {
        localStorage.setItem(STORE_KEY, JSON.stringify(state));
    }
    
    function autoClockOutYesterday() {
        // Save yesterday's data
        const yesterday = {
            date: new Date(state.clockInTime).toDateString(),
            clockIn: state.clockInTime,
            clockOut: new Date(state.clockInTime).setHours(23, 59, 59),
            entries: state.entries,
            taskTimes: state.taskTimes,
            greenCard: state.greenCard
        };
        state.history.push(yesterday);
        
        // Reset for today
        state.isClockedIn = false;
        state.clockInTime = null;
        state.currentTask = null;
        state.taskTimes = {};
        state.taskStartTime = null;
        state.entries = [];
        state.greenCard = null;
        state.gpsArrival = null;
        saveState();
    }
    
    // ==================== UI UPDATES ====================
    function updateDate() {
        const now = new Date();
        const options = { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' };
        document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', options);
    }
    
    function updateUI() {
        // Timer status
        const statusEl = document.getElementById('timerStatus');
        const clockInBtn = document.getElementById('clockInBtn');
        const clockOutBtn = document.getElementById('clockOutBtn');
        const taskSection = document.getElementById('taskSection');
        const breakdownSection = document.getElementById('breakdownSection');
        
        if (state.isClockedIn) {
            statusEl.textContent = 'Clocked In';
            statusEl.className = 'timer-status clocked-in';
            clockInBtn.disabled = true;
            clockOutBtn.disabled = false;
            taskSection.style.display = 'block';
            breakdownSection.style.display = 'block';
            startTimer();
        } else {
            statusEl.textContent = 'Clocked Out';
            statusEl.className = 'timer-status clocked-out';
            clockInBtn.disabled = false;
            clockOutBtn.disabled = true;
            taskSection.style.display = 'none';
            breakdownSection.style.display = 'none';
            document.getElementById('mainTimer').textContent = '00:00:00';
            stopTimer();
        }
        
        // Position & Office
        document.getElementById('currentPosition').textContent = state.position.charAt(0).toUpperCase() + state.position.slice(1);
        document.getElementById('currentOffice').textContent = state.office;
        document.getElementById('settingsOffice').textContent = state.office;
        document.getElementById('positionSelect').value = state.position;
        
        // Settings
        if (state.settings) {
            document.getElementById('geofenceEnabled').value = state.settings.geofenceEnabled || 'on';
            document.getElementById('geofenceRadius').value = state.settings.geofenceRadius || '200';
            document.getElementById('hourlyRate').value = state.settings.hourlyRate || 20;
        }
        
        renderTaskBreakdown();
        renderEntries();
    }
    
    function renderTasks() {
        const tasks = TASKS[state.position] || TASKS.carrier;
        const grid = document.getElementById('taskGrid');
        grid.innerHTML = tasks.map(t => `
            <button class="task-btn ${state.currentTask === t.id ? 'active' : ''}" onclick="selectTask('${t.id}')">
                <span class="task-btn-icon">${t.icon}</span>${t.name}
            </button>
        `).join('');
    }
    
    function renderTaskBreakdown() {
        const list = document.getElementById('breakdownList');
        const tasks = TASKS[state.position] || TASKS.carrier;
        let totalMs = 0;
        
        let html = '';
        tasks.forEach(t => {
            let ms = state.taskTimes[t.id] || 0;
            
            // Add current running time if this is active task
            if (state.currentTask === t.id && state.taskStartTime) {
                ms += Date.now() - state.taskStartTime;
            }
            
            totalMs += ms;
            if (ms > 0) {
                html += `<div class="breakdown-item"><span>${t.icon} ${t.name}</span><span class="breakdown-time">${formatTime(ms)}</span></div>`;
            }
        });
        
        list.innerHTML = html || '<div style="text-align:center;color:#888;padding:10px;">No tasks recorded yet</div>';
        document.getElementById('breakdownTotal').textContent = formatTime(totalMs);
    }
    
    function renderEntries() {
        const list = document.getElementById('entriesList');
        if (state.entries.length === 0) {
            list.innerHTML = '<div class="entry-item"><span class="entry-icon">üìù</span><span class="entry-text" style="color:#888;">No entries yet</span></div>';
            return;
        }
        
        list.innerHTML = state.entries.map((e, i) => `
            <div class="entry-item" onclick="editEntry(${i})">
                <span class="entry-icon">${e.icon}</span>
                <span class="entry-text">
                    ${e.text}
                    ${e.edited ? `<span class="entry-edited">(edited from ${e.original})</span>` : ''}
                </span>
                <span class="entry-time">${e.time}</span>
            </div>
        `).join('');
    }
    
    // ==================== TIMER ====================
    function startTimer() {
        if (timerInterval) return;
        updateTimerDisplay();
        timerInterval = setInterval(updateTimerDisplay, 1000);
    }
    
    function stopTimer() {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
    }
    
    function updateTimerDisplay() {
        if (!state.clockInTime) return;
        const elapsed = Date.now() - state.clockInTime;
        document.getElementById('mainTimer').textContent = formatTime(elapsed);
        
        // Update breakdown every 10 seconds
        if (Date.now() % 10000 < 1000) {
            renderTaskBreakdown();
        }
    }
    
    function formatTime(ms) {
        const totalSeconds = Math.floor(ms / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    function formatTimeShort(ms) {
        const totalMinutes = Math.floor(ms / 60000);
        const hours = Math.floor(totalMinutes / 60);
        const minutes = totalMinutes % 60;
        if (hours > 0) {
            return `${hours}h ${minutes}m`;
        }
        return `${minutes}m`;
    }
    
    // ==================== CLOCK IN/OUT ====================
    function clockIn() {
        const now = new Date();
        state.isClockedIn = true;
        state.clockInTime = now.getTime();
        state.taskTimes = {};
        state.entries = [];
        
        // Add GPS arrival if available
        if (state.gpsArrival) {
            state.entries.push({
                icon: 'üìç',
                text: `Arrived at ${state.office}`,
                time: state.gpsArrival,
                type: 'arrival'
            });
        }
        
        // Add clock in entry
        state.entries.push({
            icon: '‚è±Ô∏è',
            text: 'Clocked In',
            time: now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
            timestamp: now.getTime(),
            type: 'clockin'
        });
        
        saveState();
        updateUI();
        renderTasks();
        showToast('Clocked in at ' + now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
    }
    
    function clockOut() {
        if (!state.isClockedIn) return;
        
        // Save current task time
        if (state.currentTask && state.taskStartTime) {
            state.taskTimes[state.currentTask] = (state.taskTimes[state.currentTask] || 0) + (Date.now() - state.taskStartTime);
        }
        
        const now = new Date();
        const totalTime = now.getTime() - state.clockInTime;
        
        // Get the clock in entry to check if it was edited
        const clockInEntry = state.entries.find(e => e.type === 'clockin');
        
        // Add clock out entry
        state.entries.push({
            icon: '‚èπÔ∏è',
            text: `Clocked Out (Total: ${formatTimeShort(totalTime)})`,
            time: now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
            timestamp: now.getTime(),
            type: 'clockout'
        });
        
        // Save to history - use the CURRENT clockInTime (which reflects edits)
        state.history.push({
            date: new Date(state.clockInTime).toDateString(),
            clockIn: state.clockInTime,
            clockInEdited: clockInEntry ? clockInEntry.edited : false,
            clockOut: now.getTime(),
            totalTime: totalTime,
            entries: [...state.entries],
            taskTimes: { ...state.taskTimes },
            greenCard: state.greenCard,
            office: state.office,
            position: state.position
        });
        
        // Reset
        state.isClockedIn = false;
        state.clockInTime = null;
        state.currentTask = null;
        state.taskStartTime = null;
        state.gpsArrival = null;
        
        saveState();
        updateUI();
        showToast('Clocked out - Total: ' + formatTimeShort(totalTime));
    }
    
    // ==================== TASKS ====================
    function selectTask(taskId) {
        // Save time for previous task
        if (state.currentTask && state.taskStartTime) {
            state.taskTimes[state.currentTask] = (state.taskTimes[state.currentTask] || 0) + (Date.now() - state.taskStartTime);
        }
        
        // Set new task
        state.currentTask = taskId;
        state.taskStartTime = Date.now();
        
        // Get task name
        const tasks = TASKS[state.position] || TASKS.carrier;
        const task = tasks.find(t => t.id === taskId);
        
        // Add entry
        state.entries.push({
            icon: '‚Üí',
            text: `Switched to ${task.name}`,
            time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
            timestamp: Date.now(),
            type: 'task',
            taskId: taskId
        });
        
        saveState();
        renderTasks();
        renderTaskBreakdown();
        renderEntries();
    }
    
    // ==================== ENTRIES ====================
    function toggleEntries() {
        const list = document.getElementById('entriesList');
        const toggle = document.getElementById('entriesToggle');
        list.classList.toggle('open');
        toggle.classList.toggle('open');
    }
    
    function editEntry(index) {
        const entry = state.entries[index];
        if (entry.type !== 'clockin') return;
        
        document.getElementById('gpsArrivalTime').textContent = state.gpsArrival || '--:--';
        document.getElementById('editTimeInput').value = entry.time.replace(' AM', '').replace(' PM', '');
        document.getElementById('editTimeModal').dataset.index = index;
        document.getElementById('editTimeModal').classList.add('show');
    }
    
    function saveEditedTime() {
        const index = parseInt(document.getElementById('editTimeModal').dataset.index);
        const newTime = document.getElementById('editTimeInput').value;
        const entry = state.entries[index];
        
        if (!entry.edited) {
            entry.original = entry.time;
            entry.originalTimestamp = entry.timestamp;
        }
        entry.edited = true;
        entry.time = newTime;
        
        // CRITICAL FIX: Parse the new time and update the actual clockInTime
        if (entry.type === 'clockin') {
            const [hours, minutes] = newTime.split(':').map(n => parseInt(n));
            const newDate = new Date(state.clockInTime);
            
            let adjustedHours = hours;
            if (newTime.toLowerCase().includes('pm') && hours < 12) {
                adjustedHours = hours + 12;
            } else if (newTime.toLowerCase().includes('am') && hours === 12) {
                adjustedHours = 0;
            }
            
            newDate.setHours(adjustedHours, minutes, 0, 0);
            state.clockInTime = newDate.getTime();
            entry.timestamp = newDate.getTime();
        }
        
        saveState();
        renderEntries();
        updateTimerDisplay();
        closeModal('editTimeModal');
        showToast('Time updated - Timer recalculated');
    }
    
    // ==================== POSITION & OFFICE ====================
    function openPositionModal() {
        document.getElementById('positionModal').classList.add('show');
    }
    
    function setPosition(pos) {
        state.position = pos;
        saveState();
        renderTasks();
        updateUI();
        closeModal('positionModal');
        showToast('Position changed to ' + pos);
    }
    
    function changePosition() {
        state.position = document.getElementById('positionSelect').value;
        saveState();
        renderTasks();
        updateUI();
    }
    
    function openOfficeModal() {
        const list = document.getElementById('officeList');
        list.innerHTML = state.offices.map(o => `
            <button class="task-btn ${state.office === o ? 'active' : ''}" onclick="setOffice('${o}')" style="width:100%;margin-bottom:8px;">
                ${o}
            </button>
        `).join('');
        document.getElementById('officeModal').classList.add('show');
    }
    
    function setOffice(office) {
        state.office = office;
        saveState();
        updateUI();
        closeModal('officeModal');
        showToast('Office set to ' + office);
    }
    
    function saveNewOffice() {
        const name = document.getElementById('newOffice').value.trim();
        if (!name) return;
        
        if (!state.offices.includes(name)) {
            state.offices.push(name);
        }
        state.office = name;
        document.getElementById('newOffice').value = '';
        
        saveState();
        updateUI();
        closeModal('officeModal');
        showToast('Office added: ' + name);
    }
    
    // ==================== ROUTE SEARCH ====================
    function searchRoute() {
        const query = document.getElementById('routeSearchInput').value.trim().toUpperCase();
        const results = document.getElementById('routeResults');
        
        if (query.length < 2) {
            results.innerHTML = '<div style="padding:20px;text-align:center;color:#888;">Type at least 2 characters to search</div>';
            return;
        }
        
        // Parse query - could be "1024" or "1024 Broad" or "Broad"
        const parts = query.split(' ');
        let numQuery = null;
        let strQuery = '';
        
        if (!isNaN(parts[0])) {
            numQuery = parseInt(parts[0]);
            strQuery = parts.slice(1).join(' ');
        } else {
            strQuery = query;
        }
        
        // Search routes
        let matches = ROUTE_DATA.filter(r => {
            let numMatch = true;
            let strMatch = true;
            
            if (numQuery !== null) {
                numMatch = numQuery >= r.s && numQuery <= r.e;
            }
            
            if (strQuery) {
                strMatch = r.n.includes(strQuery);
            }
            
            return numMatch && strMatch;
        });
        
        // Sort by relevance
        matches.sort((a, b) => {
            if (numQuery) {
                // Exact range match first
                const aExact = numQuery >= a.s && numQuery <= a.e;
                const bExact = numQuery >= b.s && numQuery <= b.e;
                if (aExact && !bExact) return -1;
                if (!aExact && bExact) return 1;
            }
            return a.n.localeCompare(b.n);
        });
        
        // Limit results
        matches = matches.slice(0, 20);
        
        if (matches.length === 0) {
            results.innerHTML = '<div style="padding:20px;text-align:center;color:#888;">No routes found</div>';
            return;
        }
        
        results.innerHTML = matches.map(r => {
            const isCity = r.r.startsWith('C');
            const fullAddr = `${r.s}-${r.e} ${r.d ? r.d + ' ' : ''}${r.n} ${r.y}`.trim();
            const routeType = isCity ? 'City Route ' + r.r.substring(1) : 'Rural Route ' + r.r.substring(1);
            
            return `
                <div class="route-result-item" onclick="showRouteDetail('${encodeURIComponent(JSON.stringify(r))}')">
                    <div class="route-result-addr">${r.d ? r.d + ' ' : ''}${r.n} ${r.y}</div>
                    <div class="route-result-range">#${r.s} - ${r.e} ${r.t}</div>
                    <span class="route-result-code ${isCity ? 'city' : 'rural'}">${r.r}</span>
                </div>
            `;
        }).join('');
    }
    
    function showRouteDetail(encoded) {
        const r = JSON.parse(decodeURIComponent(encoded));
        const isCity = r.r.startsWith('C');
        const routeType = isCity ? 'City Route ' + r.r.substring(1) : 'Rural Route ' + r.r.substring(1);
        const addr = `${r.d ? r.d + ' ' : ''}${r.n} ${r.y}`;
        
        document.getElementById('routeResults').innerHTML = `
            <div class="route-detail-card">
                <div class="route-detail-addr">${addr}</div>
                <div style="color:#888;font-size:13px;margin-bottom:15px;">#${r.s} - ${r.e} ${r.t === '(B)' ? '(Both sides)' : r.t === '(E)' ? '(Even only)' : '(Odd only)'}</div>
                <div class="route-detail-code ${isCity ? 'city' : 'rural'}">${r.r}</div>
                <div class="route-detail-type">${routeType}</div>
            </div>
            <button class="clock-btn clock-btn-in" style="width:100%;" onclick="clearRouteSearch()">‚Üê Search Again</button>
        `;
    }
    
    function clearRouteSearch() {
        document.getElementById('routeSearchInput').value = '';
        document.getElementById('routeResults').innerHTML = '<div style="padding:20px;text-align:center;color:#888;">Type an address to search<br><br>Examples:<br>1024<br>1024 Broad<br>Broad St</div>';
    }
    
    // ==================== GREEN CARD ====================
    function captureGreenCard() {
        document.getElementById('greenCardInput').click();
    }
    
    function handleGreenCard(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            state.greenCard = e.target.result;
            saveState();
            showGreenCardPreview();
            showToast('Green card photo saved');
        };
        reader.readAsDataURL(file);
    }
    
    function showGreenCardPreview() {
        if (!state.greenCard) return;
        
        const preview = document.getElementById('greencardPreview');
        preview.style.display = 'flex';
        preview.innerHTML = `
            <div style="flex:1;">
                <div style="font-size:11px;color:#888;margin-bottom:5px;">App Tracked</div>
                <div style="background:rgba(0,0,0,0.3);border-radius:8px;padding:10px;font-size:11px;">
                    ${state.entries.map(e => `<div>${e.icon} ${e.time} - ${e.text}</div>`).join('')}
                </div>
            </div>
            <div style="flex:1;">
                <div style="font-size:11px;color:#888;margin-bottom:5px;">Green Card</div>
                <img src="${state.greenCard}" style="width:100%;border-radius:8px;" onclick="viewGreenCard()">
            </div>
        `;
        
        document.getElementById('greencardBtn').textContent = 'üì∑ Retake Photo';
    }
    
    function viewGreenCard() {
        // Full screen view
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:#000;z-index:500;display:flex;align-items:center;justify-content:center;';
        modal.innerHTML = `
            <img src="${state.greenCard}" style="max-width:100%;max-height:100%;">
            <button onclick="this.parentElement.remove()" style="position:absolute;top:20px;right:20px;background:#fff;border:none;border-radius:50%;width:40px;height:40px;font-size:20px;cursor:pointer;">‚úï</button>
        `;
        document.body.appendChild(modal);
    }
    
    // ==================== GEOFENCE ====================
    function startGeofence() {
        if (!navigator.geolocation) return;
        if (state.settings.geofenceEnabled !== 'on') return;
        
        // For demo, set Mansfield office coords (you'd set this when adding office)
        officeCoords = { lat: 32.5632, lng: -97.1417 }; // Mansfield, TX
        
        geoWatchId = navigator.geolocation.watchPosition(
            checkGeofence,
            (err) => console.log('Geo error:', err),
            { enableHighAccuracy: true, maximumAge: 30000 }
        );
    }
    
    function checkGeofence(position) {
        if (!officeCoords) return;
        
        const dist = getDistance(
            position.coords.latitude,
            position.coords.longitude,
            officeCoords.lat,
            officeCoords.lng
        );
        
        const radiusFeet = parseInt(state.settings.geofenceRadius) || 200;
        const radiusMeters = radiusFeet * 0.3048;
        
        if (dist <= radiusMeters) {
            // Arrived at office
            if (!state.isClockedIn && !state.gpsArrival) {
                state.gpsArrival = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                showGeoAlert('arrive');
            }
        } else {
            // Left office
            if (state.isClockedIn && state.currentTask !== 'delivering') {
                // Only prompt if not on delivery
                // showGeoAlert('leave');
            }
        }
    }
    
    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371000; // meters
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }
    
    function showGeoAlert(type) {
        const alert = document.getElementById('geoAlert');
        const title = document.getElementById('geoAlertTitle');
        const subtitle = document.getElementById('geoAlertSubtitle');
        const action = document.getElementById('geoAlertAction');
        
        if (type === 'arrive') {
            title.textContent = 'üìç Arrived at Office';
            subtitle.textContent = state.office;
            action.textContent = '‚è±Ô∏è Clock In';
            action.onclick = () => { clockIn(); dismissGeoAlert(); };
        } else {
            title.textContent = 'üìç Leaving Office';
            subtitle.textContent = 'Would you like to clock out?';
            action.textContent = '‚èπÔ∏è Clock Out';
            action.onclick = () => { clockOut(); dismissGeoAlert(); };
        }
        
        alert.classList.add('show');
    }
    
    function dismissGeoAlert() {
        document.getElementById('geoAlert').classList.remove('show');
    }
    
    function geoAlertAction() {
        // Handled by dynamic onclick
    }
    
    // ==================== HISTORY ====================
    function renderHistory() {
        const list = document.getElementById('historyList');
        if (state.history.length === 0) {
            list.innerHTML = '<div style="text-align:center;color:#888;padding:40px;">No history yet</div>';
            return;
        }
        
        list.innerHTML = state.history.slice().reverse().map((h, i) => `
            <div class="setting-group" style="margin-bottom:15px;">
                <div class="setting-group-title">${h.date}</div>
                <div class="setting-item">
                    <span>Clock In ${h.clockInEdited ? '<span style="color:#e17055;font-size:10px;">(edited)</span>' : ''}</span>
                    <span class="setting-value">${new Date(h.clockIn).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</span>
                </div>
                <div class="setting-item">
                    <span>Clock Out</span>
                    <span class="setting-value">${new Date(h.clockOut).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</span>
                </div>
                <div class="setting-item">
                    <span>Total</span>
                    <span class="setting-value">${formatTimeShort(h.totalTime)}</span>
                </div>
                <div class="setting-item">
                    <span>Office</span>
                    <span class="setting-value">${h.office || 'N/A'}</span>
                </div>
            </div>
        `).join('');
    }
    
    // ==================== PAY ====================
    function calculatePay() {
        const gross = parseFloat(document.getElementById('grossPay').value) || 0;
        const net = parseFloat(document.getElementById('netPay').value) || 0;
        const dependents = parseInt(document.getElementById('dependents').value) || 0;
        
        if (gross === 0) {
            showToast('Enter gross pay');
            return;
        }
        
        // Calculate taxes (simplified estimates)
        const fedTax = gross * (0.12 - (dependents * 0.01)); // ~12% base, -1% per dependent
        const stateTax = gross * 0; // Texas has no state tax
        const socialSecurity = gross * 0.062;
        const medicare = gross * 0.0145;
        const totalTax = fedTax + stateTax + socialSecurity + medicare;
        const calculated = gross - totalTax;
        
        document.getElementById('payBreakdown').style.display = 'block';
        document.getElementById('payBreakdownList').innerHTML = `
            <div class="setting-item"><span>Gross Pay</span><span class="setting-value">$${gross.toFixed(2)}</span></div>
            <div class="setting-item"><span>Federal Tax (~${(fedTax/gross*100).toFixed(1)}%)</span><span style="color:#e74c3c;">-$${fedTax.toFixed(2)}</span></div>
            <div class="setting-item"><span>Social Security (6.2%)</span><span style="color:#e74c3c;">-$${socialSecurity.toFixed(2)}</span></div>
            <div class="setting-item"><span>Medicare (1.45%)</span><span style="color:#e74c3c;">-$${medicare.toFixed(2)}</span></div>
            <div class="setting-item"><span>State Tax</span><span style="color:#888;">$0 (TX)</span></div>
            <div class="setting-item" style="border-top:2px solid #00b894;margin-top:10px;padding-top:15px;">
                <span><strong>Calculated Net</strong></span>
                <span class="setting-value"><strong>$${calculated.toFixed(2)}</strong></span>
            </div>
            ${net > 0 ? `
            <div class="setting-item">
                <span>Actual Net (entered)</span>
                <span class="setting-value">$${net.toFixed(2)}</span>
            </div>
            <div class="setting-item">
                <span>Other Deductions</span>
                <span style="color:#e74c3c;">$${(calculated - net).toFixed(2)}</span>
            </div>
            ` : ''}
        `;
    }
    
    // ==================== SETTINGS ====================
    function saveSettings() {
        state.settings.geofenceEnabled = document.getElementById('geofenceEnabled').value;
        state.settings.geofenceRadius = document.getElementById('geofenceRadius').value;
        state.settings.hourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 20;
        saveState();
        
        // Restart geofence if enabled
        if (geoWatchId) {
            navigator.geolocation.clearWatch(geoWatchId);
        }
        if (state.settings.geofenceEnabled === 'on') {
            startGeofence();
        }
    }
    
    function exportData() {
        const data = JSON.stringify(state, null, 2);
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'postal_clock_backup.json';
        a.click();
        showToast('Data exported');
    }
    
    function clearAllData() {
        if (!confirm('Are you sure? This will delete all data!')) return;
        localStorage.removeItem(STORE_KEY);
        location.reload();
    }
    
    // ==================== HELP ====================
    function showHelpTopic(topic) {
        const topics = {
            clock: { title: 'Clock In/Out', content: `
                <p><strong>To Clock In:</strong></p>
                <p>1. Tap the green "Clock In" button</p>
                <p>2. Your timer will start automatically</p>
                <p><strong>To Clock Out:</strong></p>
                <p>1. Tap the red "Clock Out" button</p>
                <p>2. Your day will be saved to history</p>
                <p><strong>Auto Clock-In:</strong></p>
                <p>If GPS is enabled, you'll get a prompt when you arrive at your office.</p>
            `},
            tasks: { title: 'Task Tracking', content: `
                <p><strong>Switching Tasks:</strong></p>
                <p>1. After clocking in, select your current task</p>
                <p>2. Tap a different task when you switch</p>
                <p>3. Time is tracked automatically for each task</p>
                <p><strong>Task Breakdown:</strong></p>
                <p>View how much time you spent on each task in the breakdown section.</p>
            `},
            routes: { title: 'Route Lookup', content: `
                <p><strong>To Find a Route:</strong></p>
                <p>1. Tap the "Routes" tab at the bottom</p>
                <p>2. Type an address number, street name, or both</p>
                <p>3. Tap a result to see the route code</p>
                <p><strong>Examples:</strong></p>
                <p>‚Ä¢ "1024" - shows all streets with that number</p>
                <p>‚Ä¢ "Broad" - shows all Broad streets</p>
                <p>‚Ä¢ "1024 Broad" - finds exact match</p>
            `},
            greencard: { title: 'Green Card Photo', content: `
                <p><strong>Taking a Photo:</strong></p>
                <p>1. Scroll to the Green Card section</p>
                <p>2. Tap "Take Photo of Green Card"</p>
                <p>3. Capture your green card clearly</p>
                <p><strong>Comparing:</strong></p>
                <p>The app shows your tracked data next to your green card photo so you can verify they match.</p>
            `},
            geofence: { title: 'Auto Clock-In (GPS)', content: `
                <p><strong>How it Works:</strong></p>
                <p>When you arrive at your saved office location, the app will prompt you to clock in.</p>
                <p><strong>Settings:</strong></p>
                <p>‚Ä¢ Turn on/off in Settings</p>
                <p>‚Ä¢ Adjust the detection radius (100-500 ft)</p>
                <p><strong>Note:</strong></p>
                <p>The app won't prompt clock out if you're on delivery tasks.</p>
            `},
            pay: { title: 'Pay Calculator', content: `
                <p><strong>To Calculate:</strong></p>
                <p>1. Go to the Pay tab</p>
                <p>2. Enter your gross pay</p>
                <p>3. Optionally enter net pay and dependents</p>
                <p>4. Tap Calculate</p>
                <p><strong>Shows:</strong></p>
                <p>‚Ä¢ Federal tax estimate</p>
                <p>‚Ä¢ Social Security (6.2%)</p>
                <p>‚Ä¢ Medicare (1.45%)</p>
                <p>‚Ä¢ Other deductions (if net entered)</p>
            `},
            '204b': { title: '204B Tracking', content: `
                <p><strong>For 204B/Supervisor:</strong></p>
                <p>1. Change your position in Settings</p>
                <p>2. Add offices you work at</p>
                <p>3. Track time at each office separately</p>
                <p><strong>History:</strong></p>
                <p>View which days you worked as 204B in your history for pay verification.</p>
            `}
        };
        
        const t = topics[topic];
        if (!t) return;
        
        const modal = document.createElement('div');
        modal.className = 'modal show';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-title">${t.title}</div>
                <div style="font-size:14px;line-height:1.6;color:#ccc;">${t.content}</div>
                <div class="modal-btns">
                    <button class="modal-btn modal-btn-confirm" onclick="this.closest('.modal').remove()">Got it</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    // ==================== PANELS & MODALS ====================
    function showPanel(panel) {
        // Update nav
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        event.target.closest('.nav-btn').classList.add('active');
        
        if (panel === 'main') {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('show'));
            return;
        }
        
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('show'));
        document.getElementById(panel + 'Panel').classList.add('show');
        
        if (panel === 'history') renderHistory();
        if (panel === 'routes') clearRouteSearch();
    }
    
    function closePanel() {
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('show'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.querySelector('.nav-btn').classList.add('active');
    }
    
    function closeModal(id) {
        document.getElementById(id).classList.remove('show');
    }
    
    function showToast(msg) {
        const toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
    }
    </script>
</body>
</html>
