<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>üöõ Genesis Trucker GPS</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1a1a2e; height: 100vh; color: #fff; overflow: hidden; }
        .screen { display: none; height: 100vh; width: 100%; }
        .screen.active { display: flex; flex-direction: column; }
        
        .code-screen { justify-content: center; align-items: center; padding: 40px 20px; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); }
        .logo { font-size: 80px; margin-bottom: 20px; }
        .title { font-size: 28px; font-weight: 700; margin-bottom: 10px; text-align: center; }
        .subtitle { color: #aaa; margin-bottom: 10px; text-align: center; }
        .subtitle-punjabi { color: #888; margin-bottom: 30px; text-align: center; font-size: 14px; }
        
        .code-input { width: 100%; max-width: 300px; padding: 18px; font-size: 20px; text-align: center; border: 3px solid #333; border-radius: 15px; background: #111; color: #00ff88; letter-spacing: 3px; text-transform: uppercase; }
        .code-input:focus { outline: none; border-color: #00ff88; }
        
        .btn { width: 100%; max-width: 300px; padding: 18px; margin-top: 15px; border: none; border-radius: 15px; font-size: 18px; font-weight: 700; cursor: pointer; }
        .btn-primary { background: linear-gradient(135deg, #00b894 0%, #00cec9 100%); color: #000; }
        .btn-danger { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: #fff; }
        .btn-blue { background: linear-gradient(135deg, #0984e3 0%, #74b9ff 100%); color: #fff; }
        .error-msg { color: #ff6b6b; margin-top: 15px; text-align: center; display: none; }
        .error-msg.show { display: block; }
        
        .setup-screen { padding: 30px 20px; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); overflow-y: auto; }
        .setup-header { text-align: center; margin-bottom: 30px; }
        .form-card { background: rgba(255,255,255,0.1); border-radius: 15px; padding: 20px; margin-bottom: 15px; max-width: 500px; margin-left: auto; margin-right: auto; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; color: #ccc; }
        .form-input, .form-select { width: 100%; padding: 15px; border: 2px solid rgba(255,255,255,0.2); border-radius: 12px; background: rgba(0,0,0,0.3); color: #fff; font-size: 16px; }
        .form-input:focus, .form-select:focus { outline: none; border-color: #00ff88; }
        
        .main-screen { background: #f0f0f0; position: relative; }
        .top-bar { position: absolute; top: 0; left: 0; right: 0; z-index: 1000; padding: 10px; padding-top: max(10px, env(safe-area-inset-top)); }
        
        .trip-banner { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); border-radius: 10px; padding: 10px 15px; margin-bottom: 10px; display: none; align-items: center; justify-content: space-between; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .trip-banner.show { display: flex; }
        .trip-banner-info { display: flex; align-items: center; gap: 10px; }
        .trip-banner-dot { width: 12px; height: 12px; background: #fff; border-radius: 50%; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .trip-banner-text { font-size: 13px; font-weight: 600; }
        .trip-banner-miles { font-size: 11px; opacity: 0.9; }
        .trip-banner-btn { background: rgba(0,0,0,0.3); border: none; padding: 8px 12px; border-radius: 8px; color: #fff; font-size: 12px; cursor: pointer; }
        
        .direction-box { background: linear-gradient(135deg, #2d3436 0%, #000 100%); border-radius: 15px; padding: 15px; margin-bottom: 10px; display: none; border: 2px solid #00ff88; box-shadow: 0 4px 20px rgba(0,0,0,0.4); }
        .direction-box.show { display: block; }
        .direction-main { display: flex; align-items: center; gap: 15px; }
        .direction-icon { font-size: 40px; }
        .direction-text { font-size: 18px; font-weight: 700; line-height: 1.3; flex: 1; }
        .direction-distance { font-size: 24px; font-weight: 800; color: #00ff88; }
        .direction-punjabi { font-size: 14px; color: #aaa; margin-top: 8px; padding-top: 8px; border-top: 1px solid #333; }
        .nav-stats { display: flex; justify-content: space-around; margin-top: 10px; padding-top: 10px; border-top: 1px solid #333; }
        .nav-stat { text-align: center; }
        .nav-stat-value { font-size: 16px; font-weight: 700; color: #00ff88; }
        .nav-stat-label { font-size: 10px; color: #888; }
        .nav-controls { display: flex; gap: 10px; margin-top: 10px; }
        .nav-btn { flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .nav-btn-voice { background: #0984e3; color: #fff; }
        .nav-btn-voice.active { background: #00b894; }
        .nav-btn-stop { background: #e74c3c; color: #fff; }
        
        .search-container { display: flex; gap: 10px; }
        .search-input { flex: 1; padding: 15px; border: none; border-radius: 12px; background: rgba(255,255,255,0.95); color: #333; font-size: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .search-input::placeholder { color: #888; }
        .search-input:focus { outline: 2px solid #00b894; }
        .search-btn, .menu-btn { padding: 15px; border: none; border-radius: 12px; background: #fff; color: #333; font-size: 18px; cursor: pointer; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .search-btn { background: #00b894; color: #fff; }
        
        #map { position: absolute; top: 0; bottom: 0; left: 0; right: 0; z-index: 1; }
        .bottom-panel { position: absolute; bottom: 0; left: 0; right: 0; z-index: 1000; padding: 10px; padding-bottom: max(10px, env(safe-area-inset-bottom)); }
        
        .quick-menu { background: rgba(255,255,255,0.98); border-radius: 15px; padding: 15px; margin-bottom: 10px; display: none; max-height: 70vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3); color: #333; }
        .quick-menu.show { display: block; }
        .quick-menu-title { font-size: 11px; color: #00b894; margin-bottom: 10px; text-transform: uppercase; font-weight: 700; }
        .quick-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .quick-btn { background: #f0f0f0; border: none; border-radius: 10px; padding: 12px 5px; text-align: center; cursor: pointer; color: #333; }
        .quick-btn.highlight { background: linear-gradient(135deg, #ff9f43 0%, #ee5a24 100%); color: #fff; }
        .quick-btn.red { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: #fff; }
        .quick-btn.green { background: linear-gradient(135deg, #00b894 0%, #00cec9 100%); color: #fff; }
        .quick-btn.blue { background: linear-gradient(135deg, #0984e3 0%, #74b9ff 100%); color: #fff; }
        .quick-icon { font-size: 20px; display: block; }
        .quick-text { font-size: 9px; display: block; margin-top: 3px; }
        .quick-btn.highlight .quick-text, .quick-btn.red .quick-text, .quick-btn.green .quick-text, .quick-btn.blue .quick-text { color: #fff; }
        
        .quick-places { display: flex; gap: 10px; margin-bottom: 15px; }
        .quick-place-btn { flex: 1; background: #f8f8f8; border: 2px solid #ddd; border-radius: 12px; padding: 15px 10px; text-align: center; cursor: pointer; color: #333; }
        .quick-place-btn.set { border-color: #00b894; background: #e8f8f5; }
        .quick-place-btn.not-set { border-style: dashed; opacity: 0.7; }
        .quick-place-icon { font-size: 24px; display: block; margin-bottom: 5px; }
        .quick-place-text { font-size: 12px; font-weight: 600; }
        .quick-place-addr { font-size: 10px; color: #888; margin-top: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .list-section { margin-bottom: 15px; max-height: 120px; overflow-y: auto; }
        .list-item { background: #f0f0f0; border-radius: 8px; padding: 10px 12px; margin-bottom: 6px; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .list-item:active { background: #d4edda; }
        .list-item-icon { font-size: 16px; }
        .list-item-text { flex: 1; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #333; }
        .list-item-action { color: #888; font-size: 14px; padding: 5px; }
        .list-item-action.delete { color: #e74c3c; }
        .list-item-action.fav { color: #f1c40f; }
        .no-items { color: #999; font-size: 12px; text-align: center; padding: 15px; }
        
        .poi-results { background: rgba(255,255,255,0.98); border-radius: 15px; padding: 15px; margin-bottom: 10px; max-height: 300px; overflow-y: auto; display: none; box-shadow: 0 4px 20px rgba(0,0,0,0.3); color: #333; }
        .poi-results.show { display: block; }
        .poi-results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .poi-results-title { font-weight: 600; font-size: 14px; color: #00b894; }
        .poi-results-close { background: none; border: none; color: #333; font-size: 24px; cursor: pointer; }
        .poi-item { background: #f8f8f8; border-radius: 10px; padding: 12px; margin-bottom: 8px; cursor: pointer; }
        .poi-item:active { background: #d4edda; }
        .poi-item-header { display: flex; justify-content: space-between; align-items: center; }
        .poi-item-name { font-weight: 600; font-size: 14px; }
        .poi-item-dist { font-size: 13px; color: #00b894; font-weight: 600; }
        .poi-item-cuisine { font-size: 11px; color: #e67e22; margin-top: 4px; }
        .poi-item-address { font-size: 11px; color: #888; margin-top: 4px; }
        
        .route-info { background: rgba(255,255,255,0.98); border-radius: 15px; padding: 15px; margin-bottom: 10px; display: none; box-shadow: 0 4px 20px rgba(0,0,0,0.3); color: #333; }
        .route-info.show { display: block; }
        .route-dest { font-size: 14px; color: #666; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .route-dest strong { color: #333; font-size: 16px; }
        .route-stats { display: flex; justify-content: space-around; margin-bottom: 15px; }
        .route-stat { text-align: center; }
        .route-stat-value { font-size: 28px; font-weight: 700; color: #00b894; }
        .route-stat-label { font-size: 11px; color: #888; }
        .route-actions { display: flex; gap: 10px; }
        .route-btn { flex: 1; padding: 15px; border: none; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .btn-start-nav { background: linear-gradient(135deg, #00b894 0%, #00cec9 100%); color: #fff; }
        .btn-cancel { background: #ddd; color: #333; }
        
        .panel { position: absolute; top: 0; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.98); z-index: 2000; padding: 20px; padding-top: max(20px, env(safe-area-inset-top)); display: none; overflow-y: auto; color: #333; }
        .panel.show { display: block; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .panel-title { font-size: 20px; font-weight: 700; }
        .panel-close { background: none; border: none; color: #333; font-size: 28px; cursor: pointer; }
        .panel-section { background: #f8f8f8; border-radius: 15px; padding: 15px; margin-bottom: 15px; }
        .panel-section-title { font-weight: 600; margin-bottom: 15px; font-size: 14px; color: #00b894; }
        .setting-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .setting-item:last-child { border-bottom: none; }
        .setting-label { font-size: 14px; }
        .setting-value { color: #00b894; font-size: 13px; font-weight: 600; }
        
        .trip-item { background: #f8f8f8; border-radius: 12px; padding: 15px; margin-bottom: 10px; }
        .trip-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .trip-item-date { font-weight: 600; font-size: 14px; }
        .trip-item-miles { font-size: 18px; font-weight: 700; color: #00b894; }
        .trip-item-details { font-size: 12px; color: #888; }
        .trip-item-states { font-size: 11px; color: #0984e3; margin-top: 8px; }
        
        .ifta-state { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee; }
        .ifta-state:last-child { border-bottom: none; }
        .ifta-state-name { font-weight: 600; }
        .ifta-state-miles { color: #00b894; font-weight: 600; }
        .ifta-total { background: linear-gradient(135deg, #00b894 0%, #00cec9 100%); color: #fff; padding: 15px; border-radius: 12px; margin-top: 15px; display: flex; justify-content: space-between; font-weight: 700; }
        
        .loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 500; background: rgba(255,255,255,0.95); padding: 30px; border-radius: 15px; display: none; color: #333; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        .loading.show { display: block; }
        .spinner { width: 50px; height: 50px; border: 4px solid #eee; border-top: 4px solid #00b894; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .truck-marker { font-size: 32px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        .poi-marker { font-size: 24px; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); }
        .dest-marker { font-size: 28px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        
        .export-btns { display: flex; gap: 10px; margin-top: 15px; }
        .export-btn { flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 13px; font-weight: 600; cursor: pointer; }
        
        .map-style-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .map-style-btn { padding: 12px; border: 2px solid #ddd; border-radius: 10px; text-align: center; cursor: pointer; background: #fff; }
        .map-style-btn.active { border-color: #00b894; background: #e8f8f5; }
        .map-style-name { font-weight: 600; font-size: 13px; }
        .map-style-preview { font-size: 10px; color: #888; margin-top: 3px; }
    </style>
</head>
<body>
    <!-- SCREEN 1: CODE -->
    <div id="codeScreen" class="screen active code-screen">
        <div class="logo">üöõ</div>
        <div class="title">Genesis Trucker GPS</div>
        <div class="subtitle">Full Navigation + IFTA Tracking</div>
        <div class="subtitle-punjabi">‡®™‡©Ç‡®∞‡©Ä ‡®®‡©à‡®µ‡©Ä‡®ó‡©á‡®∏‡®º‡®® + IFTA ‡®ü‡®∞‡©à‡®ï‡®ø‡©∞‡®ó</div>
        <input type="text" class="code-input" id="inviteCode" placeholder="Enter code">
        <button class="btn btn-primary" onclick="validateCode()">üîì Enter</button>
        <div class="error-msg" id="codeError">‚ùå Invalid code</div>
    </div>
    
    <!-- SCREEN 2: SETUP -->
    <div id="setupScreen" class="screen setup-screen">
        <div class="setup-header">
            <div style="font-size:60px; margin-bottom:15px;">üöõ</div>
            <h2>Driver Setup</h2>
            <p style="color:#888; margin-top:5px;">‡®°‡®∞‡®æ‡®à‡®µ‡®∞ ‡®∏‡©à‡©±‡®ü‡®Ö‡©±‡®™</p>
        </div>
        <div class="form-card">
            <label class="form-label">Your Name / ‡®§‡©Å‡®π‡®æ‡®°‡®æ ‡®®‡®æ‡®Æ</label>
            <input type="text" class="form-input" id="driverName" placeholder="e.g., Harpreet Singh">
        </div>
        <div class="form-card">
            <label class="form-label">Truck Number / ‡®ü‡®∞‡©±‡®ï ‡®®‡©∞‡®¨‡®∞</label>
            <input type="text" class="form-input" id="truckNumber" placeholder="e.g., TX-12345">
        </div>
        <div class="form-card">
            <label class="form-label">Company Name / ‡®ï‡©∞‡®™‡®®‡©Ä ‡®¶‡®æ ‡®®‡®æ‡®Æ</label>
            <input type="text" class="form-input" id="companyName" placeholder="e.g., Singh Transport LLC">
        </div>
        <div class="form-card">
            <label class="form-label">Home State (for IFTA)</label>
            <select class="form-select" id="homeState">
                <option value="TX">Texas</option><option value="CA">California</option>
                <option value="FL">Florida</option><option value="IL">Illinois</option>
                <option value="NY">New York</option><option value="PA">Pennsylvania</option>
            </select>
        </div>
        <div class="form-card">
            <label class="form-label">Voice Language</label>
            <select class="form-select" id="voiceLang">
                <option value="en">English</option>
                <option value="pa">Punjabi (Hindi voice)</option>
                <option value="both">Both / ‡®¶‡©ã‡®µ‡©á‡®Ç</option>
            </select>
        </div>
        <div style="max-width:500px; margin:0 auto;">
            <button class="btn btn-primary" onclick="completeSetup()" style="max-width:100%;">‚úÖ Start</button>
        </div>
    </div>
    
    <!-- SCREEN 3: MAP -->
    <div id="mainScreen" class="screen main-screen">
        <div id="map"></div>
        <div class="loading" id="loading"><div class="spinner"></div><div>Loading...</div></div>
        
        <div class="top-bar">
            <div class="trip-banner" id="tripBanner">
                <div class="trip-banner-info">
                    <div class="trip-banner-dot"></div>
                    <div><div class="trip-banner-text">Recording Trip</div><div class="trip-banner-miles" id="tripMiles">0.0 mi</div></div>
                </div>
                <button class="trip-banner-btn" onclick="stopTrip()">‚èπÔ∏è Stop</button>
            </div>
            
            <div class="direction-box" id="directionBox">
                <div class="direction-main">
                    <span class="direction-icon" id="directionIcon">‚Üë</span>
                    <span class="direction-text" id="directionText">Head north</span>
                    <span class="direction-distance" id="directionDistance">0.5 mi</span>
                </div>
                <div class="direction-punjabi" id="directionPunjabi">‡®â‡©±‡®§‡®∞ ‡®µ‡©±‡®≤ ‡®ú‡®æ‡®ì</div>
                <div class="nav-stats">
                    <div class="nav-stat"><div class="nav-stat-value" id="navETA">--</div><div class="nav-stat-label">ETA</div></div>
                    <div class="nav-stat"><div class="nav-stat-value" id="navRemaining">--</div><div class="nav-stat-label">Remaining</div></div>
                    <div class="nav-stat"><div class="nav-stat-value" id="navSpeed">--</div><div class="nav-stat-label">Speed</div></div>
                </div>
                <div class="nav-controls">
                    <button class="nav-btn nav-btn-voice" id="voiceBtn" onclick="toggleVoice()">üîä ON</button>
                    <button class="nav-btn nav-btn-voice" id="freeLookBtn" onclick="toggleFreeLook()">üîì Look</button>
                    <button class="nav-btn nav-btn-stop" onclick="stopNavigation()">‚èπÔ∏è End</button>
                </div>
            </div>
            
            <div class="search-container" id="searchBar">
                <button class="menu-btn" onclick="toggleQuickMenu()">‚ò∞</button>
                <input type="text" class="search-input" id="searchInput" placeholder="üîç Search destination">
                <button class="search-btn" onclick="searchDestination()">‚Üí</button>
            </div>
        </div>
        
        <div class="bottom-panel">
            <div class="quick-menu" id="quickMenu">
                <div class="quick-menu-title">üè† Quick Destinations</div>
                <div class="quick-places">
                    <div class="quick-place-btn not-set" id="homeBtn" onclick="handlePlaceClick('home')">
                        <span class="quick-place-icon">üè†</span>
                        <span class="quick-place-text">Home</span>
                        <span class="quick-place-addr" id="homeAddr">Tap to set</span>
                    </div>
                    <div class="quick-place-btn not-set" id="workBtn" onclick="handlePlaceClick('work')">
                        <span class="quick-place-icon">üöõ</span>
                        <span class="quick-place-text">Truck Yard</span>
                        <span class="quick-place-addr" id="workAddr">Tap to set</span>
                    </div>
                </div>
                
                <div class="quick-menu-title">‚≠ê Favorites</div>
                <div class="list-section" id="favoritesList"></div>
                
                <div class="quick-menu-title">üïê Recent</div>
                <div class="list-section" id="recentList"></div>
                
                <div class="quick-menu-title">üìç Trip</div>
                <div class="quick-grid" style="margin-bottom:15px;">
                    <button class="quick-btn green" onclick="startTrip()" id="startTripBtn"><span class="quick-icon">‚ñ∂Ô∏è</span><span class="quick-text">Start</span></button>
                    <button class="quick-btn red" onclick="stopTrip()" id="stopTripBtn" style="display:none;"><span class="quick-icon">‚èπÔ∏è</span><span class="quick-text">Stop</span></button>
                    <button class="quick-btn blue" onclick="openPanel('tripsPanel')"><span class="quick-icon">üìä</span><span class="quick-text">History</span></button>
                    <button class="quick-btn blue" onclick="openPanel('iftaPanel')"><span class="quick-icon">üìã</span><span class="quick-text">IFTA</span></button>
                    <button class="quick-btn" onclick="openPanel('settingsPanel')"><span class="quick-icon">‚öôÔ∏è</span><span class="quick-text">Settings</span></button>
                </div>
                
                <div class="quick-menu-title">üçΩÔ∏è Food</div>
                <div class="quick-grid" style="margin-bottom:15px;">
                    <button class="quick-btn highlight" onclick="searchPOI('indian')"><span class="quick-icon">üçõ</span><span class="quick-text">Indian</span></button>
                    <button class="quick-btn highlight" onclick="searchPOI('indian')"><span class="quick-icon">ü•ò</span><span class="quick-text">Dhaba</span></button>
                    <button class="quick-btn" onclick="searchPOI('restaurant')"><span class="quick-icon">üçî</span><span class="quick-text">All Food</span></button>
                    <button class="quick-btn" onclick="searchPOI('fast_food')"><span class="quick-icon">üçü</span><span class="quick-text">Fast Food</span></button>
                </div>
                
                <div class="quick-menu-title">üöõ Services</div>
                <div class="quick-grid">
                    <button class="quick-btn" onclick="searchPOI('fuel')"><span class="quick-icon">‚õΩ</span><span class="quick-text">Fuel</span></button>
                    <button class="quick-btn" onclick="searchPOI('parking')"><span class="quick-icon">üÖøÔ∏è</span><span class="quick-text">Parking</span></button>
                    <button class="quick-btn" onclick="searchPOI('rest_area')"><span class="quick-icon">üõèÔ∏è</span><span class="quick-text">Rest</span></button>
                    <button class="quick-btn" onclick="searchPOI('car_repair')"><span class="quick-icon">üîß</span><span class="quick-text">Repair</span></button>
                </div>
            </div>
            
            <div class="poi-results" id="poiResults">
                <div class="poi-results-header">
                    <span class="poi-results-title" id="poiResultsTitle">Results</span>
                    <button class="poi-results-close" onclick="closePOIResults()">√ó</button>
                </div>
                <div id="poiResultsList"></div>
            </div>
            
            <div class="route-info" id="routeInfo">
                <div class="route-dest">To: <strong id="routeDestName">...</strong></div>
                <div class="route-stats">
                    <div class="route-stat"><div class="route-stat-value" id="routeDistance">--</div><div class="route-stat-label">Distance</div></div>
                    <div class="route-stat"><div class="route-stat-value" id="routeTime">--</div><div class="route-stat-label">Time</div></div>
                </div>
                <div class="route-actions">
                    <button class="route-btn btn-cancel" onclick="cancelRoute()">‚úï</button>
                    <button class="route-btn btn-start-nav" onclick="startNavigation()">‚ñ∂Ô∏è Start Navigation</button>
                </div>
            </div>
        </div>
        
        <!-- SETTINGS -->
        <div class="panel" id="settingsPanel">
            <div class="panel-header"><span class="panel-title">‚öôÔ∏è Settings</span><button class="panel-close" onclick="closePanel('settingsPanel')">√ó</button></div>
            
            <div class="panel-section">
                <div class="panel-section-title">üó∫Ô∏è Map Style</div>
                <div class="map-style-grid" id="mapStyleGrid"></div>
            </div>
            
            <div class="panel-section">
                <div class="panel-section-title">üè† Saved Places</div>
                <div class="setting-item"><span>üè† Home</span><button class="btn-blue" style="padding:8px 12px;font-size:12px;border-radius:8px;border:none;cursor:pointer;" onclick="setPlaceFromCurrent('home')">üìç Use Current</button></div>
                <div class="setting-item"><span>üöõ Truck Yard</span><button class="btn-blue" style="padding:8px 12px;font-size:12px;border-radius:8px;border:none;cursor:pointer;" onclick="setPlaceFromCurrent('work')">üìç Use Current</button></div>
            </div>
            
            <div class="panel-section">
                <div class="panel-section-title">üîä Voice</div>
                <div class="setting-item">
                    <span>Language</span>
                    <select id="settingsVoice" onchange="saveVoiceSetting()" style="padding:8px;border-radius:8px;border:1px solid #ddd;">
                        <option value="en">English</option>
                        <option value="pa">Punjabi</option>
                        <option value="both">Both</option>
                        <option value="off">Off</option>
                    </select>
                </div>
            </div>
            
            <div class="panel-section">
                <div class="panel-section-title">üöõ Driver</div>
                <div class="setting-item"><span>Name</span><span class="setting-value" id="settingsName">-</span></div>
                <div class="setting-item"><span>Truck</span><span class="setting-value" id="settingsTruck">-</span></div>
                <div class="setting-item"><span>GPS</span><span class="setting-value" id="settingsGps">-</span></div>
                <div class="setting-item"><span>State</span><span class="setting-value" id="settingsCurrentState">-</span></div>
            </div>
            
            <button class="btn btn-danger" onclick="logout()" style="width:100%;margin-top:20px;">üö™ Logout</button>
        </div>
        
        <!-- TRIPS -->
        <div class="panel" id="tripsPanel">
            <div class="panel-header"><span class="panel-title">üìä Trips</span><button class="panel-close" onclick="closePanel('tripsPanel')">√ó</button></div>
            <div id="tripsList"></div>
            <div class="export-btns">
                <button class="export-btn btn-blue" onclick="exportTrips('csv')">üìä Export CSV</button>
            </div>
        </div>
        
        <!-- IFTA -->
        <div class="panel" id="iftaPanel">
            <div class="panel-header"><span class="panel-title">üìã IFTA</span><button class="panel-close" onclick="closePanel('iftaPanel')">√ó</button></div>
            <div class="panel-section">
                <div style="display:flex;gap:10px;margin-bottom:15px;">
                    <select class="form-select" id="iftaQuarter" onchange="generateIFTA()" style="flex:1;">
                        <option value="all">All</option><option value="q1">Q1</option><option value="q2">Q2</option><option value="q3">Q3</option><option value="q4">Q4</option>
                    </select>
                    <select class="form-select" id="iftaYear" onchange="generateIFTA()" style="flex:1;">
                        <option value="2026">2026</option><option value="2025">2025</option>
                    </select>
                </div>
                <div id="iftaStates"></div>
                <div class="ifta-total"><span>TOTAL</span><span id="iftaTotal">0 mi</span></div>
            </div>
            <div class="export-btns"><button class="export-btn btn-primary" onclick="exportIFTA()">üìä Export</button></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // CONFIG
        const ORS_API_KEY = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImRlMDNiNzNlNDg4ZjQ2N2NiYmEyOThhZWNiMzdmOWI1IiwiaCI6Im11cm11cjY0In0=';
        const STORAGE = { profile: 'tgps_profile', trips: 'tgps_trips', places: 'tgps_places', recent: 'tgps_recent', favorites: 'tgps_favorites', mapStyle: 'tgps_mapStyle' };
        
        // MAP STYLES - Multiple options!
        const MAP_STYLES = {
            'standard': { name: 'Standard', preview: 'Classic OpenStreetMap', url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', attr: '¬© OpenStreetMap' },
            'light': { name: 'Light', preview: 'Clean & bright', url: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', attr: '¬© CARTO' },
            'streets': { name: 'Streets', preview: 'Detailed streets', url: 'https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', attr: '¬© OpenStreetMap HOT' },
            'topo': { name: 'Terrain', preview: 'With elevation', url: 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', attr: '¬© OpenTopoMap' },
            'satellite': { name: 'Satellite', preview: 'Aerial imagery', url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', attr: '¬© Esri' },
            'dark': { name: 'Dark', preview: 'Night mode', url: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', attr: '¬© CARTO' }
        };
        
        // STATE
        let profile = null, map = null, tileLayer = null, userMarker = null, routeLine = null, destMarker = null, tripLine = null, poiMarkers = [];
        let userLat = null, userLon = null, userSpeed = 0, watchId = null;
        let currentRoute = null, routeSteps = [], currentStepIndex = 0, isNavigating = false, destinationCoords = null, destinationName = '';
        let voiceEnabled = true, voiceLang = 'en', freeLookMode = false;
        let isTripActive = false, currentTrip = null, lastStateCheck = null;
        let currentMapStyle = 'light';
        
        const US_STATES = {'Alabama':'AL','Alaska':'AK','Arizona':'AZ','Arkansas':'AR','California':'CA','Colorado':'CO','Connecticut':'CT','Delaware':'DE','Florida':'FL','Georgia':'GA','Hawaii':'HI','Idaho':'ID','Illinois':'IL','Indiana':'IN','Iowa':'IA','Kansas':'KS','Kentucky':'KY','Louisiana':'LA','Maine':'ME','Maryland':'MD','Massachusetts':'MA','Michigan':'MI','Minnesota':'MN','Mississippi':'MS','Missouri':'MO','Montana':'MT','Nebraska':'NE','Nevada':'NV','New Hampshire':'NH','New Jersey':'NJ','New Mexico':'NM','New York':'NY','North Carolina':'NC','North Dakota':'ND','Ohio':'OH','Oklahoma':'OK','Oregon':'OR','Pennsylvania':'PA','Rhode Island':'RI','South Carolina':'SC','South Dakota':'SD','Tennessee':'TN','Texas':'TX','Utah':'UT','Vermont':'VT','Virginia':'VA','Washington':'WA','West Virginia':'WV','Wisconsin':'WI','Wyoming':'WY'};
        const PUNJABI = {'Turn left':'‡®ñ‡©±‡®¨‡©á ‡®Æ‡©Å‡©ú‡©ã','Turn right':'‡®∏‡©±‡®ú‡©á ‡®Æ‡©Å‡©ú‡©ã','Continue':'‡®ú‡®æ‡®∞‡©Ä ‡®∞‡©±‡®ñ‡©ã','Head':'‡®µ‡©±‡®≤ ‡®ö‡©±‡®≤‡©ã','Arrive':'‡®™‡®π‡©Å‡©∞‡®ö ‡®ó‡®è','Keep left':'‡®ñ‡©±‡®¨‡©á ‡®∞‡®π‡©ã','Keep right':'‡®∏‡©±‡®ú‡©á ‡®∞‡®π‡©ã'};
        
        // INIT
        document.addEventListener('DOMContentLoaded', () => {
            const saved = localStorage.getItem(STORAGE.profile);
            const code = localStorage.getItem('tgps_code');
            if (code && saved) { profile = JSON.parse(saved); showMainApp(); }
            else if (code) showScreen('setupScreen');
        });
        
        function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        
        function validateCode() {
            let code = document.getElementById('inviteCode').value.trim().toUpperCase();
            if (!code.startsWith('TRUCK-')) code = 'TRUCK-' + code;
            if (code.length >= 11) { localStorage.setItem('tgps_code', code); showScreen('setupScreen'); }
            else document.getElementById('codeError').classList.add('show');
        }
        
        function completeSetup() {
            const name = document.getElementById('driverName').value.trim();
            if (!name) { alert('Enter your name'); return; }
            profile = {
                name, truck: document.getElementById('truckNumber').value.trim() || '-',
                company: document.getElementById('companyName').value.trim() || '-',
                homeState: document.getElementById('homeState').value,
                voiceLang: document.getElementById('voiceLang').value
            };
            localStorage.setItem(STORAGE.profile, JSON.stringify(profile));
            showMainApp();
        }
        
        function showMainApp() {
            showScreen('mainScreen');
            voiceLang = profile.voiceLang || 'en';
            currentMapStyle = localStorage.getItem(STORAGE.mapStyle) || 'light';
            
            document.getElementById('settingsName').textContent = profile.name;
            document.getElementById('settingsTruck').textContent = profile.truck;
            document.getElementById('settingsVoice').value = voiceLang;
            
            setTimeout(initMap, 100);
            startGPS();
            renderMapStyles();
            updatePlaceButtons();
            renderRecent();
            renderFavorites();
            
            document.getElementById('searchInput').addEventListener('keypress', e => { if (e.key === 'Enter') searchDestination(); });
            
            // Load voices
            if ('speechSynthesis' in window) { speechSynthesis.getVoices(); speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices(); }
        }
        
        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([32.7767, -96.7970], 12);
            setMapStyle(currentMapStyle);
            
            const icon = L.divIcon({ html: '<div class="truck-marker">üöõ</div>', className: '', iconSize: [32, 32], iconAnchor: [16, 16] });
            userMarker = L.marker([32.7767, -96.7970], { icon }).addTo(map);
        }
        
        function setMapStyle(style) {
            currentMapStyle = style;
            localStorage.setItem(STORAGE.mapStyle, style);
            const s = MAP_STYLES[style] || MAP_STYLES['light'];
            if (tileLayer) map.removeLayer(tileLayer);
            tileLayer = L.tileLayer(s.url, { maxZoom: 19, attribution: s.attr }).addTo(map);
            renderMapStyles();
        }
        
        function renderMapStyles() {
            const grid = document.getElementById('mapStyleGrid');
            if (!grid) return;
            grid.innerHTML = Object.entries(MAP_STYLES).map(([k, v]) => `
                <div class="map-style-btn ${currentMapStyle === k ? 'active' : ''}" onclick="setMapStyle('${k}')">
                    <div class="map-style-name">${v.name}</div>
                    <div class="map-style-preview">${v.preview}</div>
                </div>
            `).join('');
        }
        
        function startGPS() {
            if (!navigator.geolocation) { document.getElementById('settingsGps').textContent = 'N/A'; return; }
            watchId = navigator.geolocation.watchPosition(updateLocation, e => {}, { enableHighAccuracy: true, timeout: 10000, maximumAge: 2000 });
        }
        
        function updateLocation(pos) {
            const prevLat = userLat, prevLon = userLon;
            userLat = pos.coords.latitude; userLon = pos.coords.longitude; userSpeed = pos.coords.speed || 0;
            document.getElementById('settingsGps').textContent = '‚úì Active';
            
            if (userMarker) userMarker.setLatLng([userLat, userLon]);
            
            if (isNavigating) {
                document.getElementById('navSpeed').textContent = Math.round(userSpeed * 2.237) + ' mph';
                if (!freeLookMode) map.setView([userLat, userLon], map.getZoom());
            } else if (!currentRoute) {
                map.setView([userLat, userLon], 14);
            }
            
            // Trip recording
            if (isTripActive && currentTrip && prevLat) {
                currentTrip.totalMiles += getDistMiles(prevLat, prevLon, userLat, userLon);
                document.getElementById('tripMiles').textContent = currentTrip.totalMiles.toFixed(1) + ' mi';
                if (tripLine) tripLine.addLatLng([userLat, userLon]);
                
                if (!lastStateCheck || Date.now() - lastStateCheck > 30000) { lastStateCheck = Date.now(); checkState(); }
            }
        }
        
        // NAVIGATION
        async function searchDestination() {
            const q = document.getElementById('searchInput').value.trim();
            if (!q) return;
            closeMenus(); showLoading(true);
            
            try {
                const res = await fetch(`https://api.openrouteservice.org/geocode/search?api_key=${ORS_API_KEY}&text=${encodeURIComponent(q)}&size=1`);
                const data = await res.json();
                if (!data.features?.length) { alert('Not found'); showLoading(false); return; }
                
                const c = data.features[0].geometry.coordinates;
                destinationCoords = { lat: c[1], lon: c[0] };
                destinationName = data.features[0].properties.label || q;
                
                saveRecent(destinationName, c[1], c[0]);
                await getRoute();
            } catch (e) { alert('Search failed'); }
            showLoading(false);
        }
        
        async function getRoute() {
            if (!userLat || !destinationCoords) return;
            showLoading(true);
            
            try {
                const res = await fetch(`https://api.openrouteservice.org/v2/directions/driving-hgv?api_key=${ORS_API_KEY}&start=${userLon},${userLat}&end=${destinationCoords.lon},${destinationCoords.lat}`);
                const data = await res.json();
                if (!data.features?.length) { alert('No route'); showLoading(false); return; }
                
                currentRoute = data.features[0];
                const coords = currentRoute.geometry.coordinates.map(c => [c[1], c[0]]);
                const props = currentRoute.properties;
                
                clearRoute();
                routeLine = L.polyline(coords, { color: '#0984e3', weight: 6, opacity: 0.9 }).addTo(map);
                destMarker = L.marker([destinationCoords.lat, destinationCoords.lon], { icon: L.divIcon({ html: '<div class="dest-marker">üìç</div>', className: '', iconSize: [28, 28], iconAnchor: [14, 28] }) }).addTo(map);
                
                map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });
                
                const distMi = (props.summary.distance / 1609.34).toFixed(1);
                const mins = Math.round(props.summary.duration / 60);
                document.getElementById('routeDistance').textContent = distMi + ' mi';
                document.getElementById('routeTime').textContent = mins >= 60 ? Math.floor(mins/60) + 'h ' + (mins%60) + 'm' : mins + 'm';
                document.getElementById('routeDestName').textContent = destinationName;
                
                routeSteps = props.segments[0].steps.map(s => ({ instruction: s.instruction, distance: s.distance, duration: s.duration }));
                document.getElementById('routeInfo').classList.add('show');
            } catch (e) { alert('Route failed'); }
            showLoading(false);
        }
        
        function startNavigation() {
            if (!routeSteps.length) return;
            isNavigating = true; currentStepIndex = 0; freeLookMode = false;
            
            document.getElementById('routeInfo').classList.remove('show');
            document.getElementById('searchBar').style.display = 'none';
            document.getElementById('directionBox').classList.add('show');
            
            updateNavDisplay();
            if (voiceEnabled && voiceLang !== 'off') setTimeout(() => announceStep(routeSteps[0]), 500);
            map.setView([userLat, userLon], 16);
        }
        
        function updateNavDisplay() {
            if (currentStepIndex >= routeSteps.length) {
                document.getElementById('directionIcon').textContent = 'üèÅ';
                document.getElementById('directionText').textContent = 'You have arrived!';
                document.getElementById('directionPunjabi').textContent = '‡®§‡©Å‡®∏‡©Ä‡®Ç ‡®™‡®π‡©Å‡©∞‡®ö ‡®ó‡®è ‡®π‡©ã!';
                document.getElementById('directionDistance').textContent = '';
                if (voiceEnabled) { speak('You have arrived.'); if (voiceLang === 'pa' || voiceLang === 'both') setTimeout(() => speak('‡®§‡©Å‡®∏‡©Ä‡®Ç ‡®™‡®π‡©Å‡©∞‡®ö ‡®ó‡®è ‡®π‡©ã', 'pa'), 2000); }
                return;
            }
            
            const step = routeSteps[currentStepIndex];
            document.getElementById('directionIcon').textContent = getIcon(step.instruction);
            document.getElementById('directionText').textContent = step.instruction;
            document.getElementById('directionPunjabi').textContent = toPunjabi(step.instruction);
            document.getElementById('directionDistance').textContent = fmtDist(step.distance);
            
            let rem = 0, time = 0;
            for (let i = currentStepIndex; i < routeSteps.length; i++) { rem += routeSteps[i].distance; time += routeSteps[i].duration; }
            document.getElementById('navRemaining').textContent = fmtDist(rem);
            document.getElementById('navETA').textContent = new Date(Date.now() + time * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }
        
        function announceStep(step) {
            const dist = step.distance >= 1609 ? (step.distance/1609.34).toFixed(1) + ' miles' : Math.round(step.distance * 3.28) + ' feet';
            speak(`In ${dist}, ${step.instruction}`);
            if (voiceLang === 'pa' || voiceLang === 'both') setTimeout(() => speak(toPunjabi(step.instruction), 'pa'), 2500);
        }
        
        function speak(text, lang = 'en') {
            if (!('speechSynthesis' in window) || !voiceEnabled) return;
            speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            const voices = speechSynthesis.getVoices();
            if (lang === 'pa') {
                const v = voices.find(v => v.lang.startsWith('pa')) || voices.find(v => v.lang.startsWith('hi'));
                if (v) { u.voice = v; u.lang = v.lang; } else u.lang = 'hi-IN';
            } else {
                u.lang = 'en-US';
                const v = voices.find(v => v.lang.startsWith('en'));
                if (v) u.voice = v;
            }
            u.rate = 0.9; speechSynthesis.speak(u);
        }
        
        function toggleVoice() {
            voiceEnabled = !voiceEnabled;
            document.getElementById('voiceBtn').textContent = voiceEnabled ? 'üîä ON' : 'üîá OFF';
        }
        
        function toggleFreeLook() {
            freeLookMode = !freeLookMode;
            const btn = document.getElementById('freeLookBtn');
            btn.textContent = freeLookMode ? 'üîí Back' : 'üîì Look';
            btn.style.background = freeLookMode ? '#e74c3c' : '';
            if (!freeLookMode && userLat) map.setView([userLat, userLon], 16);
        }
        
        function stopNavigation() {
            isNavigating = false; freeLookMode = false;
            document.getElementById('directionBox').classList.remove('show');
            document.getElementById('searchBar').style.display = 'flex';
            document.getElementById('freeLookBtn').textContent = 'üîì Look';
            document.getElementById('freeLookBtn').style.background = '';
            speechSynthesis.cancel();
            clearRoute();
            if (userLat) map.setView([userLat, userLon], 14);
        }
        
        function cancelRoute() {
            clearRoute();
            document.getElementById('routeInfo').classList.remove('show');
            document.getElementById('searchInput').value = '';
            if (userLat) map.setView([userLat, userLon], 14);
        }
        
        function clearRoute() {
            if (routeLine) { map.removeLayer(routeLine); routeLine = null; }
            if (destMarker) { map.removeLayer(destMarker); destMarker = null; }
            currentRoute = null; routeSteps = []; destinationCoords = null; destinationName = '';
        }
        
        // POI SEARCH
        async function searchPOI(type) {
            if (!userLat) { alert('Waiting for GPS'); return; }
            closeMenus(); showLoading(true); clearPOIMarkers();
            
            const cfg = {
                'indian': { q: 'cuisine~"indian|pakistani|punjabi|curry"', icon: 'üçõ', title: 'Indian Food' },
                'restaurant': { q: 'amenity=restaurant', icon: 'üçî', title: 'Restaurants' },
                'fast_food': { q: 'amenity=fast_food', icon: 'üçü', title: 'Fast Food' },
                'fuel': { q: 'amenity=fuel', icon: '‚õΩ', title: 'Fuel' },
                'parking': { q: 'amenity=parking', icon: 'üÖøÔ∏è', title: 'Parking' },
                'rest_area': { q: 'highway=rest_area', icon: 'üõèÔ∏è', title: 'Rest Areas' },
                'car_repair': { q: 'shop=car_repair', icon: 'üîß', title: 'Repair' }
            }[type] || { q: 'amenity=restaurant', icon: 'üçî', title: 'Food' };
            
            const bbox = getBBox(userLat, userLon, 25000);
            let query = type === 'indian' 
                ? `[out:json][timeout:30];(node["amenity"="restaurant"]["cuisine"~"indian|pakistani|punjabi",i](${bbox});node["amenity"="restaurant"]["name"~"india|punjab|dhaba|tandoor|curry",i](${bbox}););out 30;`
                : `[out:json][timeout:30];(node[${cfg.q.split('=').map((p,i) => i ? `"${p}"` : `"${p}"`).join('=')}](${bbox}););out 40;`;
            
            try {
                const res = await fetch('https://overpass-api.de/api/interpreter', { method: 'POST', body: query });
                const data = await res.json();
                if (!data.elements?.length) { alert('None found nearby'); showLoading(false); return; }
                
                const pois = data.elements.map(e => ({
                    name: e.tags?.name || 'Unnamed', lat: e.lat, lon: e.lon,
                    cuisine: e.tags?.cuisine || '', brand: e.tags?.brand || '',
                    addr: [e.tags?.['addr:housenumber'], e.tags?.['addr:street'], e.tags?.['addr:city']].filter(Boolean).join(' '),
                    dist: getDistMiles(userLat, userLon, e.lat, e.lon)
                })).filter(p => p.lat).sort((a,b) => a.dist - b.dist).slice(0, 25);
                
                pois.forEach(p => {
                    const m = L.marker([p.lat, p.lon], { icon: L.divIcon({ html: `<div class="poi-marker">${cfg.icon}</div>`, className: '', iconSize: [24, 24], iconAnchor: [12, 12] }) })
                        .addTo(map).bindPopup(`<b>${p.name}</b><br>${p.dist.toFixed(1)} mi`);
                    m.on('click', () => selectPOI(p));
                    poiMarkers.push(m);
                });
                
                if (poiMarkers.length) map.fitBounds(L.featureGroup(poiMarkers).getBounds().pad(0.1));
                
                document.getElementById('poiResultsTitle').textContent = `${cfg.icon} ${cfg.title} (${pois.length})`;
                document.getElementById('poiResultsList').innerHTML = pois.map((p,i) => `
                    <div class="poi-item" onclick="selectPOIByIdx(${i})">
                        <div class="poi-item-header"><span class="poi-item-name">${p.name}</span><span class="poi-item-dist">${p.dist.toFixed(1)} mi</span></div>
                        ${p.cuisine ? `<div class="poi-item-cuisine">üçΩÔ∏è ${p.cuisine}</div>` : ''}
                        ${p.brand ? `<div class="poi-item-cuisine">üè™ ${p.brand}</div>` : ''}
                        ${p.addr ? `<div class="poi-item-address">üìç ${p.addr}</div>` : ''}
                    </div>
                `).join('');
                window._pois = pois;
                document.getElementById('poiResults').classList.add('show');
            } catch (e) { alert('Search failed'); }
            showLoading(false);
        }
        
        function selectPOIByIdx(i) { selectPOI(window._pois[i]); }
        function selectPOI(p) {
            destinationCoords = { lat: p.lat, lon: p.lon }; destinationName = p.name;
            document.getElementById('searchInput').value = p.name;
            closePOIResults(); getRoute();
        }
        function closePOIResults() { document.getElementById('poiResults').classList.remove('show'); }
        function clearPOIMarkers() { poiMarkers.forEach(m => map.removeLayer(m)); poiMarkers = []; }
        
        // PLACES (Home/Work)
        function getPlaces() { return JSON.parse(localStorage.getItem(STORAGE.places) || '{}'); }
        function savePlaces(p) { localStorage.setItem(STORAGE.places, JSON.stringify(p)); updatePlaceButtons(); }
        
        function updatePlaceButtons() {
            const p = getPlaces();
            ['home', 'work'].forEach(k => {
                const btn = document.getElementById(k + 'Btn');
                const addr = document.getElementById(k + 'Addr');
                if (p[k]) {
                    btn.classList.remove('not-set'); btn.classList.add('set');
                    addr.textContent = p[k].name.substring(0, 25) + (p[k].name.length > 25 ? '...' : '');
                } else {
                    btn.classList.add('not-set'); btn.classList.remove('set');
                    addr.textContent = 'Tap to set';
                }
            });
        }
        
        function handlePlaceClick(type) {
            const p = getPlaces();
            if (p[type]) {
                destinationCoords = { lat: p[type].lat, lon: p[type].lon };
                destinationName = p[type].name;
                document.getElementById('searchInput').value = destinationName;
                closeMenus(); getRoute();
            } else {
                alert(`To set ${type === 'home' ? 'Home' : 'Truck Yard'}:\n\n1. Go to Settings\n2. Tap "Use Current Location"\n\nOr search for the address first.`);
            }
        }
        
        function setPlaceFromCurrent(type) {
            if (!userLat) { alert('Waiting for GPS'); return; }
            const name = type === 'home' ? 'Home' : 'Truck Yard';
            const p = getPlaces();
            p[type] = { name, lat: userLat, lon: userLon };
            savePlaces(p);
            alert(`${name} set to current location!`);
        }
        
        // RECENT & FAVORITES
        function getRecent() { return JSON.parse(localStorage.getItem(STORAGE.recent) || '[]'); }
        function saveRecentList(r) { localStorage.setItem(STORAGE.recent, JSON.stringify(r)); renderRecent(); }
        function saveRecent(name, lat, lon) {
            let r = getRecent().filter(x => x.name !== name);
            r.unshift({ name, lat, lon, ts: Date.now() });
            saveRecentList(r.slice(0, 20));
        }
        
        function renderRecent() {
            const r = getRecent();
            document.getElementById('recentList').innerHTML = r.length ? r.slice(0, 8).map((x, i) => `
                <div class="list-item" onclick="navToRecent(${i})">
                    <span class="list-item-icon">üìç</span>
                    <span class="list-item-text">${x.name}</span>
                    <span class="list-item-action fav" onclick="event.stopPropagation();addFav(${i})">‚≠ê</span>
                    <span class="list-item-action delete" onclick="event.stopPropagation();delRecent(${i})">‚úï</span>
                </div>
            `).join('') : '<div class="no-items">No recent searches</div>';
        }
        
        function navToRecent(i) { const r = getRecent()[i]; if (r) { destinationCoords = { lat: r.lat, lon: r.lon }; destinationName = r.name; document.getElementById('searchInput').value = r.name; closeMenus(); getRoute(); } }
        function delRecent(i) { const r = getRecent(); r.splice(i, 1); saveRecentList(r); }
        function addFav(i) { const r = getRecent()[i]; if (r) { let f = getFavorites().filter(x => x.name !== r.name); f.unshift(r); saveFavList(f.slice(0, 20)); alert('Added to favorites!'); } }
        
        function getFavorites() { return JSON.parse(localStorage.getItem(STORAGE.favorites) || '[]'); }
        function saveFavList(f) { localStorage.setItem(STORAGE.favorites, JSON.stringify(f)); renderFavorites(); }
        
        function renderFavorites() {
            const f = getFavorites();
            document.getElementById('favoritesList').innerHTML = f.length ? f.map((x, i) => `
                <div class="list-item" onclick="navToFav(${i})">
                    <span class="list-item-icon">‚≠ê</span>
                    <span class="list-item-text">${x.name}</span>
                    <span class="list-item-action delete" onclick="event.stopPropagation();delFav(${i})">‚úï</span>
                </div>
            `).join('') : '<div class="no-items">No favorites yet</div>';
        }
        
        function navToFav(i) { const f = getFavorites()[i]; if (f) { destinationCoords = { lat: f.lat, lon: f.lon }; destinationName = f.name; document.getElementById('searchInput').value = f.name; closeMenus(); getRoute(); } }
        function delFav(i) { const f = getFavorites(); f.splice(i, 1); saveFavList(f); }
        
        // TRIP RECORDING
        function startTrip() {
            if (isTripActive) return;
            isTripActive = true;
            currentTrip = { id: Date.now(), start: new Date().toISOString(), totalMiles: 0, stateLog: [], stateMiles: {} };
            tripLine = L.polyline([[userLat, userLon]], { color: '#e74c3c', weight: 4 }).addTo(map);
            document.getElementById('tripBanner').classList.add('show');
            document.getElementById('startTripBtn').style.display = 'none';
            document.getElementById('stopTripBtn').style.display = 'block';
            closeMenus(); checkState();
        }
        
        function stopTrip() {
            if (!isTripActive) return;
            isTripActive = false;
            currentTrip.end = new Date().toISOString();
            calcStateMiles();
            
            const trips = JSON.parse(localStorage.getItem(STORAGE.trips) || '[]');
            trips.unshift(currentTrip);
            localStorage.setItem(STORAGE.trips, JSON.stringify(trips));
            
            document.getElementById('tripBanner').classList.remove('show');
            document.getElementById('startTripBtn').style.display = 'block';
            document.getElementById('stopTripBtn').style.display = 'none';
            if (tripLine) { tripLine.setStyle({ color: '#00b894', opacity: 0.5 }); tripLine = null; }
            alert(`Trip saved: ${currentTrip.totalMiles.toFixed(1)} miles`);
            currentTrip = null;
        }
        
        async function checkState() {
            if (!userLat) return;
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${userLat}&lon=${userLon}`);
                const data = await res.json();
                const state = data.address?.state || '';
                const code = US_STATES[state] || state;
                document.getElementById('settingsCurrentState').textContent = code || '-';
                
                if (isTripActive && currentTrip && code) {
                    const last = currentTrip.stateLog[currentTrip.stateLog.length - 1];
                    if (!last || last.state !== code) currentTrip.stateLog.push({ state: code, miles: currentTrip.totalMiles });
                }
            } catch (e) {}
        }
        
        function calcStateMiles() {
            if (!currentTrip?.stateLog.length) return;
            for (let i = 0; i < currentTrip.stateLog.length; i++) {
                const e = currentTrip.stateLog[i], n = currentTrip.stateLog[i + 1];
                const mi = n ? n.miles - e.miles : currentTrip.totalMiles - e.miles;
                currentTrip.stateMiles[e.state] = (currentTrip.stateMiles[e.state] || 0) + mi;
            }
        }
        
        // PANELS
        function toggleQuickMenu() { closeMenus(); document.getElementById('quickMenu').classList.toggle('show'); renderRecent(); renderFavorites(); updatePlaceButtons(); }
        function closeMenus() { ['quickMenu', 'poiResults', 'routeInfo'].forEach(id => document.getElementById(id).classList.remove('show')); }
        function openPanel(id) { closeMenus(); if (id === 'tripsPanel') renderTrips(); if (id === 'iftaPanel') generateIFTA(); document.getElementById(id).classList.add('show'); }
        function closePanel(id) { document.getElementById(id).classList.remove('show'); }
        
        function renderTrips() {
            const trips = JSON.parse(localStorage.getItem(STORAGE.trips) || '[]');
            document.getElementById('tripsList').innerHTML = trips.length ? trips.slice(0, 50).map(t => `
                <div class="trip-item">
                    <div class="trip-item-header"><span class="trip-item-date">${new Date(t.start).toLocaleDateString()}</span><span class="trip-item-miles">${t.totalMiles.toFixed(1)} mi</span></div>
                    <div class="trip-item-details">${new Date(t.start).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} - ${t.end ? new Date(t.end).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : '-'}</div>
                    <div class="trip-item-states">üìç ${Object.keys(t.stateMiles || {}).join(', ') || '-'}</div>
                </div>
            `).join('') : '<div class="no-items">No trips yet</div>';
        }
        
        function generateIFTA() {
            const trips = JSON.parse(localStorage.getItem(STORAGE.trips) || '[]');
            const q = document.getElementById('iftaQuarter').value;
            const y = parseInt(document.getElementById('iftaYear').value);
            
            const filtered = trips.filter(t => {
                if (q === 'all') return true;
                const d = new Date(t.start), m = d.getMonth() + 1;
                if (d.getFullYear() !== y) return false;
                if (q === 'q1') return m <= 3;
                if (q === 'q2') return m >= 4 && m <= 6;
                if (q === 'q3') return m >= 7 && m <= 9;
                if (q === 'q4') return m >= 10;
            });
            
            const sm = {};
            filtered.forEach(t => Object.entries(t.stateMiles || {}).forEach(([s, m]) => sm[s] = (sm[s] || 0) + m));
            
            const sorted = Object.entries(sm).sort((a, b) => b[1] - a[1]);
            document.getElementById('iftaStates').innerHTML = sorted.length 
                ? sorted.map(([s, m]) => `<div class="ifta-state"><span class="ifta-state-name">${s}</span><span class="ifta-state-miles">${m.toFixed(1)} mi</span></div>`).join('')
                : '<div class="no-items">No data</div>';
            document.getElementById('iftaTotal').textContent = sorted.reduce((a, [_, m]) => a + m, 0).toFixed(1) + ' mi';
        }
        
        function saveVoiceSetting() { voiceLang = document.getElementById('settingsVoice').value; voiceEnabled = voiceLang !== 'off'; profile.voiceLang = voiceLang; localStorage.setItem(STORAGE.profile, JSON.stringify(profile)); }
        
        // EXPORT
        function exportTrips(fmt) {
            const trips = JSON.parse(localStorage.getItem(STORAGE.trips) || '[]');
            if (!trips.length) { alert('No trips'); return; }
            const rows = [['Date', 'Start', 'End', 'Miles', 'States']];
            trips.forEach(t => rows.push([new Date(t.start).toLocaleDateString(), new Date(t.start).toLocaleTimeString(), t.end ? new Date(t.end).toLocaleTimeString() : '', t.totalMiles.toFixed(1), Object.keys(t.stateMiles || {}).join(';')]));
            download(rows.map(r => r.join(',')).join('\n'), 'trips.csv', 'text/csv');
        }
        
        function exportIFTA() {
            const trips = JSON.parse(localStorage.getItem(STORAGE.trips) || '[]');
            const sm = {};
            trips.forEach(t => Object.entries(t.stateMiles || {}).forEach(([s, m]) => sm[s] = (sm[s] || 0) + m));
            const rows = [['State', 'Miles'], ...Object.entries(sm).map(([s, m]) => [s, m.toFixed(1)]), ['TOTAL', Object.values(sm).reduce((a, b) => a + b, 0).toFixed(1)]];
            download(rows.map(r => r.join(',')).join('\n'), 'IFTA.csv', 'text/csv');
        }
        
        function download(content, name, type) { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([content], { type })); a.download = name; a.click(); }
        
        // UTILS
        function getDistMiles(lat1, lon1, lat2, lon2) {
            const R = 3959, dLat = (lat2 - lat1) * Math.PI / 180, dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }
        function getBBox(lat, lon, r) { const d = r/111000; return `${lat-d},${lon-d},${lat+d},${lon+d}`; }
        function fmtDist(m) { return m >= 1609 ? (m/1609.34).toFixed(1) + ' mi' : Math.round(m*3.28) + ' ft'; }
        function getIcon(t) { const l = t.toLowerCase(); if (l.includes('left')) return '‚Ü∞'; if (l.includes('right')) return '‚Ü±'; if (l.includes('arrive')) return 'üèÅ'; return '‚Üë'; }
        function toPunjabi(t) { let r = t; Object.entries(PUNJABI).forEach(([e, p]) => r = r.replace(new RegExp(e, 'gi'), p)); return r; }
        function showLoading(s) { document.getElementById('loading').classList.toggle('show', s); }
        function logout() { if (isTripActive && !confirm('Stop trip and logout?')) return; if (isTripActive) stopTrip(); localStorage.removeItem(STORAGE.profile); localStorage.removeItem('tgps_code'); location.reload(); }
    </script>
</body>
</html>
