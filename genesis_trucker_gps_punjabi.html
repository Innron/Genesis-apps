<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>üöõ Genesis Trucker GPS</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            height: 100vh;
            color: #fff;
            overflow: hidden;
        }
        
        .screen { display: none; height: 100vh; width: 100%; }
        .screen.active { display: flex; flex-direction: column; }
        
        /* CODE SCREEN */
        .code-screen {
            justify-content: center;
            align-items: center;
            padding: 40px 20px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }
        
        .logo { font-size: 80px; margin-bottom: 20px; }
        .title { font-size: 28px; font-weight: 700; margin-bottom: 10px; text-align: center; }
        .subtitle { color: #aaa; margin-bottom: 10px; text-align: center; }
        .subtitle-punjabi { color: #888; margin-bottom: 30px; text-align: center; font-size: 14px; }
        
        .code-input {
            width: 100%;
            max-width: 300px;
            padding: 18px;
            font-size: 20px;
            text-align: center;
            border: 3px solid #333;
            border-radius: 15px;
            background: #111;
            color: #00ff88;
            letter-spacing: 3px;
            text-transform: uppercase;
        }
        
        .code-input:focus { outline: none; border-color: #00ff88; }
        
        .btn {
            width: 100%;
            max-width: 300px;
            padding: 18px;
            margin-top: 15px;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
        }
        
        .btn-primary { background: linear-gradient(135deg, #00b894 0%, #00cec9 100%); color: #000; }
        .btn-danger { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: #fff; }
        
        .error-msg { color: #ff6b6b; margin-top: 15px; text-align: center; display: none; }
        .error-msg.show { display: block; }
        
        /* SETUP SCREEN */
        .setup-screen {
            padding: 30px 20px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            overflow-y: auto;
        }
        
        .setup-header { text-align: center; margin-bottom: 30px; }
        
        .form-card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .form-label { display: block; margin-bottom: 5px; font-weight: 600; color: #ccc; }
        .form-label-punjabi { display: block; margin-bottom: 8px; font-size: 12px; color: #888; }
        
        .form-input {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            background: rgba(0,0,0,0.3);
            color: #fff;
            font-size: 16px;
        }
        
        .form-input:focus { outline: none; border-color: #00ff88; }
        
        /* MAIN APP - FULL MAP */
        .main-screen { background: #0a0a0a; position: relative; }
        
        /* TOP BAR */
        .top-bar {
            position: absolute;
            top: 0; left: 0; right: 0;
            z-index: 1000;
            padding: 10px;
            padding-top: max(10px, env(safe-area-inset-top));
        }
        
        /* DIRECTION BOX */
        .direction-box {
            background: linear-gradient(135deg, #2d3436 0%, #636e72 100%);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .direction-box.show { display: block; }
        
        .direction-icon { font-size: 30px; float: left; margin-right: 15px; }
        .direction-text { font-size: 16px; font-weight: 600; line-height: 1.3; }
        .direction-punjabi { font-size: 13px; color: #aaa; margin-top: 5px; }
        .direction-distance { font-size: 12px; color: #00ff88; margin-top: 5px; }
        
        /* SEARCH BAR */
        .search-container {
            display: flex;
            gap: 10px;
        }
        
        .search-input {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            background: rgba(0,0,0,0.8);
            color: #fff;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .search-input:focus { outline: 2px solid #00ff88; }
        
        .search-btn {
            padding: 15px;
            border: none;
            border-radius: 12px;
            background: #00b894;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
        }
        
        .menu-btn {
            padding: 15px;
            border: none;
            border-radius: 12px;
            background: rgba(0,0,0,0.8);
            color: #fff;
            font-size: 18px;
            cursor: pointer;
        }
        
        /* MAP */
        #map {
            position: absolute;
            top: 0; bottom: 0; left: 0; right: 0;
            z-index: 1;
        }
        
        /* BOTTOM PANEL */
        .bottom-panel {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            z-index: 1000;
            padding: 10px;
            padding-bottom: max(10px, env(safe-area-inset-bottom));
        }
        
        /* QUICK SEARCH DROPDOWN */
        .quick-menu {
            background: rgba(0,0,0,0.95);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            display: none;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .quick-menu.show { display: block; }
        
        .quick-menu-title { font-size: 12px; color: #888; margin-bottom: 10px; text-transform: uppercase; }
        
        .quick-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        
        .quick-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 10px;
            padding: 12px 5px;
            text-align: center;
            cursor: pointer;
            color: #fff;
        }
        
        .quick-btn.highlight {
            background: linear-gradient(135deg, #ff9f43 0%, #ee5a24 100%);
        }
        
        .quick-icon { font-size: 20px; display: block; }
        .quick-text { font-size: 9px; color: #ccc; display: block; margin-top: 3px; }
        
        /* ROUTE INFO */
        .route-info {
            background: rgba(0,0,0,0.9);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            display: none;
        }
        
        .route-info.show { display: block; }
        
        .route-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px;
        }
        
        .route-stat { text-align: center; }
        .route-stat-value { font-size: 24px; font-weight: 700; color: #00ff88; }
        .route-stat-label { font-size: 10px; color: #888; }
        
        .route-actions { display: flex; gap: 10px; }
        
        .route-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn-start { background: linear-gradient(135deg, #00b894 0%, #00cec9 100%); color: #000; }
        .btn-voice { background: linear-gradient(135deg, #0984e3 0%, #74b9ff 100%); color: #fff; }
        .btn-cancel { background: #333; color: #fff; }
        
        /* NAV MODE */
        .nav-mode .top-bar { background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); }
        .nav-mode .bottom-panel { background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); }
        
        /* STEPS LIST */
        .steps-list {
            background: rgba(0,0,0,0.95);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            max-height: 250px;
            overflow-y: auto;
            display: none;
        }
        
        .steps-list.show { display: block; }
        
        .step-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .step-item:last-child { border-bottom: none; }
        
        .step-icon { font-size: 20px; margin-right: 12px; }
        .step-text { flex: 1; font-size: 13px; }
        .step-dist { font-size: 12px; color: #00ff88; }
        
        /* SETTINGS PANEL */
        .settings-panel {
            position: absolute;
            top: 0; bottom: 0; left: 0; right: 0;
            background: rgba(0,0,0,0.95);
            z-index: 2000;
            padding: 20px;
            padding-top: max(20px, env(safe-area-inset-top));
            display: none;
            overflow-y: auto;
        }
        
        .settings-panel.show { display: block; }
        
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .settings-title { font-size: 20px; font-weight: 700; }
        .settings-close { background: none; border: none; color: #fff; font-size: 28px; cursor: pointer; }
        
        .settings-section {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .settings-section-title { font-weight: 600; margin-bottom: 15px; font-size: 14px; }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .setting-item:last-child { border-bottom: none; }
        .setting-value { color: #00ff88; font-size: 13px; }
        
        /* LOADING */
        .loading {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 500;
            display: none;
        }
        
        .loading.show { display: block; }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #333;
            border-top: 4px solid #00ff88;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* TRUCK MARKER */
        .truck-marker {
            font-size: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .leaflet-routing-container { display: none; }
    </style>
</head>
<body>
    <!-- SCREEN 1: CODE ENTRY -->
    <div id="codeScreen" class="screen active code-screen">
        <div class="logo">üöõ</div>
        <div class="title">Genesis Trucker GPS</div>
        <div class="subtitle">Truck-friendly navigation</div>
        <div class="subtitle-punjabi">‡®ü‡®∞‡©±‡®ï‡®∞‡®æ‡®Ç ‡®≤‡®à GPS ‡®ê‡®™</div>
        
        <input type="text" class="code-input" id="inviteCode" placeholder="Enter code">
        <button class="btn btn-primary" onclick="validateCode()">üîì Enter / ‡®ê‡®™ ‡®ñ‡©ã‡®≤‡©ç‡®π‡©ã</button>
        <div class="error-msg" id="codeError">‚ùå Invalid code</div>
    </div>
    
    <!-- SCREEN 2: DRIVER SETUP -->
    <div id="setupScreen" class="screen setup-screen">
        <div class="setup-header">
            <div style="font-size:60px; margin-bottom:15px;">üöõ</div>
            <h2>Driver Setup</h2>
            <p style="color:#888; margin-top:5px;">‡®°‡®∞‡®æ‡®à‡®µ‡®∞ ‡®∏‡©à‡©±‡®ü‡®Ö‡©±‡®™</p>
        </div>
        
        <div class="form-card">
            <label class="form-label">Your Name</label>
            <label class="form-label-punjabi">‡®§‡©Å‡®π‡®æ‡®°‡®æ ‡®®‡®æ‡®Æ</label>
            <input type="text" class="form-input" id="driverName" placeholder="e.g., Harpreet Singh">
        </div>
        
        <div class="form-card">
            <label class="form-label">Truck Number</label>
            <label class="form-label-punjabi">‡®ü‡®∞‡©±‡®ï ‡®®‡©∞‡®¨‡®∞</label>
            <input type="text" class="form-input" id="truckNumber" placeholder="e.g., TX-12345">
        </div>
        
        <div class="form-card">
            <label class="form-label">Company Name</label>
            <label class="form-label-punjabi">‡®ï‡©∞‡®™‡®®‡©Ä ‡®¶‡®æ ‡®®‡®æ‡®Æ</label>
            <input type="text" class="form-input" id="companyName" placeholder="e.g., Singh Transport LLC">
        </div>
        
        <div style="max-width:500px; margin:0 auto;">
            <button class="btn btn-primary" onclick="completeSetup()" style="max-width:100%;">‚úÖ Start / ‡®∏‡®º‡©Å‡®∞‡©Ç ‡®ï‡®∞‡©ã</button>
        </div>
    </div>
    
    <!-- SCREEN 3: MAIN MAP -->
    <div id="mainScreen" class="screen main-screen">
        <div id="map"></div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div>Loading route... / ‡®∞‡©Ç‡®ü ‡®≤‡©ã‡®° ‡®π‡©ã ‡®∞‡®ø‡®π‡®æ...</div>
        </div>
        
        <div class="top-bar">
            <!-- CURRENT DIRECTION -->
            <div class="direction-box" id="directionBox">
                <span class="direction-icon" id="directionIcon">‚Üë</span>
                <div class="direction-text" id="directionText">Head north on Main St</div>
                <div class="direction-punjabi" id="directionPunjabi">Main St ‡®§‡©á ‡®â‡©±‡®§‡®∞ ‡®µ‡©±‡®≤ ‡®ú‡®æ‡®ì</div>
                <div class="direction-distance" id="directionDistance">500 m</div>
            </div>
            
            <!-- SEARCH BAR -->
            <div class="search-container">
                <button class="menu-btn" onclick="toggleQuickMenu()">‚ò∞</button>
                <input type="text" class="search-input" id="searchInput" placeholder="üîç Search destination / ‡®Æ‡©∞‡®ú‡®º‡®ø‡®≤ ‡®ñ‡©ã‡®ú‡©ã">
                <button class="search-btn" onclick="searchDestination()">‚Üí</button>
            </div>
        </div>
        
        <div class="bottom-panel">
            <!-- QUICK SEARCH MENU -->
            <div class="quick-menu" id="quickMenu">
                <div class="quick-menu-title">üçΩÔ∏è Food / ‡®ñ‡®æ‡®£‡®æ</div>
                <div class="quick-grid" style="margin-bottom:15px;">
                    <button class="quick-btn highlight" onclick="searchPOI('indian restaurant')">
                        <span class="quick-icon">üçõ</span>
                        <span class="quick-text">Indian</span>
                    </button>
                    <button class="quick-btn highlight" onclick="searchPOI('punjabi dhaba')">
                        <span class="quick-icon">ü•ò</span>
                        <span class="quick-text">Dhaba</span>
                    </button>
                    <button class="quick-btn" onclick="searchPOI('restaurant')">
                        <span class="quick-icon">üçî</span>
                        <span class="quick-text">Food</span>
                    </button>
                    <button class="quick-btn" onclick="searchPOI('fast food')">
                        <span class="quick-icon">üçü</span>
                        <span class="quick-text">Fast Food</span>
                    </button>
                </div>
                
                <div class="quick-menu-title">üöõ Trucker / ‡®ü‡®∞‡©±‡®ï‡®∞</div>
                <div class="quick-grid">
                    <button class="quick-btn" onclick="searchPOI('truck stop')">
                        <span class="quick-icon">‚õΩ</span>
                        <span class="quick-text">Truck Stop</span>
                    </button>
                    <button class="quick-btn" onclick="searchPOI('rest area')">
                        <span class="quick-icon">üÖøÔ∏è</span>
                        <span class="quick-text">Rest Area</span>
                    </button>
                    <button class="quick-btn" onclick="searchPOI('truck wash')">
                        <span class="quick-icon">üöø</span>
                        <span class="quick-text">Wash</span>
                    </button>
                    <button class="quick-btn" onclick="searchPOI('truck repair')">
                        <span class="quick-icon">üîß</span>
                        <span class="quick-text">Repair</span>
                    </button>
                </div>
            </div>
            
            <!-- STEPS LIST -->
            <div class="steps-list" id="stepsList"></div>
            
            <!-- ROUTE INFO -->
            <div class="route-info" id="routeInfo">
                <div class="route-stats">
                    <div class="route-stat">
                        <div class="route-stat-value" id="routeDistance">--</div>
                        <div class="route-stat-label">Distance / ‡®¶‡©Ç‡®∞‡©Ä</div>
                    </div>
                    <div class="route-stat">
                        <div class="route-stat-value" id="routeTime">--</div>
                        <div class="route-stat-label">Time / ‡®∏‡®Æ‡®æ‡®Ç</div>
                    </div>
                </div>
                <div class="route-actions">
                    <button class="route-btn btn-cancel" onclick="cancelRoute()">‚úï</button>
                    <button class="route-btn btn-start" onclick="startNavigation()">‚ñ∂Ô∏è Start / ‡®∏‡®º‡©Å‡®∞‡©Ç</button>
                    <button class="route-btn btn-voice" onclick="openGoogleMaps()">üîä Voice</button>
                </div>
                <div style="text-align:center; margin-top:10px; font-size:11px; color:#888;">
                    üìù In-app text directions ‚Ä¢ üîä Voice = Google Maps
                </div>
            </div>
        </div>
        
        <!-- SETTINGS PANEL -->
        <div class="settings-panel" id="settingsPanel">
            <div class="settings-header">
                <span class="settings-title">‚öôÔ∏è Settings / ‡®∏‡©à‡®ü‡®ø‡©∞‡®ó‡®ú‡®º</span>
                <button class="settings-close" onclick="closeSettings()">√ó</button>
            </div>
            
            <div class="settings-section">
                <div class="settings-section-title">üöõ Driver Info</div>
                <div class="setting-item">
                    <span>Name / ‡®®‡®æ‡®Æ</span>
                    <span class="setting-value" id="settingsName">-</span>
                </div>
                <div class="setting-item">
                    <span>Truck / ‡®ü‡®∞‡©±‡®ï</span>
                    <span class="setting-value" id="settingsTruck">-</span>
                </div>
                <div class="setting-item">
                    <span>Company / ‡®ï‡©∞‡®™‡®®‡©Ä</span>
                    <span class="setting-value" id="settingsCompany">-</span>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="settings-section-title">üìç GPS Status</div>
                <div class="setting-item">
                    <span>Location</span>
                    <span class="setting-value" id="settingsGps">-</span>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="settings-section-title">‚ÑπÔ∏è About</div>
                <div class="setting-item">
                    <span>Navigation</span>
                    <span class="setting-value">OpenRouteService</span>
                </div>
                <div class="setting-item">
                    <span>Maps</span>
                    <span class="setting-value">OpenStreetMap</span>
                </div>
                <div class="setting-item">
                    <span>Voice (coming soon)</span>
                    <span class="setting-value">Use Google Maps</span>
                </div>
            </div>
            
            <button class="btn btn-danger" onclick="logout()" style="max-width:100%; margin-top:20px;">
                üö™ Logout / ‡®≤‡©å‡®ó‡®Ü‡®ä‡®ü
            </button>
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // OpenRouteService API Key
        const ORS_API_KEY = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImRlMDNiNzNlNDg4ZjQ2N2NiYmEyOThhZWNiMzdmOWI1IiwiaCI6Im11cm11cjY0In0=';
        
        const CODES_KEY = 'genesis_invite_codes';
        const PROFILE_KEY = 'trucker_profile';
        
        let profile = null;
        let map = null;
        let userMarker = null;
        let routeLine = null;
        let destMarker = null;
        let userLat = null;
        let userLon = null;
        let watchId = null;
        let currentRoute = null;
        let routeSteps = [];
        let currentStepIndex = 0;
        let isNavigating = false;
        let destinationCoords = null;
        
        // Direction icons
        const directionIcons = {
            'left': '‚Ü∞',
            'right': '‚Ü±',
            'sharp left': '‚Ü≤',
            'sharp right': '‚Ü≥',
            'slight left': '‚Üñ',
            'slight right': '‚Üó',
            'straight': '‚Üë',
            'uturn': '‚Ü©',
            'arrive': 'üèÅ',
            'depart': 'üöõ',
            'roundabout': 'üîÑ',
            'default': '‚Üí'
        };
        
        // Punjabi translations for common directions
        const punjabiDirections = {
            'Turn left': '‡®ñ‡©±‡®¨‡©á ‡®Æ‡©Å‡©ú‡©ã',
            'Turn right': '‡®∏‡©±‡®ú‡©á ‡®Æ‡©Å‡©ú‡©ã',
            'Continue': '‡®ú‡®æ‡®∞‡©Ä ‡®∞‡©±‡®ñ‡©ã',
            'Head': '‡®µ‡©±‡®≤ ‡®ú‡®æ‡®ì',
            'Arrive': '‡®™‡®π‡©Å‡©∞‡®ö ‡®ó‡®è',
            'north': '‡®â‡©±‡®§‡®∞',
            'south': '‡®¶‡©±‡®ñ‡®£',
            'east': '‡®™‡©Ç‡®∞‡®¨',
            'west': '‡®™‡©±‡®õ‡®Æ',
            'onto': '‡®§‡©á',
            'Keep left': '‡®ñ‡©±‡®¨‡©á ‡®∞‡®π‡©ã',
            'Keep right': '‡®∏‡©±‡®ú‡©á ‡®∞‡®π‡©ã',
            'Enter roundabout': '‡®ó‡©ã‡®≤ ‡®ö‡©±‡®ï‡®∞ ‡®µ‡®ø‡©±‡®ö ‡®ú‡®æ‡®ì',
            'Exit roundabout': '‡®ó‡©ã‡®≤ ‡®ö‡©±‡®ï‡®∞ ‡®§‡©ã‡®Ç ‡®¨‡®æ‡®π‡®∞',
            'Merge': '‡®Æ‡®ø‡®≤‡®æ‡®ì',
            'Take exit': '‡®ê‡®ó‡®ú‡®º‡®ø‡®ü ‡®≤‡®ì'
        };
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const savedProfile = localStorage.getItem(PROFILE_KEY);
            const validatedCode = localStorage.getItem('trucker_validated_code');
            
            if (validatedCode && savedProfile) {
                profile = JSON.parse(savedProfile);
                showMainApp();
            } else if (validatedCode) {
                showScreen('setupScreen');
            }
        });
        
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }
        
        function validateCode() {
            let code = document.getElementById('inviteCode').value.trim().toUpperCase();
            const errorEl = document.getElementById('codeError');
            
            if (!code.startsWith('TRUCK-')) {
                code = 'TRUCK-' + code;
            }
            
            if (code.startsWith('TRUCK-') && code.length >= 11) {
                localStorage.setItem('trucker_validated_code', code);
                errorEl.classList.remove('show');
                showScreen('setupScreen');
                return;
            }
            
            errorEl.textContent = '‚ùå Please enter code / ‡®ï‡©ã‡®° ‡®¶‡®ø‡®ì';
            errorEl.classList.add('show');
        }
        
        function completeSetup() {
            const name = document.getElementById('driverName').value.trim();
            const truck = document.getElementById('truckNumber').value.trim();
            const company = document.getElementById('companyName').value.trim();
            
            if (!name) {
                alert('Please enter your name / ‡®Ü‡®™‡®£‡®æ ‡®®‡®æ‡®Æ ‡®¶‡®ø‡®ì');
                return;
            }
            
            profile = {
                name: name,
                truck: truck || 'Not set',
                company: company || 'Not set',
                created: new Date().toISOString()
            };
            
            localStorage.setItem(PROFILE_KEY, JSON.stringify(profile));
            showMainApp();
        }
        
        function showMainApp() {
            showScreen('mainScreen');
            
            document.getElementById('settingsName').textContent = profile.name;
            document.getElementById('settingsTruck').textContent = profile.truck;
            document.getElementById('settingsCompany').textContent = profile.company;
            
            setTimeout(initMap, 100);
            startGPS();
            
            // Enter key for search
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') searchDestination();
            });
        }
        
        function initMap() {
            map = L.map('map', {
                zoomControl: false
            }).setView([32.7767, -96.7970], 10); // Default to Dallas area
            
            // Dark map tiles
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                maxZoom: 19,
                attribution: '¬© OpenStreetMap, ¬© CARTO'
            }).addTo(map);
            
            // Truck icon
            const truckIcon = L.divIcon({
                html: '<div class="truck-marker">üöõ</div>',
                className: '',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
            
            userMarker = L.marker([32.7767, -96.7970], { icon: truckIcon }).addTo(map);
        }
        
        function startGPS() {
            if (!navigator.geolocation) {
                document.getElementById('settingsGps').textContent = 'Not available';
                return;
            }
            
            watchId = navigator.geolocation.watchPosition(
                updateLocation,
                (err) => { document.getElementById('settingsGps').textContent = 'Error: ' + err.message; },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 3000 }
            );
        }
        
        function updateLocation(position) {
            userLat = position.coords.latitude;
            userLon = position.coords.longitude;
            
            document.getElementById('settingsGps').textContent = 'Active ‚úì';
            
            if (userMarker) {
                userMarker.setLatLng([userLat, userLon]);
            }
            
            if (!isNavigating && !currentRoute) {
                map.setView([userLat, userLon], 14);
            }
            
            // Update navigation if active
            if (isNavigating && routeSteps.length > 0) {
                updateNavigation();
            }
        }
        
        function toggleQuickMenu() {
            const menu = document.getElementById('quickMenu');
            const routeInfo = document.getElementById('routeInfo');
            const stepsList = document.getElementById('stepsList');
            
            menu.classList.toggle('show');
            routeInfo.classList.remove('show');
            stepsList.classList.remove('show');
        }
        
        function searchPOI(type) {
            document.getElementById('quickMenu').classList.remove('show');
            
            if (userLat && userLon) {
                window.open(`https://www.google.com/maps/search/${encodeURIComponent(type)}/@${userLat},${userLon},13z`, '_blank');
            } else {
                window.open(`https://www.google.com/maps/search/${encodeURIComponent(type)}`, '_blank');
            }
        }
        
        async function searchDestination() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;
            
            document.getElementById('quickMenu').classList.remove('show');
            showLoading(true);
            
            try {
                // Geocode the destination using OpenRouteService
                const geocodeUrl = `https://api.openrouteservice.org/geocode/search?api_key=${ORS_API_KEY}&text=${encodeURIComponent(query)}&size=1`;
                
                const geoResponse = await fetch(geocodeUrl);
                const geoData = await geoResponse.json();
                
                if (!geoData.features || geoData.features.length === 0) {
                    alert('Location not found / ‡®∏‡®•‡®æ‡®® ‡®®‡®π‡©Ä‡®Ç ‡®Æ‡®ø‡®≤‡®ø‡®Ü');
                    showLoading(false);
                    return;
                }
                
                const destCoords = geoData.features[0].geometry.coordinates;
                destinationCoords = { lat: destCoords[1], lon: destCoords[0] };
                const destName = geoData.features[0].properties.label;
                
                // Get route
                await getRoute(destinationCoords.lat, destinationCoords.lon, destName);
                
            } catch (error) {
                console.error('Search error:', error);
                alert('Search failed. Try again / ‡®ñ‡©ã‡®ú ‡®´‡©á‡®≤‡©ç‡®π ‡®π‡©ã‡®à');
                showLoading(false);
            }
        }
        
        async function getRoute(destLat, destLon, destName) {
            if (!userLat || !userLon) {
                alert('Waiting for GPS location / GPS ‡®¶‡©Ä ‡®â‡®°‡©Ä‡®ï');
                showLoading(false);
                return;
            }
            
            try {
                // Use HGV (Heavy Goods Vehicle) profile for trucks
                const routeUrl = `https://api.openrouteservice.org/v2/directions/driving-hgv?api_key=${ORS_API_KEY}&start=${userLon},${userLat}&end=${destLon},${destLat}`;
                
                const response = await fetch(routeUrl);
                const data = await response.json();
                
                if (!data.features || data.features.length === 0) {
                    alert('Route not found / ‡®∞‡©Ç‡®ü ‡®®‡®π‡©Ä‡®Ç ‡®Æ‡®ø‡®≤‡®ø‡®Ü');
                    showLoading(false);
                    return;
                }
                
                currentRoute = data.features[0];
                const coords = currentRoute.geometry.coordinates;
                const props = currentRoute.properties;
                const segments = props.segments[0];
                
                // Draw route on map
                if (routeLine) map.removeLayer(routeLine);
                if (destMarker) map.removeLayer(destMarker);
                
                const routeCoords = coords.map(c => [c[1], c[0]]);
                routeLine = L.polyline(routeCoords, {
                    color: '#00ff88',
                    weight: 6,
                    opacity: 0.8
                }).addTo(map);
                
                // Add destination marker
                const destIcon = L.divIcon({
                    html: 'üèÅ',
                    className: '',
                    iconSize: [30, 30],
                    iconAnchor: [15, 30]
                });
                destMarker = L.marker([destLat, destLon], { icon: destIcon }).addTo(map);
                
                // Fit map to route
                map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });
                
                // Show route info
                const distanceKm = (props.summary.distance / 1000).toFixed(1);
                const distanceMi = (props.summary.distance / 1609.34).toFixed(1);
                const durationMin = Math.round(props.summary.duration / 60);
                const durationHr = Math.floor(durationMin / 60);
                const durationRemMin = durationMin % 60;
                
                document.getElementById('routeDistance').textContent = `${distanceMi} mi`;
                document.getElementById('routeTime').textContent = durationHr > 0 ? `${durationHr}h ${durationRemMin}m` : `${durationMin}m`;
                
                // Parse steps
                routeSteps = segments.steps.map(step => ({
                    instruction: step.instruction,
                    distance: step.distance,
                    duration: step.duration,
                    type: step.type,
                    name: step.name || ''
                }));
                
                // Show steps list
                renderStepsList();
                
                document.getElementById('routeInfo').classList.add('show');
                document.getElementById('stepsList').classList.add('show');
                
            } catch (error) {
                console.error('Route error:', error);
                alert('Failed to get route / ‡®∞‡©Ç‡®ü ‡®≤‡©à‡®£ ‡®µ‡®ø‡©±‡®ö ‡®´‡©á‡®≤‡©ç‡®π');
            }
            
            showLoading(false);
        }
        
        function renderStepsList() {
            const list = document.getElementById('stepsList');
            
            list.innerHTML = routeSteps.map((step, i) => {
                const icon = getDirectionIcon(step.instruction);
                const distStr = step.distance >= 1000 ? 
                    `${(step.distance/1609.34).toFixed(1)} mi` : 
                    `${Math.round(step.distance * 3.28)} ft`;
                
                return `
                    <div class="step-item" id="step-${i}">
                        <span class="step-icon">${icon}</span>
                        <span class="step-text">${step.instruction}</span>
                        <span class="step-dist">${distStr}</span>
                    </div>
                `;
            }).join('');
        }
        
        function getDirectionIcon(instruction) {
            const lower = instruction.toLowerCase();
            if (lower.includes('left') && lower.includes('sharp')) return directionIcons['sharp left'];
            if (lower.includes('right') && lower.includes('sharp')) return directionIcons['sharp right'];
            if (lower.includes('left') && lower.includes('slight')) return directionIcons['slight left'];
            if (lower.includes('right') && lower.includes('slight')) return directionIcons['slight right'];
            if (lower.includes('left')) return directionIcons['left'];
            if (lower.includes('right')) return directionIcons['right'];
            if (lower.includes('straight') || lower.includes('continue')) return directionIcons['straight'];
            if (lower.includes('arrive')) return directionIcons['arrive'];
            if (lower.includes('depart') || lower.includes('head')) return directionIcons['depart'];
            if (lower.includes('roundabout')) return directionIcons['roundabout'];
            if (lower.includes('u-turn')) return directionIcons['uturn'];
            return directionIcons['default'];
        }
        
        function translateToPunjabi(text) {
            let translated = text;
            for (const [eng, pun] of Object.entries(punjabiDirections)) {
                translated = translated.replace(new RegExp(eng, 'gi'), pun);
            }
            return translated;
        }
        
        function startNavigation() {
            if (!routeSteps || routeSteps.length === 0) return;
            
            isNavigating = true;
            currentStepIndex = 0;
            
            document.getElementById('routeInfo').classList.remove('show');
            document.getElementById('stepsList').classList.remove('show');
            document.getElementById('directionBox').classList.add('show');
            document.getElementById('mainScreen').classList.add('nav-mode');
            
            updateDirectionDisplay();
            
            // Center on user
            if (userLat && userLon) {
                map.setView([userLat, userLon], 16);
            }
        }
        
        function updateDirectionDisplay() {
            if (currentStepIndex >= routeSteps.length) {
                // Arrived!
                document.getElementById('directionIcon').textContent = 'üèÅ';
                document.getElementById('directionText').textContent = 'You have arrived!';
                document.getElementById('directionPunjabi').textContent = '‡®§‡©Å‡®∏‡©Ä‡®Ç ‡®™‡®π‡©Å‡©∞‡®ö ‡®ó‡®è ‡®π‡©ã!';
                document.getElementById('directionDistance').textContent = '';
                return;
            }
            
            const step = routeSteps[currentStepIndex];
            const icon = getDirectionIcon(step.instruction);
            const distStr = step.distance >= 1000 ? 
                `${(step.distance/1609.34).toFixed(1)} mi` : 
                `${Math.round(step.distance * 3.28)} ft`;
            
            document.getElementById('directionIcon').textContent = icon;
            document.getElementById('directionText').textContent = step.instruction;
            document.getElementById('directionPunjabi').textContent = translateToPunjabi(step.instruction);
            document.getElementById('directionDistance').textContent = distStr;
            
            // Highlight current step
            document.querySelectorAll('.step-item').forEach(el => el.style.background = '');
            const currentEl = document.getElementById(`step-${currentStepIndex}`);
            if (currentEl) currentEl.style.background = 'rgba(0,255,136,0.2)';
        }
        
        function updateNavigation() {
            // Simple distance check to advance steps
            // In production, would use more sophisticated logic
            if (currentStepIndex < routeSteps.length - 1) {
                // Check if we should advance to next step
                // This is simplified - real implementation would check actual position along route
            }
        }
        
        function cancelRoute() {
            isNavigating = false;
            currentRoute = null;
            routeSteps = [];
            destinationCoords = null;
            
            if (routeLine) {
                map.removeLayer(routeLine);
                routeLine = null;
            }
            if (destMarker) {
                map.removeLayer(destMarker);
                destMarker = null;
            }
            
            document.getElementById('routeInfo').classList.remove('show');
            document.getElementById('stepsList').classList.remove('show');
            document.getElementById('directionBox').classList.remove('show');
            document.getElementById('mainScreen').classList.remove('nav-mode');
            document.getElementById('searchInput').value = '';
            
            if (userLat && userLon) {
                map.setView([userLat, userLon], 14);
            }
        }
        
        function openGoogleMaps() {
            if (!destinationCoords) return;
            
            let url;
            if (userLat && userLon) {
                url = `https://www.google.com/maps/dir/${userLat},${userLon}/${destinationCoords.lat},${destinationCoords.lon}`;
            } else {
                url = `https://www.google.com/maps/dir/?api=1&destination=${destinationCoords.lat},${destinationCoords.lon}`;
            }
            
            window.open(url, '_blank');
        }
        
        function showLoading(show) {
            document.getElementById('loading').classList.toggle('show', show);
        }
        
        function openSettings() {
            document.getElementById('settingsPanel').classList.add('show');
        }
        
        function closeSettings() {
            document.getElementById('settingsPanel').classList.remove('show');
        }
        
        // Add settings button functionality to menu
        document.addEventListener('DOMContentLoaded', function() {
            const menuBtn = document.querySelector('.menu-btn');
            if (menuBtn) {
                menuBtn.addEventListener('long', openSettings);
            }
        });
        
        function logout() {
            if (confirm('Logout? / ‡®≤‡©å‡®ó‡®Ü‡®ä‡®ü?')) {
                if (watchId) navigator.geolocation.clearWatch(watchId);
                localStorage.removeItem(PROFILE_KEY);
                localStorage.removeItem('trucker_validated_code');
                location.reload();
            }
        }
        
        // Double tap menu for settings
        let menuTapCount = 0;
        document.querySelector('.menu-btn')?.addEventListener('click', function() {
            menuTapCount++;
            if (menuTapCount === 2) {
                openSettings();
                menuTapCount = 0;
            }
            setTimeout(() => { menuTapCount = 0; }, 500);
        });
    </script>
</body>
</html>
