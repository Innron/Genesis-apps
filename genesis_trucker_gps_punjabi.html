<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>üöõ Genesis Trucker GPS</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            height: 100vh;
            color: #fff;
            overflow: hidden;
        }
        
        .screen { display: none; height: 100vh; width: 100%; }
        .screen.active { display: flex; flex-direction: column; }
        
        /* CODE SCREEN */
        .code-screen {
            justify-content: center;
            align-items: center;
            padding: 40px 20px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }
        
        .logo { font-size: 80px; margin-bottom: 20px; }
        .title { font-size: 28px; font-weight: 700; margin-bottom: 10px; text-align: center; }
        .subtitle { color: #aaa; margin-bottom: 10px; text-align: center; }
        .subtitle-punjabi { color: #888; margin-bottom: 30px; text-align: center; font-size: 14px; }
        
        .code-input {
            width: 100%;
            max-width: 300px;
            padding: 18px;
            font-size: 20px;
            text-align: center;
            border: 3px solid #333;
            border-radius: 15px;
            background: #111;
            color: #00ff88;
            letter-spacing: 3px;
            text-transform: uppercase;
        }
        
        .code-input:focus { outline: none; border-color: #00ff88; }
        
        .btn {
            width: 100%;
            max-width: 300px;
            padding: 18px;
            margin-top: 15px;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
        }
        
        .btn-primary { background: linear-gradient(135deg, #00b894 0%, #00cec9 100%); color: #000; }
        .btn-secondary { background: linear-gradient(135deg, #636e72 0%, #2d3436 100%); color: #fff; }
        .btn-danger { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: #fff; }
        .btn-blue { background: linear-gradient(135deg, #0984e3 0%, #74b9ff 100%); color: #fff; }
        
        .error-msg { color: #ff6b6b; margin-top: 15px; text-align: center; display: none; }
        .error-msg.show { display: block; }
        
        /* SETUP SCREEN */
        .setup-screen {
            padding: 30px 20px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            overflow-y: auto;
        }
        
        .setup-header { text-align: center; margin-bottom: 30px; }
        
        .form-card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .form-label { display: block; margin-bottom: 5px; font-weight: 600; color: #ccc; }
        .form-label-punjabi { display: block; margin-bottom: 8px; font-size: 12px; color: #888; }
        
        .form-input, .form-select {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            background: rgba(0,0,0,0.3);
            color: #fff;
            font-size: 16px;
        }
        
        .form-input:focus, .form-select:focus { outline: none; border-color: #00ff88; }
        
        /* MAIN APP - FULL MAP */
        .main-screen { background: #0a0a0a; position: relative; }
        
        /* TOP BAR */
        .top-bar {
            position: absolute;
            top: 0; left: 0; right: 0;
            z-index: 1000;
            padding: 10px;
            padding-top: max(10px, env(safe-area-inset-top));
        }
        
        /* TRIP RECORDING BANNER */
        .trip-banner {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            border-radius: 10px;
            padding: 10px 15px;
            margin-bottom: 10px;
            display: none;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .trip-banner.show { display: flex; }
        
        .trip-banner-info { display: flex; align-items: center; gap: 10px; }
        .trip-banner-dot { width: 12px; height: 12px; background: #fff; border-radius: 50%; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .trip-banner-text { font-size: 13px; font-weight: 600; }
        .trip-banner-miles { font-size: 11px; opacity: 0.9; }
        .trip-banner-btn { background: rgba(0,0,0,0.3); border: none; padding: 8px 12px; border-radius: 8px; color: #fff; font-size: 12px; cursor: pointer; }
        
        /* NAVIGATION DIRECTION BOX */
        .direction-box {
            background: linear-gradient(135deg, #2d3436 0%, #000 100%);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            border: 2px solid #00ff88;
        }
        
        .direction-box.show { display: block; }
        
        .direction-main { display: flex; align-items: center; gap: 15px; }
        .direction-icon { font-size: 40px; }
        .direction-text { font-size: 18px; font-weight: 700; line-height: 1.3; flex: 1; }
        .direction-distance { font-size: 24px; font-weight: 800; color: #00ff88; text-align: right; }
        .direction-punjabi { font-size: 14px; color: #aaa; margin-top: 8px; padding-top: 8px; border-top: 1px solid #333; }
        
        .nav-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #333;
        }
        
        .nav-stat { text-align: center; }
        .nav-stat-value { font-size: 16px; font-weight: 700; color: #00ff88; }
        .nav-stat-label { font-size: 10px; color: #888; }
        
        .nav-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .nav-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .nav-btn-voice { background: #0984e3; color: #fff; }
        .nav-btn-voice.active { background: #00b894; }
        .nav-btn-stop { background: #e74c3c; color: #fff; }
        
        /* SEARCH BAR */
        .search-container { display: flex; gap: 10px; }
        
        .search-input {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            background: rgba(0,0,0,0.9);
            color: #fff;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .search-input:focus { outline: 2px solid #00ff88; }
        
        .search-btn, .menu-btn {
            padding: 15px;
            border: none;
            border-radius: 12px;
            background: rgba(0,0,0,0.9);
            color: #fff;
            font-size: 18px;
            cursor: pointer;
        }
        
        .search-btn { background: #00b894; }
        
        /* MAP */
        #map {
            position: absolute;
            top: 0; bottom: 0; left: 0; right: 0;
            z-index: 1;
        }
        
        /* BOTTOM PANEL */
        .bottom-panel {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            z-index: 1000;
            padding: 10px;
            padding-bottom: max(10px, env(safe-area-inset-bottom));
        }
        
        /* QUICK MENU */
        .quick-menu {
            background: rgba(0,0,0,0.98);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            display: none;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .quick-menu.show { display: block; }
        
        .quick-menu-title { font-size: 11px; color: #00ff88; margin-bottom: 10px; text-transform: uppercase; font-weight: 600; }
        
        .quick-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        
        .quick-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 10px;
            padding: 12px 5px;
            text-align: center;
            cursor: pointer;
            color: #fff;
        }
        
        .quick-btn.highlight { background: linear-gradient(135deg, #ff9f43 0%, #ee5a24 100%); }
        .quick-btn.red { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }
        .quick-btn.green { background: linear-gradient(135deg, #00b894 0%, #00cec9 100%); color: #000; }
        .quick-btn.blue { background: linear-gradient(135deg, #0984e3 0%, #74b9ff 100%); }
        
        .quick-icon { font-size: 20px; display: block; }
        .quick-text { font-size: 9px; color: #ccc; display: block; margin-top: 3px; }
        .quick-btn.highlight .quick-text, .quick-btn.red .quick-text, .quick-btn.green .quick-text, .quick-btn.blue .quick-text { color: #fff; }
        
        /* POI RESULTS */
        .poi-results {
            background: rgba(0,0,0,0.98);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }
        
        .poi-results.show { display: block; }
        
        .poi-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        
        .poi-results-title { font-weight: 600; font-size: 14px; color: #00ff88; }
        .poi-results-close { background: none; border: none; color: #fff; font-size: 24px; cursor: pointer; }
        
        .poi-item {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
        }
        
        .poi-item:active { background: rgba(0, 255, 136, 0.2); }
        
        .poi-item-header { display: flex; justify-content: space-between; align-items: center; }
        .poi-item-name { font-weight: 600; font-size: 14px; }
        .poi-item-dist { font-size: 13px; color: #00ff88; font-weight: 600; }
        .poi-item-cuisine { font-size: 11px; color: #ff9f43; margin-top: 4px; }
        .poi-item-address { font-size: 11px; color: #aaa; margin-top: 4px; }
        
        /* ROUTE INFO (before starting navigation) */
        .route-info {
            background: rgba(0,0,0,0.95);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            display: none;
        }
        
        .route-info.show { display: block; }
        
        .route-dest {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        
        .route-dest strong { color: #fff; font-size: 16px; }
        
        .route-stats { display: flex; justify-content: space-around; margin-bottom: 15px; }
        .route-stat { text-align: center; }
        .route-stat-value { font-size: 28px; font-weight: 700; color: #00ff88; }
        .route-stat-label { font-size: 11px; color: #888; }
        
        .route-actions { display: flex; gap: 10px; }
        
        .route-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn-start-nav { background: linear-gradient(135deg, #00b894 0%, #00cec9 100%); color: #000; }
        .btn-cancel { background: #333; color: #fff; }
        
        /* PANELS */
        .panel {
            position: absolute;
            top: 0; bottom: 0; left: 0; right: 0;
            background: rgba(0,0,0,0.98);
            z-index: 2000;
            padding: 20px;
            padding-top: max(20px, env(safe-area-inset-top));
            display: none;
            overflow-y: auto;
        }
        
        .panel.show { display: block; }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }
        
        .panel-title { font-size: 20px; font-weight: 700; }
        .panel-close { background: none; border: none; color: #fff; font-size: 28px; cursor: pointer; }
        
        .panel-section {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .panel-section-title { font-weight: 600; margin-bottom: 15px; font-size: 14px; color: #00ff88; }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .setting-item:last-child { border-bottom: none; }
        .setting-value { color: #00ff88; font-size: 13px; }
        
        /* TRIP HISTORY */
        .trip-item {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .trip-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .trip-item-date { font-weight: 600; font-size: 14px; }
        .trip-item-miles { font-size: 18px; font-weight: 700; color: #00ff88; }
        .trip-item-details { font-size: 12px; color: #aaa; }
        .trip-item-states { font-size: 11px; color: #74b9ff; margin-top: 8px; }
        
        /* IFTA */
        .ifta-state {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .ifta-state:last-child { border-bottom: none; }
        .ifta-state-name { font-weight: 600; }
        .ifta-state-miles { color: #00ff88; font-weight: 600; }
        
        .ifta-total {
            background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
            color: #000;
            padding: 15px;
            border-radius: 12px;
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
            font-weight: 700;
        }
        
        /* LOADING */
        .loading {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 500;
            background: rgba(0,0,0,0.9);
            padding: 30px;
            border-radius: 15px;
            display: none;
        }
        
        .loading.show { display: block; }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #333;
            border-top: 4px solid #00ff88;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .truck-marker { font-size: 32px; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); }
        .poi-marker { font-size: 24px; text-shadow: 1px 1px 3px rgba(0,0,0,0.8); }
        .dest-marker { font-size: 28px; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); }
        
        .export-btns { display: flex; gap: 10px; margin-top: 15px; }
        .export-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- SCREEN 1: CODE ENTRY -->
    <div id="codeScreen" class="screen active code-screen">
        <div class="logo">üöõ</div>
        <div class="title">Genesis Trucker GPS</div>
        <div class="subtitle">Full Navigation + IFTA Tracking</div>
        <div class="subtitle-punjabi">‡®™‡©Ç‡®∞‡©Ä ‡®®‡©à‡®µ‡©Ä‡®ó‡©á‡®∏‡®º‡®® + IFTA ‡®ü‡®∞‡©à‡®ï‡®ø‡©∞‡®ó</div>
        
        <input type="text" class="code-input" id="inviteCode" placeholder="Enter code">
        <button class="btn btn-primary" onclick="validateCode()">üîì Enter / ‡®ê‡®™ ‡®ñ‡©ã‡®≤‡©ç‡®π‡©ã</button>
        <div class="error-msg" id="codeError">‚ùå Invalid code</div>
    </div>
    
    <!-- SCREEN 2: DRIVER SETUP -->
    <div id="setupScreen" class="screen setup-screen">
        <div class="setup-header">
            <div style="font-size:60px; margin-bottom:15px;">üöõ</div>
            <h2>Driver Setup</h2>
            <p style="color:#888; margin-top:5px;">‡®°‡®∞‡®æ‡®à‡®µ‡®∞ ‡®∏‡©à‡©±‡®ü‡®Ö‡©±‡®™</p>
        </div>
        
        <div class="form-card">
            <label class="form-label">Your Name / ‡®§‡©Å‡®π‡®æ‡®°‡®æ ‡®®‡®æ‡®Æ</label>
            <input type="text" class="form-input" id="driverName" placeholder="e.g., Harpreet Singh">
        </div>
        
        <div class="form-card">
            <label class="form-label">Truck Number / ‡®ü‡®∞‡©±‡®ï ‡®®‡©∞‡®¨‡®∞</label>
            <input type="text" class="form-input" id="truckNumber" placeholder="e.g., TX-12345">
        </div>
        
        <div class="form-card">
            <label class="form-label">Company Name / ‡®ï‡©∞‡®™‡®®‡©Ä ‡®¶‡®æ ‡®®‡®æ‡®Æ</label>
            <input type="text" class="form-input" id="companyName" placeholder="e.g., Singh Transport LLC">
        </div>
        
        <div class="form-card">
            <label class="form-label">Home State (for IFTA)</label>
            <select class="form-select" id="homeState">
                <option value="TX">Texas</option>
                <option value="CA">California</option>
                <option value="FL">Florida</option>
                <option value="IL">Illinois</option>
                <option value="NY">New York</option>
                <option value="PA">Pennsylvania</option>
                <option value="OH">Ohio</option>
                <option value="GA">Georgia</option>
                <option value="NC">North Carolina</option>
                <option value="MI">Michigan</option>
            </select>
        </div>
        
        <div class="form-card">
            <label class="form-label">Voice Navigation Language</label>
            <select class="form-select" id="voiceLang">
                <option value="en">English</option>
                <option value="pa">Punjabi (‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä)</option>
                <option value="both">Both / ‡®¶‡©ã‡®µ‡©á‡®Ç</option>
            </select>
        </div>
        
        <div style="max-width:500px; margin:0 auto;">
            <button class="btn btn-primary" onclick="completeSetup()" style="max-width:100%;">‚úÖ Start / ‡®∏‡®º‡©Å‡®∞‡©Ç ‡®ï‡®∞‡©ã</button>
        </div>
    </div>
    
    <!-- SCREEN 3: MAIN MAP -->
    <div id="mainScreen" class="screen main-screen">
        <div id="map"></div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div>Loading... / ‡®≤‡©ã‡®° ‡®π‡©ã ‡®∞‡®ø‡®π‡®æ...</div>
        </div>
        
        <div class="top-bar">
            <!-- TRIP RECORDING BANNER -->
            <div class="trip-banner" id="tripBanner">
                <div class="trip-banner-info">
                    <div class="trip-banner-dot"></div>
                    <div>
                        <div class="trip-banner-text">Recording Trip</div>
                        <div class="trip-banner-miles" id="tripMiles">0.0 mi</div>
                    </div>
                </div>
                <button class="trip-banner-btn" onclick="stopTrip()">‚èπÔ∏è Stop</button>
            </div>
            
            <!-- NAVIGATION DIRECTION BOX -->
            <div class="direction-box" id="directionBox">
                <div class="direction-main">
                    <span class="direction-icon" id="directionIcon">‚Üë</span>
                    <span class="direction-text" id="directionText">Head north on Main St</span>
                    <span class="direction-distance" id="directionDistance">0.5 mi</span>
                </div>
                <div class="direction-punjabi" id="directionPunjabi">Main St ‡®§‡©á ‡®â‡©±‡®§‡®∞ ‡®µ‡©±‡®≤ ‡®ú‡®æ‡®ì</div>
                <div class="nav-stats">
                    <div class="nav-stat">
                        <div class="nav-stat-value" id="navETA">--</div>
                        <div class="nav-stat-label">ETA</div>
                    </div>
                    <div class="nav-stat">
                        <div class="nav-stat-value" id="navRemaining">--</div>
                        <div class="nav-stat-label">Remaining</div>
                    </div>
                    <div class="nav-stat">
                        <div class="nav-stat-value" id="navSpeed">--</div>
                        <div class="nav-stat-label">Speed</div>
                    </div>
                </div>
                <div class="nav-controls">
                    <button class="nav-btn nav-btn-voice" id="voiceBtn" onclick="toggleVoice()">üîä Voice ON</button>
                    <button class="nav-btn nav-btn-stop" onclick="stopNavigation()">‚èπÔ∏è End Nav</button>
                </div>
            </div>
            
            <!-- SEARCH BAR (shown when not navigating) -->
            <div class="search-container" id="searchBar">
                <button class="menu-btn" onclick="toggleQuickMenu()">‚ò∞</button>
                <input type="text" class="search-input" id="searchInput" placeholder="üîç Search destination / ‡®Æ‡©∞‡®ú‡®º‡®ø‡®≤ ‡®ñ‡©ã‡®ú‡©ã">
                <button class="search-btn" onclick="searchDestination()">‚Üí</button>
            </div>
        </div>
        
        <div class="bottom-panel">
            <!-- QUICK MENU -->
            <div class="quick-menu" id="quickMenu">
                <div class="quick-menu-title">üìç Trip Recording</div>
                <div class="quick-grid" style="margin-bottom:15px;">
                    <button class="quick-btn green" onclick="startTrip()" id="startTripBtn">
                        <span class="quick-icon">‚ñ∂Ô∏è</span>
                        <span class="quick-text">Start Trip</span>
                    </button>
                    <button class="quick-btn red" onclick="stopTrip()" id="stopTripBtn" style="display:none;">
                        <span class="quick-icon">‚èπÔ∏è</span>
                        <span class="quick-text">Stop Trip</span>
                    </button>
                    <button class="quick-btn blue" onclick="openTripsPanel()">
                        <span class="quick-icon">üìä</span>
                        <span class="quick-text">History</span>
                    </button>
                    <button class="quick-btn blue" onclick="openIFTAPanel()">
                        <span class="quick-icon">üìã</span>
                        <span class="quick-text">IFTA</span>
                    </button>
                    <button class="quick-btn" onclick="openSettingsPanel()">
                        <span class="quick-icon">‚öôÔ∏è</span>
                        <span class="quick-text">Settings</span>
                    </button>
                </div>
                
                <div class="quick-menu-title">üçΩÔ∏è Find Food (In-App)</div>
                <div class="quick-grid" style="margin-bottom:15px;">
                    <button class="quick-btn highlight" onclick="searchPOI('indian')">
                        <span class="quick-icon">üçõ</span>
                        <span class="quick-text">Indian</span>
                    </button>
                    <button class="quick-btn highlight" onclick="searchPOI('indian')">
                        <span class="quick-icon">ü•ò</span>
                        <span class="quick-text">Dhaba</span>
                    </button>
                    <button class="quick-btn" onclick="searchPOI('restaurant')">
                        <span class="quick-icon">üçî</span>
                        <span class="quick-text">All Food</span>
                    </button>
                    <button class="quick-btn" onclick="searchPOI('fast_food')">
                        <span class="quick-icon">üçü</span>
                        <span class="quick-text">Fast Food</span>
                    </button>
                </div>
                
                <div class="quick-menu-title">üöõ Trucker Services (In-App)</div>
                <div class="quick-grid">
                    <button class="quick-btn" onclick="searchPOI('fuel')">
                        <span class="quick-icon">‚õΩ</span>
                        <span class="quick-text">Fuel</span>
                    </button>
                    <button class="quick-btn" onclick="searchPOI('parking')">
                        <span class="quick-icon">üÖøÔ∏è</span>
                        <span class="quick-text">Parking</span>
                    </button>
                    <button class="quick-btn" onclick="searchPOI('rest_area')">
                        <span class="quick-icon">üõèÔ∏è</span>
                        <span class="quick-text">Rest Area</span>
                    </button>
                    <button class="quick-btn" onclick="searchPOI('car_repair')">
                        <span class="quick-icon">üîß</span>
                        <span class="quick-text">Repair</span>
                    </button>
                </div>
            </div>
            
            <!-- POI SEARCH RESULTS -->
            <div class="poi-results" id="poiResults">
                <div class="poi-results-header">
                    <span class="poi-results-title" id="poiResultsTitle">üçõ Results</span>
                    <button class="poi-results-close" onclick="closePOIResults()">√ó</button>
                </div>
                <div id="poiResultsList"></div>
            </div>
            
            <!-- ROUTE INFO (before starting navigation) -->
            <div class="route-info" id="routeInfo">
                <div class="route-dest">
                    Destination: <strong id="routeDestName">Loading...</strong>
                </div>
                <div class="route-stats">
                    <div class="route-stat">
                        <div class="route-stat-value" id="routeDistance">--</div>
                        <div class="route-stat-label">Distance</div>
                    </div>
                    <div class="route-stat">
                        <div class="route-stat-value" id="routeTime">--</div>
                        <div class="route-stat-label">Time</div>
                    </div>
                </div>
                <div class="route-actions">
                    <button class="route-btn btn-cancel" onclick="cancelRoute()">‚úï Cancel</button>
                    <button class="route-btn btn-start-nav" onclick="startNavigation()">‚ñ∂Ô∏è Start Navigation</button>
                </div>
            </div>
        </div>
        
        <!-- SETTINGS PANEL -->
        <div class="panel" id="settingsPanel">
            <div class="panel-header">
                <span class="panel-title">‚öôÔ∏è Settings</span>
                <button class="panel-close" onclick="closePanel('settingsPanel')">√ó</button>
            </div>
            
            <div class="panel-section">
                <div class="panel-section-title">üöõ Driver Info</div>
                <div class="setting-item">
                    <span>Name</span>
                    <span class="setting-value" id="settingsName">-</span>
                </div>
                <div class="setting-item">
                    <span>Truck</span>
                    <span class="setting-value" id="settingsTruck">-</span>
                </div>
                <div class="setting-item">
                    <span>Company</span>
                    <span class="setting-value" id="settingsCompany">-</span>
                </div>
                <div class="setting-item">
                    <span>Home State</span>
                    <span class="setting-value" id="settingsState">-</span>
                </div>
            </div>
            
            <div class="panel-section">
                <div class="panel-section-title">üîä Voice Settings</div>
                <div class="setting-item">
                    <span>Voice Navigation</span>
                    <select class="form-select" id="settingsVoice" onchange="saveVoiceSetting()" style="width:120px;padding:8px;">
                        <option value="en">English</option>
                        <option value="pa">Punjabi</option>
                        <option value="both">Both</option>
                        <option value="off">Off</option>
                    </select>
                </div>
            </div>
            
            <div class="panel-section">
                <div class="panel-section-title">üìç GPS Status</div>
                <div class="setting-item">
                    <span>Status</span>
                    <span class="setting-value" id="settingsGps">-</span>
                </div>
                <div class="setting-item">
                    <span>Current State</span>
                    <span class="setting-value" id="settingsCurrentState">-</span>
                </div>
            </div>
            
            <button class="btn btn-danger" onclick="logout()" style="width:100%; margin-top:20px;">
                üö™ Logout
            </button>
        </div>
        
        <!-- TRIPS PANEL -->
        <div class="panel" id="tripsPanel">
            <div class="panel-header">
                <span class="panel-title">üìä Trip History</span>
                <button class="panel-close" onclick="closePanel('tripsPanel')">√ó</button>
            </div>
            <div id="tripsList"></div>
            <div class="export-btns">
                <button class="export-btn btn-blue" onclick="exportTrips('json')">üìÑ JSON</button>
                <button class="export-btn btn-primary" onclick="exportTrips('csv')">üìä CSV</button>
            </div>
        </div>
        
        <!-- IFTA PANEL -->
        <div class="panel" id="iftaPanel">
            <div class="panel-header">
                <span class="panel-title">üìã IFTA Report</span>
                <button class="panel-close" onclick="closePanel('iftaPanel')">√ó</button>
            </div>
            
            <div class="panel-section">
                <div class="panel-section-title">üìÖ Select Period</div>
                <div style="display:flex;gap:10px;">
                    <select class="form-select" id="iftaQuarter" onchange="generateIFTA()">
                        <option value="all">All Time</option>
                        <option value="q1">Q1 (Jan-Mar)</option>
                        <option value="q2">Q2 (Apr-Jun)</option>
                        <option value="q3">Q3 (Jul-Sep)</option>
                        <option value="q4">Q4 (Oct-Dec)</option>
                    </select>
                    <select class="form-select" id="iftaYear" onchange="generateIFTA()">
                        <option value="2026">2026</option>
                        <option value="2025">2025</option>
                    </select>
                </div>
            </div>
            
            <div class="panel-section">
                <div class="panel-section-title">üó∫Ô∏è Miles by State</div>
                <div id="iftaStates"></div>
                <div class="ifta-total">
                    <span>TOTAL</span>
                    <span id="iftaTotal">0.0 mi</span>
                </div>
            </div>
            
            <div class="export-btns">
                <button class="export-btn btn-primary" onclick="exportIFTA()">üìä Export IFTA CSV</button>
            </div>
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ============ CONFIGURATION ============
        const ORS_API_KEY = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImRlMDNiNzNlNDg4ZjQ2N2NiYmEyOThhZWNiMzdmOWI1IiwiaCI6Im11cm11cjY0In0=';
        const PROFILE_KEY = 'trucker_profile';
        const TRIPS_KEY = 'trucker_trips';
        
        // ============ STATE ============
        let profile = null;
        let map = null;
        let userMarker = null;
        let routeLine = null;
        let destMarker = null;
        let tripLine = null;
        let poiMarkers = [];
        
        let userLat = null;
        let userLon = null;
        let userSpeed = 0;
        let userHeading = 0;
        let watchId = null;
        
        let currentRoute = null;
        let routeSteps = [];
        let currentStepIndex = 0;
        let isNavigating = false;
        let destinationCoords = null;
        let destinationName = '';
        let routeTotalDistance = 0;
        let routeTotalTime = 0;
        
        let voiceEnabled = true;
        let voiceLang = 'en';
        
        let isTripActive = false;
        let currentTrip = null;
        let lastStateCheck = null;
        
        // State codes
        const US_STATES = {
            'Alabama':'AL','Alaska':'AK','Arizona':'AZ','Arkansas':'AR','California':'CA','Colorado':'CO',
            'Connecticut':'CT','Delaware':'DE','Florida':'FL','Georgia':'GA','Hawaii':'HI','Idaho':'ID',
            'Illinois':'IL','Indiana':'IN','Iowa':'IA','Kansas':'KS','Kentucky':'KY','Louisiana':'LA',
            'Maine':'ME','Maryland':'MD','Massachusetts':'MA','Michigan':'MI','Minnesota':'MN','Mississippi':'MS',
            'Missouri':'MO','Montana':'MT','Nebraska':'NE','Nevada':'NV','New Hampshire':'NH','New Jersey':'NJ',
            'New Mexico':'NM','New York':'NY','North Carolina':'NC','North Dakota':'ND','Ohio':'OH','Oklahoma':'OK',
            'Oregon':'OR','Pennsylvania':'PA','Rhode Island':'RI','South Carolina':'SC','South Dakota':'SD',
            'Tennessee':'TN','Texas':'TX','Utah':'UT','Vermont':'VT','Virginia':'VA','Washington':'WA',
            'West Virginia':'WV','Wisconsin':'WI','Wyoming':'WY'
        };
        
        const CA_PROVINCES = {
            'Alberta':'AB','British Columbia':'BC','Manitoba':'MB','New Brunswick':'NB',
            'Newfoundland and Labrador':'NL','Nova Scotia':'NS','Ontario':'ON','Prince Edward Island':'PE',
            'Quebec':'QC','Saskatchewan':'SK'
        };
        
        // Direction icons
        const DIR_ICONS = {
            'left':'‚Ü∞','right':'‚Ü±','sharp left':'‚Ü≤','sharp right':'‚Ü≥','slight left':'‚Üñ',
            'slight right':'‚Üó','straight':'‚Üë','uturn':'‚Ü©','arrive':'üèÅ','depart':'üöõ',
            'roundabout':'üîÑ','default':'‚Üí'
        };
        
        // Punjabi translations
        const PUNJABI = {
            'Turn left':'‡®ñ‡©±‡®¨‡©á ‡®Æ‡©Å‡©ú‡©ã','Turn right':'‡®∏‡©±‡®ú‡©á ‡®Æ‡©Å‡©ú‡©ã','Continue':'‡®ú‡®æ‡®∞‡©Ä ‡®∞‡©±‡®ñ‡©ã',
            'Head':'‡®µ‡©±‡®≤ ‡®ö‡©±‡®≤‡©ã','Arrive':'‡®™‡®π‡©Å‡©∞‡®ö ‡®ó‡®è','Keep left':'‡®ñ‡©±‡®¨‡©á ‡®∞‡®π‡©ã','Keep right':'‡®∏‡©±‡®ú‡©á ‡®∞‡®π‡©ã',
            'north':'‡®â‡©±‡®§‡®∞','south':'‡®¶‡©±‡®ñ‡®£','east':'‡®™‡©Ç‡®∞‡®¨','west':'‡®™‡©±‡®õ‡®Æ',
            'onto':'‡®§‡©á','on':'‡®§‡©á','Enter roundabout':'‡®ó‡©ã‡®≤ ‡®ö‡©±‡®ï‡®∞ ‡®µ‡®ø‡©±‡®ö ‡®ú‡®æ‡®ì',
            'meters':'‡®Æ‡©Ä‡®ü‡®∞','miles':'‡®Æ‡©Ä‡®≤','feet':'‡®´‡©Å‡©±‡®ü'
        };
        
        // ============ INITIALIZATION ============
        document.addEventListener('DOMContentLoaded', function() {
            const savedProfile = localStorage.getItem(PROFILE_KEY);
            const validatedCode = localStorage.getItem('trucker_validated_code');
            
            if (validatedCode && savedProfile) {
                profile = JSON.parse(savedProfile);
                showMainApp();
            } else if (validatedCode) {
                showScreen('setupScreen');
            }
        });
        
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }
        
        function validateCode() {
            let code = document.getElementById('inviteCode').value.trim().toUpperCase();
            if (!code.startsWith('TRUCK-')) code = 'TRUCK-' + code;
            
            if (code.startsWith('TRUCK-') && code.length >= 11) {
                localStorage.setItem('trucker_validated_code', code);
                showScreen('setupScreen');
                return;
            }
            document.getElementById('codeError').classList.add('show');
        }
        
        function completeSetup() {
            const name = document.getElementById('driverName').value.trim();
            if (!name) { alert('Please enter your name'); return; }
            
            profile = {
                name: name,
                truck: document.getElementById('truckNumber').value.trim() || 'Not set',
                company: document.getElementById('companyName').value.trim() || 'Not set',
                homeState: document.getElementById('homeState').value,
                voiceLang: document.getElementById('voiceLang').value,
                created: new Date().toISOString()
            };
            
            localStorage.setItem(PROFILE_KEY, JSON.stringify(profile));
            showMainApp();
        }
        
        function showMainApp() {
            showScreen('mainScreen');
            
            voiceLang = profile.voiceLang || 'en';
            
            document.getElementById('settingsName').textContent = profile.name;
            document.getElementById('settingsTruck').textContent = profile.truck;
            document.getElementById('settingsCompany').textContent = profile.company;
            document.getElementById('settingsState').textContent = profile.homeState;
            document.getElementById('settingsVoice').value = voiceLang;
            
            setTimeout(initMap, 100);
            startGPS();
            
            document.getElementById('searchInput').addEventListener('keypress', e => {
                if (e.key === 'Enter') searchDestination();
            });
        }
        
        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([32.7767, -96.7970], 12);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                maxZoom: 19,
                attribution: '¬© OpenStreetMap'
            }).addTo(map);
            
            const truckIcon = L.divIcon({
                html: '<div class="truck-marker">üöõ</div>',
                className: '',
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            });
            
            userMarker = L.marker([32.7767, -96.7970], { icon: truckIcon }).addTo(map);
        }
        
        function startGPS() {
            if (!navigator.geolocation) {
                document.getElementById('settingsGps').textContent = 'Not available';
                return;
            }
            
            watchId = navigator.geolocation.watchPosition(
                updateLocation,
                err => { document.getElementById('settingsGps').textContent = 'Error'; },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 2000 }
            );
        }
        
        function updateLocation(position) {
            const prevLat = userLat;
            const prevLon = userLon;
            
            userLat = position.coords.latitude;
            userLon = position.coords.longitude;
            userSpeed = position.coords.speed || 0;
            userHeading = position.coords.heading || 0;
            
            document.getElementById('settingsGps').textContent = 'Active ‚úì';
            
            if (userMarker) {
                userMarker.setLatLng([userLat, userLon]);
            }
            
            // Update speed display during navigation
            if (isNavigating) {
                const speedMph = Math.round(userSpeed * 2.237);
                document.getElementById('navSpeed').textContent = speedMph + ' mph';
                
                // Check if we should advance to next step
                checkNavigationProgress();
                
                // Center map on user
                map.setView([userLat, userLon], 16);
            } else if (!currentRoute) {
                map.setView([userLat, userLon], 14);
            }
            
            // Trip recording
            if (isTripActive && currentTrip && prevLat && prevLon) {
                const dist = getDistanceMiles(prevLat, prevLon, userLat, userLon);
                currentTrip.totalMiles += dist;
                document.getElementById('tripMiles').textContent = currentTrip.totalMiles.toFixed(1) + ' mi';
                
                if (tripLine) tripLine.addLatLng([userLat, userLon]);
                
                // Check state
                const now = Date.now();
                if (!lastStateCheck || (now - lastStateCheck) > 30000) {
                    lastStateCheck = now;
                    checkCurrentState();
                }
            }
        }
        
        // ============ NAVIGATION ============
        
        async function searchDestination() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;
            
            closeAllPanels();
            showLoading(true);
            
            try {
                const url = `https://api.openrouteservice.org/geocode/search?api_key=${ORS_API_KEY}&text=${encodeURIComponent(query)}&size=1`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (!data.features || data.features.length === 0) {
                    alert('Location not found / ‡®∏‡®•‡®æ‡®® ‡®®‡®π‡©Ä‡®Ç ‡®Æ‡®ø‡®≤‡®ø‡®Ü');
                    showLoading(false);
                    return;
                }
                
                const coords = data.features[0].geometry.coordinates;
                destinationCoords = { lat: coords[1], lon: coords[0] };
                destinationName = data.features[0].properties.label || query;
                
                await getRoute();
            } catch (error) {
                console.error('Search error:', error);
                alert('Search failed');
            }
            showLoading(false);
        }
        
        async function getRoute() {
            if (!userLat || !userLon || !destinationCoords) return;
            
            showLoading(true);
            
            try {
                // Use HGV (truck) profile
                const url = `https://api.openrouteservice.org/v2/directions/driving-hgv?api_key=${ORS_API_KEY}&start=${userLon},${userLat}&end=${destinationCoords.lon},${destinationCoords.lat}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (!data.features || data.features.length === 0) {
                    alert('Route not found');
                    showLoading(false);
                    return;
                }
                
                currentRoute = data.features[0];
                const coords = currentRoute.geometry.coordinates;
                const props = currentRoute.properties;
                const segments = props.segments[0];
                
                // Draw route
                if (routeLine) map.removeLayer(routeLine);
                if (destMarker) map.removeLayer(destMarker);
                
                const routeCoords = coords.map(c => [c[1], c[0]]);
                routeLine = L.polyline(routeCoords, { color: '#00ff88', weight: 6, opacity: 0.9 }).addTo(map);
                
                const destIcon = L.divIcon({
                    html: '<div class="dest-marker">üèÅ</div>',
                    className: '',
                    iconSize: [28, 28],
                    iconAnchor: [14, 28]
                });
                destMarker = L.marker([destinationCoords.lat, destinationCoords.lon], { icon: destIcon }).addTo(map);
                
                map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });
                
                // Parse route info
                routeTotalDistance = props.summary.distance;
                routeTotalTime = props.summary.duration;
                
                const distMi = (routeTotalDistance / 1609.34).toFixed(1);
                const timeMin = Math.round(routeTotalTime / 60);
                const timeHr = Math.floor(timeMin / 60);
                const timeRemMin = timeMin % 60;
                
                document.getElementById('routeDistance').textContent = distMi + ' mi';
                document.getElementById('routeTime').textContent = timeHr > 0 ? `${timeHr}h ${timeRemMin}m` : `${timeMin}m`;
                document.getElementById('routeDestName').textContent = destinationName;
                
                // Parse steps
                routeSteps = segments.steps.map(step => ({
                    instruction: step.instruction,
                    distance: step.distance,
                    duration: step.duration,
                    type: step.type,
                    wayPoints: step.way_points
                }));
                
                document.getElementById('routeInfo').classList.add('show');
                
            } catch (error) {
                console.error('Route error:', error);
                alert('Failed to get route');
            }
            showLoading(false);
        }
        
        function startNavigation() {
            if (!routeSteps || routeSteps.length === 0) return;
            
            isNavigating = true;
            currentStepIndex = 0;
            
            // Hide route info, show nav box
            document.getElementById('routeInfo').classList.remove('show');
            document.getElementById('searchBar').style.display = 'none';
            document.getElementById('directionBox').classList.add('show');
            
            // Update displays
            updateNavigationDisplay();
            
            // Announce first step
            if (voiceEnabled) {
                setTimeout(() => announceStep(routeSteps[0]), 500);
            }
            
            map.setView([userLat, userLon], 16);
        }
        
        function updateNavigationDisplay() {
            if (currentStepIndex >= routeSteps.length) {
                // Arrived!
                document.getElementById('directionIcon').textContent = 'üèÅ';
                document.getElementById('directionText').textContent = 'You have arrived!';
                document.getElementById('directionPunjabi').textContent = '‡®§‡©Å‡®∏‡©Ä‡®Ç ‡®™‡®π‡©Å‡©∞‡®ö ‡®ó‡®è ‡®π‡©ã!';
                document.getElementById('directionDistance').textContent = '';
                
                if (voiceEnabled) {
                    speak('You have arrived at your destination.');
                    if (voiceLang === 'pa' || voiceLang === 'both') {
                        setTimeout(() => speak('‡®§‡©Å‡®∏‡©Ä‡®Ç ‡®Ü‡®™‡®£‡©Ä ‡®Æ‡©∞‡®ú‡®º‡®ø‡®≤ ‡®§‡©á ‡®™‡®π‡©Å‡©∞‡®ö ‡®ó‡®è ‡®π‡©ã', 'pa'), 2000);
                    }
                }
                return;
            }
            
            const step = routeSteps[currentStepIndex];
            const icon = getDirectionIcon(step.instruction);
            const distStr = formatDistance(step.distance);
            
            document.getElementById('directionIcon').textContent = icon;
            document.getElementById('directionText').textContent = step.instruction;
            document.getElementById('directionPunjabi').textContent = translateToPunjabi(step.instruction);
            document.getElementById('directionDistance').textContent = distStr;
            
            // Calculate remaining distance and ETA
            let remainingDist = 0;
            let remainingTime = 0;
            for (let i = currentStepIndex; i < routeSteps.length; i++) {
                remainingDist += routeSteps[i].distance;
                remainingTime += routeSteps[i].duration;
            }
            
            document.getElementById('navRemaining').textContent = formatDistance(remainingDist);
            
            const eta = new Date(Date.now() + remainingTime * 1000);
            document.getElementById('navETA').textContent = eta.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }
        
        function checkNavigationProgress() {
            if (!isNavigating || currentStepIndex >= routeSteps.length) return;
            
            // Simple progress check - advance when close to step end
            // In production, would use actual waypoint coordinates
            const step = routeSteps[currentStepIndex];
            
            // Estimate if we've traveled the step distance
            // This is simplified - real implementation would track actual position along route
        }
        
        function advanceToNextStep() {
            currentStepIndex++;
            updateNavigationDisplay();
            
            if (currentStepIndex < routeSteps.length && voiceEnabled) {
                announceStep(routeSteps[currentStepIndex]);
            }
        }
        
        function announceStep(step) {
            const text = step.instruction;
            const dist = formatDistanceVoice(step.distance);
            
            const announcement = `In ${dist}, ${text}`;
            speak(announcement, 'en');
            
            if (voiceLang === 'pa' || voiceLang === 'both') {
                setTimeout(() => {
                    const punjabiText = translateToPunjabi(text);
                    speak(punjabiText, 'pa');
                }, 2500);
            }
        }
        
        function speak(text, lang = 'en') {
            if (!('speechSynthesis' in window)) return;
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = lang === 'pa' ? 'pa-IN' : 'en-US';
            utterance.rate = 0.9;
            utterance.pitch = 1;
            speechSynthesis.speak(utterance);
        }
        
        function toggleVoice() {
            voiceEnabled = !voiceEnabled;
            const btn = document.getElementById('voiceBtn');
            btn.textContent = voiceEnabled ? 'üîä Voice ON' : 'üîá Voice OFF';
            btn.classList.toggle('active', voiceEnabled);
        }
        
        function stopNavigation() {
            isNavigating = false;
            currentStepIndex = 0;
            
            document.getElementById('directionBox').classList.remove('show');
            document.getElementById('searchBar').style.display = 'flex';
            
            speechSynthesis.cancel();
            
            if (userLat && userLon) {
                map.setView([userLat, userLon], 14);
            }
        }
        
        function cancelRoute() {
            currentRoute = null;
            routeSteps = [];
            destinationCoords = null;
            destinationName = '';
            
            if (routeLine) { map.removeLayer(routeLine); routeLine = null; }
            if (destMarker) { map.removeLayer(destMarker); destMarker = null; }
            
            document.getElementById('routeInfo').classList.remove('show');
            document.getElementById('searchInput').value = '';
            
            if (userLat && userLon) map.setView([userLat, userLon], 14);
        }
        
        // ============ POI SEARCH ============
        
        async function searchPOI(type) {
            if (!userLat || !userLon) {
                alert('Waiting for GPS');
                return;
            }
            
            document.getElementById('quickMenu').classList.remove('show');
            showLoading(true);
            clearPOIMarkers();
            
            const POI_CONFIG = {
                'indian': { query: 'cuisine~"indian|pakistani|punjabi|curry"', icon: 'üçõ', title: 'Indian Food' },
                'restaurant': { query: 'amenity=restaurant', icon: 'üçî', title: 'Restaurants' },
                'fast_food': { query: 'amenity=fast_food', icon: 'üçü', title: 'Fast Food' },
                'fuel': { query: 'amenity=fuel', icon: '‚õΩ', title: 'Fuel Stations' },
                'parking': { query: 'amenity=parking', icon: 'üÖøÔ∏è', title: 'Parking' },
                'rest_area': { query: 'highway=rest_area', icon: 'üõèÔ∏è', title: 'Rest Areas' },
                'car_repair': { query: 'shop=car_repair', icon: 'üîß', title: 'Repair' }
            };
            
            const config = POI_CONFIG[type] || POI_CONFIG['restaurant'];
            
            try {
                const radius = 25000; // 25km
                const bbox = getBBox(userLat, userLon, radius);
                
                let query;
                if (type === 'indian') {
                    query = `[out:json][timeout:30];
                        (node["amenity"="restaurant"]["cuisine"~"indian|pakistani|punjabi|curry|south_asian",i](${bbox});
                         way["amenity"="restaurant"]["cuisine"~"indian|pakistani|punjabi|curry|south_asian",i](${bbox});
                         node["amenity"="restaurant"]["name"~"india|punjab|dhaba|tandoor|curry|masala|biryani",i](${bbox});
                         way["amenity"="restaurant"]["name"~"india|punjab|dhaba|tandoor|curry|masala|biryani",i](${bbox});
                        );out center 30;`;
                } else if (type === 'rest_area') {
                    query = `[out:json][timeout:30];
                        (node["highway"="rest_area"](${bbox});
                         way["highway"="rest_area"](${bbox});
                         node["highway"="services"](${bbox});
                         way["highway"="services"](${bbox});
                        );out center 30;`;
                } else {
                    const [key, val] = config.query.split('=');
                    query = `[out:json][timeout:30];
                        (node["${key}"="${val}"](${bbox});
                         way["${key}"="${val}"](${bbox});
                        );out center 40;`;
                }
                
                const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: query
                });
                
                const data = await response.json();
                
                if (!data.elements || data.elements.length === 0) {
                    alert('No results found nearby');
                    showLoading(false);
                    return;
                }
                
                const pois = data.elements.map(el => ({
                    id: el.id,
                    name: el.tags?.name || 'Unnamed',
                    lat: el.lat || el.center?.lat,
                    lon: el.lon || el.center?.lon,
                    cuisine: el.tags?.cuisine || '',
                    brand: el.tags?.brand || '',
                    address: formatAddr(el.tags),
                    distance: getDistanceMiles(userLat, userLon, el.lat || el.center?.lat, el.lon || el.center?.lon)
                })).filter(p => p.lat && p.lon)
                  .sort((a, b) => a.distance - b.distance)
                  .slice(0, 25);
                
                // Add markers
                pois.forEach(poi => {
                    const icon = L.divIcon({
                        html: `<div class="poi-marker">${config.icon}</div>`,
                        className: '',
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    });
                    
                    const marker = L.marker([poi.lat, poi.lon], { icon })
                        .addTo(map)
                        .bindPopup(`<b>${poi.name}</b><br>${poi.distance.toFixed(1)} mi`);
                    
                    marker.on('click', () => selectPOI(poi));
                    poiMarkers.push(marker);
                });
                
                if (poiMarkers.length > 0) {
                    const group = new L.featureGroup(poiMarkers);
                    map.fitBounds(group.getBounds().pad(0.1));
                }
                
                displayPOIResults(pois, config);
                
            } catch (error) {
                console.error('POI error:', error);
                alert('Search failed');
            }
            showLoading(false);
        }
        
        function displayPOIResults(pois, config) {
            document.getElementById('poiResultsTitle').textContent = `${config.icon} ${config.title} (${pois.length})`;
            
            document.getElementById('poiResultsList').innerHTML = pois.map((poi, i) => `
                <div class="poi-item" onclick="selectPOIByIndex(${i})">
                    <div class="poi-item-header">
                        <span class="poi-item-name">${poi.name}</span>
                        <span class="poi-item-dist">${poi.distance.toFixed(1)} mi</span>
                    </div>
                    ${poi.cuisine ? `<div class="poi-item-cuisine">üçΩÔ∏è ${poi.cuisine}</div>` : ''}
                    ${poi.brand ? `<div class="poi-item-cuisine">üè™ ${poi.brand}</div>` : ''}
                    ${poi.address ? `<div class="poi-item-address">üìç ${poi.address}</div>` : ''}
                </div>
            `).join('');
            
            window._currentPOIs = pois;
            document.getElementById('poiResults').classList.add('show');
        }
        
        function selectPOIByIndex(i) {
            selectPOI(window._currentPOIs[i]);
        }
        
        function selectPOI(poi) {
            destinationCoords = { lat: poi.lat, lon: poi.lon };
            destinationName = poi.name;
            document.getElementById('searchInput').value = poi.name;
            closePOIResults();
            getRoute();
        }
        
        function closePOIResults() {
            document.getElementById('poiResults').classList.remove('show');
        }
        
        function clearPOIMarkers() {
            poiMarkers.forEach(m => map.removeLayer(m));
            poiMarkers = [];
        }
        
        // ============ TRIP RECORDING ============
        
        function startTrip() {
            if (isTripActive) return;
            
            isTripActive = true;
            currentTrip = {
                id: Date.now(),
                startTime: new Date().toISOString(),
                endTime: null,
                totalMiles: 0,
                stateLog: [],
                stateMiles: {}
            };
            
            tripLine = L.polyline([[userLat, userLon]], {
                color: '#e74c3c',
                weight: 4,
                opacity: 0.8
            }).addTo(map);
            
            document.getElementById('tripBanner').classList.add('show');
            document.getElementById('startTripBtn').style.display = 'none';
            document.getElementById('stopTripBtn').style.display = 'block';
            document.getElementById('quickMenu').classList.remove('show');
            
            checkCurrentState();
        }
        
        function stopTrip() {
            if (!isTripActive || !currentTrip) return;
            
            isTripActive = false;
            currentTrip.endTime = new Date().toISOString();
            calculateStateMiles();
            
            const trips = JSON.parse(localStorage.getItem(TRIPS_KEY) || '[]');
            trips.unshift(currentTrip);
            localStorage.setItem(TRIPS_KEY, JSON.stringify(trips));
            
            document.getElementById('tripBanner').classList.remove('show');
            document.getElementById('startTripBtn').style.display = 'block';
            document.getElementById('stopTripBtn').style.display = 'none';
            
            if (tripLine) tripLine.setStyle({ color: '#00ff88', opacity: 0.5 });
            
            alert(`Trip saved: ${currentTrip.totalMiles.toFixed(1)} miles`);
            currentTrip = null;
        }
        
        async function checkCurrentState() {
            if (!userLat || !userLon) return;
            
            try {
                const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${userLat}&lon=${userLon}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.address) {
                    const state = data.address.state || data.address.province || '';
                    const country = data.address.country_code?.toUpperCase() || '';
                    
                    let stateCode = US_STATES[state] || CA_PROVINCES[state] || state;
                    
                    document.getElementById('settingsCurrentState').textContent = stateCode || '-';
                    
                    if (isTripActive && currentTrip && stateCode) {
                        const last = currentTrip.stateLog[currentTrip.stateLog.length - 1];
                        if (!last || last.state !== stateCode) {
                            currentTrip.stateLog.push({
                                state: stateCode,
                                entryMiles: currentTrip.totalMiles
                            });
                        }
                    }
                }
            } catch (e) {}
        }
        
        function calculateStateMiles() {
            if (!currentTrip || currentTrip.stateLog.length === 0) return;
            
            for (let i = 0; i < currentTrip.stateLog.length; i++) {
                const entry = currentTrip.stateLog[i];
                const next = currentTrip.stateLog[i + 1];
                
                const miles = next ? next.entryMiles - entry.entryMiles : currentTrip.totalMiles - entry.entryMiles;
                
                if (!currentTrip.stateMiles[entry.state]) currentTrip.stateMiles[entry.state] = 0;
                currentTrip.stateMiles[entry.state] += miles;
            }
        }
        
        // ============ PANELS ============
        
        function toggleQuickMenu() {
            closeAllPanels();
            document.getElementById('quickMenu').classList.toggle('show');
        }
        
        function closeAllPanels() {
            document.getElementById('quickMenu').classList.remove('show');
            document.getElementById('poiResults').classList.remove('show');
            document.getElementById('routeInfo').classList.remove('show');
        }
        
        function openSettingsPanel() {
            document.getElementById('quickMenu').classList.remove('show');
            document.getElementById('settingsPanel').classList.add('show');
        }
        
        function openTripsPanel() {
            document.getElementById('quickMenu').classList.remove('show');
            renderTrips();
            document.getElementById('tripsPanel').classList.add('show');
        }
        
        function openIFTAPanel() {
            document.getElementById('quickMenu').classList.remove('show');
            generateIFTA();
            document.getElementById('iftaPanel').classList.add('show');
        }
        
        function closePanel(id) {
            document.getElementById(id).classList.remove('show');
        }
        
        function renderTrips() {
            const trips = JSON.parse(localStorage.getItem(TRIPS_KEY) || '[]');
            const list = document.getElementById('tripsList');
            
            if (trips.length === 0) {
                list.innerHTML = '<div style="text-align:center;color:#888;padding:40px;">No trips yet</div>';
                return;
            }
            
            list.innerHTML = trips.slice(0, 50).map(t => `
                <div class="trip-item">
                    <div class="trip-item-header">
                        <span class="trip-item-date">${new Date(t.startTime).toLocaleDateString()}</span>
                        <span class="trip-item-miles">${t.totalMiles.toFixed(1)} mi</span>
                    </div>
                    <div class="trip-item-details">${new Date(t.startTime).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} - ${t.endTime ? new Date(t.endTime).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : '-'}</div>
                    <div class="trip-item-states">üìç ${Object.keys(t.stateMiles || {}).join(', ') || '-'}</div>
                </div>
            `).join('');
        }
        
        function generateIFTA() {
            const trips = JSON.parse(localStorage.getItem(TRIPS_KEY) || '[]');
            const quarter = document.getElementById('iftaQuarter').value;
            const year = parseInt(document.getElementById('iftaYear').value);
            
            const filtered = trips.filter(t => {
                const d = new Date(t.startTime);
                const y = d.getFullYear();
                const m = d.getMonth() + 1;
                
                if (quarter === 'all') return true;
                if (y !== year) return false;
                if (quarter === 'q1' && m >= 1 && m <= 3) return true;
                if (quarter === 'q2' && m >= 4 && m <= 6) return true;
                if (quarter === 'q3' && m >= 7 && m <= 9) return true;
                if (quarter === 'q4' && m >= 10 && m <= 12) return true;
                return false;
            });
            
            const stateMiles = {};
            filtered.forEach(t => {
                for (const [s, m] of Object.entries(t.stateMiles || {})) {
                    if (!stateMiles[s]) stateMiles[s] = 0;
                    stateMiles[s] += m;
                }
            });
            
            const sorted = Object.entries(stateMiles).sort((a, b) => b[1] - a[1]);
            
            document.getElementById('iftaStates').innerHTML = sorted.length === 0 ?
                '<div style="text-align:center;color:#888;padding:20px;">No data</div>' :
                sorted.map(([s, m]) => `<div class="ifta-state"><span class="ifta-state-name">${s}</span><span class="ifta-state-miles">${m.toFixed(1)} mi</span></div>`).join('');
            
            const total = sorted.reduce((a, [_, m]) => a + m, 0);
            document.getElementById('iftaTotal').textContent = total.toFixed(1) + ' mi';
        }
        
        function saveVoiceSetting() {
            voiceLang = document.getElementById('settingsVoice').value;
            voiceEnabled = voiceLang !== 'off';
            profile.voiceLang = voiceLang;
            localStorage.setItem(PROFILE_KEY, JSON.stringify(profile));
        }
        
        // ============ EXPORT ============
        
        function exportTrips(format) {
            const trips = JSON.parse(localStorage.getItem(TRIPS_KEY) || '[]');
            if (trips.length === 0) { alert('No trips'); return; }
            
            let content, filename, type;
            
            if (format === 'json') {
                content = JSON.stringify(trips, null, 2);
                filename = `trips_${new Date().toISOString().split('T')[0]}.json`;
                type = 'application/json';
            } else {
                const rows = [['Date','Start','End','Miles','States']];
                trips.forEach(t => rows.push([
                    new Date(t.startTime).toLocaleDateString(),
                    new Date(t.startTime).toLocaleTimeString(),
                    t.endTime ? new Date(t.endTime).toLocaleTimeString() : '',
                    t.totalMiles.toFixed(1),
                    Object.keys(t.stateMiles || {}).join(';')
                ]));
                content = rows.map(r => r.join(',')).join('\n');
                filename = `trips_${new Date().toISOString().split('T')[0]}.csv`;
                type = 'text/csv';
            }
            
            download(content, filename, type);
        }
        
        function exportIFTA() {
            const trips = JSON.parse(localStorage.getItem(TRIPS_KEY) || '[]');
            const stateMiles = {};
            trips.forEach(t => {
                for (const [s, m] of Object.entries(t.stateMiles || {})) {
                    if (!stateMiles[s]) stateMiles[s] = 0;
                    stateMiles[s] += m;
                }
            });
            
            const rows = [['State','Miles']];
            Object.entries(stateMiles).sort((a,b) => b[1]-a[1]).forEach(([s, m]) => rows.push([s, m.toFixed(1)]));
            rows.push(['TOTAL', Object.values(stateMiles).reduce((a,b) => a+b, 0).toFixed(1)]);
            
            download(rows.map(r => r.join(',')).join('\n'), 'IFTA_Report.csv', 'text/csv');
        }
        
        function download(content, filename, type) {
            const blob = new Blob([content], { type });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            a.click();
        }
        
        // ============ UTILITIES ============
        
        function getDistanceMiles(lat1, lon1, lat2, lon2) {
            const R = 3959;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }
        
        function getBBox(lat, lon, radius) {
            const latD = radius / 111000;
            const lonD = radius / (111000 * Math.cos(lat * Math.PI / 180));
            return `${lat-latD},${lon-lonD},${lat+latD},${lon+lonD}`;
        }
        
        function formatAddr(tags) {
            if (!tags) return '';
            const parts = [];
            if (tags['addr:housenumber']) parts.push(tags['addr:housenumber']);
            if (tags['addr:street']) parts.push(tags['addr:street']);
            if (tags['addr:city']) parts.push(tags['addr:city']);
            return parts.join(' ');
        }
        
        function formatDistance(m) {
            if (m >= 1609) return (m / 1609.34).toFixed(1) + ' mi';
            return Math.round(m * 3.28) + ' ft';
        }
        
        function formatDistanceVoice(m) {
            if (m >= 1609) return (m / 1609.34).toFixed(1) + ' miles';
            if (m >= 400) return Math.round(m * 3.28 / 100) * 100 + ' feet';
            return Math.round(m * 3.28) + ' feet';
        }
        
        function getDirectionIcon(text) {
            const l = text.toLowerCase();
            if (l.includes('sharp') && l.includes('left')) return DIR_ICONS['sharp left'];
            if (l.includes('sharp') && l.includes('right')) return DIR_ICONS['sharp right'];
            if (l.includes('slight') && l.includes('left')) return DIR_ICONS['slight left'];
            if (l.includes('slight') && l.includes('right')) return DIR_ICONS['slight right'];
            if (l.includes('left')) return DIR_ICONS['left'];
            if (l.includes('right')) return DIR_ICONS['right'];
            if (l.includes('straight') || l.includes('continue')) return DIR_ICONS['straight'];
            if (l.includes('arrive')) return DIR_ICONS['arrive'];
            if (l.includes('depart') || l.includes('head')) return DIR_ICONS['depart'];
            if (l.includes('roundabout')) return DIR_ICONS['roundabout'];
            return DIR_ICONS['default'];
        }
        
        function translateToPunjabi(text) {
            let t = text;
            for (const [e, p] of Object.entries(PUNJABI)) {
                t = t.replace(new RegExp(e, 'gi'), p);
            }
            return t;
        }
        
        function showLoading(show) {
            document.getElementById('loading').classList.toggle('show', show);
        }
        
        function logout() {
            if (isTripActive && !confirm('Trip recording! Stop and logout?')) return;
            if (isTripActive) stopTrip();
            if (watchId) navigator.geolocation.clearWatch(watchId);
            localStorage.removeItem(PROFILE_KEY);
            localStorage.removeItem('trucker_validated_code');
            location.reload();
        }
    </script>
</body>
</html>
