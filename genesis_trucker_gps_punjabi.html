<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>üöõ Genesis Trucker GPS</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            height: 100vh;
            color: #fff;
            overflow: hidden;
        }
        
        .screen { display: none; height: 100vh; width: 100%; }
        .screen.active { display: flex; flex-direction: column; }
        
        /* CODE SCREEN */
        .code-screen {
            justify-content: center;
            align-items: center;
            padding: 40px 20px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }
        
        .logo { font-size: 80px; margin-bottom: 20px; }
        .title { font-size: 28px; font-weight: 700; margin-bottom: 10px; text-align: center; }
        .subtitle { color: #aaa; margin-bottom: 10px; text-align: center; }
        .subtitle-punjabi { color: #888; margin-bottom: 30px; text-align: center; font-size: 14px; }
        
        .code-input {
            width: 100%;
            max-width: 300px;
            padding: 18px;
            font-size: 20px;
            text-align: center;
            border: 3px solid #333;
            border-radius: 15px;
            background: #111;
            color: #00ff88;
            letter-spacing: 3px;
            text-transform: uppercase;
        }
        
        .code-input:focus { outline: none; border-color: #00ff88; }
        
        .btn {
            width: 100%;
            max-width: 300px;
            padding: 18px;
            margin-top: 15px;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
        }
        
        .btn-primary { background: linear-gradient(135deg, #00b894 0%, #00cec9 100%); color: #000; }
        .btn-secondary { background: linear-gradient(135deg, #636e72 0%, #2d3436 100%); color: #fff; }
        .btn-danger { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: #fff; }
        .btn-blue { background: linear-gradient(135deg, #0984e3 0%, #74b9ff 100%); color: #fff; }
        
        .error-msg { color: #ff6b6b; margin-top: 15px; text-align: center; display: none; }
        .error-msg.show { display: block; }
        
        /* SETUP SCREEN */
        .setup-screen {
            padding: 30px 20px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            overflow-y: auto;
        }
        
        .setup-header { text-align: center; margin-bottom: 30px; }
        
        .form-card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .form-label { display: block; margin-bottom: 5px; font-weight: 600; color: #ccc; }
        .form-label-punjabi { display: block; margin-bottom: 8px; font-size: 12px; color: #888; }
        
        .form-input, .form-select {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            background: rgba(0,0,0,0.3);
            color: #fff;
            font-size: 16px;
        }
        
        .form-input:focus, .form-select:focus { outline: none; border-color: #00ff88; }
        
        /* MAIN APP - FULL MAP */
        .main-screen { background: #0a0a0a; position: relative; }
        
        /* TOP BAR */
        .top-bar {
            position: absolute;
            top: 0; left: 0; right: 0;
            z-index: 1000;
            padding: 10px;
            padding-top: max(10px, env(safe-area-inset-top));
        }
        
        /* TRIP RECORDING BANNER */
        .trip-banner {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            border-radius: 10px;
            padding: 10px 15px;
            margin-bottom: 10px;
            display: none;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .trip-banner.show { display: flex; }
        
        .trip-banner-info { display: flex; align-items: center; gap: 10px; }
        .trip-banner-dot { width: 12px; height: 12px; background: #fff; border-radius: 50%; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .trip-banner-text { font-size: 13px; font-weight: 600; }
        .trip-banner-miles { font-size: 11px; opacity: 0.9; }
        .trip-banner-btn { background: rgba(0,0,0,0.3); border: none; padding: 8px 12px; border-radius: 8px; color: #fff; font-size: 12px; cursor: pointer; }
        
        /* DIRECTION BOX */
        .direction-box {
            background: linear-gradient(135deg, #2d3436 0%, #636e72 100%);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .direction-box.show { display: block; }
        
        .direction-icon { font-size: 30px; float: left; margin-right: 15px; }
        .direction-text { font-size: 16px; font-weight: 600; line-height: 1.3; }
        .direction-punjabi { font-size: 13px; color: #aaa; margin-top: 5px; }
        .direction-distance { font-size: 12px; color: #00ff88; margin-top: 5px; }
        
        /* SEARCH BAR */
        .search-container { display: flex; gap: 10px; }
        
        .search-input {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            background: rgba(0,0,0,0.8);
            color: #fff;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .search-input:focus { outline: 2px solid #00ff88; }
        
        .search-btn, .menu-btn {
            padding: 15px;
            border: none;
            border-radius: 12px;
            background: rgba(0,0,0,0.8);
            color: #fff;
            font-size: 18px;
            cursor: pointer;
        }
        
        .search-btn { background: #00b894; }
        
        /* MAP */
        #map {
            position: absolute;
            top: 0; bottom: 0; left: 0; right: 0;
            z-index: 1;
        }
        
        /* BOTTOM PANEL */
        .bottom-panel {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            z-index: 1000;
            padding: 10px;
            padding-bottom: max(10px, env(safe-area-inset-bottom));
        }
        
        /* QUICK SEARCH DROPDOWN */
        .quick-menu {
            background: rgba(0,0,0,0.95);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            display: none;
            max-height: 350px;
            overflow-y: auto;
        }
        
        .quick-menu.show { display: block; }
        
        .quick-menu-title { font-size: 12px; color: #888; margin-bottom: 10px; text-transform: uppercase; }
        
        .quick-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        
        .quick-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 10px;
            padding: 12px 5px;
            text-align: center;
            cursor: pointer;
            color: #fff;
        }
        
        .quick-btn.highlight { background: linear-gradient(135deg, #ff9f43 0%, #ee5a24 100%); }
        .quick-btn.red { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }
        .quick-btn.green { background: linear-gradient(135deg, #00b894 0%, #00cec9 100%); color: #000; }
        .quick-btn.blue { background: linear-gradient(135deg, #0984e3 0%, #74b9ff 100%); }
        
        .quick-icon { font-size: 20px; display: block; }
        .quick-text { font-size: 9px; color: #ccc; display: block; margin-top: 3px; }
        .quick-btn.highlight .quick-text, .quick-btn.red .quick-text, .quick-btn.green .quick-text, .quick-btn.blue .quick-text { color: #fff; }
        
        /* ROUTE INFO */
        .route-info {
            background: rgba(0,0,0,0.9);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            display: none;
        }
        
        .route-info.show { display: block; }
        
        .route-stats { display: flex; justify-content: space-around; margin-bottom: 15px; }
        .route-stat { text-align: center; }
        .route-stat-value { font-size: 24px; font-weight: 700; color: #00ff88; }
        .route-stat-label { font-size: 10px; color: #888; }
        
        .route-actions { display: flex; gap: 10px; }
        
        .route-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn-start { background: linear-gradient(135deg, #00b894 0%, #00cec9 100%); color: #000; }
        .btn-voice { background: linear-gradient(135deg, #0984e3 0%, #74b9ff 100%); color: #fff; }
        .btn-cancel { background: #333; color: #fff; }
        
        /* STEPS LIST */
        .steps-list {
            background: rgba(0,0,0,0.95);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        
        .steps-list.show { display: block; }
        
        .step-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .step-item:last-child { border-bottom: none; }
        .step-icon { font-size: 18px; margin-right: 10px; }
        .step-text { flex: 1; font-size: 12px; }
        .step-dist { font-size: 11px; color: #00ff88; }
        
        /* PANELS */
        .panel {
            position: absolute;
            top: 0; bottom: 0; left: 0; right: 0;
            background: rgba(0,0,0,0.98);
            z-index: 2000;
            padding: 20px;
            padding-top: max(20px, env(safe-area-inset-top));
            display: none;
            overflow-y: auto;
        }
        
        .panel.show { display: block; }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }
        
        .panel-title { font-size: 20px; font-weight: 700; }
        .panel-close { background: none; border: none; color: #fff; font-size: 28px; cursor: pointer; }
        
        .panel-section {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .panel-section-title { font-weight: 600; margin-bottom: 15px; font-size: 14px; color: #00ff88; }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .setting-item:last-child { border-bottom: none; }
        .setting-value { color: #00ff88; font-size: 13px; }
        
        /* TRIP HISTORY */
        .trip-item {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .trip-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .trip-item-date { font-weight: 600; font-size: 14px; }
        .trip-item-miles { font-size: 18px; font-weight: 700; color: #00ff88; }
        .trip-item-details { font-size: 12px; color: #aaa; }
        .trip-item-states { font-size: 11px; color: #74b9ff; margin-top: 8px; }
        
        /* IFTA REPORT */
        .ifta-state {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .ifta-state:last-child { border-bottom: none; }
        .ifta-state-name { font-weight: 600; }
        .ifta-state-miles { color: #00ff88; font-weight: 600; }
        
        .ifta-total {
            background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
            color: #000;
            padding: 15px;
            border-radius: 12px;
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
            font-weight: 700;
        }
        
        /* LOADING */
        .loading {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 500;
            display: none;
        }
        
        .loading.show { display: block; }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #333;
            border-top: 4px solid #00ff88;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .truck-marker { font-size: 30px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        
        /* Export buttons */
        .export-btns { display: flex; gap: 10px; margin-top: 15px; }
        .export-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- SCREEN 1: CODE ENTRY -->
    <div id="codeScreen" class="screen active code-screen">
        <div class="logo">üöõ</div>
        <div class="title">Genesis Trucker GPS</div>
        <div class="subtitle">Truck-friendly navigation + IFTA tracking</div>
        <div class="subtitle-punjabi">‡®ü‡®∞‡©±‡®ï‡®∞‡®æ‡®Ç ‡®≤‡®à GPS ‡®ê‡®™</div>
        
        <input type="text" class="code-input" id="inviteCode" placeholder="Enter code">
        <button class="btn btn-primary" onclick="validateCode()">üîì Enter / ‡®ê‡®™ ‡®ñ‡©ã‡®≤‡©ç‡®π‡©ã</button>
        <div class="error-msg" id="codeError">‚ùå Invalid code</div>
    </div>
    
    <!-- SCREEN 2: DRIVER SETUP -->
    <div id="setupScreen" class="screen setup-screen">
        <div class="setup-header">
            <div style="font-size:60px; margin-bottom:15px;">üöõ</div>
            <h2>Driver Setup</h2>
            <p style="color:#888; margin-top:5px;">‡®°‡®∞‡®æ‡®à‡®µ‡®∞ ‡®∏‡©à‡©±‡®ü‡®Ö‡©±‡®™</p>
        </div>
        
        <div class="form-card">
            <label class="form-label">Your Name</label>
            <label class="form-label-punjabi">‡®§‡©Å‡®π‡®æ‡®°‡®æ ‡®®‡®æ‡®Æ</label>
            <input type="text" class="form-input" id="driverName" placeholder="e.g., Harpreet Singh">
        </div>
        
        <div class="form-card">
            <label class="form-label">Truck Number</label>
            <label class="form-label-punjabi">‡®ü‡®∞‡©±‡®ï ‡®®‡©∞‡®¨‡®∞</label>
            <input type="text" class="form-input" id="truckNumber" placeholder="e.g., TX-12345">
        </div>
        
        <div class="form-card">
            <label class="form-label">Company Name</label>
            <label class="form-label-punjabi">‡®ï‡©∞‡®™‡®®‡©Ä ‡®¶‡®æ ‡®®‡®æ‡®Æ</label>
            <input type="text" class="form-input" id="companyName" placeholder="e.g., Singh Transport LLC">
        </div>
        
        <div class="form-card">
            <label class="form-label">Home State (for IFTA)</label>
            <label class="form-label-punjabi">‡®ò‡®∞ ‡®¶‡®æ ‡®∞‡®æ‡®ú</label>
            <select class="form-select" id="homeState">
                <option value="TX">Texas</option>
                <option value="CA">California</option>
                <option value="FL">Florida</option>
                <option value="IL">Illinois</option>
                <option value="NY">New York</option>
                <option value="PA">Pennsylvania</option>
                <option value="OH">Ohio</option>
                <option value="GA">Georgia</option>
                <option value="NC">North Carolina</option>
                <option value="MI">Michigan</option>
            </select>
        </div>
        
        <div style="max-width:500px; margin:0 auto;">
            <button class="btn btn-primary" onclick="completeSetup()" style="max-width:100%;">‚úÖ Start / ‡®∏‡®º‡©Å‡®∞‡©Ç ‡®ï‡®∞‡©ã</button>
        </div>
    </div>
    
    <!-- SCREEN 3: MAIN MAP -->
    <div id="mainScreen" class="screen main-screen">
        <div id="map"></div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div>Loading... / ‡®≤‡©ã‡®° ‡®π‡©ã ‡®∞‡®ø‡®π‡®æ...</div>
        </div>
        
        <div class="top-bar">
            <!-- TRIP RECORDING BANNER -->
            <div class="trip-banner" id="tripBanner">
                <div class="trip-banner-info">
                    <div class="trip-banner-dot"></div>
                    <div>
                        <div class="trip-banner-text">Recording Trip</div>
                        <div class="trip-banner-miles" id="tripMiles">0.0 mi</div>
                    </div>
                </div>
                <button class="trip-banner-btn" onclick="stopTrip()">‚èπÔ∏è Stop</button>
            </div>
            
            <!-- CURRENT DIRECTION -->
            <div class="direction-box" id="directionBox">
                <span class="direction-icon" id="directionIcon">‚Üë</span>
                <div class="direction-text" id="directionText">Head north</div>
                <div class="direction-punjabi" id="directionPunjabi">‡®â‡©±‡®§‡®∞ ‡®µ‡©±‡®≤ ‡®ú‡®æ‡®ì</div>
                <div class="direction-distance" id="directionDistance">500 m</div>
            </div>
            
            <!-- SEARCH BAR -->
            <div class="search-container">
                <button class="menu-btn" onclick="toggleQuickMenu()">‚ò∞</button>
                <input type="text" class="search-input" id="searchInput" placeholder="üîç Search / ‡®ñ‡©ã‡®ú‡©ã">
                <button class="search-btn" onclick="searchDestination()">‚Üí</button>
            </div>
        </div>
        
        <div class="bottom-panel">
            <!-- QUICK MENU -->
            <div class="quick-menu" id="quickMenu">
                <div class="quick-menu-title">üìç Trip / ‡®Ø‡®æ‡®§‡®∞‡®æ</div>
                <div class="quick-grid" style="margin-bottom:15px;">
                    <button class="quick-btn green" onclick="startTrip()" id="startTripBtn">
                        <span class="quick-icon">‚ñ∂Ô∏è</span>
                        <span class="quick-text">Start Trip</span>
                    </button>
                    <button class="quick-btn red" onclick="stopTrip()" id="stopTripBtn" style="display:none;">
                        <span class="quick-icon">‚èπÔ∏è</span>
                        <span class="quick-text">Stop Trip</span>
                    </button>
                    <button class="quick-btn blue" onclick="openTripsPanel()">
                        <span class="quick-icon">üìä</span>
                        <span class="quick-text">History</span>
                    </button>
                    <button class="quick-btn blue" onclick="openIFTAPanel()">
                        <span class="quick-icon">üìã</span>
                        <span class="quick-text">IFTA</span>
                    </button>
                    <button class="quick-btn" onclick="openSettingsPanel()">
                        <span class="quick-icon">‚öôÔ∏è</span>
                        <span class="quick-text">Settings</span>
                    </button>
                </div>
                
                <div class="quick-menu-title">üçΩÔ∏è Food / ‡®ñ‡®æ‡®£‡®æ</div>
                <div class="quick-grid" style="margin-bottom:15px;">
                    <button class="quick-btn highlight" onclick="searchPOI('indian restaurant')">
                        <span class="quick-icon">üçõ</span>
                        <span class="quick-text">Indian</span>
                    </button>
                    <button class="quick-btn highlight" onclick="searchPOI('punjabi dhaba')">
                        <span class="quick-icon">ü•ò</span>
                        <span class="quick-text">Dhaba</span>
                    </button>
                    <button class="quick-btn" onclick="searchPOI('restaurant')">
                        <span class="quick-icon">üçî</span>
                        <span class="quick-text">Food</span>
                    </button>
                    <button class="quick-btn" onclick="searchPOI('fast food')">
                        <span class="quick-icon">üçü</span>
                        <span class="quick-text">Fast Food</span>
                    </button>
                </div>
                
                <div class="quick-menu-title">üöõ Trucker / ‡®ü‡®∞‡©±‡®ï‡®∞</div>
                <div class="quick-grid">
                    <button class="quick-btn" onclick="searchPOI('truck stop')">
                        <span class="quick-icon">‚õΩ</span>
                        <span class="quick-text">Truck Stop</span>
                    </button>
                    <button class="quick-btn" onclick="searchPOI('rest area')">
                        <span class="quick-icon">üÖøÔ∏è</span>
                        <span class="quick-text">Rest Area</span>
                    </button>
                    <button class="quick-btn" onclick="searchPOI('truck wash')">
                        <span class="quick-icon">üöø</span>
                        <span class="quick-text">Wash</span>
                    </button>
                    <button class="quick-btn" onclick="searchPOI('truck repair')">
                        <span class="quick-icon">üîß</span>
                        <span class="quick-text">Repair</span>
                    </button>
                </div>
            </div>
            
            <!-- STEPS LIST -->
            <div class="steps-list" id="stepsList"></div>
            
            <!-- ROUTE INFO -->
            <div class="route-info" id="routeInfo">
                <div class="route-stats">
                    <div class="route-stat">
                        <div class="route-stat-value" id="routeDistance">--</div>
                        <div class="route-stat-label">Distance</div>
                    </div>
                    <div class="route-stat">
                        <div class="route-stat-value" id="routeTime">--</div>
                        <div class="route-stat-label">Time</div>
                    </div>
                </div>
                <div class="route-actions">
                    <button class="route-btn btn-cancel" onclick="cancelRoute()">‚úï</button>
                    <button class="route-btn btn-start" onclick="startNavigation()">‚ñ∂Ô∏è Start</button>
                    <button class="route-btn btn-voice" onclick="openGoogleMaps()">üîä Voice</button>
                </div>
                <div style="text-align:center; margin-top:8px; font-size:10px; color:#888;">
                    üìù In-app text nav ‚Ä¢ üîä Voice = Google Maps
                </div>
            </div>
        </div>
        
        <!-- SETTINGS PANEL -->
        <div class="panel" id="settingsPanel">
            <div class="panel-header">
                <span class="panel-title">‚öôÔ∏è Settings</span>
                <button class="panel-close" onclick="closePanel('settingsPanel')">√ó</button>
            </div>
            
            <div class="panel-section">
                <div class="panel-section-title">üöõ Driver Info</div>
                <div class="setting-item">
                    <span>Name</span>
                    <span class="setting-value" id="settingsName">-</span>
                </div>
                <div class="setting-item">
                    <span>Truck</span>
                    <span class="setting-value" id="settingsTruck">-</span>
                </div>
                <div class="setting-item">
                    <span>Company</span>
                    <span class="setting-value" id="settingsCompany">-</span>
                </div>
                <div class="setting-item">
                    <span>Home State</span>
                    <span class="setting-value" id="settingsState">-</span>
                </div>
            </div>
            
            <div class="panel-section">
                <div class="panel-section-title">üìç GPS Status</div>
                <div class="setting-item">
                    <span>Location</span>
                    <span class="setting-value" id="settingsGps">-</span>
                </div>
                <div class="setting-item">
                    <span>Current State</span>
                    <span class="setting-value" id="settingsCurrentState">-</span>
                </div>
            </div>
            
            <div class="panel-section">
                <div class="panel-section-title">‚ÑπÔ∏è About</div>
                <div class="setting-item">
                    <span>Navigation</span>
                    <span class="setting-value">OpenRouteService</span>
                </div>
                <div class="setting-item">
                    <span>Maps</span>
                    <span class="setting-value">OpenStreetMap</span>
                </div>
            </div>
            
            <button class="btn btn-danger" onclick="logout()" style="width:100%; margin-top:20px;">
                üö™ Logout
            </button>
        </div>
        
        <!-- TRIPS PANEL -->
        <div class="panel" id="tripsPanel">
            <div class="panel-header">
                <span class="panel-title">üìä Trip History</span>
                <button class="panel-close" onclick="closePanel('tripsPanel')">√ó</button>
            </div>
            
            <div id="tripsList"></div>
            
            <div class="export-btns">
                <button class="export-btn btn-blue" onclick="exportTrips('json')">üìÑ Export JSON</button>
                <button class="export-btn btn-primary" onclick="exportTrips('csv')">üìä Export CSV</button>
            </div>
        </div>
        
        <!-- IFTA PANEL -->
        <div class="panel" id="iftaPanel">
            <div class="panel-header">
                <span class="panel-title">üìã IFTA Report</span>
                <button class="panel-close" onclick="closePanel('iftaPanel')">√ó</button>
            </div>
            
            <div class="panel-section">
                <div class="panel-section-title">üìÖ Select Quarter</div>
                <select class="form-select" id="iftaQuarter" onchange="generateIFTA()" style="margin-bottom:10px;">
                    <option value="all">All Time</option>
                    <option value="q1">Q1 (Jan-Mar)</option>
                    <option value="q2">Q2 (Apr-Jun)</option>
                    <option value="q3">Q3 (Jul-Sep)</option>
                    <option value="q4">Q4 (Oct-Dec)</option>
                </select>
                <select class="form-select" id="iftaYear" onchange="generateIFTA()">
                    <option value="2026">2026</option>
                    <option value="2025">2025</option>
                    <option value="2024">2024</option>
                </select>
            </div>
            
            <div class="panel-section">
                <div class="panel-section-title">üó∫Ô∏è Miles by State/Province</div>
                <div id="iftaStates"></div>
                <div class="ifta-total">
                    <span>TOTAL MILES</span>
                    <span id="iftaTotal">0.0 mi</span>
                </div>
            </div>
            
            <div class="export-btns">
                <button class="export-btn btn-primary" onclick="exportIFTA()">üìä Export IFTA CSV</button>
            </div>
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const ORS_API_KEY = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImRlMDNiNzNlNDg4ZjQ2N2NiYmEyOThhZWNiMzdmOWI1IiwiaCI6Im11cm11cjY0In0=';
        
        const PROFILE_KEY = 'trucker_profile';
        const TRIPS_KEY = 'trucker_trips';
        const GPS_LOG_KEY = 'trucker_gps_log';
        
        let profile = null;
        let map = null;
        let userMarker = null;
        let routeLine = null;
        let destMarker = null;
        let tripLine = null;
        let userLat = null;
        let userLon = null;
        let watchId = null;
        let currentRoute = null;
        let routeSteps = [];
        let isNavigating = false;
        let destinationCoords = null;
        
        // Trip recording
        let isTripActive = false;
        let currentTrip = null;
        let tripGpsLog = [];
        let tripInterval = null;
        let lastStateCheck = null;
        
        // State boundaries (approximate centers for reverse geocoding)
        const US_STATES = {
            'Alabama': 'AL', 'Alaska': 'AK', 'Arizona': 'AZ', 'Arkansas': 'AR', 'California': 'CA',
            'Colorado': 'CO', 'Connecticut': 'CT', 'Delaware': 'DE', 'Florida': 'FL', 'Georgia': 'GA',
            'Hawaii': 'HI', 'Idaho': 'ID', 'Illinois': 'IL', 'Indiana': 'IN', 'Iowa': 'IA',
            'Kansas': 'KS', 'Kentucky': 'KY', 'Louisiana': 'LA', 'Maine': 'ME', 'Maryland': 'MD',
            'Massachusetts': 'MA', 'Michigan': 'MI', 'Minnesota': 'MN', 'Mississippi': 'MS', 'Missouri': 'MO',
            'Montana': 'MT', 'Nebraska': 'NE', 'Nevada': 'NV', 'New Hampshire': 'NH', 'New Jersey': 'NJ',
            'New Mexico': 'NM', 'New York': 'NY', 'North Carolina': 'NC', 'North Dakota': 'ND', 'Ohio': 'OH',
            'Oklahoma': 'OK', 'Oregon': 'OR', 'Pennsylvania': 'PA', 'Rhode Island': 'RI', 'South Carolina': 'SC',
            'South Dakota': 'SD', 'Tennessee': 'TN', 'Texas': 'TX', 'Utah': 'UT', 'Vermont': 'VT',
            'Virginia': 'VA', 'Washington': 'WA', 'West Virginia': 'WV', 'Wisconsin': 'WI', 'Wyoming': 'WY'
        };
        
        const CA_PROVINCES = {
            'Alberta': 'AB', 'British Columbia': 'BC', 'Manitoba': 'MB', 'New Brunswick': 'NB',
            'Newfoundland and Labrador': 'NL', 'Nova Scotia': 'NS', 'Ontario': 'ON', 'Prince Edward Island': 'PE',
            'Quebec': 'QC', 'Saskatchewan': 'SK'
        };
        
        const MX_STATES = {
            'Baja California': 'BCN', 'Sonora': 'SON', 'Chihuahua': 'CHH', 'Coahuila': 'COA',
            'Nuevo Le√≥n': 'NLE', 'Tamaulipas': 'TAM'
        };
        
        // Direction icons
        const directionIcons = {
            'left': '‚Ü∞', 'right': '‚Ü±', 'sharp left': '‚Ü≤', 'sharp right': '‚Ü≥',
            'slight left': '‚Üñ', 'slight right': '‚Üó', 'straight': '‚Üë',
            'uturn': '‚Ü©', 'arrive': 'üèÅ', 'depart': 'üöõ', 'roundabout': 'üîÑ', 'default': '‚Üí'
        };
        
        const punjabiDirections = {
            'Turn left': '‡®ñ‡©±‡®¨‡©á ‡®Æ‡©Å‡©ú‡©ã', 'Turn right': '‡®∏‡©±‡®ú‡©á ‡®Æ‡©Å‡©ú‡©ã', 'Continue': '‡®ú‡®æ‡®∞‡©Ä ‡®∞‡©±‡®ñ‡©ã',
            'Head': '‡®µ‡©±‡®≤ ‡®ú‡®æ‡®ì', 'Arrive': '‡®™‡®π‡©Å‡©∞‡®ö ‡®ó‡®è', 'Keep left': '‡®ñ‡©±‡®¨‡©á ‡®∞‡®π‡©ã', 'Keep right': '‡®∏‡©±‡®ú‡©á ‡®∞‡®π‡©ã'
        };
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const savedProfile = localStorage.getItem(PROFILE_KEY);
            const validatedCode = localStorage.getItem('trucker_validated_code');
            
            if (validatedCode && savedProfile) {
                profile = JSON.parse(savedProfile);
                showMainApp();
            } else if (validatedCode) {
                showScreen('setupScreen');
            }
        });
        
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }
        
        function validateCode() {
            let code = document.getElementById('inviteCode').value.trim().toUpperCase();
            if (!code.startsWith('TRUCK-')) code = 'TRUCK-' + code;
            
            if (code.startsWith('TRUCK-') && code.length >= 11) {
                localStorage.setItem('trucker_validated_code', code);
                showScreen('setupScreen');
                return;
            }
            
            document.getElementById('codeError').classList.add('show');
        }
        
        function completeSetup() {
            const name = document.getElementById('driverName').value.trim();
            if (!name) { alert('Please enter your name'); return; }
            
            profile = {
                name: name,
                truck: document.getElementById('truckNumber').value.trim() || 'Not set',
                company: document.getElementById('companyName').value.trim() || 'Not set',
                homeState: document.getElementById('homeState').value,
                created: new Date().toISOString()
            };
            
            localStorage.setItem(PROFILE_KEY, JSON.stringify(profile));
            showMainApp();
        }
        
        function showMainApp() {
            showScreen('mainScreen');
            
            document.getElementById('settingsName').textContent = profile.name;
            document.getElementById('settingsTruck').textContent = profile.truck;
            document.getElementById('settingsCompany').textContent = profile.company;
            document.getElementById('settingsState').textContent = profile.homeState;
            
            setTimeout(initMap, 100);
            startGPS();
            
            document.getElementById('searchInput').addEventListener('keypress', e => {
                if (e.key === 'Enter') searchDestination();
            });
        }
        
        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([32.7767, -96.7970], 10);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                maxZoom: 19,
                attribution: '¬© OpenStreetMap, ¬© CARTO'
            }).addTo(map);
            
            const truckIcon = L.divIcon({
                html: '<div class="truck-marker">üöõ</div>',
                className: '',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
            
            userMarker = L.marker([32.7767, -96.7970], { icon: truckIcon }).addTo(map);
        }
        
        function startGPS() {
            if (!navigator.geolocation) {
                document.getElementById('settingsGps').textContent = 'Not available';
                return;
            }
            
            watchId = navigator.geolocation.watchPosition(
                updateLocation,
                err => { document.getElementById('settingsGps').textContent = 'Error: ' + err.message; },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 3000 }
            );
        }
        
        function updateLocation(position) {
            const prevLat = userLat;
            const prevLon = userLon;
            
            userLat = position.coords.latitude;
            userLon = position.coords.longitude;
            
            document.getElementById('settingsGps').textContent = 'Active ‚úì';
            
            if (userMarker) userMarker.setLatLng([userLat, userLon]);
            
            if (!isNavigating && !currentRoute) {
                map.setView([userLat, userLon], 14);
            }
            
            // Record GPS for trip
            if (isTripActive && currentTrip) {
                const point = {
                    lat: userLat,
                    lon: userLon,
                    timestamp: new Date().toISOString(),
                    speed: position.coords.speed || 0
                };
                
                tripGpsLog.push(point);
                
                // Calculate distance from last point
                if (prevLat && prevLon) {
                    const dist = getDistanceMiles(prevLat, prevLon, userLat, userLon);
                    currentTrip.totalMiles += dist;
                    document.getElementById('tripMiles').textContent = currentTrip.totalMiles.toFixed(1) + ' mi';
                    
                    // Update trip line on map
                    if (tripLine) {
                        tripLine.addLatLng([userLat, userLon]);
                    }
                }
                
                // Check state every 30 seconds
                const now = Date.now();
                if (!lastStateCheck || (now - lastStateCheck) > 30000) {
                    lastStateCheck = now;
                    checkCurrentState();
                }
            }
        }
        
        function getDistanceMiles(lat1, lon1, lat2, lon2) {
            const R = 3959; // Earth radius in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        async function checkCurrentState() {
            if (!userLat || !userLon) return;
            
            try {
                const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${userLat}&lon=${userLon}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.address) {
                    let state = data.address.state || data.address.province || '';
                    let country = data.address.country_code?.toUpperCase() || '';
                    
                    let stateCode = null;
                    
                    if (country === 'US' && US_STATES[state]) {
                        stateCode = US_STATES[state];
                    } else if (country === 'CA' && CA_PROVINCES[state]) {
                        stateCode = CA_PROVINCES[state];
                    } else if (country === 'MX' && MX_STATES[state]) {
                        stateCode = MX_STATES[state];
                    }
                    
                    document.getElementById('settingsCurrentState').textContent = stateCode || state || '-';
                    
                    // Record state entry for trip
                    if (isTripActive && currentTrip && stateCode) {
                        const lastState = currentTrip.stateLog[currentTrip.stateLog.length - 1];
                        if (!lastState || lastState.state !== stateCode) {
                            currentTrip.stateLog.push({
                                state: stateCode,
                                country: country,
                                entryTime: new Date().toISOString(),
                                entryLat: userLat,
                                entryLon: userLon,
                                entryMiles: currentTrip.totalMiles
                            });
                        }
                    }
                }
            } catch (e) {
                console.error('State check error:', e);
            }
        }
        
        // ============ TRIP RECORDING ============
        
        function startTrip() {
            if (isTripActive) return;
            
            isTripActive = true;
            tripGpsLog = [];
            lastStateCheck = null;
            
            currentTrip = {
                id: Date.now(),
                startTime: new Date().toISOString(),
                endTime: null,
                startLat: userLat,
                startLon: userLon,
                endLat: null,
                endLon: null,
                totalMiles: 0,
                stateLog: [],
                stateMiles: {}
            };
            
            // Start trip line on map
            tripLine = L.polyline([[userLat, userLon]], {
                color: '#e74c3c',
                weight: 4,
                opacity: 0.8
            }).addTo(map);
            
            document.getElementById('tripBanner').classList.add('show');
            document.getElementById('startTripBtn').style.display = 'none';
            document.getElementById('stopTripBtn').style.display = 'block';
            document.getElementById('quickMenu').classList.remove('show');
            
            // Check initial state
            checkCurrentState();
        }
        
        function stopTrip() {
            if (!isTripActive || !currentTrip) return;
            
            isTripActive = false;
            
            currentTrip.endTime = new Date().toISOString();
            currentTrip.endLat = userLat;
            currentTrip.endLon = userLon;
            
            // Calculate miles per state
            calculateStateMiles();
            
            // Save trip
            const trips = JSON.parse(localStorage.getItem(TRIPS_KEY) || '[]');
            trips.unshift(currentTrip);
            localStorage.setItem(TRIPS_KEY, JSON.stringify(trips));
            
            // Save GPS log separately (can be large)
            const gpsLogs = JSON.parse(localStorage.getItem(GPS_LOG_KEY) || '{}');
            gpsLogs[currentTrip.id] = tripGpsLog;
            localStorage.setItem(GPS_LOG_KEY, JSON.stringify(gpsLogs));
            
            // Reset
            document.getElementById('tripBanner').classList.remove('show');
            document.getElementById('startTripBtn').style.display = 'block';
            document.getElementById('stopTripBtn').style.display = 'none';
            
            // Keep trip line visible but change color
            if (tripLine) {
                tripLine.setStyle({ color: '#00ff88', opacity: 0.5 });
            }
            
            alert(`Trip saved!\n${currentTrip.totalMiles.toFixed(1)} miles recorded\n\n‡®Ø‡®æ‡®§‡®∞‡®æ ‡®∏‡©á‡®µ ‡®π‡©ã ‡®ó‡®à!`);
            
            currentTrip = null;
            tripGpsLog = [];
        }
        
        function calculateStateMiles() {
            if (!currentTrip || currentTrip.stateLog.length === 0) return;
            
            const log = currentTrip.stateLog;
            
            for (let i = 0; i < log.length; i++) {
                const entry = log[i];
                const nextEntry = log[i + 1];
                
                let milesInState;
                if (nextEntry) {
                    milesInState = nextEntry.entryMiles - entry.entryMiles;
                } else {
                    milesInState = currentTrip.totalMiles - entry.entryMiles;
                }
                
                if (!currentTrip.stateMiles[entry.state]) {
                    currentTrip.stateMiles[entry.state] = 0;
                }
                currentTrip.stateMiles[entry.state] += milesInState;
            }
        }
        
        // ============ PANELS ============
        
        function toggleQuickMenu() {
            const menu = document.getElementById('quickMenu');
            menu.classList.toggle('show');
            document.getElementById('routeInfo').classList.remove('show');
            document.getElementById('stepsList').classList.remove('show');
        }
        
        function openSettingsPanel() {
            document.getElementById('quickMenu').classList.remove('show');
            document.getElementById('settingsPanel').classList.add('show');
        }
        
        function openTripsPanel() {
            document.getElementById('quickMenu').classList.remove('show');
            renderTrips();
            document.getElementById('tripsPanel').classList.add('show');
        }
        
        function openIFTAPanel() {
            document.getElementById('quickMenu').classList.remove('show');
            generateIFTA();
            document.getElementById('iftaPanel').classList.add('show');
        }
        
        function closePanel(id) {
            document.getElementById(id).classList.remove('show');
        }
        
        function renderTrips() {
            const trips = JSON.parse(localStorage.getItem(TRIPS_KEY) || '[]');
            const list = document.getElementById('tripsList');
            
            if (trips.length === 0) {
                list.innerHTML = '<div style="text-align:center; color:#888; padding:40px;">No trips recorded yet<br>‡®ï‡©ã‡®à ‡®Ø‡®æ‡®§‡®∞‡®æ ‡®∞‡®ø‡®ï‡®æ‡®∞‡®° ‡®®‡®π‡©Ä‡®Ç</div>';
                return;
            }
            
            list.innerHTML = trips.slice(0, 50).map(trip => {
                const startDate = new Date(trip.startTime).toLocaleDateString();
                const startTime = new Date(trip.startTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const endTime = trip.endTime ? new Date(trip.endTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '-';
                const states = Object.keys(trip.stateMiles || {}).join(', ') || '-';
                
                return `
                    <div class="trip-item">
                        <div class="trip-item-header">
                            <span class="trip-item-date">${startDate}</span>
                            <span class="trip-item-miles">${trip.totalMiles.toFixed(1)} mi</span>
                        </div>
                        <div class="trip-item-details">${startTime} - ${endTime}</div>
                        <div class="trip-item-states">üìç States: ${states}</div>
                    </div>
                `;
            }).join('');
        }
        
        function generateIFTA() {
            const trips = JSON.parse(localStorage.getItem(TRIPS_KEY) || '[]');
            const quarter = document.getElementById('iftaQuarter').value;
            const year = parseInt(document.getElementById('iftaYear').value);
            
            // Filter trips by quarter/year
            const filteredTrips = trips.filter(trip => {
                const date = new Date(trip.startTime);
                const tripYear = date.getFullYear();
                const tripMonth = date.getMonth() + 1;
                
                if (quarter === 'all') return true;
                if (tripYear !== year) return false;
                
                if (quarter === 'q1' && tripMonth >= 1 && tripMonth <= 3) return true;
                if (quarter === 'q2' && tripMonth >= 4 && tripMonth <= 6) return true;
                if (quarter === 'q3' && tripMonth >= 7 && tripMonth <= 9) return true;
                if (quarter === 'q4' && tripMonth >= 10 && tripMonth <= 12) return true;
                
                return false;
            });
            
            // Aggregate miles by state
            const stateMiles = {};
            filteredTrips.forEach(trip => {
                for (const [state, miles] of Object.entries(trip.stateMiles || {})) {
                    if (!stateMiles[state]) stateMiles[state] = 0;
                    stateMiles[state] += miles;
                }
            });
            
            // Sort by miles
            const sorted = Object.entries(stateMiles).sort((a, b) => b[1] - a[1]);
            
            const statesDiv = document.getElementById('iftaStates');
            
            if (sorted.length === 0) {
                statesDiv.innerHTML = '<div style="text-align:center; color:#888; padding:20px;">No data for selected period</div>';
                document.getElementById('iftaTotal').textContent = '0.0 mi';
                return;
            }
            
            let total = 0;
            statesDiv.innerHTML = sorted.map(([state, miles]) => {
                total += miles;
                return `
                    <div class="ifta-state">
                        <span class="ifta-state-name">${state}</span>
                        <span class="ifta-state-miles">${miles.toFixed(1)} mi</span>
                    </div>
                `;
            }).join('');
            
            document.getElementById('iftaTotal').textContent = total.toFixed(1) + ' mi';
        }
        
        // ============ EXPORT ============
        
        function exportTrips(format) {
            const trips = JSON.parse(localStorage.getItem(TRIPS_KEY) || '[]');
            
            if (trips.length === 0) {
                alert('No trips to export');
                return;
            }
            
            let content, filename, type;
            
            if (format === 'json') {
                content = JSON.stringify(trips, null, 2);
                filename = `trips_${new Date().toISOString().split('T')[0]}.json`;
                type = 'application/json';
            } else {
                // CSV
                const headers = ['Date', 'Start Time', 'End Time', 'Miles', 'States'];
                const rows = trips.map(t => [
                    new Date(t.startTime).toLocaleDateString(),
                    new Date(t.startTime).toLocaleTimeString(),
                    t.endTime ? new Date(t.endTime).toLocaleTimeString() : '',
                    t.totalMiles.toFixed(1),
                    Object.keys(t.stateMiles || {}).join('; ')
                ]);
                
                content = [headers, ...rows].map(r => r.join(',')).join('\n');
                filename = `trips_${new Date().toISOString().split('T')[0]}.csv`;
                type = 'text/csv';
            }
            
            downloadFile(content, filename, type);
        }
        
        function exportIFTA() {
            const trips = JSON.parse(localStorage.getItem(TRIPS_KEY) || '[]');
            const quarter = document.getElementById('iftaQuarter').value;
            const year = document.getElementById('iftaYear').value;
            
            // Same filtering as generateIFTA
            const filteredTrips = trips.filter(trip => {
                const date = new Date(trip.startTime);
                const tripYear = date.getFullYear();
                const tripMonth = date.getMonth() + 1;
                
                if (quarter === 'all') return true;
                if (tripYear !== parseInt(year)) return false;
                
                if (quarter === 'q1' && tripMonth >= 1 && tripMonth <= 3) return true;
                if (quarter === 'q2' && tripMonth >= 4 && tripMonth <= 6) return true;
                if (quarter === 'q3' && tripMonth >= 7 && tripMonth <= 9) return true;
                if (quarter === 'q4' && tripMonth >= 10 && tripMonth <= 12) return true;
                
                return false;
            });
            
            const stateMiles = {};
            filteredTrips.forEach(trip => {
                for (const [state, miles] of Object.entries(trip.stateMiles || {})) {
                    if (!stateMiles[state]) stateMiles[state] = 0;
                    stateMiles[state] += miles;
                }
            });
            
            const headers = ['State/Province', 'Miles'];
            const rows = Object.entries(stateMiles).map(([state, miles]) => [state, miles.toFixed(1)]);
            const total = Object.values(stateMiles).reduce((a, b) => a + b, 0);
            rows.push(['TOTAL', total.toFixed(1)]);
            
            const content = [headers, ...rows].map(r => r.join(',')).join('\n');
            const filename = `IFTA_${quarter}_${year}.csv`;
            
            downloadFile(content, filename, 'text/csv');
        }
        
        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // ============ NAVIGATION ============
        
        function searchPOI(type) {
            document.getElementById('quickMenu').classList.remove('show');
            if (userLat && userLon) {
                window.open(`https://www.google.com/maps/search/${encodeURIComponent(type)}/@${userLat},${userLon},13z`, '_blank');
            } else {
                window.open(`https://www.google.com/maps/search/${encodeURIComponent(type)}`, '_blank');
            }
        }
        
        async function searchDestination() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;
            
            document.getElementById('quickMenu').classList.remove('show');
            showLoading(true);
            
            try {
                const geocodeUrl = `https://api.openrouteservice.org/geocode/search?api_key=${ORS_API_KEY}&text=${encodeURIComponent(query)}&size=1`;
                const geoResponse = await fetch(geocodeUrl);
                const geoData = await geoResponse.json();
                
                if (!geoData.features || geoData.features.length === 0) {
                    alert('Location not found');
                    showLoading(false);
                    return;
                }
                
                const destCoords = geoData.features[0].geometry.coordinates;
                destinationCoords = { lat: destCoords[1], lon: destCoords[0] };
                
                await getRoute(destinationCoords.lat, destinationCoords.lon);
            } catch (error) {
                console.error('Search error:', error);
                alert('Search failed');
                showLoading(false);
            }
        }
        
        async function getRoute(destLat, destLon) {
            if (!userLat || !userLon) {
                alert('Waiting for GPS');
                showLoading(false);
                return;
            }
            
            try {
                const routeUrl = `https://api.openrouteservice.org/v2/directions/driving-hgv?api_key=${ORS_API_KEY}&start=${userLon},${userLat}&end=${destLon},${destLat}`;
                const response = await fetch(routeUrl);
                const data = await response.json();
                
                if (!data.features || data.features.length === 0) {
                    alert('Route not found');
                    showLoading(false);
                    return;
                }
                
                currentRoute = data.features[0];
                const coords = currentRoute.geometry.coordinates;
                const props = currentRoute.properties;
                const segments = props.segments[0];
                
                if (routeLine) map.removeLayer(routeLine);
                if (destMarker) map.removeLayer(destMarker);
                
                const routeCoords = coords.map(c => [c[1], c[0]]);
                routeLine = L.polyline(routeCoords, { color: '#00ff88', weight: 6, opacity: 0.8 }).addTo(map);
                
                const destIcon = L.divIcon({ html: 'üèÅ', className: '', iconSize: [30, 30], iconAnchor: [15, 30] });
                destMarker = L.marker([destLat, destLon], { icon: destIcon }).addTo(map);
                
                map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });
                
                const distanceMi = (props.summary.distance / 1609.34).toFixed(1);
                const durationMin = Math.round(props.summary.duration / 60);
                const durationHr = Math.floor(durationMin / 60);
                const durationRemMin = durationMin % 60;
                
                document.getElementById('routeDistance').textContent = `${distanceMi} mi`;
                document.getElementById('routeTime').textContent = durationHr > 0 ? `${durationHr}h ${durationRemMin}m` : `${durationMin}m`;
                
                routeSteps = segments.steps.map(step => ({
                    instruction: step.instruction,
                    distance: step.distance,
                    type: step.type
                }));
                
                renderStepsList();
                document.getElementById('routeInfo').classList.add('show');
                document.getElementById('stepsList').classList.add('show');
            } catch (error) {
                console.error('Route error:', error);
                alert('Failed to get route');
            }
            
            showLoading(false);
        }
        
        function renderStepsList() {
            document.getElementById('stepsList').innerHTML = routeSteps.map((step, i) => {
                const icon = getDirectionIcon(step.instruction);
                const distStr = step.distance >= 1000 ? `${(step.distance/1609.34).toFixed(1)} mi` : `${Math.round(step.distance * 3.28)} ft`;
                
                return `<div class="step-item" id="step-${i}">
                    <span class="step-icon">${icon}</span>
                    <span class="step-text">${step.instruction}</span>
                    <span class="step-dist">${distStr}</span>
                </div>`;
            }).join('');
        }
        
        function getDirectionIcon(instruction) {
            const lower = instruction.toLowerCase();
            if (lower.includes('sharp') && lower.includes('left')) return directionIcons['sharp left'];
            if (lower.includes('sharp') && lower.includes('right')) return directionIcons['sharp right'];
            if (lower.includes('slight') && lower.includes('left')) return directionIcons['slight left'];
            if (lower.includes('slight') && lower.includes('right')) return directionIcons['slight right'];
            if (lower.includes('left')) return directionIcons['left'];
            if (lower.includes('right')) return directionIcons['right'];
            if (lower.includes('straight') || lower.includes('continue')) return directionIcons['straight'];
            if (lower.includes('arrive')) return directionIcons['arrive'];
            if (lower.includes('depart') || lower.includes('head')) return directionIcons['depart'];
            if (lower.includes('roundabout')) return directionIcons['roundabout'];
            return directionIcons['default'];
        }
        
        function translateToPunjabi(text) {
            let translated = text;
            for (const [eng, pun] of Object.entries(punjabiDirections)) {
                translated = translated.replace(new RegExp(eng, 'gi'), pun);
            }
            return translated;
        }
        
        function startNavigation() {
            if (!routeSteps || routeSteps.length === 0) return;
            
            isNavigating = true;
            
            document.getElementById('routeInfo').classList.remove('show');
            document.getElementById('stepsList').classList.remove('show');
            document.getElementById('directionBox').classList.add('show');
            
            updateDirectionDisplay(0);
            
            if (userLat && userLon) map.setView([userLat, userLon], 16);
        }
        
        function updateDirectionDisplay(index) {
            if (index >= routeSteps.length) {
                document.getElementById('directionIcon').textContent = 'üèÅ';
                document.getElementById('directionText').textContent = 'You have arrived!';
                document.getElementById('directionPunjabi').textContent = '‡®§‡©Å‡®∏‡©Ä‡®Ç ‡®™‡®π‡©Å‡©∞‡®ö ‡®ó‡®è ‡®π‡©ã!';
                document.getElementById('directionDistance').textContent = '';
                return;
            }
            
            const step = routeSteps[index];
            const icon = getDirectionIcon(step.instruction);
            const distStr = step.distance >= 1000 ? `${(step.distance/1609.34).toFixed(1)} mi` : `${Math.round(step.distance * 3.28)} ft`;
            
            document.getElementById('directionIcon').textContent = icon;
            document.getElementById('directionText').textContent = step.instruction;
            document.getElementById('directionPunjabi').textContent = translateToPunjabi(step.instruction);
            document.getElementById('directionDistance').textContent = distStr;
        }
        
        function cancelRoute() {
            isNavigating = false;
            currentRoute = null;
            routeSteps = [];
            destinationCoords = null;
            
            if (routeLine) { map.removeLayer(routeLine); routeLine = null; }
            if (destMarker) { map.removeLayer(destMarker); destMarker = null; }
            
            document.getElementById('routeInfo').classList.remove('show');
            document.getElementById('stepsList').classList.remove('show');
            document.getElementById('directionBox').classList.remove('show');
            document.getElementById('searchInput').value = '';
            
            if (userLat && userLon) map.setView([userLat, userLon], 14);
        }
        
        function openGoogleMaps() {
            if (!destinationCoords) return;
            const url = userLat && userLon ?
                `https://www.google.com/maps/dir/${userLat},${userLon}/${destinationCoords.lat},${destinationCoords.lon}` :
                `https://www.google.com/maps/dir/?api=1&destination=${destinationCoords.lat},${destinationCoords.lon}`;
            window.open(url, '_blank');
        }
        
        function showLoading(show) {
            document.getElementById('loading').classList.toggle('show', show);
        }
        
        function logout() {
            if (isTripActive) {
                if (!confirm('Trip is recording! Stop and logout?')) return;
                stopTrip();
            }
            if (watchId) navigator.geolocation.clearWatch(watchId);
            localStorage.removeItem(PROFILE_KEY);
            localStorage.removeItem('trucker_validated_code');
            location.reload();
        }
    </script>
</body>
</html>
